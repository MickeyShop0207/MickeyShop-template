# 前台篩選條件系統

## 系統概覽

### 篩選系統特性
- **多維度篩選：** 支援商品屬性、美容專屬、用戶體驗等多種篩選條件
- **智慧篩選：** 根據已選條件動態調整可選項，避免無效組合
- **性能優化：** 結合前端快取和後端優化，確保流暢體驗
- **動畫整合：** 與 GSAP 動畫系統深度整合，提供豐富的互動反饋

## 篩選條件分類

### 1. 商品基礎屬性篩選

#### 品牌篩選 (Brand)
```javascript
const brandFilter = {
  type: 'checkbox',
  multiple: true,
  logic: 'OR', // 多品牌選擇為OR邏輯
  options: [
    { id: 'brand_1', name: 'L\'Oréal', count: 156 },
    { id: 'brand_2', name: 'Maybelline', count: 89 },
    { id: 'brand_3', name: 'Estée Lauder', count: 234 },
    // 動態從後端載入
  ],
  search: true, // 支援品牌搜尋
  showCount: true // 顯示商品數量
}
```

#### 價格區間篩選 (Price Range)
```javascript
const priceFilter = {
  type: 'range-slider',
  min: 0,
  max: 5000,
  step: 50,
  defaultValue: [0, 5000],
  currency: 'NT$',
  presets: [
    { label: '100以下', range: [0, 100] },
    { label: '100-500', range: [100, 500] },
    { label: '500-1000', range: [500, 1000] },
    { label: '1000-2000', range: [1000, 2000] },
    { label: '2000以上', range: [2000, 5000] }
  ]
}
```

#### 商品分類篩選 (Category)
```javascript
const categoryFilter = {
  type: 'tree-select',
  multiple: true,
  hierarchy: [
    {
      id: 'skincare',
      name: '保養品',
      children: [
        { id: 'cleansing', name: '清潔', count: 89 },
        { id: 'moisturizing', name: '保濕', count: 156 },
        { id: 'anti-aging', name: '抗老', count: 67 },
        { id: 'whitening', name: '美白', count: 94 }
      ]
    },
    {
      id: 'makeup',
      name: '美容用品',
      children: [
        { id: 'foundation', name: '底妝', count: 78 },
        { id: 'lipstick', name: '唇彩', count: 123 },
        { id: 'eyeshadow', name: '眼影', count: 156 }
      ]
    },
    {
      id: 'haircare',
      name: '美髮用品',
      children: [
        { id: 'shampoo', name: '洗髮', count: 45 },
        { id: 'treatment', name: '護髮', count: 67 },
        { id: 'styling', name: '造型', count: 89 }
      ]
    }
  ]
}
```

### 2. 美容專屬篩選條件

#### 膚質類型篩選 (Skin Type)
```javascript
const skinTypeFilter = {
  type: 'radio-group',
  multiple: false,
  logic: 'AND',
  options: [
    { id: 'all_skin', name: '所有膚質', isDefault: true },
    { id: 'dry', name: '乾性肌膚', icon: '🏜️' },
    { id: 'oily', name: '油性肌膚', icon: '💧' },
    { id: 'combination', name: '混合性肌膚', icon: '⚖️' },
    { id: 'sensitive', name: '敏感性肌膚', icon: '🌸' },
    { id: 'mature', name: '成熟肌膚', icon: '🕰️' }
  ]
}
```

#### 商品功效篩選 (Benefits)
```javascript
const benefitsFilter = {
  type: 'tag-select',
  multiple: true,
  logic: 'AND',
  maxSelection: 3, // 最多選擇3個功效
  options: [
    { id: 'hydrating', name: '保濕', color: '#4FC3F7' },
    { id: 'whitening', name: '美白', color: '#FFE082' },
    { id: 'anti-aging', name: '抗老', color: '#A5D6A7' },
    { id: 'oil-control', name: '控油', color: '#FFAB91' },
    { id: 'acne-fighting', name: '抗痘', color: '#F8BBD9' },
    { id: 'firming', name: '緊緻', color: '#C5CAE9' },
    { id: 'brightening', name: '亮澤', color: '#FFF59D' },
    { id: 'soothing', name: '舒緩', color: '#DCEDC8' }
  ]
}
```

#### 成分類型篩選 (Ingredients)
```javascript
const ingredientsFilter = {
  type: 'checkbox-group',
  multiple: true,
  logic: 'OR',
  categories: [
    {
      name: '天然成分',
      items: [
        { id: 'natural', name: '天然', badge: '🌿' },
        { id: 'organic', name: '有機認證', badge: '🌱' },
        { id: 'vegan', name: '純素', badge: '🥕' }
      ]
    },
    {
      name: '無添加',
      items: [
        { id: 'paraben-free', name: '無防腐劑', badge: '🚫' },
        { id: 'fragrance-free', name: '無香精', badge: '🚫' },
        { id: 'alcohol-free', name: '無酒精', badge: '🚫' }
      ]
    }
  ]
}
```

### 3. 用戶體驗篩選

#### 評分篩選 (Rating)
```javascript
const ratingFilter = {
  type: 'star-rating',
  minRating: 1,
  maxRating: 5,
  step: 0.5,
  defaultValue: 0, // 0表示不篩選
  showCount: true,
  options: [
    { stars: 5, label: '5星', count: 234 },
    { stars: 4, label: '4星以上', count: 456 },
    { stars: 3, label: '3星以上', count: 678 },
    { stars: 2, label: '2星以上', count: 789 },
    { stars: 1, label: '1星以上', count: 890 }
  ]
}
```

#### 商品狀態篩選 (Product Status)
```javascript
const statusFilter = {
  type: 'badge-select',
  multiple: true,
  logic: 'OR',
  options: [
    { id: 'new', name: '新品', badge: 'NEW', color: '#FF5722' },
    { id: 'hot', name: '熱賣', badge: 'HOT', color: '#F44336' },
    { id: 'sale', name: '特價', badge: 'SALE', color: '#4CAF50' },
    { id: 'limited', name: '限量', badge: 'LIMITED', color: '#9C27B0' },
    { id: 'preorder', name: '預購', badge: 'PRE-ORDER', color: '#FF9800' }
  ]
}
```

## 篩選器介面設計

### 桌面版側邊欄篩選器
```scss
// FilterSidebar.module.scss
.filterSidebar {
  width: 280px;
  background: var(--bg-component);
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  
  .filterHeader {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    
    .title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .clearAll {
      color: var(--color-primary);
      cursor: pointer;
      font-size: 0.875rem;
      
      &:hover {
        text-decoration: underline;
      }
    }
  }
  
  .filterSection {
    margin-bottom: 32px;
    
    &:last-child {
      margin-bottom: 0;
    }
    
    .sectionTitle {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      
      .toggleIcon {
        transform: rotate(0deg);
        transition: transform 0.3s ease;
        
        &.collapsed {
          transform: rotate(-90deg);
        }
      }
    }
    
    .sectionContent {
      opacity: 1;
      max-height: 500px;
      overflow: hidden;
      transition: all 0.3s ease;
      
      &.collapsed {
        opacity: 0;
        max-height: 0;
      }
    }
  }
}
```

### 移動版底部彈出篩選器
```scss
// FilterBottomSheet.module.scss
.filterBottomSheet {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-component);
  border-radius: 16px 16px 0 0;
  max-height: 80vh;
  overflow-y: auto;
  z-index: 1000;
  
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  
  &.open {
    transform: translateY(0);
  }
  
  .dragHandle {
    width: 40px;
    height: 4px;
    background: var(--text-tertiary);
    border-radius: 2px;
    margin: 12px auto;
  }
  
  .filterContent {
    padding: 0 24px 24px;
  }
  
  .filterActions {
    position: sticky;
    bottom: 0;
    background: var(--bg-component);
    padding: 16px 24px;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 12px;
    
    .clearButton,
    .applyButton {
      flex: 1;
      height: 44px;
      border-radius: 8px;
      font-weight: 500;
    }
    
    .clearButton {
      background: var(--bg-hover);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    
    .applyButton {
      background: var(--color-primary);
      color: white;
      border: none;
    }
  }
}
```

## 篩選邏輯與狀態管理

### Zustand 篩選狀態管理
```javascript
// stores/filterStore.js
import { create } from 'zustand'
import { subscribeWithSelector } from 'zustand/middleware'

const useFilterStore = create(
  subscribeWithSelector((set, get) => ({
    // 篩選條件狀態
    filters: {
      brands: [],
      priceRange: [0, 5000],
      categories: [],
      skinType: null,
      benefits: [],
      ingredients: [],
      rating: 0,
      status: []
    },
    
    // 篩選結果
    filteredProducts: [],
    totalCount: 0,
    isLoading: false,
    
    // 篩選選項
    filterOptions: {},
    
    // 動作
    setFilter: (filterType, value) => {
      set((state) => ({
        filters: {
          ...state.filters,
          [filterType]: value
        }
      }))
    },
    
    clearFilter: (filterType) => {
      const defaultValues = {
        brands: [],
        priceRange: [0, 5000],
        categories: [],
        skinType: null,
        benefits: [],
        ingredients: [],
        rating: 0,
        status: []
      }
      
      set((state) => ({
        filters: {
          ...state.filters,
          [filterType]: defaultValues[filterType]
        }
      }))
    },
    
    clearAllFilters: () => {
      set({
        filters: {
          brands: [],
          priceRange: [0, 5000],
          categories: [],
          skinType: null,
          benefits: [],
          ingredients: [],
          rating: 0,
          status: []
        }
      })
    },
    
    applyFilters: async () => {
      set({ isLoading: true })
      
      try {
        const { filters } = get()
        const response = await filterProducts(filters)
        
        set({
          filteredProducts: response.products,
          totalCount: response.total,
          isLoading: false
        })
      } catch (error) {
        set({ isLoading: false })
        // 使用統一錯誤處理系統
        const { useErrorHandler } = await import('@/stores/error-handler')
        useErrorHandler.getState().handleError(error, {
          type: 'filter-application',
          filters: filters,
          retryCallback: () => get().applyFilters(filters)
        })
      }
    },
    
    loadFilterOptions: async () => {
      try {
        const options = await getFilterOptions()
        set({ filterOptions: options })
      } catch (error) {
        // 使用統一錯誤處理系統
        const { useErrorHandler } = await import('@/stores/error-handler')
        useErrorHandler.getState().handleError(error, {
          type: 'filter-options-load',
          retryCallback: () => get().loadFilterOptions()
        })
      }
    }
  }))
)

export default useFilterStore
```

### 智慧篩選邏輯
```javascript
// utils/smartFiltering.js
export const updateAvailableOptions = (currentFilters, allOptions) => {
  // 根據當前已選擇的篩選條件，動態更新可用選項
  const { brands, categories, skinType, benefits } = currentFilters
  
  // 如果已選擇分類，則只顯示該分類下的品牌
  let availableBrands = allOptions.brands
  if (categories.length > 0) {
    availableBrands = allOptions.brands.filter(brand => 
      brand.categories.some(cat => categories.includes(cat))
    )
  }
  
  // 如果已選擇膚質，則只顯示適合的功效
  let availableBenefits = allOptions.benefits
  if (skinType) {
    availableBenefits = allOptions.benefits.filter(benefit =>
      benefit.suitableFor.includes(skinType) || benefit.suitableFor.includes('all')
    )
  }
  
  return {
    ...allOptions,
    brands: availableBrands,
    benefits: availableBenefits
  }
}

// 篩選邏輯組合
export const combineFilters = (filters) => {
  const conditions = []
  
  // 品牌篩選 (OR邏輯)
  if (filters.brands.length > 0) {
    conditions.push({
      field: 'brand',
      operator: 'in',
      value: filters.brands
    })
  }
  
  // 價格區間篩選
  if (filters.priceRange[0] > 0 || filters.priceRange[1] < 5000) {
    conditions.push({
      field: 'price',
      operator: 'between',
      value: filters.priceRange
    })
  }
  
  // 分類篩選 (OR邏輯)
  if (filters.categories.length > 0) {
    conditions.push({
      field: 'category',
      operator: 'in',
      value: filters.categories
    })
  }
  
  // 膚質篩選
  if (filters.skinType) {
    conditions.push({
      field: 'skinTypes',
      operator: 'contains',
      value: filters.skinType
    })
  }
  
  // 功效篩選 (AND邏輯 - 必須包含所有選中的功效)
  if (filters.benefits.length > 0) {
    conditions.push({
      field: 'benefits',
      operator: 'containsAll',
      value: filters.benefits
    })
  }
  
  // 成分篩選 (OR邏輯)
  if (filters.ingredients.length > 0) {
    conditions.push({
      field: 'ingredients',
      operator: 'containsAny',
      value: filters.ingredients
    })
  }
  
  // 評分篩選
  if (filters.rating > 0) {
    conditions.push({
      field: 'rating',
      operator: 'gte',
      value: filters.rating
    })
  }
  
  // 商品狀態篩選 (OR邏輯)
  if (filters.status.length > 0) {
    conditions.push({
      field: 'status',
      operator: 'in',
      value: filters.status
    })
  }
  
  return {
    conditions,
    logic: 'AND' // 不同篩選類型之間使用AND邏輯
  }
}
```

## 動畫整合

### 篩選結果更新動畫
```javascript
// animations/filterAnimations.js
export const filterResultAnimations = {
  // 商品列表更新動畫
  updateProductList: async (container, newProducts) => {
    const timeline = gsap.timeline()
    
    // 1. 舊商品淡出
    timeline
      .to('.product-card', {
        opacity: 0,
        y: 20,
        duration: 0.3,
        stagger: 0.05,
        ease: 'power2.in'
      })
      
    // 2. 更新商品內容
    timeline
      .call(() => {
        renderNewProducts(newProducts)
      })
      
    // 3. 新商品淡入
    timeline
      .from('.product-card', {
        opacity: 0,
        y: -20,
        duration: 0.4,
        stagger: 0.08,
        ease: 'power2.out'
      })
      
    return timeline
  },
  
  // 篩選器展開動畫
  expandFilterSection: (sectionElement) => {
    const content = sectionElement.querySelector('.sectionContent')
    const icon = sectionElement.querySelector('.toggleIcon')
    
    const timeline = gsap.timeline()
    
    timeline
      .to(icon, {
        rotation: 0,
        duration: 0.3,
        ease: 'power2.out'
      })
      .to(content, {
        opacity: 1,
        maxHeight: 500,
        duration: 0.3,
        ease: 'power2.out'
      }, '<')
      
    return timeline
  },
  
  // 篩選器收合動畫
  collapseFilterSection: (sectionElement) => {
    const content = sectionElement.querySelector('.sectionContent')
    const icon = sectionElement.querySelector('.toggleIcon')
    
    const timeline = gsap.timeline()
    
    timeline
      .to(icon, {
        rotation: -90,
        duration: 0.3,
        ease: 'power2.out'
      })
      .to(content, {
        opacity: 0,
        maxHeight: 0,
        duration: 0.3,
        ease: 'power2.out'
      }, '<')
      
    return timeline
  },
  
  // 載入狀態動畫
  showLoading: (container) => {
    return gsap.fromTo('.filter-loading', 
      { opacity: 0, scale: 0.8 },
      { opacity: 1, scale: 1, duration: 0.3, ease: 'back.out(1.7)' }
    )
  },
  
  // 無結果狀態動畫
  showNoResults: (container) => {
    return gsap.fromTo('.no-results', 
      { opacity: 0, y: 30 },
      { opacity: 1, y: 0, duration: 0.5, ease: 'power2.out' }
    )
  }
}
```

## 性能優化策略

### 前端快取策略
```javascript
// utils/filterCache.js
class FilterCache {
  constructor() {
    this.cache = new Map()
    this.maxCacheSize = 50
    this.cacheTTL = 5 * 60 * 1000 // 5分鐘
  }
  
  generateCacheKey(filters) {
    return JSON.stringify(filters)
  }
  
  get(filters) {
    const key = this.generateCacheKey(filters)
    const cached = this.cache.get(key)
    
    if (cached && Date.now() - cached.timestamp < this.cacheTTL) {
      return cached.data
    }
    
    return null
  }
  
  set(filters, data) {
    const key = this.generateCacheKey(filters)
    
    // LRU 清理策略
    if (this.cache.size >= this.maxCacheSize) {
      const firstKey = this.cache.keys().next().value
      this.cache.delete(firstKey)
    }
    
    this.cache.set(key, {
      data,
      timestamp: Date.now()
    })
  }
  
  clear() {
    this.cache.clear()
  }
}

export const filterCache = new FilterCache()
```

### 防抖處理
```javascript
// hooks/useFilterDebounce.js
import { useCallback, useRef } from 'react'
import { debounce } from 'lodash-es'

export const useFilterDebounce = (callback, delay = 300) => {
  const callbackRef = useRef(callback)
  callbackRef.current = callback
  
  return useCallback(
    debounce((...args) => {
      callbackRef.current(...args)
    }, delay),
    [delay]
  )
}
```

## API 設計

### 篩選API端點
```javascript
// api/filter.js
export const filterAPI = {
  // 獲取篩選選項
  getFilterOptions: async () => {
    const response = await fetch('/api/filters/options')
    return response.json()
  },
  
  // 篩選商品
  filterProducts: async (filters, pagination = { page: 1, limit: 20 }) => {
    const response = await fetch('/api/products/filter', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        filters: combineFilters(filters),
        pagination
      })
    })
    return response.json()
  },
  
  // 獲取篩選統計
  getFilterStats: async (filters) => {
    const response = await fetch('/api/filters/stats', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ filters })
    })
    return response.json()
  }
}
```

## 使用者體驗優化

### 篩選狀態持久化
```javascript
// utils/filterPersistence.js
export const filterPersistence = {
  // 保存篩選狀態到 URL
  saveToURL: (filters) => {
    const searchParams = new URLSearchParams()
    
    Object.entries(filters).forEach(([key, value]) => {
      if (Array.isArray(value) && value.length > 0) {
        searchParams.set(key, value.join(','))
      } else if (value && typeof value === 'object') {
        searchParams.set(key, JSON.stringify(value))
      } else if (value) {
        searchParams.set(key, value.toString())
      }
    })
    
    const newURL = `${window.location.pathname}?${searchParams.toString()}`
    window.history.replaceState({}, '', newURL)
  },
  
  // 從 URL 載入篩選狀態
  loadFromURL: () => {
    const searchParams = new URLSearchParams(window.location.search)
    const filters = {}
    
    searchParams.forEach((value, key) => {
      if (key === 'priceRange') {
        filters[key] = JSON.parse(value)
      } else if (['brands', 'categories', 'benefits', 'ingredients', 'status'].includes(key)) {
        filters[key] = value.split(',').filter(Boolean)
      } else if (key === 'rating') {
        filters[key] = parseFloat(value)
      } else {
        filters[key] = value
      }
    })
    
    return filters
  }
}
```

### 篩選建議功能
```javascript
// components/FilterSuggestions.jsx
const FilterSuggestions = () => {
  const [suggestions, setSuggestions] = useState([])
  
  useEffect(() => {
    // 根據用戶行為和熱門篩選條件生成建議
    const generateSuggestions = async () => {
      const popular = await getPopularFilters()
      const userHistory = await getUserFilterHistory()
      const seasonal = await getSeasonalSuggestions()
      
      setSuggestions([...popular, ...userHistory, ...seasonal])
    }
    
    generateSuggestions()
  }, [])
  
  return (
    <div className={styles.suggestions}>
      <h3>推薦篩選</h3>
      <div className={styles.suggestionTags}>
        {suggestions.map(suggestion => (
          <button
            key={suggestion.id}
            className={styles.suggestionTag}
            onClick={() => applySuggestion(suggestion.filters)}
          >
            {suggestion.label}
          </button>
        ))}
      </div>
    </div>
  )
}
```