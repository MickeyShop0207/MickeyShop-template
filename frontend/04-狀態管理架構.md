# ç‹€æ…‹ç®¡ç†æ¶æ§‹ (å®Œæ•´æ•´åˆç‰ˆ)

## æŠ€è¡“é¸å‹èˆ‡æ•´åˆç­–ç•¥

- **ç‹€æ…‹ç®¡ç†**: Zustand (å®¢æˆ¶ç«¯ç‹€æ…‹)
- **APIç‹€æ…‹**: React Query (TanStack Query) (æœå‹™ç«¯ç‹€æ…‹)
- **ç³»çµ±å”èª¿**: çµ±ä¸€ç‹€æ…‹å”èª¿å™¨ (è·¨ç³»çµ±åŒæ­¥)
- **æ•´åˆç¯„åœ**: ä¸»é¡Œç³»çµ±ã€å‹•ç•«ç³»çµ±ã€åœ‹éš›åŒ–ã€PWAã€éŒ¯èª¤è™•ç†ã€æ€§èƒ½ç›£æ§

## çµ±ä¸€ç‹€æ…‹å”èª¿å™¨

### æ ¸å¿ƒå”èª¿å™¨è¨­è¨ˆ
```javascript
// stores/coordinator.js - ä¸­å¤®ç‹€æ…‹å”èª¿ç³»çµ±
class StateCoordinator {
  constructor() {
    this.subscribers = new Map()
    this.eventBus = new EventTarget()
    this.syncQueue = []
    this.isInitialized = false
    this.performanceMetrics = {
      syncCount: 0,
      avgSyncTime: 0,
      errorCount: 0
    }
  }
  
  // è¨»å†Šç‹€æ…‹ç®¡ç†å™¨
  register(name, store, config = {}) {
    this.subscribers.set(name, {
      store,
      config: {
        syncOnInit: false,
        syncOnChange: [],
        dependencies: [],
        integrations: [],
        ...config
      },
      lastSync: Date.now()
    })
    
    console.log(`ğŸ“ è¨»å†Šç‹€æ…‹ç®¡ç†å™¨: ${name}`)
  }
  
  // ç™¼å¸ƒè·¨ç³»çµ±äº‹ä»¶
  publish(eventType, data, source) {
    const event = new CustomEvent(eventType, {
      detail: { data, source, timestamp: Date.now() }
    })
    
    this.eventBus.dispatchEvent(event)
    console.log(`ğŸ“¡ ç™¼å¸ƒäº‹ä»¶: ${eventType} (ä¾†æº: ${source})`)
  }
  
  // è¨‚é–±è·¨ç³»çµ±äº‹ä»¶
  subscribe(eventType, callback) {
    this.eventBus.addEventListener(eventType, callback)
  }
  
  // æ‰¹é‡ç‹€æ…‹åŒæ­¥
  async syncAll() {
    const startTime = performance.now()
    console.log('ğŸ”„ é–‹å§‹å…¨ç³»çµ±ç‹€æ…‹åŒæ­¥...')
    
    try {
      const syncPromises = Array.from(this.subscribers.entries())
        .map(([name, { store, config }]) => this.syncStore(name, store, config))
      
      const results = await Promise.allSettled(syncPromises)
      
      const successful = results.filter(r => r.status === 'fulfilled').length
      const failed = results.filter(r => r.status === 'rejected').length
      
      const duration = performance.now() - startTime
      this.updatePerformanceMetrics(duration, failed)
      
      console.log(`âœ… ç‹€æ…‹åŒæ­¥å®Œæˆ: ${successful} æˆåŠŸ, ${failed} å¤±æ•— (${duration.toFixed(2)}ms)`)
      this.publish('sync-completed', { successful, failed, duration }, 'coordinator')
      
    } catch (error) {
      console.error('âŒ ç‹€æ…‹åŒæ­¥å¤±æ•—:', error)
      this.publish('sync-error', error, 'coordinator')
    }
  }
  
  updatePerformanceMetrics(duration, errorCount) {
    this.performanceMetrics.syncCount++
    this.performanceMetrics.avgSyncTime = 
      (this.performanceMetrics.avgSyncTime + duration) / 2
    this.performanceMetrics.errorCount += errorCount
  }
}

export const stateCoordinator = new StateCoordinator()
```

## Zustand Storeæ¶æ§‹

### 1. å¢å¼·ä¸»é¡Œç‹€æ…‹ç®¡ç† (æ•´åˆè‰²å½©ç³»çµ±)
```javascript
// stores/theme.js - èˆ‡é…ç½®é©…å‹•è‰²å½©ç³»çµ±å®Œæ•´æ•´åˆ
import { themeConfig } from '@/config'
import { stateCoordinator } from './coordinator'

export const useThemeStore = create((set, get) => ({
  // åŸºæœ¬ç‹€æ…‹
  theme: themeConfig.defaultTheme,
  isTransitioning: false,
  customColors: null,
  systemTheme: 'light',
  
  // èˆ‡é…ç½®ç³»çµ±æ•´åˆçš„ä¸»é¡Œè¨­å®š
  setTheme: (theme) => {
    set({ isTransitioning: true })
    
    // æ›´æ–°é…ç½®é©…å‹•çš„ CSS è®Šæ•¸
    const variables = themeConfig.generateVariables()
    Object.entries(variables).forEach(([key, value]) => {
      document.documentElement.style.setProperty(key, value)
    })
    
    // è¨­å®š data-theme å±¬æ€§
    document.documentElement.setAttribute('data-theme', theme)
    
    // æ›´æ–°ç‹€æ…‹
    set({ theme, isTransitioning: false })
    localStorage.setItem('theme-preference', theme)
    
    // é€šçŸ¥å…¶ä»–ç³»çµ±ä¸»é¡Œè®Šæ›´
    stateCoordinator.publish('theme-changed', { 
      theme, 
      variables, 
      previousTheme: get().theme 
    }, 'theme')
    
    // é€šçŸ¥å‹•ç•«ç³»çµ±èª¿æ•´
    window.dispatchEvent(new CustomEvent('themeChanged', { detail: theme }))
    
    console.log(`ğŸ¨ ä¸»é¡Œå·²åˆ‡æ›è‡³: ${theme}`)
  },
  
  // å®¢æˆ¶å“ç‰Œè‰²å½©è¦†è“‹
  applyBrandColors: (colors) => {
    const customVariables = Object.entries(colors).reduce((acc, [key, value]) => {
      acc[`--brand-${key}`] = value
      return acc
    }, {})
    
    Object.entries(customVariables).forEach(([key, value]) => {
      document.documentElement.style.setProperty(key, value)
    })
    
    set({ customColors: colors })
    stateCoordinator.publish('brand-colors-updated', colors, 'theme')
    console.log('ğŸ¯ å“ç‰Œè‰²å½©å·²æ‡‰ç”¨')
  },
  
  // ç³»çµ±ä¸»é¡Œæª¢æ¸¬
  detectSystemTheme: () => {
    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches
    const systemTheme = isDark ? 'dark' : 'light'
    set({ systemTheme })
    return systemTheme
  },
  
  // å®Œæ•´ä¸»é¡Œç³»çµ±åˆå§‹åŒ–
  initThemeSystem: async () => {
    console.log('ğŸ¨ åˆå§‹åŒ–ä¸»é¡Œç³»çµ±...')
    
    try {
      // æª¢æ¸¬ç³»çµ±ä¸»é¡Œ
      const systemTheme = get().detectSystemTheme()
      
      // è¼‰å…¥ä¿å­˜çš„åå¥½æˆ–ä½¿ç”¨ç³»çµ±ä¸»é¡Œ
      const savedTheme = localStorage.getItem('theme-preference') || systemTheme
      
      // åˆå§‹åŒ–é…ç½®é©…å‹•çš„ä¸»é¡Œè®Šæ•¸
      await import('@/utils/themeInitializer').then(({ initializeTheme }) => {
        initializeTheme()
      })
      
      // è¨­å®šä¸»é¡Œ
      get().setTheme(savedTheme)
      
      // ç›£è½ç³»çµ±ä¸»é¡Œè®ŠåŒ–
      window.matchMedia('(prefers-color-scheme: dark)')
        .addEventListener('change', (e) => {
          const newSystemTheme = e.matches ? 'dark' : 'light'
          set({ systemTheme: newSystemTheme })
          
          // å¦‚æœç”¨æˆ¶æ²’æœ‰æ‰‹å‹•è¨­å®šåå¥½ï¼Œè·Ÿéš¨ç³»çµ±
          if (!localStorage.getItem('theme-preference')) {
            get().setTheme(newSystemTheme)
          }
          
          stateCoordinator.publish('system-theme-changed', { systemTheme: newSystemTheme }, 'theme')
        })
      
      console.log('âœ… ä¸»é¡Œç³»çµ±åˆå§‹åŒ–å®Œæˆ')
      
    } catch (error) {
      console.error('âŒ ä¸»é¡Œç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error)
      // ä½¿ç”¨é è¨­ä¸»é¡Œä½œç‚ºå‚™ç”¨
      get().setTheme('light')
    }
  }
}))

// è¨»å†Šåˆ°å”èª¿å™¨
stateCoordinator.register('theme', useThemeStore, {
  syncOnInit: true,
  integrations: ['animation', 'pwa']
})
```

### 2. å¢å¼·åœ‹éš›åŒ–ç‹€æ…‹ç®¡ç† (æ•´åˆ react-i18next)
```javascript
// stores/i18n.js - èˆ‡ react-i18next å®Œæ•´æ•´åˆ
import i18n from '@/i18n'
import { stateCoordinator } from './coordinator'
import { queryClient } from '@/config/query-client'

export const useI18nStore = create((set, get) => ({
  // åŸºæœ¬ç‹€æ…‹
  locale: 'zh-TW',
  currency: 'TWD',
  region: 'TW',
  isLoading: false,
  loadedNamespaces: new Set(['common']),
  
  // å€åŸŸæ˜ å°„é…ç½®
  regionMapping: {
    'TW': { locale: 'zh-TW', currency: 'TWD' },
    'HK': { locale: 'zh-HK', currency: 'HKD' },
    'CN': { locale: 'zh-CN', currency: 'CNY' },
    'US': { locale: 'en-US', currency: 'USD' },
    'GB': { locale: 'en-GB', currency: 'GBP' },
    'JP': { locale: 'ja-JP', currency: 'JPY' },
    'KR': { locale: 'ko-KR', currency: 'KRW' }
  },
  
  // èˆ‡ react-i18next æ•´åˆçš„èªè¨€åˆ‡æ›
  setLocale: async (locale) => {
    set({ isLoading: true })
    console.log(`ğŸŒ åˆ‡æ›èªè¨€è‡³: ${locale}`)
    
    try {
      // æ›´æ–° i18next
      await i18n.changeLanguage(locale)
      
      // æ›´æ–° HTML lang å±¬æ€§
      document.documentElement.lang = locale
      
      // æ›´æ–°è·¯ç”± (å¦‚æœéœ€è¦)
      const currentPath = window.location.pathname
      const newPath = currentPath.replace(/^\/[a-z]{2}(-[A-Z]{2})?/, `/${locale}`)
      if (newPath !== currentPath && newPath !== `/${locale}`) {
        window.history.replaceState({}, '', newPath)
      }
      
      // æ›´æ–°ç‹€æ…‹
      const previousLocale = get().locale
      set({ locale, isLoading: false })
      localStorage.setItem('locale-preference', locale)
      
      // é€šçŸ¥å…¶ä»–ç³»çµ±èªè¨€è®Šæ›´
      stateCoordinator.publish('locale-changed', { 
        locale, 
        previousLocale 
      }, 'i18n')
      
      // é‡æ–°è¼‰å…¥ä¾è³´æœ¬åœ°åŒ–çš„è³‡æ–™
      queryClient.invalidateQueries({ 
        predicate: (query) => {
          return query.queryKey.some(key => 
            typeof key === 'string' && key.includes('locale-dependent')
          ) || query.queryKey.includes(previousLocale)
        }
      })
      
      console.log(`âœ… èªè¨€åˆ‡æ›å®Œæˆ: ${previousLocale} â†’ ${locale}`)
      
    } catch (error) {
      console.error('âŒ èªè¨€åˆ‡æ›å¤±æ•—:', error)
      set({ isLoading: false })
      throw error
    }
  },
  
  // æŒ‰éœ€è¼‰å…¥ç¿»è­¯å‘½åç©ºé–“
  loadNamespace: async (namespace) => {
    const { loadedNamespaces } = get()
    
    if (!loadedNamespaces.has(namespace)) {
      try {
        console.log(`ğŸ“š è¼‰å…¥ç¿»è­¯å‘½åç©ºé–“: ${namespace}`)
        await i18n.loadNamespaces(namespace)
        
        const updated = new Set([...loadedNamespaces, namespace])
        set({ loadedNamespaces: updated })
        
        stateCoordinator.publish('namespace-loaded', { namespace }, 'i18n')
        console.log(`âœ… å‘½åç©ºé–“è¼‰å…¥å®Œæˆ: ${namespace}`)
        
      } catch (error) {
        console.error(`âŒ è¼‰å…¥ç¿»è­¯å‘½åç©ºé–“å¤±æ•—: ${namespace}`, error)
        throw error
      }
    }
  },
  
  // è²¨å¹£è¨­å®š
  setCurrency: (currency) => {
    const previousCurrency = get().currency
    set({ currency })
    localStorage.setItem('currency-preference', currency)
    
    stateCoordinator.publish('currency-changed', { 
      currency, 
      previousCurrency 
    }, 'i18n')
    
    console.log(`ğŸ’° è²¨å¹£å·²åˆ‡æ›: ${previousCurrency} â†’ ${currency}`)
  },
  
  // å€åŸŸè¨­å®š (åŒæ™‚æ›´æ–°èªè¨€å’Œè²¨å¹£)
  setRegion: async (region) => {
    const mapping = get().regionMapping[region]
    if (!mapping) {
      console.warn(`âš ï¸ æœªçŸ¥å€åŸŸä»£ç¢¼: ${region}`)
      return
    }
    
    const previousRegion = get().region
    console.log(`ğŸ—ºï¸ åˆ‡æ›å€åŸŸ: ${previousRegion} â†’ ${region}`)
    
    try {
      // åŒæ™‚æ›´æ–°èªè¨€å’Œè²¨å¹£
      await get().setLocale(mapping.locale)
      get().setCurrency(mapping.currency)
      
      set({ region })
      localStorage.setItem('region-preference', region)
      
      stateCoordinator.publish('region-changed', { 
        region, 
        previousRegion, 
        locale: mapping.locale, 
        currency: mapping.currency 
      }, 'i18n')
      
      console.log(`âœ… å€åŸŸåˆ‡æ›å®Œæˆ: ${region}`)
      
    } catch (error) {
      console.error('âŒ å€åŸŸåˆ‡æ›å¤±æ•—:', error)
      throw error
    }
  },
  
  // åˆå§‹åŒ–åœ‹éš›åŒ–ç³»çµ±
  initI18nSystem: async () => {
    console.log('ğŸŒ åˆå§‹åŒ–åœ‹éš›åŒ–ç³»çµ±...')
    
    try {
      // æª¢æŸ¥ä¿å­˜çš„åå¥½è¨­å®š
      const savedLocale = localStorage.getItem('locale-preference')
      const savedCurrency = localStorage.getItem('currency-preference') 
      const savedRegion = localStorage.getItem('region-preference')
      
      if (savedLocale && savedCurrency && savedRegion) {
        // ä½¿ç”¨ä¿å­˜çš„è¨­å®š
        await get().setLocale(savedLocale)
        get().setCurrency(savedCurrency)
        set({ region: savedRegion })
        
      } else {
        // ä½¿ç”¨åœ°ç†æª¢æ¸¬ (Cloudflare)
        const detectedRegion = await detectUserRegion() // å¯¦ç¾åœ°ç†æª¢æ¸¬
        await get().setRegion(detectedRegion)
      }
      
      // é è¼‰å…¥å¸¸ç”¨å‘½åç©ºé–“
      const commonNamespaces = ['common', 'products', 'cart', 'auth', 'errors']
      await Promise.all(
        commonNamespaces.map(ns => get().loadNamespace(ns))
      )
      
      console.log('âœ… åœ‹éš›åŒ–ç³»çµ±åˆå§‹åŒ–å®Œæˆ')
      
    } catch (error) {
      console.error('âŒ åœ‹éš›åŒ–ç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error)
      // ä½¿ç”¨é è¨­è¨­å®šä½œç‚ºå‚™ç”¨
      await get().setLocale('zh-TW')
      get().setCurrency('TWD')
      set({ region: 'TW' })
    }
  }
}))

// åœ°ç†æª¢æ¸¬å‡½æ•¸ (ä½¿ç”¨ Cloudflare)
async function detectUserRegion() {
  try {
    const response = await fetch('/api/detect-region')
    const data = await response.json()
    return data.region || 'TW'
  } catch (error) {
    console.warn('âš ï¸ åœ°ç†æª¢æ¸¬å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€åŸŸ')
    return 'TW'
  }
}

// è¨»å†Šåˆ°å”èª¿å™¨
stateCoordinator.register('i18n', useI18nStore, {
  syncOnInit: true,
  dependencies: ['theme', 'auth'],
  integrations: ['cart', 'products']
})
```

### 3. è³¼ç‰©è»Šç‹€æ…‹ç®¡ç†
```js
// stores/cart.js
export const useCartStore = create((set, get) => ({
  items: [],
  isOpen: false,
  
  addItem: (product, quantity = 1) => {
    const { items } = get()
    const existingItem = items.find(item => item.id === product.id)
    
    if (existingItem) {
      set({
        items: items.map(item =>
          item.id === product.id 
            ? { ...item, quantity: item.quantity + quantity }
            : item
        )
      })
    } else {
      set({ items: [...items, { ...product, quantity }] })
    }
  },
  
  removeItem: (productId) => {
    set({ items: get().items.filter(item => item.id !== productId) })
  },
  
  updateQuantity: (productId, quantity) => {
    if (quantity <= 0) {
      get().removeItem(productId)
      return
    }
    
    set({
      items: get().items.map(item =>
        item.id === productId ? { ...item, quantity } : item
      )
    })
  },
  
  clearCart: () => set({ items: [] }),
  
  toggleCart: () => set({ isOpen: !get().isOpen }),
  
  // è¨ˆç®—å±¬æ€§
  getTotalItems: () => get().items.reduce((sum, item) => sum + item.quantity, 0),
  getTotalPrice: () => get().items.reduce((sum, item) => sum + (item.price * item.quantity), 0)
}))
```

### 4. ç”¨æˆ¶ç‹€æ…‹ç®¡ç†
```js
// stores/auth.js
export const useAuthStore = create((set, get) => ({
  user: null,
  isAuthenticated: false,
  isLoading: false,
  
  login: async (credentials) => {
    set({ isLoading: true })
    try {
      const user = await authAPI.login(credentials)
      set({ user, isAuthenticated: true, isLoading: false })
      localStorage.setItem('auth-token', user.token)
    } catch (error) {
      set({ isLoading: false })
      throw error
    }
  },
  
  logout: () => {
    set({ user: null, isAuthenticated: false })
    localStorage.removeItem('auth-token')
  },
  
  initAuth: async () => {
    const token = localStorage.getItem('auth-token')
    if (token) {
      try {
        const user = await authAPI.verifyToken(token)
        set({ user, isAuthenticated: true })
      } catch {
        localStorage.removeItem('auth-token')
      }
    }
  }
}))
```

### 5. ç¯€æ…¶ç®¡ç†ç‹€æ…‹
```js
// stores/festival.js - ç¯€æ…¶æ´»å‹•ç‹€æ…‹ç®¡ç†
export const useFestivalStore = create((set, get) => ({
  // åŸºæœ¬ç‹€æ…‹
  activeFestivals: [],
  currentTheme: null,
  priceCache: new Map(),
  banners: {},
  
  // å‹•ç•«ç‹€æ…‹
  currentAnimation: null,
  backgroundConfig: null,
  
  // è¼‰å…¥ç‹€æ…‹
  isLoading: false,
  lastUpdated: null,
  
  // è¼‰å…¥æ´»èºç¯€æ…¶
  loadActiveFestivals: async () => {
    set({ isLoading: true })
    try {
      const festivals = await festivalAPI.getActiveFestivals()
      set({ 
        activeFestivals: festivals,
        lastUpdated: Date.now(),
        isLoading: false
      })
      
      // é€šçŸ¥å…¶ä»–ç³»çµ±ç¯€æ…¶è³‡æ–™å·²æ›´æ–°
      stateCoordinator.publish('festivals-loaded', { count: festivals.length }, 'festival')
      
    } catch (error) {
      set({ isLoading: false })
      console.error('è¼‰å…¥ç¯€æ…¶æ´»å‹•å¤±æ•—:', error)
      throw error
    }
  },
  
  // å¥—ç”¨ç¯€æ…¶ä¸»é¡Œ
  applyFestivalTheme: async (festivalId) => {
    try {
      const themeConfig = await festivalAPI.getFestivalTheme(festivalId, new Date())
      
      // æ›´æ–° CSS è®Šæ•¸
      Object.entries(themeConfig.colors).forEach(([key, value]) => {
        document.documentElement.style.setProperty(`--festival-${key}`, value)
      })
      
      set({ currentTheme: themeConfig })
      stateCoordinator.publish('festival-theme-applied', { festivalId, themeConfig }, 'festival')
      
      console.log(`ğŸª ç¯€æ…¶ä¸»é¡Œå·²å¥—ç”¨: ${festivalId}`)
      
    } catch (error) {
      console.error('å¥—ç”¨ç¯€æ…¶ä¸»é¡Œå¤±æ•—:', error)
      throw error
    }
  },
  
  // é‡ç½®ä¸»é¡Œ
  resetTheme: () => {
    // æ¸…é™¤ç¯€æ…¶ CSS è®Šæ•¸
    const festivalVars = Array.from(document.documentElement.style)
      .filter(prop => prop.startsWith('--festival-'))
    
    festivalVars.forEach(prop => {
      document.documentElement.style.removeProperty(prop)
    })
    
    set({ currentTheme: null, backgroundConfig: null })
    stateCoordinator.publish('festival-theme-reset', {}, 'festival')
  },
  
  // è¨ˆç®—ç¯€æ…¶åƒ¹æ ¼
  calculatePrice: async (productId, quantity) => {
    const cacheKey = `${productId}-${quantity}`
    
    // æª¢æŸ¥å¿«å–
    if (get().priceCache.has(cacheKey)) {
      return get().priceCache.get(cacheKey)
    }
    
    try {
      const { user } = useAuthStore.getState()
      const priceBreakdown = await festivalAPI.calculatePrice({
        productId,
        quantity,
        userId: user?.id
      })
      
      // æ›´æ–°å¿«å–
      const updatedCache = new Map(get().priceCache)
      updatedCache.set(cacheKey, priceBreakdown)
      set({ priceCache: updatedCache })
      
      return priceBreakdown
      
    } catch (error) {
      console.error('è¨ˆç®—ç¯€æ…¶åƒ¹æ ¼å¤±æ•—:', error)
      throw error
    }
  },
  
  // æ¸…é™¤åƒ¹æ ¼å¿«å–
  clearPriceCache: () => {
    set({ priceCache: new Map() })
  },
  
  // æ’­æ”¾ç¯€æ…¶å‹•ç•«
  playAnimation: (type, config) => {
    if (window.animationManager) {
      window.animationManager.playFestivalAnimation(type, config)
      set({ currentAnimation: type, backgroundConfig: config })
      
      console.log(`ğŸ­ æ’­æ”¾ç¯€æ…¶å‹•ç•«: ${type}`)
    }
  },
  
  // åœæ­¢å‹•ç•«
  stopAnimation: () => {
    if (window.animationManager) {
      window.animationManager.stopAllAnimations()
      set({ currentAnimation: null, backgroundConfig: null })
    }
  },
  
  // è¼‰å…¥æ©«å¹…
  loadBanners: async (position) => {
    try {
      const banners = await festivalAPI.getBanners(position)
      set(state => ({
        banners: {
          ...state.banners,
          [position]: banners
        }
      }))
      
      stateCoordinator.publish('banners-loaded', { position, count: banners.length }, 'festival')
      
    } catch (error) {
      console.error(`è¼‰å…¥æ©«å¹…å¤±æ•— (${position}):`, error)
    }
  },
  
  // ç²å–ç•¶å‰é©ç”¨çš„æŠ˜æ‰£
  getApplicableDiscounts: async (productId) => {
    const { activeFestivals } = get()
    const applicableDiscounts = []
    
    for (const festival of activeFestivals) {
      try {
        const validation = await festivalAPI.validateDiscountConditions({
          productId,
          festivalId: festival.id,
          userId: useAuthStore.getState().user?.id
        })
        
        if (validation.isValid) {
          applicableDiscounts.push({
            festivalId: festival.id,
            festivalName: festival.name,
            discountRules: festival.discountRules
          })
        }
      } catch (error) {
        console.error(`é©—è­‰æŠ˜æ‰£æ¢ä»¶å¤±æ•— (${festival.name}):`, error)
      }
    }
    
    return applicableDiscounts
  }
}))

// è¨»å†Šåˆ°å”èª¿å™¨
stateCoordinator.register('festival', useFestivalStore, {
  syncOnInit: true,
  dependencies: ['auth'],
  integrations: ['theme', 'animation', 'cart']
})
```

## React Queryé…ç½®

### 1. Query Clientè¨­å®š
```js
// config/query-client.js
import { QueryClient } from '@tanstack/react-query'

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5åˆ†é˜
      cacheTime: 10 * 60 * 1000, // 10åˆ†é˜
      retry: (failureCount, error) => {
        if (error.status === 404) return false
        return failureCount < 3
      }
    },
    mutations: {
      retry: false
    }
  }
})
```

### 2. API Hookç¯„ä¾‹
```js
// hooks/useProducts.js
export const useProducts = (params) => {
  const { locale, currency } = useI18nStore()
  
  return useQuery({
    queryKey: ['products', params, locale, currency],
    queryFn: () => productAPI.getProducts({ 
      ...params, 
      locale, 
      currency 
    }),
    enabled: !!locale && !!currency
  })
}

export const useProduct = (id) => {
  const { locale, currency } = useI18nStore()
  
  return useQuery({
    queryKey: ['product', id, locale, currency],
    queryFn: () => productAPI.getProduct(id, { locale, currency }),
    enabled: !!id
  })
}
```

### 3. Mutation Hookç¯„ä¾‹
```js
// hooks/useCart.js
export const useAddToCart = () => {
  const queryClient = useQueryClient()
  const addItem = useCartStore(state => state.addItem)
  
  return useMutation({
    mutationFn: ({ productId, quantity }) => 
      cartAPI.addToCart(productId, quantity),
    onSuccess: (data, variables) => {
      // æ¨‚è§€æ›´æ–°æœ¬åœ°ç‹€æ…‹
      addItem(variables.product, variables.quantity)
      
      // ä½¿ç›¸é—œæŸ¥è©¢å¤±æ•ˆ
      queryClient.invalidateQueries(['cart'])
      queryClient.invalidateQueries(['user-profile'])
    },
    onError: (error, variables) => {
      // éŒ¯èª¤è™•ç†å’Œå›æ»¾
      console.error('æ·»åŠ åˆ°è³¼ç‰©è»Šå¤±æ•—:', error)
    }
  })
}
```

## PWAé›¢ç·šç‹€æ…‹ç®¡ç†

### 1. ç¶²çµ¡ç‹€æ…‹æª¢æ¸¬
```js
// stores/network.js
export const useNetworkStore = create((set) => ({
  isOnline: navigator.onLine,
  isOfflineMode: false,
  
  setOnline: (status) => set({ isOnline: status }),
  
  toggleOfflineMode: () => set(state => ({ 
    isOfflineMode: !state.isOfflineMode 
  })),
  
  init: () => {
    window.addEventListener('online', () => set({ isOnline: true }))
    window.addEventListener('offline', () => set({ isOnline: false }))
  }
}))
```

### 2. é›¢ç·šè³¼ç‰©è»ŠåŒæ­¥
```js
// stores/offline-cart.js
export const useOfflineCartStore = create((set, get) => ({
  pendingActions: [],
  
  addPendingAction: (action) => {
    const { pendingActions } = get()
    const updated = [...pendingActions, { 
      ...action, 
      timestamp: Date.now(),
      id: crypto.randomUUID()
    }]
    set({ pendingActions: updated })
    localStorage.setItem('pending-cart-actions', JSON.stringify(updated))
  },
  
  syncPendingActions: async () => {
    const { pendingActions } = get()
    const synced = []
    
    for (const action of pendingActions) {
      try {
        await cartAPI.syncAction(action)
        synced.push(action.id)
      } catch (error) {
        console.error('åŒæ­¥å¤±æ•—:', error)
      }
    }
    
    const remaining = pendingActions.filter(
      action => !synced.includes(action.id)
    )
    set({ pendingActions: remaining })
    localStorage.setItem('pending-cart-actions', JSON.stringify(remaining))
  }
}))
```

## ç‹€æ…‹æŒä¹…åŒ–

### 1. è‡ªå‹•æŒä¹…åŒ–é…ç½®
```js
// utils/persistence.js
import { subscribeWithSelector } from 'zustand/middleware'

export const createPersistedStore = (config, options = {}) => {
  const { key, storage = localStorage } = options
  
  return create(
    subscribeWithSelector((set, get, api) => {
      const store = config(set, get, api)
      
      // è¼‰å…¥æŒä¹…åŒ–æ•¸æ“š
      try {
        const saved = storage.getItem(key)
        if (saved) {
          const parsed = JSON.parse(saved)
          set(parsed)
        }
      } catch (error) {
        console.error('è¼‰å…¥æŒä¹…åŒ–ç‹€æ…‹å¤±æ•—:', error)
      }
      
      // è¨‚é–±ç‹€æ…‹è®ŠåŒ–ä¸¦è‡ªå‹•ä¿å­˜
      api.subscribe((state) => {
        try {
          storage.setItem(key, JSON.stringify(state))
        } catch (error) {
          console.error('ä¿å­˜ç‹€æ…‹å¤±æ•—:', error)
        }
      })
      
      return store
    })
  )
}
```

## DevToolsæ•´åˆ

### 1. é–‹ç™¼ç’°å¢ƒåµéŒ¯
```js
// stores/index.js
const isDev = process.env.NODE_ENV === 'development'

export const useCartStore = create(
  isDev 
    ? devtools(cartStore, { name: 'cart-store' })
    : cartStore
)
```

## æ€§èƒ½å„ªåŒ–

### 1. é¸æ“‡å™¨å„ªåŒ–
```js
// é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
const cartCount = useCartStore(state => state.getTotalItems())

// ä½¿ç”¨æ·ºæ¯”è¼ƒé¸æ“‡å™¨
const cartItems = useCartStore(
  state => state.items,
  shallow
)
```

### 2. React Queryå„ªåŒ–
```js
// é è¼‰å…¥é—œéµæ•¸æ“š
export const prefetchProducts = () => {
  queryClient.prefetchQuery({
    queryKey: ['products', { featured: true }],
    queryFn: () => productAPI.getFeaturedProducts()
  })
}
```

## æ–°å¢æ•´åˆç³»çµ±

### å‹•ç•«ç‹€æ…‹æ•´åˆ
```javascript
// stores/animation.js - èˆ‡ AnimationManager å”ä½œ
export const useAnimationStore = create((set, get) => ({
  // å‹•ç•«ç‹€æ…‹
  loadedAnimations: new Set(),
  userInteracted: false,
  animationsPaused: false,
  performanceMode: 'normal', // normal, reduced, disabled
  
  // èˆ‡ AnimationManager åŒæ­¥
  syncWithAnimationManager: () => {
    if (window.animationManager) {
      const status = window.animationManager.getLoadingStatus()
      set({
        loadedAnimations: new Set(status.loadedAnimations),
        userInteracted: status.userInteracted
      })
    }
  },
  
  // å‹•ç•«è¼‰å…¥é€šçŸ¥
  setAnimationLoaded: (name) => {
    const { loadedAnimations } = get()
    const updated = new Set([...loadedAnimations, name])
    set({ loadedAnimations: updated })
    
    stateCoordinator.publish('animation-loaded', { name, total: updated.size }, 'animation')
  },
  
  // æ€§èƒ½æ¨¡å¼èª¿æ•´
  setPerformanceMode: (mode) => {
    set({ performanceMode: mode })
    
    if (window.animationManager) {
      window.animationManager.setPerformanceMode?.(mode)
    }
    
    stateCoordinator.publish('performance-mode-changed', mode, 'animation')
    console.log(`ğŸ­ å‹•ç•«æ€§èƒ½æ¨¡å¼: ${mode}`)
  },
  
  // ç›£è½å‹•ç•«äº‹ä»¶
  initAnimationListeners: () => {
    // ç›£è½ AnimationManager äº‹ä»¶
    window.addEventListener('animationManagerInteracted', () => {
      set({ userInteracted: true })
    })
    
    // ç›£è½æ¸›å°‘å‹•ç•«åå¥½
    window.matchMedia('(prefers-reduced-motion: reduce)')
      .addEventListener('change', (e) => {
        if (e.matches) {
          get().setPerformanceMode('reduced')
        }
      })
  }
}))

stateCoordinator.register('animation', useAnimationStore, {
  syncOnInit: true,
  integrations: ['theme', 'pwa']
})
```

### PWA é›¢ç·šç‹€æ…‹æ•´åˆ
```javascript
// stores/pwa.js - å®Œæ•´ PWA åŠŸèƒ½æ•´åˆ
export const usePWAStore = create((set, get) => ({
  // ç¶²è·¯ç‹€æ…‹
  isOnline: navigator.onLine,
  connectionType: 'unknown',
  isLowDataMode: false,
  
  // é›¢ç·šåŠŸèƒ½
  offlineMode: false,
  syncQueue: [],
  lastSync: null,
  
  // Service Worker ç‹€æ…‹
  swStatus: 'unknown',
  updateAvailable: false,
  
  // å¿«å–ç‹€æ…‹
  cachedPages: new Set(),
  cacheSize: 0,
  
  // ç¶²è·¯ç‹€æ…‹æ›´æ–°
  updateConnectionStatus: (status) => {
    const previousStatus = get().isOnline
    set({ isOnline: status })
    
    console.log(`ğŸ“¶ ç¶²è·¯ç‹€æ…‹: ${previousStatus ? 'ç·šä¸Š' : 'é›¢ç·š'} â†’ ${status ? 'ç·šä¸Š' : 'é›¢ç·š'}`)
    
    if (status && !previousStatus) {
      // é‡æ–°é€£ç·šï¼Œé–‹å§‹åŒæ­¥
      get().syncOfflineActions()
      stateCoordinator.publish('connection-restored', {}, 'pwa')
    } else if (!status && previousStatus) {
      // æ–·ç·šï¼Œå•Ÿå‹•é›¢ç·šæ¨¡å¼
      stateCoordinator.publish('offline-mode-activated', {}, 'pwa')
    }
  },
  
  // é›¢ç·šå‹•ä½œåŒæ­¥
  syncOfflineActions: async () => {
    const { syncQueue } = get()
    if (syncQueue.length === 0) return
    
    console.log(`ğŸ”„ åŒæ­¥é›¢ç·šå‹•ä½œ: ${syncQueue.length} é …`)
    
    const successful = []
    const failed = []
    
    for (const action of syncQueue) {
      try {
        await syncOfflineAction(action)
        successful.push(action.id)
      } catch (error) {
        failed.push({ action, error })
      }
    }
    
    const remaining = syncQueue.filter(
      action => !successful.includes(action.id)
    )
    
    set({ 
      syncQueue: remaining,
      lastSync: Date.now()
    })
    
    stateCoordinator.publish('offline-sync-completed', {
      successful: successful.length,
      failed: failed.length,
      remaining: remaining.length
    }, 'pwa')
    
    console.log(`âœ… é›¢ç·šåŒæ­¥å®Œæˆ: ${successful.length} æˆåŠŸ, ${failed.length} å¤±æ•—`)
  },
  
  // Service Worker åˆå§‹åŒ–
  initServiceWorker: async () => {
    if ('serviceWorker' in navigator) {
      try {
        const registration = await navigator.serviceWorker.register('/sw.js')
        
        registration.addEventListener('updatefound', () => {
          set({ swStatus: 'installing' })
          console.log('ğŸ”„ Service Worker æ›´æ–°ä¸­...')
        })
        
        navigator.serviceWorker.addEventListener('message', (event) => {
          if (event.data.type === 'UPDATE_AVAILABLE') {
            set({ updateAvailable: true })
            stateCoordinator.publish('app-update-available', {}, 'pwa')
            console.log('ğŸ†• æ‡‰ç”¨ç¨‹å¼æ›´æ–°å¯ç”¨')
          }
        })
        
        set({ swStatus: 'activated' })
        console.log('âœ… Service Worker å•Ÿå‹•å®Œæˆ')
        
      } catch (error) {
        console.error('âŒ Service Worker è¨»å†Šå¤±æ•—:', error)
      }
    }
  },
  
  // ä½æµé‡æ¨¡å¼
  setLowDataMode: (enabled) => {
    set({ isLowDataMode: enabled })
    
    stateCoordinator.publish('low-data-mode-changed', { enabled }, 'pwa')
    
    // èª¿æ•´å…¶ä»–ç³»çµ±
    if (enabled) {
      useAnimationStore.getState().setPerformanceMode('reduced')
    }
    
    console.log(`ğŸ“± ä½æµé‡æ¨¡å¼: ${enabled ? 'å•Ÿç”¨' : 'åœç”¨'}`)
  }
}))

// é›¢ç·šå‹•ä½œåŒæ­¥å‡½æ•¸
async function syncOfflineAction(action) {
  // æ ¹æ“šå‹•ä½œé¡å‹é€²è¡ŒåŒæ­¥
  switch (action.type) {
    case 'cart-add':
      return await cartAPI.addToCart(action.productId, action.quantity)
    case 'cart-remove':
      return await cartAPI.removeFromCart(action.productId)
    case 'wishlist-add':
      return await wishlistAPI.add(action.productId)
    default:
      throw new Error(`æœªçŸ¥é›¢ç·šå‹•ä½œé¡å‹: ${action.type}`)
  }
}

stateCoordinator.register('pwa', usePWAStore, {
  syncOnInit: true,
  integrations: ['animation', 'cart', 'theme']
})
```

### éŒ¯èª¤è™•ç†ç³»çµ±æ•´åˆ
```javascript
// å¼•ç”¨çµ±ä¸€éŒ¯èª¤è™•ç†ç³»çµ±
import { useErrorHandler } from '@/stores/error-handler'

// åœ¨ç‹€æ…‹å”èª¿å™¨ä¸­è¨»å†ŠéŒ¯èª¤è™•ç†
stateCoordinator.register('error', useErrorHandler)

// æ³¨æ„ï¼šçµ±ä¸€éŒ¯èª¤è™•ç†å¯¦ç¾è©³è¦‹ 15-çµ±ä¸€éŒ¯èª¤è™•ç†ç³»çµ±.md
```

### çµ±ä¸€åˆå§‹åŒ–ç³»çµ±
```javascript
// stores/init.js - å®Œæ•´ç³»çµ±åˆå§‹åŒ–
export const initializeStateManagement = async () => {
  console.log('ğŸš€ å•Ÿå‹•ç‹€æ…‹ç®¡ç†ç³»çµ±åˆå§‹åŒ–...')
  
  try {
    // åˆå§‹åŒ–å”èª¿å™¨
    stateCoordinator.publish('init-started', { timestamp: Date.now() }, 'system')
    
    // æŒ‰ä¾è³´é †åºåˆå§‹åŒ–å„ç³»çµ±
    const initSequence = [
      // ç¬¬ä¸€éšæ®µï¼šåŸºç¤ç³»çµ±
      {
        name: 'åŸºç¤ç³»çµ±',
        tasks: async () => {
          await useThemeStore.getState().initThemeSystem()
          await usePWAStore.getState().initServiceWorker()
          useErrorHandler.getState() // ç¢ºä¿éŒ¯èª¤è™•ç†å·²å•Ÿå‹•
        }
      },
      
      // ç¬¬äºŒéšæ®µï¼šå…§å®¹èˆ‡å‹•ç•«ç³»çµ±
      {
        name: 'å…§å®¹èˆ‡å‹•ç•«ç³»çµ±', 
        tasks: async () => {
          await useI18nStore.getState().initI18nSystem()
          useAnimationStore.getState().initAnimationListeners()
          
          // ç­‰å¾…å‹•ç•«ç®¡ç†å™¨åˆå§‹åŒ–
          if (window.animationManager) {
            useAnimationStore.getState().syncWithAnimationManager()
          }
        }
      },
      
      // ç¬¬ä¸‰éšæ®µï¼šç”¨æˆ¶ç›¸é—œç³»çµ±
      {
        name: 'ç”¨æˆ¶ç›¸é—œç³»çµ±',
        tasks: async () => {
          await useAuthStore.getState().initAuth()
          // åˆå§‹åŒ–å…¶ä»–ç”¨æˆ¶ç›¸é—œåŠŸèƒ½
        }
      },
      
      // ç¬¬å››éšæ®µï¼šç›£æ§èˆ‡å„ªåŒ–
      {
        name: 'ç›£æ§èˆ‡å„ªåŒ–',
        tasks: async () => {
          // è¨­å®šç¶²è·¯ç›£è½
          window.addEventListener('online', () => {
            usePWAStore.getState().updateConnectionStatus(true)
          })
          window.addEventListener('offline', () => {
            usePWAStore.getState().updateConnectionStatus(false)
          })
          
          // æ€§èƒ½ç›£æ§
          if (process.env.NODE_ENV === 'development') {
            setInterval(() => {
              console.log('ğŸ“Š ç‹€æ…‹ç®¡ç†æ€§èƒ½:', stateCoordinator.performanceMetrics)
            }, 30000)
          }
        }
      }
    ]
    
    // ä¾åºåŸ·è¡Œåˆå§‹åŒ–éšæ®µ
    for (const [index, { name, tasks }] of initSequence.entries()) {
      console.log(`ğŸ“ åŸ·è¡Œç¬¬ ${index + 1} éšæ®µ: ${name}`)
      await tasks()
    }
    
    // è¨­å®šè·¨ç³»çµ±äº‹ä»¶ç›£è½
    setupCrossSystemIntegration()
    
    // åŸ·è¡Œé¦–æ¬¡å…¨ç³»çµ±åŒæ­¥
    await stateCoordinator.syncAll()
    
    console.log('ğŸ‰ ç‹€æ…‹ç®¡ç†ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼')
    stateCoordinator.publish('init-completed', { 
      timestamp: Date.now(),
      systems: stateCoordinator.subscribers.size 
    }, 'system')
    
  } catch (error) {
    console.error('ğŸ’¥ ç‹€æ…‹ç®¡ç†ç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error)
    useErrorHandler.getState().handleError(error, { type: 'init-failure' })
    throw error
  }
}

// è·¨ç³»çµ±æ•´åˆé‚è¼¯
function setupCrossSystemIntegration() {
  console.log('ğŸ”— è¨­å®šè·¨ç³»çµ±æ•´åˆ...')
  
  // ä¸»é¡Œè®Šæ›´æ•´åˆ
  stateCoordinator.subscribe('theme-changed', (event) => {
    const { theme } = event.detail.data
    console.log(`ğŸ¨ ä¸»é¡Œè®Šæ›´é€šçŸ¥: ${theme}`)
    // å¯ä»¥åœ¨é€™è£¡æ·»åŠ å…¶ä»–ç³»çµ±çš„ä¸»é¡ŒéŸ¿æ‡‰é‚è¼¯
  })
  
  // èªè¨€è®Šæ›´æ•´åˆ
  stateCoordinator.subscribe('locale-changed', (event) => {
    const { locale, previousLocale } = event.detail.data
    console.log(`ğŸŒ èªè¨€è®Šæ›´é€šçŸ¥: ${previousLocale} â†’ ${locale}`)
    // æ›´æ–°é é¢ meta è³‡è¨Š
    document.documentElement.lang = locale
  })
  
  // é›¢ç·šæ¨¡å¼æ•´åˆ
  stateCoordinator.subscribe('offline-mode-activated', () => {
    console.log('ğŸ“± é€²å…¥é›¢ç·šæ¨¡å¼')
    // èª¿æ•´å‹•ç•«æ€§èƒ½ä»¥ç¯€çœè³‡æº
    useAnimationStore.getState().setPerformanceMode('reduced')
  })
  
  // é€£ç·šæ¢å¾©æ•´åˆ
  stateCoordinator.subscribe('connection-restored', () => {
    console.log('ğŸŒ ç¶²è·¯é€£ç·šå·²æ¢å¾©')
    // æ¢å¾©æ­£å¸¸å‹•ç•«æ€§èƒ½
    useAnimationStore.getState().setPerformanceMode('normal')
  })
  
  // åš´é‡éŒ¯èª¤æ•´åˆ
  stateCoordinator.subscribe('critical-error', (event) => {
    const error = event.detail.data
    console.log('ğŸš¨ åš´é‡éŒ¯èª¤è™•ç†ä¸­:', error)
    // æš«åœæ‰€æœ‰éå¿…è¦å‹•ç•«
    useAnimationStore.getState().setPerformanceMode('disabled')
  })
}
```

## ä½¿ç”¨æŒ‡å—

### åœ¨ React App ä¸­åˆå§‹åŒ–
```javascript
// App.jsx
import { initializeStateManagement } from '@/stores/init'
import { useEffect } from 'react'

function App() {
  useEffect(() => {
    // å•Ÿå‹•ç‹€æ…‹ç®¡ç†ç³»çµ±
    initializeStateManagement().catch(error => {
      console.error('ç‹€æ…‹ç®¡ç†åˆå§‹åŒ–å¤±æ•—:', error)
    })
  }, [])
  
  return (
    // æ‡‰ç”¨ç¨‹å¼å…§å®¹
    <div>Your App</div>
  )
}
```

### åœ¨çµ„ä»¶ä¸­ä½¿ç”¨æ•´åˆç‹€æ…‹
```jsx
// ä¸»é¡Œèˆ‡åœ‹éš›åŒ–æ•´åˆä½¿ç”¨
const ThemeLanguageToggle = () => {
  const { theme, setTheme } = useThemeStore()
  const { locale, setLocale } = useI18nStore()
  const { loadedAnimations } = useAnimationStore()
  
  return (
    <div>
      <button onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')}>
        åˆ‡æ›ä¸»é¡Œ: {theme}
      </button>
      <button onClick={() => setLocale(locale === 'zh-TW' ? 'en-US' : 'zh-TW')}>
        åˆ‡æ›èªè¨€: {locale}
      </button>
      <p>å·²è¼‰å…¥å‹•ç•«: {loadedAnimations.size}</p>
    </div>
  )
}
```