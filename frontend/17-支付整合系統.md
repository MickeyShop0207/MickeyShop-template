# 17-支付整合系統

## 系統概述

支付整合系統整合 LINE Pay 和 ECPay 綠界科技兩大支付平台，提供用戶多元化支付選擇。系統採用直接跳轉模式，支付完成後引導用戶選擇後續動作，並完整記錄所有支付流程。

## 支付流程架構

### 主要支付流程
```
購物車確認 → 填寫訂單資訊 → 選擇支付方式 → 跳轉第三方支付 → 支付完成 → 返回網站選擇動作
```

### 支付方式選項
- **LINE Pay**: 直接跳轉至 LINE Pay 支付頁面
- **ECPay**: 跳轉至綠界科技支付頁面，支援所有綠界提供的支付方式

## LINE Pay 整合

### 支付請求流程
```javascript
// LINE Pay 支付請求
const initiateLinePayment = async (orderData) => {
  const paymentRequest = {
    amount: orderData.totalAmount,
    currency: 'TWD',
    orderId: orderData.orderId,
    packages: [{
      id: orderData.orderId,
      amount: orderData.totalAmount,
      products: orderData.items.map(item => ({
        name: item.productName,
        quantity: item.quantity,
        price: item.price
      }))
    }],
    redirectUrls: {
      confirmUrl: `${config.baseUrl}/payment/line-pay/confirm`,
      cancelUrl: `${config.baseUrl}/payment/line-pay/cancel`
    }
  }
  
  const response = await linePayAPI.request(paymentRequest)
  if (response.returnCode === '0000') {
    window.location.href = response.info.paymentUrl.web
  }
}
```

### 支付確認處理
```javascript
// LINE Pay 支付確認
const confirmLinePayment = async (transactionId, orderId) => {
  try {
    const confirmResponse = await linePayAPI.confirm(transactionId, {
      amount: orderAmount,
      currency: 'TWD'
    })
    
    if (confirmResponse.returnCode === '0000') {
      // 更新訂單狀態為已支付
      await updateOrderStatus(orderId, 'paid')
      
      // 記錄支付記錄
      await createPaymentRecord({
        orderId,
        paymentMethod: 'LINE Pay',
        transactionId,
        amount: orderAmount,
        status: 'success'
      })
      
      // 跳轉至成功頁面
      navigate('/payment/success', { state: { orderId } })
    }
  } catch (error) {
    navigate('/payment/failure', { state: { orderId, error: error.message } })
  }
}
```

## ECPay 整合

### 支付請求表單
```javascript
// ECPay 支付表單生成
const generateECPayForm = (orderData) => {
  const paymentData = {
    MerchantID: config.ecpay.merchantId,
    MerchantTradeNo: orderData.orderId,
    MerchantTradeDate: new Date().toISOString().slice(0, 19).replace('T', ' '),
    PaymentType: 'aio',
    TotalAmount: orderData.totalAmount,
    TradeDesc: orderData.description || '商品購買',
    ItemName: orderData.items.map(item => 
      `${item.productName} x${item.quantity}`
    ).join('#'),
    ReturnURL: `${config.baseUrl}/api/payment/ecpay/notify`,
    ChoosePayment: 'ALL',
    ClientBackURL: `${config.baseUrl}/payment/ecpay/return`,
    OrderResultURL: `${config.baseUrl}/payment/result`
  }
  
  // 生成檢查碼並提交表單
  const checkMacValue = generateECPayCheckMac(paymentData)
  submitECPayForm({ ...paymentData, CheckMacValue: checkMacValue })
}
```

### 支付結果處理
```javascript
// ECPay 支付結果處理
const handleECPayResult = async (paymentResult) => {
  const { MerchantTradeNo, RtnCode, RtnMsg, TradeAmt, PaymentDate, TradeNo } = paymentResult
  
  if (RtnCode === '1') {
    // 支付成功
    await updateOrderStatus(MerchantTradeNo, 'paid')
    await createPaymentRecord({
      orderId: MerchantTradeNo,
      paymentMethod: 'ECPay',
      transactionId: TradeNo,
      amount: parseInt(TradeAmt),
      status: 'success',
      paidAt: new Date(PaymentDate)
    })
    
    return { success: true, orderId: MerchantTradeNo }
  } else {
    // 支付失敗
    await createPaymentRecord({
      orderId: MerchantTradeNo,
      paymentMethod: 'ECPay',
      transactionId: TradeNo,
      amount: parseInt(TradeAmt),
      status: 'failed',
      errorMessage: RtnMsg
    })
    
    return { success: false, orderId: MerchantTradeNo, error: RtnMsg }
  }
}
```

## 支付成功/失敗頁面

### 支付成功頁面
```jsx
// PaymentSuccess.jsx
const PaymentSuccess = () => {
  const location = useLocation()
  const navigate = useNavigate()
  const { orderId } = location.state || {}
  const [orderDetails, setOrderDetails] = useState(null)
  const [storeName, setStoreName] = useState('')
  
  useEffect(() => {
    if (orderId) {
      loadOrderDetails()
      loadStoreSettings()
    }
  }, [orderId])
  
  const loadOrderDetails = async () => {
    try {
      const order = await orderAPI.getOrderById(orderId)
      setOrderDetails(order)
    } catch (error) {
      console.error('載入訂單詳情失敗:', error)
    }
  }
  
  const loadStoreSettings = async () => {
    try {
      const settings = await settingsAPI.getStoreSettings()
      setStoreName(settings.storeName)
    } catch (error) {
      console.error('載入商店設定失敗:', error)
    }
  }
  
  return (
    <div className="payment-success">
      <div className="success-icon">
        <CheckCircleOutlined style={{ fontSize: '64px', color: '#52c41a' }} />
      </div>
      
      <h2>支付成功！</h2>
      <p>感謝您在 {storeName} 的購買</p>
      
      {orderDetails && (
        <div className="order-summary">
          <h3>訂單明細</h3>
          <div className="order-info">
            <p><strong>訂單編號：</strong>{orderDetails.orderNumber}</p>
            <p><strong>支付金額：</strong>NT$ {orderDetails.totalAmount.toLocaleString()}</p>
            <p><strong>支付方式：</strong>{orderDetails.paymentMethod}</p>
            <p><strong>支付時間：</strong>{new Date(orderDetails.paidAt).toLocaleString()}</p>
          </div>
          
          <div className="product-list">
            {orderDetails.items.map(item => (
              <div key={item.id} className="product-item">
                <span className="product-name">{item.productName}</span>
                <span className="quantity">數量: {item.quantity}</span>
                <span className="unit-price">單價: NT$ {item.price}</span>
                <span className="subtotal">小計: NT$ {item.subtotal}</span>
              </div>
            ))}
          </div>
          
          <div className="shipping-info">
            <p><strong>運費：</strong>NT$ {orderDetails.shippingFee}</p>
          </div>
        </div>
      )}
      
      <div className="action-buttons">
        <button 
          onClick={() => navigate('/products')}
          className="btn-browse"
        >
          繼續瀏覽商品
        </button>
        <button 
          onClick={() => navigate('/member/orders')}
          className="btn-orders"
        >
          查看訂單
        </button>
      </div>
    </div>
  )
}
```

### 支付失敗頁面
```jsx
// PaymentFailure.jsx
const PaymentFailure = () => {
  const location = useLocation()
  const navigate = useNavigate()
  const { orderId, error } = location.state || {}
  
  return (
    <div className="payment-failure">
      <div className="failure-icon">
        <CloseCircleOutlined style={{ fontSize: '64px', color: '#ff4d4f' }} />
      </div>
      
      <h2>支付失敗</h2>
      <p>很抱歉，您的支付未能成功完成</p>
      
      {error && (
        <div className="error-message">
          <h3>失敗原因：</h3>
          <p>{error}</p>
        </div>
      )}
      
      <div className="action-buttons">
        <button 
          onClick={() => navigate(`/checkout/${orderId}`)}
          className="btn-retry"
        >
          重新支付
        </button>
        <button 
          onClick={() => navigate('/cart')}
          className="btn-cart"
        >
          返回購物車
        </button>
        <button 
          onClick={() => navigate('/products')}
          className="btn-browse"
        >
          繼續瀏覽商品
        </button>
      </div>
    </div>
  )
}
```

## 支付記錄系統

### 支付記錄資料結構
```javascript
// 支付記錄表結構
const PaymentRecord = {
  id: 'string',
  orderId: 'string',
  userId: 'string',
  paymentMethod: 'LINE Pay | ECPay',
  transactionId: 'string', // 支付訂單號碼
  amount: 'number',
  status: 'success | failed | pending',
  paidAt: 'datetime',
  errorMessage: 'string', // 失敗時的錯誤訊息
  refundStatus: 'none | processing | completed | failed',
  refundAmount: 'number',
  refundAt: 'datetime',
  createdAt: 'datetime',
  updatedAt: 'datetime'
}
```

### 支付記錄查詢
```jsx
// UserPaymentRecords.jsx - 用戶支付記錄頁面
const UserPaymentRecords = () => {
  const [records, setRecords] = useState([])
  const [loading, setLoading] = useState(true)
  const [filters, setFilters] = useState({
    paymentMethod: 'all',
    status: 'all',
    dateRange: [null, null]
  })
  
  useEffect(() => {
    loadPaymentRecords()
  }, [filters])
  
  const loadPaymentRecords = async () => {
    setLoading(true)
    try {
      const response = await paymentAPI.getUserPaymentRecords(filters)
      setRecords(response.data)
    } catch (error) {
      message.error('載入支付記錄失敗')
    } finally {
      setLoading(false)
    }
  }
  
  return (
    <div className="payment-records">
      <h2>我的支付記錄</h2>
      
      <div className="filters">
        <Select
          value={filters.paymentMethod}
          onChange={value => setFilters(prev => ({ ...prev, paymentMethod: value }))}
          placeholder="支付方式"
        >
          <Option value="all">全部支付方式</Option>
          <Option value="LINE Pay">LINE Pay</Option>
          <Option value="ECPay">ECPay</Option>
        </Select>
        
        <Select
          value={filters.status}
          onChange={value => setFilters(prev => ({ ...prev, status: value }))}
          placeholder="支付狀態"
        >
          <Option value="all">全部狀態</Option>
          <Option value="success">成功</Option>
          <Option value="failed">失敗</Option>
        </Select>
        
        <RangePicker
          value={filters.dateRange}
          onChange={dates => setFilters(prev => ({ ...prev, dateRange: dates }))}
          placeholder={['開始日期', '結束日期']}
        />
      </div>
      
      <Table
        loading={loading}
        dataSource={records}
        columns={[
          {
            title: '支付時間',
            dataIndex: 'paidAt',
            render: date => date ? new Date(date).toLocaleString() : '-'
          },
          {
            title: '訂單編號',
            dataIndex: 'orderId',
            render: (orderId) => (
              <a onClick={() => navigate(`/member/orders/${orderId}`)}>
                {orderId}
              </a>
            )
          },
          {
            title: '支付方式',
            dataIndex: 'paymentMethod'
          },
          {
            title: '支付訂單號碼',
            dataIndex: 'transactionId'
          },
          {
            title: '支付金額',
            dataIndex: 'amount',
            render: amount => `NT$ ${amount.toLocaleString()}`
          },
          {
            title: '狀態',
            dataIndex: 'status',
            render: status => (
              <Tag color={status === 'success' ? 'green' : status === 'failed' ? 'red' : 'orange'}>
                {status === 'success' ? '成功' : status === 'failed' ? '失敗' : '處理中'}
              </Tag>
            )
          }
        ]}
        pagination={{
          pageSize: 20,
          showSizeChanger: true,
          showQuickJumper: true,
          showTotal: (total) => `共 ${total} 筆記錄`
        }}
      />
    </div>
  )
}
```

## 後台支付管理

### 支付方式設定
```jsx
// PaymentMethodSettings.jsx - 後台支付方式管理
const PaymentMethodSettings = () => {
  const [settings, setSettings] = useState({
    linePayEnabled: true,
    ecpayEnabled: true,
    linePayFee: 0,
    ecpayFee: 0
  })
  
  const handleSave = async () => {
    try {
      await paymentAPI.updatePaymentSettings(settings)
      message.success('支付設定已更新')
    } catch (error) {
      message.error('更新設定失敗')
    }
  }
  
  return (
    <div className="payment-settings">
      <h2>支付方式設定</h2>
      
      <Form layout="vertical">
        <Form.Item label="LINE Pay">
          <Switch
            checked={settings.linePayEnabled}
            onChange={checked => setSettings(prev => ({ ...prev, linePayEnabled: checked }))}
          />
          <span style={{ marginLeft: 8 }}>
            {settings.linePayEnabled ? '已啟用' : '已停用'}
          </span>
          
          {settings.linePayEnabled && (
            <div style={{ marginTop: 16 }}>
              <Form.Item label="手續費 (%)">
                <InputNumber
                  min={0}
                  max={10}
                  step={0.1}
                  value={settings.linePayFee}
                  onChange={value => setSettings(prev => ({ ...prev, linePayFee: value }))}
                  formatter={value => `${value}%`}
                  parser={value => value.replace('%', '')}
                />
              </Form.Item>
            </div>
          )}
        </Form.Item>
        
        <Form.Item label="ECPay (綠界科技)">
          <Switch
            checked={settings.ecpayEnabled}
            onChange={checked => setSettings(prev => ({ ...prev, ecpayEnabled: checked }))}
          />
          <span style={{ marginLeft: 8 }}>
            {settings.ecpayEnabled ? '已啟用' : '已停用'}
          </span>
          
          {settings.ecpayEnabled && (
            <div style={{ marginTop: 16 }}>
              <Form.Item label="手續費 (%)">
                <InputNumber
                  min={0}
                  max={10}
                  step={0.1}
                  value={settings.ecpayFee}
                  onChange={value => setSettings(prev => ({ ...prev, ecpayFee: value }))}
                  formatter={value => `${value}%`}
                  parser={value => value.replace('%', '')}
                />
              </Form.Item>
            </div>
          )}
        </Form.Item>
        
        <Form.Item>
          <Button type="primary" onClick={handleSave}>
            儲存設定
          </Button>
        </Form.Item>
      </Form>
    </div>
  )
}
```

## 線上退款功能

### 退款請求處理
```javascript
// 支付退款處理
class PaymentRefundService {
  // LINE Pay 退款
  async refundLinePayment(paymentRecord, refundAmount, reason) {
    try {
      const refundRequest = {
        refundAmount: refundAmount,
        currency: 'TWD',
        reason: reason
      }
      
      const response = await linePayAPI.refund(
        paymentRecord.transactionId, 
        refundRequest
      )
      
      if (response.returnCode === '0000') {
        await this.updateRefundRecord(paymentRecord.id, {
          refundStatus: 'completed',
          refundAmount: refundAmount,
          refundAt: new Date()
        })
        
        return { success: true, refundId: response.info.refundTransactionId }
      } else {
        throw new Error(response.returnMessage)
      }
    } catch (error) {
      await this.updateRefundRecord(paymentRecord.id, {
        refundStatus: 'failed',
        errorMessage: error.message
      })
      
      throw error
    }
  }
  
  // ECPay 退款
  async refundECPayment(paymentRecord, refundAmount, reason) {
    try {
      const refundData = {
        MerchantID: config.ecpay.merchantId,
        MerchantTradeNo: paymentRecord.orderId,
        TradeNo: paymentRecord.transactionId,
        Action: 'R',
        TotalAmount: refundAmount,
        Desc: reason
      }
      
      const response = await ecpayAPI.doAction(refundData)
      
      if (response.RtnCode === '1') {
        await this.updateRefundRecord(paymentRecord.id, {
          refundStatus: 'completed',
          refundAmount: refundAmount,
          refundAt: new Date()
        })
        
        return { success: true, refundId: response.TradeNo }
      } else {
        throw new Error(response.RtnMsg)
      }
    } catch (error) {
      await this.updateRefundRecord(paymentRecord.id, {
        refundStatus: 'failed',
        errorMessage: error.message
      })
      
      throw error
    }
  }
  
  async updateRefundRecord(recordId, refundData) {
    await paymentAPI.updatePaymentRecord(recordId, refundData)
  }
}
```

## 支付統計報表

### 支付數據統計
```jsx
// PaymentAnalytics.jsx - 後台支付統計
const PaymentAnalytics = () => {
  const [analytics, setAnalytics] = useState(null)
  const [dateRange, setDateRange] = useState([
    dayjs().subtract(30, 'day'),
    dayjs()
  ])
  
  useEffect(() => {
    loadAnalytics()
  }, [dateRange])
  
  const loadAnalytics = async () => {
    try {
      const [startDate, endDate] = dateRange
      const data = await paymentAPI.getPaymentAnalytics({
        startDate: startDate.format('YYYY-MM-DD'),
        endDate: endDate.format('YYYY-MM-DD')
      })
      setAnalytics(data)
    } catch (error) {
      message.error('載入統計數據失敗')
    }
  }
  
  return (
    <div className="payment-analytics">
      <div className="analytics-header">
        <h2>支付統計報表</h2>
        <RangePicker
          value={dateRange}
          onChange={setDateRange}
          placeholder={['開始日期', '結束日期']}
        />
      </div>
      
      {analytics && (
        <div className="analytics-content">
          <Row gutter={16}>
            <Col span={6}>
              <Card>
                <Statistic
                  title="總交易額"
                  value={analytics.totalAmount}
                  prefix="NT$"
                  formatter={(value) => value.toLocaleString()}
                />
              </Card>
            </Col>
            <Col span={6}>
              <Card>
                <Statistic
                  title="交易筆數"
                  value={analytics.totalTransactions}
                />
              </Card>
            </Col>
            <Col span={6}>
              <Card>
                <Statistic
                  title="成功率"
                  value={analytics.successRate}
                  suffix="%"
                />
              </Card>
            </Col>
            <Col span={6}>
              <Card>
                <Statistic
                  title="平均交易額"
                  value={analytics.averageAmount}
                  prefix="NT$"
                  formatter={(value) => value.toLocaleString()}
                />
              </Card>
            </Col>
          </Row>
          
          <Row gutter={16} style={{ marginTop: 16 }}>
            <Col span={12}>
              <Card title="支付方式分佈">
                <Pie
                  data={analytics.paymentMethodDistribution}
                  angleField="value"
                  colorField="type"
                />
              </Card>
            </Col>
            <Col span={12}>
              <Card title="每日交易趨勢">
                <Line
                  data={analytics.dailyTrends}
                  xField="date"
                  yField="amount"
                  seriesField="type"
                />
              </Card>
            </Col>
          </Row>
        </div>
      )}
    </div>
  )
}
```

## 安全性考量

### 資料驗證與加密
- 所有金額計算使用 BigDecimal 精確運算
- 支付請求包含檢查碼驗證
- 敏感資訊加密儲存
- API 請求使用 HTTPS 加密傳輸

### 防範措施
- 支付金額二次驗證
- 訂單狀態變更日誌記錄
- 異常交易監控與警報
- 支付憑證保存與備份

## 國際化支援

### 多語言文字
```javascript
// 支付相關國際化文字
const paymentI18n = {
  'zh-TW': {
    'payment.method.linepay': 'LINE Pay',
    'payment.method.ecpay': 'ECPay (綠界科技)',
    'payment.success.title': '支付成功！',
    'payment.success.message': '感謝您的購買',
    'payment.failure.title': '支付失敗',
    'payment.failure.message': '很抱歉，您的支付未能成功完成',
    'payment.records.title': '我的支付記錄',
    'payment.continue.browsing': '繼續瀏覽商品',
    'payment.view.orders': '查看訂單',
    'payment.retry': '重新支付'
  },
  'en': {
    'payment.method.linepay': 'LINE Pay',
    'payment.method.ecpay': 'ECPay',
    'payment.success.title': 'Payment Successful!',
    'payment.success.message': 'Thank you for your purchase',
    'payment.failure.title': 'Payment Failed',
    'payment.failure.message': 'Sorry, your payment could not be completed',
    'payment.records.title': 'My Payment Records',
    'payment.continue.browsing': 'Continue Browsing',
    'payment.view.orders': 'View Orders',
    'payment.retry': 'Retry Payment'
  }
}
```

## 效能優化

### 快取策略
- 支付方式設定快取 30 分鐘
- 匯率資訊快取 1 小時
- 支付記錄分頁載入

### 錯誤處理
- 支付失敗自動重試機制
- 網路異常時的離線提示
- 支付狀態同步驗證