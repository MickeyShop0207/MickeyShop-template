# 認證系統設計

## 登入方式設計

### 雙重登入模式

#### 1. 頁面登入
- **觸發位置**: 頂端導航列的登入按鈕
- **使用場景**: 用戶主動想要登入
- **路由**: `/:locale/login`, `/:locale/register`
- **特性**: 獨立頁面，完整的註冊/登入流程

#### 2. Modal登入  
- **觸發位置**: 購物車結帳按鈕
- **使用場景**: 用戶想結帳但尚未登入
- **實現**: 彈出登入Modal，無需跳轉頁面
- **特性**: 快速登入，登入後直接進入結帳流程

### 認證狀態管理

#### "記住我"功能
```js
// 登入狀態持久化策略
const handleLogin = (credentials, rememberMe) => {
  if (rememberMe) {
    // 長期Token (30天)
    localStorage.setItem('rememberMe', 'true')
    setRefreshTokenExpiry('30d')
  } else {
    // 短期Token (關閉瀏覽器即失效)
    sessionStorage.setItem('tempSession', 'true')
    setRefreshTokenExpiry('session')
  }
}
```

#### Token管理
- **Access Token**: 15分鐘過期，儲存在memory
- **Refresh Token**: 
  - 記住我：30天過期，httpOnly cookie
  - 未勾選：Session過期，sessionStorage
- **自動刷新**: Token過期前自動續期

### 購物流程設計

#### 結帳流程分支
```
購物車 → [檢查登入狀態]
├── 已登入 → 自動帶入收件資訊 → 付款方式 → 訂單確認 → 付款處理 → 完成
└── 未登入 → Modal登入 → 填寫收件資訊 → 付款方式 → 訂單確認 → 付款處理 → 完成
```

#### 註冊強制性
- **預設**: 強制註冊 (無法訪客結帳)
- **管理員控制**: 可在後台開啟訪客結帳功能
- **訪客結帳**: 開啟時允許不註冊直接結帳

## 社群登入系統

### 支援平台

#### Google OAuth 2.0
```js
// 技術實現
- 使用 @google-cloud/oauth2 庫
- 支援email和profile權限
- 需要Google Cloud Console設定
```

#### LINE Login
```js  
// 技術實現
- 使用LINE Login API
- 適合台灣本地用戶
- 高普及率和信任度
```

#### 移除平台
- ❌ **Facebook**: 審核流程複雜，維護成本高
- ❌ **Instagram**: 不適合登入驗證，API限制多

### 後台管理控制

#### 資料庫設計
```sql
CREATE TABLE social_login_providers (
  provider VARCHAR(50) PRIMARY KEY,
  enabled BOOLEAN DEFAULT false,
  client_id VARCHAR(255),
  client_secret VARCHAR(255),
  redirect_uri VARCHAR(255),
  button_text VARCHAR(100),
  button_color VARCHAR(7),
  sort_order INT DEFAULT 0
);
```

#### 管理功能
- **啟用控制**: 管理員可開啟/關閉各平台登入
- **介面控制**: 未啟用的平台不顯示登入按鈕
- **配置管理**: Client ID/Secret等參數後台設定
- **排序控制**: 可調整登入按鈕顯示順序

### 前端實現

#### 動態顯示
```jsx
// 社群登入按鈕組件
const SocialLogins = () => {
  const { data: providers } = useQuery(
    ['social-providers'],
    () => api.getSocialProviders()
  )
  
  return (
    <div className="social-logins">
      {providers
        .filter(provider => provider.enabled)
        .sort((a, b) => a.sort_order - b.sort_order)
        .map(provider => (
          <SocialLoginButton key={provider.provider} {...provider} />
        ))
      }
    </div>
  )
}
```

#### 登入流程
```js
// OAuth登入流程
1. 用戶點擊社群登入按鈕
2. 重定向到OAuth提供商
3. 用戶授權後返回callback
4. 後端驗證token並創建/登入用戶
5. 設定session並返回前端
6. 前端更新登入狀態
```

## 安全考量

### 資料保護
- 社群登入token加密存儲
- Client Secret環境變數存儲
- HTTPS強制使用
- CSRF token保護

### 用戶隱私
- 最小權限請求 (僅email和基本資料)
- 透明的隱私政策
- 用戶可解除社群帳戶綁定

### 錯誤處理
- 社群登入失敗時的備用方案
- 清晰的錯誤訊息提示
- 登入狀態異常時的自動修復