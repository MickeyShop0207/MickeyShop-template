# 商品管理系統

## 系統概覽

完整的商品管理系統，支援複雜變體層級結構、多語言內容、智能價格體系和前端互動功能。

## 核心特性

- **複雜變體系統**: 最多10層變體樹狀結構，每層獨立SKU設定
- **多語言支援**: JSON + Markdown 混合格式
- **智能價格體系**: FIFO成本計算、多層會員價格、價格歷史記錄
- **前端互動**: 懸停選變體、滑動動畫、QR Code生成
- **SEO優化**: 獨立URL Slug、多語言SEO設定

## 資料庫設計

### products 表 (商品主表)
```sql
CREATE TABLE products (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  sku_prefix VARCHAR(10) NOT NULL,          -- 商品級別SKU前綴
  name JSON NOT NULL,                       -- 多語言商品名稱
  description JSON NOT NULL,                -- 多語言Markdown描述
  short_description JSON,                   -- 多語言簡短描述
  meta_title JSON,                         -- 多語言SEO標題
  meta_description JSON,                   -- 多語言SEO描述
  url_slug JSON NOT NULL,                  -- 多語言URL段落
  tags JSON,                               -- 商品標籤 (SEO+篩選)
  
  -- 基礎價格 (所有變體的基礎價格)
  base_cost_price DECIMAL(10,2) DEFAULT 0, -- 基礎成本價
  base_original_price DECIMAL(10,2) NOT NULL, -- 基礎原價
  base_sale_price DECIMAL(10,2),           -- 基礎優惠價
  base_bronze_price DECIMAL(10,2),         -- 基礎銅牌會員價
  base_silver_price DECIMAL(10,2),         -- 基礎銀牌會員價
  base_gold_price DECIMAL(10,2),           -- 基礎黃金會員價
  
  -- 圖片相關
  main_image_url VARCHAR(255),             -- 主圖URL (4:3比例)
  image_urls JSON,                         -- 最多10張圖片URLs
  
  -- 狀態控制
  status ENUM('draft', 'active', 'inactive') DEFAULT 'draft',
  sort_weight INTEGER DEFAULT 0,           -- 排序權重
  
  -- 系統欄位
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  created_by INTEGER,                      -- 創建者管理員ID
  updated_by INTEGER,                      -- 更新者管理員ID
  
  FOREIGN KEY (created_by) REFERENCES admin_users(id),
  FOREIGN KEY (updated_by) REFERENCES admin_users(id)
);
```

### product_categories 表 (商品分類關聯)
```sql
CREATE TABLE product_categories (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  product_id INTEGER NOT NULL,
  category_id INTEGER NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
  FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE CASCADE,
  UNIQUE(product_id, category_id)
);
```

### product_variants 表 (商品變體層級)
```sql
CREATE TABLE product_variants (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  product_id INTEGER NOT NULL,
  parent_id INTEGER,                       -- 父變體ID (NULL為第一層)
  level INTEGER NOT NULL,                  -- 變體層級 (1-10)
  level_name JSON NOT NULL,                -- 層級名稱 (多語言)
  option_name JSON NOT NULL,               -- 選項名稱 (多語言)
  sku_code VARCHAR(20) NOT NULL,           -- 此層級SKU代碼
  sort_order INTEGER DEFAULT 0,            -- 同層級排序
  level_sort_order INTEGER DEFAULT 0,      -- 層級排序 (拖曳調整)
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
  FOREIGN KEY (parent_id) REFERENCES product_variants(id) ON DELETE CASCADE,
  
  -- 確保同一商品下，同一層級內SKU代碼不重複
  UNIQUE(product_id, level, sku_code),
  -- 確保同一父變體下的排序唯一
  UNIQUE(parent_id, sort_order)
);
```

### product_skus 表 (最終SKU)
```sql
CREATE TABLE product_skus (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  product_id INTEGER NOT NULL,
  sku VARCHAR(100) NOT NULL UNIQUE,        -- 完整SKU (無分隔符號)
  variant_path JSON NOT NULL,              -- 變體路徑 (所有層級ID數組)
  
  -- 價格設定 (可覆蓋基礎價格)
  cost_price DECIMAL(10,2),                -- 成本價 (FIFO自動計算)
  original_price DECIMAL(10,2),            -- 原價微調
  sale_price DECIMAL(10,2),                -- 優惠價微調
  bronze_price DECIMAL(10,2),              -- 銅牌會員價微調
  silver_price DECIMAL(10,2),              -- 銀牌會員價微調
  gold_price DECIMAL(10,2),                -- 黃金會員價微調
  
  -- 圖片與QR Code
  image_url VARCHAR(255),                  -- SKU專屬圖片
  qr_code_url VARCHAR(255),                -- SKU QR Code URL
  
  -- 狀態
  is_active BOOLEAN DEFAULT TRUE,
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
);
```

### price_history 表 (價格歷史)
```sql
CREATE TABLE price_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  product_id INTEGER,
  sku_id INTEGER,
  price_type ENUM('cost', 'original', 'sale', 'bronze', 'silver', 'gold') NOT NULL,
  old_price DECIMAL(10,2),
  new_price DECIMAL(10,2) NOT NULL,
  change_reason VARCHAR(255),              -- 變更原因
  changed_by INTEGER NOT NULL,             -- 變更者管理員ID
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
  FOREIGN KEY (sku_id) REFERENCES product_skus(id) ON DELETE CASCADE,
  FOREIGN KEY (changed_by) REFERENCES admin_users(id)
);
```

### product_qr_codes 表 (QR Code管理)
```sql
CREATE TABLE product_qr_codes (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  product_id INTEGER,
  sku_id INTEGER,
  type ENUM('product_url', 'sku_info') NOT NULL,
  qr_data TEXT NOT NULL,                   -- QR Code包含的資料
  qr_image_url VARCHAR(255) NOT NULL,      -- QR Code圖片URL
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
  FOREIGN KEY (sku_id) REFERENCES product_skus(id) ON DELETE CASCADE
);
```

## 商品變體系統邏輯

### 變體樹狀結構建立
```javascript
// 變體結構範例
const variantStructure = {
  product_id: 1,
  sku_prefix: "WH", // 美白精華液
  levels: [
    {
      level: 1,
      name: { "zh-TW": "顏色", "en": "Color" },
      options: [
        {
          name: { "zh-TW": "紅色包裝", "en": "Red Package" },
          sku_code: "R",
          sort_order: 1
        },
        {
          name: { "zh-TW": "藍色包裝", "en": "Blue Package" },
          sku_code: "B", 
          sort_order: 2
        }
      ]
    },
    {
      level: 2,
      name: { "zh-TW": "容量", "en": "Volume" },
      options: [
        {
          name: { "zh-TW": "30ml", "en": "30ml" },
          sku_code: "30",
          sort_order: 1
        },
        {
          name: { "zh-TW": "50ml", "en": "50ml" },
          sku_code: "50",
          sort_order: 2
        }
      ]
    }
  ]
}
```

### SKU自動生成邏輯
```javascript
// 生成最終SKU
const generateSKU = (product, variantPath) => {
  let sku = product.sku_prefix // 商品前綴
  
  // 按層級順序連接SKU代碼
  variantPath.forEach(variantId => {
    const variant = getVariantById(variantId)
    sku += variant.sku_code
  })
  
  return sku // 例如: WHR30, WHR50, WHB30, WHB50
}

// 驗證SKU完整性
const validateProductSKUs = async (productId) => {
  const product = await getProduct(productId)
  const variants = await getProductVariants(productId)
  
  // 生成所有可能的組合
  const allCombinations = generateAllVariantCombinations(variants)
  const existingSKUs = await getProductSKUs(productId)
  
  // 檢查是否所有組合都有對應的SKU
  const missingSKUs = allCombinations.filter(combo => {
    const expectedSKU = generateSKU(product, combo.variantPath)
    return !existingSKUs.find(sku => sku.sku === expectedSKU)
  })
  
  if (missingSKUs.length > 0) {
    return {
      valid: false,
      canPublish: false,
      missingSKUs
    }
  }
  
  // 檢查重複SKU
  const duplicates = findDuplicateSKUs(existingSKUs)
  if (duplicates.length > 0) {
    return {
      valid: false,
      canPublish: false,
      duplicates
    }
  }
  
  return { valid: true, canPublish: true }
}
```

## 價格體系邏輯

### FIFO成本價格計算
```javascript
// 基於採購單的FIFO成本計算
const calculateFIFOCostPrice = async (skuId, quantity = 1) => {
  // 獲取該SKU的採購記錄 (按時間排序)
  const purchases = await db.prepare(`
    SELECT pi.cost_price, pi.remaining_quantity, pi.purchase_date
    FROM purchase_items pi
    JOIN purchase_orders po ON pi.purchase_id = po.id
    WHERE pi.sku_id = ? AND pi.remaining_quantity > 0
    ORDER BY po.purchase_date ASC
  `).bind(skuId).all()
  
  let totalCost = 0
  let remainingQuantity = quantity
  
  for (const purchase of purchases) {
    const useQuantity = Math.min(remainingQuantity, purchase.remaining_quantity)
    totalCost += useQuantity * purchase.cost_price
    remainingQuantity -= useQuantity
    
    if (remainingQuantity <= 0) break
  }
  
  return quantity > 0 ? totalCost / quantity : 0
}

// 更新SKU成本價格
const updateSKUCostPrice = async (skuId) => {
  const costPrice = await calculateFIFOCostPrice(skuId)
  
  await db.prepare(`
    UPDATE product_skus 
    SET cost_price = ?, updated_at = CURRENT_TIMESTAMP 
    WHERE id = ?
  `).bind(costPrice, skuId).run()
  
  // 記錄價格歷史
  await recordPriceHistory(null, skuId, 'cost', null, costPrice, 'FIFO calculation', 1)
}
```

### 會員價格計算邏輯
```javascript
// 獲取商品的最終售價 (考慮會員層級)
const getProductPrice = async (productId, skuId, memberLevel = null) => {
  const product = await getProduct(productId)
  const sku = skuId ? await getSKU(skuId) : null
  
  // 價格繼承邏輯：SKU價格 > 商品基礎價格
  const originalPrice = sku?.original_price ?? product.base_original_price
  const salePrice = sku?.sale_price ?? product.base_sale_price
  
  // 會員價格計算
  if (memberLevel) {
    // 優先使用商品/SKU設定的會員價格
    const memberPriceField = `${memberLevel}_price`
    const setMemberPrice = sku?.[memberPriceField] ?? product[`base_${memberPriceField}`]
    
    if (setMemberPrice) {
      return setMemberPrice
    }
    
    // 使用會員層級折扣計算
    const memberDiscount = await getMemberDiscount(memberLevel)
    if (memberDiscount) {
      const basePrice = salePrice || originalPrice
      return basePrice * (1 - memberDiscount / 100)
    }
  }
  
  // 一般用戶價格
  return salePrice || originalPrice
}
```

## QR Code生成系統

### QR Code生成邏輯
```javascript
// 生成商品網址QR Code
const generateProductUrlQR = async (productId, locale = 'zh-TW') => {
  const product = await getProduct(productId)
  const urlSlug = product.url_slug[locale]
  const productUrl = `${config.frontendUrl}/${locale}/products/${urlSlug}`
  
  const qrData = {
    type: 'product_url',
    productId,
    url: productUrl,
    locale
  }
  
  const qrImageBuffer = await QRCode.toBuffer(productUrl, {
    errorCorrectionLevel: 'M',
    type: 'png',
    quality: 0.92,
    margin: 1,
    width: 200
  })
  
  // 上傳到R2
  const qrImageUrl = await uploadToR2(qrImageBuffer, `qr/product_${productId}_${locale}.png`)
  
  // 保存到資料庫
  await db.prepare(`
    INSERT INTO product_qr_codes (product_id, type, qr_data, qr_image_url)
    VALUES (?, ?, ?, ?)
  `).bind(productId, 'product_url', JSON.stringify(qrData), qrImageUrl).run()
  
  return qrImageUrl
}

// 生成SKU資訊QR Code  
const generateSKUQR = async (skuId) => {
  const sku = await getSKU(skuId)
  const product = await getProduct(sku.product_id)
  
  const qrData = {
    type: 'sku_info',
    sku: sku.sku,
    productName: product.name,
    variantPath: sku.variant_path,
    price: sku.original_price || product.base_original_price
  }
  
  const qrImageBuffer = await QRCode.toBuffer(JSON.stringify(qrData), {
    errorCorrectionLevel: 'M',
    type: 'png',
    quality: 0.92,
    margin: 1,
    width: 150
  })
  
  const qrImageUrl = await uploadToR2(qrImageBuffer, `qr/sku_${sku.sku}.png`)
  
  await db.prepare(`
    INSERT INTO product_qr_codes (sku_id, type, qr_data, qr_image_url)
    VALUES (?, ?, ?, ?)
  `).bind(skuId, 'sku_info', JSON.stringify(qrData), qrImageUrl).run()
  
  return qrImageUrl
}
```

## API 端點設計

### 商品CRUD API
```javascript
// GET /admin/products - 獲取商品列表
app.get('/admin/products', authenticateAdmin, requirePermission('product', 'read'), async (request) => {
  const { page = 1, limit = 20, status, category, search } = request.query
  
  let query = `
    SELECT p.*, 
           GROUP_CONCAT(c.name) as category_names,
           COUNT(ps.id) as sku_count
    FROM products p
    LEFT JOIN product_categories pc ON p.id = pc.product_id
    LEFT JOIN categories c ON pc.category_id = c.id
    LEFT JOIN product_skus ps ON p.id = ps.product_id
    WHERE 1=1
  `
  
  const params = []
  
  if (status) {
    query += ` AND p.status = ?`
    params.push(status)
  }
  
  if (category) {
    query += ` AND pc.category_id = ?`
    params.push(category)
  }
  
  if (search) {
    query += ` AND (JSON_EXTRACT(p.name, '$.zh-TW') LIKE ? OR p.sku_prefix LIKE ?)`
    params.push(`%${search}%`, `%${search}%`)
  }
  
  query += ` GROUP BY p.id ORDER BY p.sort_weight DESC, p.updated_at DESC`
  query += ` LIMIT ? OFFSET ?`
  params.push(limit, (page - 1) * limit)
  
  const products = await db.prepare(query).bind(...params).all()
  
  return {
    products,
    pagination: {
      page: parseInt(page),
      limit: parseInt(limit),
      total: await getProductCount(status, category, search)
    }
  }
})

// POST /admin/products - 創建商品
app.post('/admin/products', authenticateAdmin, requirePermission('product', 'create'), async (request) => {
  const data = await request.json()
  const adminId = request.auth.userId
  
  // 驗證必填欄位
  const validation = validateProductData(data)
  if (!validation.valid) {
    return new Response(JSON.stringify({ error: validation.message }), { status: 400 })
  }
  
  // 驗證SKU前綴唯一性
  const existingProduct = await db.prepare(`
    SELECT id FROM products WHERE sku_prefix = ?
  `).bind(data.sku_prefix).first()
  
  if (existingProduct) {
    return new Response(JSON.stringify({ error: 'SKU前綴已存在' }), { status: 400 })
  }
  
  const result = await db.prepare(`
    INSERT INTO products (
      sku_prefix, name, description, short_description,
      meta_title, meta_description, url_slug, tags,
      base_original_price, base_sale_price,
      base_bronze_price, base_silver_price, base_gold_price,
      main_image_url, image_urls, status,
      created_by, updated_by
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
  `).bind(
    data.sku_prefix,
    JSON.stringify(data.name),
    JSON.stringify(data.description),
    JSON.stringify(data.short_description || {}),
    JSON.stringify(data.meta_title || {}),
    JSON.stringify(data.meta_description || {}), 
    JSON.stringify(data.url_slug),
    JSON.stringify(data.tags || []),
    data.base_original_price,
    data.base_sale_price || null,
    data.base_bronze_price || null,
    data.base_silver_price || null,
    data.base_gold_price || null,
    data.main_image_url || null,
    JSON.stringify(data.image_urls || []),
    'draft',
    adminId,
    adminId
  ).run()
  
  const productId = result.meta.last_row_id
  
  // 創建分類關聯
  if (data.category_ids && data.category_ids.length > 0) {
    await createProductCategories(productId, data.category_ids)
  }
  
  // 生成商品網址QR Code
  await generateProductUrlQR(productId)
  
  return {
    success: true,
    product: await getProduct(productId)
  }
})
```

### 變體管理API
```javascript
// POST /admin/products/:id/variants - 創建商品變體
app.post('/admin/products/:id/variants', authenticateAdmin, requirePermission('product', 'create'), async (request) => {
  const productId = request.params.id
  const data = await request.json()
  
  const { level, level_name, options, parent_id = null } = data
  
  // 驗證層級限制
  if (level < 1 || level > 10) {
    return new Response(JSON.stringify({ error: '變體層級必須在1-10之間' }), { status: 400 })
  }
  
  // 批量創建變體選項
  const variantIds = []
  
  for (let i = 0; i < options.length; i++) {
    const option = options[i]
    
    // 驗證SKU代碼唯一性
    const existingVariant = await db.prepare(`
      SELECT id FROM product_variants 
      WHERE product_id = ? AND level = ? AND sku_code = ?
    `).bind(productId, level, option.sku_code).first()
    
    if (existingVariant) {
      return new Response(JSON.stringify({ 
        error: `SKU代碼 "${option.sku_code}" 在第${level}層已存在` 
      }), { status: 400 })
    }
    
    const result = await db.prepare(`
      INSERT INTO product_variants 
      (product_id, parent_id, level, level_name, option_name, sku_code, sort_order)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `).bind(
      productId,
      parent_id,
      level,
      JSON.stringify(level_name),
      JSON.stringify(option.option_name),
      option.sku_code,
      i + 1
    ).run()
    
    variantIds.push(result.meta.last_row_id)
  }
  
  return {
    success: true,
    variant_ids: variantIds
  }
})

// PUT /admin/products/:id/variants/reorder - 重新排序變體
app.put('/admin/products/:id/variants/reorder', authenticateAdmin, requirePermission('product', 'update'), async (request) => {
  const productId = request.params.id
  const { reorder_data } = await request.json()
  
  // reorder_data format: [{ variant_id, sort_order, level_sort_order }]
  
  for (const item of reorder_data) {
    await db.prepare(`
      UPDATE product_variants 
      SET sort_order = ?, level_sort_order = ?, updated_at = CURRENT_TIMESTAMP
      WHERE id = ? AND product_id = ?
    `).bind(item.sort_order, item.level_sort_order, item.variant_id, productId).run()
  }
  
  return { success: true }
})
```

### SKU管理API
```javascript
// POST /admin/products/:id/skus/generate - 生成所有可能的SKU
app.post('/admin/products/:id/skus/generate', authenticateAdmin, requirePermission('product', 'create'), async (request) => {
  const productId = request.params.id
  
  const product = await getProduct(productId)
  const variants = await getProductVariants(productId)
  
  // 生成所有變體組合
  const combinations = generateAllVariantCombinations(variants)
  
  const generatedSKUs = []
  
  for (const combo of combinations) {
    const sku = generateSKU(product, combo.variantPath)
    
    // 檢查SKU是否已存在
    const existing = await db.prepare(`
      SELECT id FROM product_skus WHERE sku = ?
    `).bind(sku).first()
    
    if (!existing) {
      const result = await db.prepare(`
        INSERT INTO product_skus (product_id, sku, variant_path, is_active)
        VALUES (?, ?, ?, 1)
      `).bind(productId, sku, JSON.stringify(combo.variantPath)).run()
      
      const skuId = result.meta.last_row_id
      
      // 生成SKU QR Code
      await generateSKUQR(skuId)
      
      generatedSKUs.push({
        id: skuId,
        sku,
        variant_path: combo.variantPath
      })
    }
  }
  
  return {
    success: true,
    generated_skus: generatedSKUs
  }
})

// PUT /admin/products/:id/skus/:sku_id - 更新SKU設定
app.put('/admin/products/:id/skus/:sku_id', authenticateAdmin, requirePermission('product', 'update'), async (request) => {
  const productId = request.params.id
  const skuId = request.params.sku_id
  const data = await request.json()
  const adminId = request.auth.userId
  
  const sku = await getSKU(skuId)
  if (!sku || sku.product_id !== parseInt(productId)) {
    return new Response(JSON.stringify({ error: 'SKU不存在' }), { status: 404 })
  }
  
  // 更新價格並記錄歷史
  const priceFields = ['original_price', 'sale_price', 'bronze_price', 'silver_price', 'gold_price']
  
  for (const field of priceFields) {
    if (data[field] !== undefined && data[field] !== sku[field]) {
      await recordPriceHistory(
        productId, 
        skuId, 
        field.replace('_price', ''), 
        sku[field], 
        data[field], 
        data.change_reason || 'Manual update',
        adminId
      )
    }
  }
  
  await db.prepare(`
    UPDATE product_skus 
    SET original_price = ?, sale_price = ?, bronze_price = ?, silver_price = ?, gold_price = ?,
        image_url = ?, is_active = ?, updated_at = CURRENT_TIMESTAMP
    WHERE id = ?
  `).bind(
    data.original_price,
    data.sale_price, 
    data.bronze_price,
    data.silver_price,
    data.gold_price,
    data.image_url,
    data.is_active,
    skuId
  ).run()
  
  return { success: true }
})
```

## 前端組件設計

### 商品編輯頁面主組件
```jsx
// src/pages/admin/ProductEdit.jsx
import { useState, useEffect } from 'react'
import { Form, Input, Select, InputNumber, Upload, Button, message, Tabs } from 'antd'
import { PlusOutlined } from '@ant-design/icons'
import ProductVariantManager from './components/ProductVariantManager'
import ProductSKUManager from './components/ProductSKUManager'

const ProductEdit = ({ productId }) => {
  const [form] = Form.useForm()
  const [loading, setLoading] = useState(false)
  const [product, setProduct] = useState(null)
  const [activeTab, setActiveTab] = useState('basic')
  
  useEffect(() => {
    if (productId) {
      loadProduct()
    }
  }, [productId])
  
  const loadProduct = async () => {
    try {
      const response = await fetch(`/admin/products/${productId}`)
      const result = await response.json()
      setProduct(result)
      form.setFieldsValue(result)
    } catch (error) {
      message.error('載入商品失敗')
    }
  }
  
  const handleSave = async (values) => {
    setLoading(true)
    try {
      const url = productId ? `/admin/products/${productId}` : '/admin/products'
      const method = productId ? 'PUT' : 'POST'
      
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(values)
      })
      
      const result = await response.json()
      
      if (result.success) {
        message.success('商品保存成功')
        if (!productId) {
          window.location.href = `/admin/products/${result.product.id}/edit`
        }
      } else {
        message.error(result.error || '保存失敗')
      }
    } catch (error) {
      message.error('保存失敗')
    } finally {
      setLoading(false)
    }
  }
  
  const tabItems = [
    {
      key: 'basic',
      label: '基本資料',
      children: <BasicInfoTab form={form} product={product} />
    },
    {
      key: 'variants',
      label: '商品變體',
      disabled: !productId,
      children: <ProductVariantManager productId={productId} />
    },
    {
      key: 'skus',
      label: 'SKU管理',
      disabled: !productId,
      children: <ProductSKUManager productId={productId} />
    },
    {
      key: 'seo',
      label: 'SEO設定',
      children: <SEOTab form={form} product={product} />
    }
  ]
  
  return (
    <div className="product-edit-page">
      <Form form={form} layout="vertical" onFinish={handleSave}>
        <Tabs
          activeKey={activeTab}
          onChange={setActiveTab}
          items={tabItems}
        />
        
        <div className="form-actions">
          <Button type="primary" htmlType="submit" loading={loading}>
            {productId ? '更新商品' : '創建商品'}
          </Button>
          <Button onClick={() => window.history.back()}>
            取消
          </Button>
        </div>
      </Form>
    </div>
  )
}

export default ProductEdit
```

### 商品變體管理組件
```jsx
// src/pages/admin/components/ProductVariantManager.jsx
import { useState, useEffect } from 'react'
import { Card, Button, Tree, Modal, Form, Input, Space, message } from 'antd'
import { PlusOutlined, DragOutlined, EditOutlined, DeleteOutlined } from '@ant-design/icons'
import { DndProvider } from 'react-dnd'
import { HTML5Backend } from 'react-dnd-html5-backend'
import DraggableVariantNode from './DraggableVariantNode'

const ProductVariantManager = ({ productId }) => {
  const [variants, setVariants] = useState([])
  const [treeData, setTreeData] = useState([])
  const [modalVisible, setModalVisible] = useState(false)
  const [editingLevel, setEditingLevel] = useState(null)
  const [form] = Form.useForm()
  
  useEffect(() => {
    if (productId) {
      loadVariants()
    }
  }, [productId])
  
  const loadVariants = async () => {
    try {
      const response = await fetch(`/admin/products/${productId}/variants`)
      const result = await response.json()
      setVariants(result)
      setTreeData(buildVariantTree(result))
    } catch (error) {
      message.error('載入變體失敗')
    }
  }
  
  const buildVariantTree = (variants) => {
    // 將扁平的變體數據轉換為樹狀結構
    const levels = {}
    
    variants.forEach(variant => {
      if (!levels[variant.level]) {
        levels[variant.level] = {
          key: `level-${variant.level}`,
          title: variant.level_name,
          level: variant.level,
          children: []
        }
      }
      
      levels[variant.level].children.push({
        key: variant.id,
        title: variant.option_name,
        sku_code: variant.sku_code,
        sort_order: variant.sort_order,
        isOption: true
      })
    })
    
    return Object.values(levels).sort((a, b) => a.level - b.level)
  }
  
  const handleAddLevel = () => {
    const nextLevel = Object.keys(variants.reduce((acc, v) => {
      acc[v.level] = true
      return acc
    }, {})).length + 1
    
    if (nextLevel > 10) {
      message.error('最多只能設定10層變體')
      return
    }
    
    setEditingLevel({ level: nextLevel, isNew: true })
    setModalVisible(true)
    form.resetFields()
  }
  
  const handleSaveLevel = async (values) => {
    try {
      const response = await fetch(`/admin/products/${productId}/variants`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          level: editingLevel.level,
          level_name: values.level_name,
          options: values.options
        })
      })
      
      const result = await response.json()
      
      if (result.success) {
        message.success('變體層級保存成功')
        setModalVisible(false)
        loadVariants()
      } else {
        message.error(result.error)
      }
    } catch (error) {
      message.error('保存失敗')
    }
  }
  
  const handleReorderVariants = async (dragInfo) => {
    try {
      const response = await fetch(`/admin/products/${productId}/variants/reorder`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          reorder_data: dragInfo
        })
      })
      
      if (response.ok) {
        loadVariants()
      }
    } catch (error) {
      message.error('排序失敗')
    }
  }
  
  return (
    <DndProvider backend={HTML5Backend}>
      <Card title="商品變體管理" 
            extra={
              <Button type="primary" icon={<PlusOutlined />} onClick={handleAddLevel}>
                新增變體層級
              </Button>
            }>
        
        <div className="variant-tree">
          {treeData.map(level => (
            <Card key={level.key} size="small" className="level-card">
              <div className="level-header">
                <span className="level-title">
                  第{level.level}層：{level.title}
                </span>
                <Space>
                  <Button size="small" icon={<EditOutlined />} />
                  <Button size="small" icon={<DeleteOutlined />} danger />
                </Space>
              </div>
              
              <div className="level-options">
                {level.children.map((option, index) => (
                  <DraggableVariantNode
                    key={option.key}
                    option={option}
                    index={index}
                    level={level.level}
                    onReorder={handleReorderVariants}
                  />
                ))}
              </div>
            </Card>
          ))}
        </div>
        
        <Modal
          title={editingLevel?.isNew ? '新增變體層級' : '編輯變體層級'}
          open={modalVisible}
          onCancel={() => setModalVisible(false)}
          onOk={() => form.submit()}
          width={800}
        >
          <VariantLevelForm 
            form={form} 
            onFinish={handleSaveLevel}
            initialValues={editingLevel}
          />
        </Modal>
        
      </Card>
    </DndProvider>
  )
}

export default ProductVariantManager
```

### SKU管理組件
```jsx
// src/pages/admin/components/ProductSKUManager.jsx  
import { useState, useEffect } from 'react'
import { Table, Button, InputNumber, Select, Upload, Image, QRCode, message } from 'antd'
import { PlusOutlined, QrcodeOutlined } from '@ant-design/icons'

const ProductSKUManager = ({ productId }) => {
  const [skus, setSKUs] = useState([])
  const [loading, setLoading] = useState(false)
  const [product, setProduct] = useState(null)
  
  useEffect(() => {
    if (productId) {
      loadSKUs()
      loadProduct()
    }
  }, [productId])
  
  const loadSKUs = async () => {
    try {
      const response = await fetch(`/admin/products/${productId}/skus`)
      const result = await response.json()
      setSKUs(result)
    } catch (error) {
      message.error('載入SKU失敗')
    }
  }
  
  const loadProduct = async () => {
    try {
      const response = await fetch(`/admin/products/${productId}`)
      const result = await response.json()
      setProduct(result)
    } catch (error) {
      message.error('載入商品失敗')
    }
  }
  
  const handleGenerateSKUs = async () => {
    setLoading(true)
    try {
      const response = await fetch(`/admin/products/${productId}/skus/generate`, {
        method: 'POST'
      })
      
      const result = await response.json()
      
      if (result.success) {
        message.success(`成功生成 ${result.generated_skus.length} 個SKU`)
        loadSKUs()
      } else {
        message.error(result.error)
      }
    } catch (error) {
      message.error('生成SKU失敗')
    } finally {
      setLoading(false)
    }
  }
  
  const handleUpdateSKU = async (skuId, field, value) => {
    try {
      const response = await fetch(`/admin/products/${productId}/skus/${skuId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          [field]: value,
          change_reason: '手動調整'
        })
      })
      
      if (response.ok) {
        loadSKUs()
        message.success('更新成功')
      }
    } catch (error) {
      message.error('更新失敗')
    }
  }
  
  const columns = [
    {
      title: 'SKU',
      dataIndex: 'sku',
      width: 120,
      fixed: 'left'
    },
    {
      title: '變體組合',
      dataIndex: 'variant_path',
      render: (variantPath) => {
        // 解析變體路徑顯示組合信息
        return <VariantPathDisplay variantPath={variantPath} />
      }
    },
    {
      title: '成本價',
      dataIndex: 'cost_price',
      render: (price, record) => (
        <span>${price || product?.base_cost_price || 0}</span>
      )
    },
    {
      title: '原價',
      dataIndex: 'original_price',
      render: (price, record) => (
        <InputNumber
          size="small"
          value={price || product?.base_original_price}
          onChange={(value) => handleUpdateSKU(record.id, 'original_price', value)}
          formatter={value => `$ ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
          parser={value => value.replace(/\$\s?|(,*)/g, '')}
        />
      )
    },
    {
      title: '優惠價',
      dataIndex: 'sale_price',
      render: (price, record) => (
        <InputNumber
          size="small"
          value={price || product?.base_sale_price}
          onChange={(value) => handleUpdateSKU(record.id, 'sale_price', value)}
          formatter={value => `$ ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
          parser={value => value.replace(/\$\s?|(,*)/g, '')}
        />
      )
    },
    {
      title: '銅牌會員價',
      dataIndex: 'bronze_price',
      render: (price, record) => (
        <InputNumber
          size="small"
          value={price || product?.base_bronze_price}
          onChange={(value) => handleUpdateSKU(record.id, 'bronze_price', value)}
          formatter={value => `$ ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
          parser={value => value.replace(/\$\s?|(,*)/g, '')}
        />
      )
    },
    {
      title: '銀牌會員價',
      dataIndex: 'silver_price',
      render: (price, record) => (
        <InputNumber
          size="small"
          value={price || product?.base_silver_price}
          onChange={(value) => handleUpdateSKU(record.id, 'silver_price', value)}
          formatter={value => `$ ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
          parser={value => value.replace(/\$\s?|(,*)/g, '')}
        />
      )
    },
    {
      title: '黃金會員價',
      dataIndex: 'gold_price',
      render: (price, record) => (
        <InputNumber
          size="small"
          value={price || product?.base_gold_price}
          onChange={(value) => handleUpdateSKU(record.id, 'gold_price', value)}
          formatter={value => `$ ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
          parser={value => value.replace(/\$\s?|(,*)/g, '')}
        />
      )
    },
    {
      title: 'SKU圖片',
      dataIndex: 'image_url',
      render: (imageUrl, record) => (
        <div className="sku-image-upload">
          {imageUrl ? (
            <Image src={imageUrl} width={50} height={50} />
          ) : (
            <div className="upload-placeholder">無圖片</div>
          )}
          <Upload
            name="image"
            showUploadList={false}
            beforeUpload={() => false}
            onChange={(info) => {
              // 處理圖片上傳
              handleImageUpload(record.id, info.file)
            }}
          >
            <Button size="small" icon={<PlusOutlined />} />
          </Upload>
        </div>
      )
    },
    {
      title: 'QR Code',
      dataIndex: 'qr_code_url',
      render: (qrUrl, record) => (
        <div className="sku-qr">
          {qrUrl ? (
            <QRCode value={record.sku} size={50} />
          ) : (
            <Button 
              size="small" 
              icon={<QrcodeOutlined />}
              onClick={() => generateSKUQR(record.id)}
            >
              生成
            </Button>
          )}
        </div>
      )
    }
  ]
  
  return (
    <div className="sku-manager">
      <div className="sku-actions">
        <Button 
          type="primary" 
          icon={<PlusOutlined />}
          loading={loading}
          onClick={handleGenerateSKUs}
        >
          自動生成所有SKU
        </Button>
      </div>
      
      <Table
        dataSource={skus}
        columns={columns}
        rowKey="id"
        scroll={{ x: 1200 }}
        pagination={{
          pageSize: 20,
          showSizeChanger: true,
          showQuickJumper: true
        }}
      />
    </div>
  )
}

export default ProductSKUManager
```

## 前端商品頁面互動

### 商品變體選擇器
```jsx
// src/components/frontend/ProductVariantSelector.jsx
import { useState, useEffect } from 'react'
import { Radio, Image } from 'antd'
import { motion, AnimatePresence } from 'framer-motion'

const ProductVariantSelector = ({ product, onVariantChange }) => {
  const [selectedVariants, setSelectedVariants] = useState({})
  const [currentImage, setCurrentImage] = useState(product.main_image_url)
  const [variantTree, setVariantTree] = useState([])
  
  useEffect(() => {
    buildVariantTree()
  }, [product])
  
  const buildVariantTree = () => {
    // 構建前端用的變體選擇樹
    const tree = buildTreeFromVariants(product.variants)
    setVariantTree(tree)
  }
  
  const handleVariantSelect = (level, optionId, option) => {
    const newSelection = {
      ...selectedVariants,
      [level]: {
        id: optionId,
        option: option
      }
    }
    
    setSelectedVariants(newSelection)
    
    // 查找對應的SKU
    const sku = findMatchingSKU(newSelection)
    if (sku && sku.image_url) {
      setCurrentImage(sku.image_url)
    }
    
    onVariantChange(newSelection, sku)
  }
  
  const handleImageHover = (imageUrl, variantPath) => {
    // 滑鼠懸停圖片時自動選擇對應變體
    setCurrentImage(imageUrl)
    
    // 根據圖片對應的變體路徑自動設置選項
    const autoSelection = {}
    variantPath.forEach((variantId, index) => {
      const variant = findVariantById(variantId)
      autoSelection[variant.level] = {
        id: variantId,
        option: variant
      }
    })
    
    setSelectedVariants(autoSelection)
  }
  
  return (
    <div className="product-variant-selector">
      {/* 主圖區域 */}
      <div className="product-images">
        <AnimatePresence mode="wait">
          <motion.div
            key={currentImage}
            initial={{ opacity: 0, x: 20 }}
            animate={{ opacity: 1, x: 0 }}
            exit={{ opacity: 0, x: -20 }}
            transition={{ duration: 0.3 }}
            className="main-image"
          >
            <Image src={currentImage} alt={product.name} />
          </motion.div>
        </AnimatePresence>
        
        {/* 縮圖列表 */}
        <div className="thumbnail-list">
          {product.image_urls?.map((imageUrl, index) => (
            <div 
              key={index}
              className="thumbnail"
              onMouseEnter={() => {
                const correspondingSKU = findSKUByImage(imageUrl)
                if (correspondingSKU) {
                  handleImageHover(imageUrl, correspondingSKU.variant_path)
                }
              }}
            >
              <Image src={imageUrl} preview={false} />
            </div>
          ))}
        </div>
      </div>
      
      {/* 變體選擇區域 */}
      <div className="variant-options">
        {variantTree.map(level => (
          <div key={level.level} className="variant-level">
            <h4 className="level-title">{level.name}</h4>
            
            <Radio.Group
              value={selectedVariants[level.level]?.id}
              onChange={(e) => {
                const optionId = e.target.value
                const option = level.options.find(opt => opt.id === optionId)
                handleVariantSelect(level.level, optionId, option)
              }}
            >
              {level.options.map(option => (
                <Radio.Button 
                  key={option.id} 
                  value={option.id}
                  className="variant-option"
                >
                  {option.thumbnail && (
                    <div className="option-thumbnail">
                      <Image src={option.thumbnail} preview={false} />
                    </div>
                  )}
                  <span className="option-name">{option.name}</span>
                  {option.sku && (
                    <span className="option-sku">({option.sku})</span>
                  )}
                </Radio.Button>
              ))}
            </Radio.Group>
          </div>
        ))}
      </div>
      
      {/* 價格顯示 */}
      <div className="product-price">
        <PriceDisplay 
          product={product}
          selectedSKU={findMatchingSKU(selectedVariants)}
        />
      </div>
    </div>
  )
}

export default ProductVariantSelector
```

## 智能排序系統

### 用戶行為追蹤
```javascript
// 用戶瀏覽行為記錄 (將在用戶追蹤模組詳細討論)
const trackUserProductView = async (userId, productId, categoryIds, viewDuration) => {
  await db.prepare(`
    INSERT INTO user_behavior_logs (
      user_id, product_id, category_ids, action_type, 
      duration, created_at
    ) VALUES (?, ?, ?, 'view', ?, CURRENT_TIMESTAMP)
  `).bind(userId, productId, JSON.stringify(categoryIds), viewDuration).run()
}

// 智能商品排序
const getPersonalizedProductSort = async (userId = null, categoryId = null) => {
  if (!userId) {
    // 新用戶排序：熱門商品 + 高評分商品
    return `
      ORDER BY 
        (SELECT COUNT(*) FROM user_behavior_logs WHERE product_id = p.id AND action_type = 'view') DESC,
        (SELECT AVG(rating) FROM product_reviews WHERE product_id = p.id) DESC NULLS LAST,
        p.sort_weight DESC,
        p.created_at DESC
    `
  }
  
  // 基於用戶歷史的個性化排序
  return `
    ORDER BY 
      CASE WHEN pc.category_id IN (
        SELECT DISTINCT JSON_EXTRACT(category_ids, '$[*]') 
        FROM user_behavior_logs 
        WHERE user_id = ${userId} AND action_type = 'view'
        GROUP BY JSON_EXTRACT(category_ids, '$[*]')
        ORDER BY COUNT(*) DESC
        LIMIT 3
      ) THEN 1 ELSE 2 END,
      
      CASE WHEN p.id IN (
        SELECT product_id FROM order_items oi
        JOIN orders o ON oi.order_id = o.id
        WHERE o.user_id = ${userId}
      ) THEN 1 ELSE 2 END,
      
      p.sort_weight DESC,
      p.updated_at DESC
  `
}
```

## 多語言翻譯檢查

### 翻譯完整性驗證
```javascript
// 檢查商品多語言完整性
const validateProductTranslations = (product, requiredLocales = ['zh-TW', 'en']) => {
  const multilingualFields = ['name', 'description', 'short_description', 'meta_title', 'meta_description', 'url_slug']
  const missingTranslations = []
  
  multilingualFields.forEach(field => {
    if (product[field]) {
      requiredLocales.forEach(locale => {
        if (!product[field][locale] || product[field][locale].trim() === '') {
          missingTranslations.push({
            field,
            locale,
            message: `${field} 缺少 ${locale} 翻譯`
          })
        }
      })
    }
  })
  
  return {
    isComplete: missingTranslations.length === 0,
    missingTranslations
  }
}

// 批量檢查商品翻譯狀態
const checkAllProductsTranslations = async () => {
  const products = await db.prepare(`
    SELECT id, name, description, short_description, meta_title, meta_description, url_slug
    FROM products 
    WHERE status != 'draft'
  `).all()
  
  const incompleteProducts = []
  
  products.forEach(product => {
    const validation = validateProductTranslations(product)
    if (!validation.isComplete) {
      incompleteProducts.push({
        productId: product.id,
        productName: product.name['zh-TW'] || product.name['en'] || 'Unnamed Product',
        missingTranslations: validation.missingTranslations
      })
    }
  })
  
  return incompleteProducts
}
```

## 系統設定需求記錄

基於商品管理模組，以下設定項目需要在系統設定模組中實現：

### 商品相關系統設定
1. **圖片設定**
   - 商品主圖建議尺寸顯示設定
   - 支援的圖片格式列表 (SVG, PNG, WebP)
   - 圖片壓縮品質設定
   - 縮圖自動生成設定

2. **SKU設定** 
   - SKU代碼字元限制設定
   - SKU重複檢查開關
   - QR Code生成設定

3. **多語言設定**
   - 啟用的語言列表
   - 預設語言設定  
   - 必填語言設定
   - 翻譯完整性檢查開關

4. **價格設定**
   - 價格歷史記錄開關
   - FIFO成本計算開關
   - 會員價格顯示邏輯

5. **排序設定**
   - 智能排序開關
   - 新用戶預設排序方式
   - 用戶行為權重設定

此商品管理系統提供了完整的變體管理、多語言支援、智能價格體系和前端互動功能。所有代碼都遵循300行限制，採用模組化設計，便於維護和擴展。