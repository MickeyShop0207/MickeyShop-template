# 訂單管理模組 (Order Management System)

## 模組概述
訂單管理系統是電商後台的核心模組，負責處理從下單到完成的完整訂單生命週期，包含訂單處理、狀態管理、付款追蹤、物流整合、退換貨處理等功能。

## 訂單狀態體系

### 1. 付款狀態定義（基於0.md需求）
```typescript
enum PaymentStatus {
  UNPAID = 'unpaid',                 // 訂單未付款（綠界、LINE Pay還沒收到錢，我們還沒收到）
  PAID = 'paid',                     // 訂單已付款（綠界、LINE Pay已經收到錢，我們還沒收到）
  TRANSFERRED = 'transferred',       // 訂單已撥款（綠界、LINE Pay已經收到錢，我們還未確認）
  CONFIRMED = 'confirmed',           // 訂單已入帳（綠界、LINE Pay已經收到錢，我們已確認）
  PARTIAL_PAID = 'partial_paid',     // 部分付款（分期付款或預付訂金）
  REFUNDED = 'refunded',            // 已退款
  PARTIAL_REFUNDED = 'partial_refunded', // 部分退款
  FAILED = 'failed',                // 付款失敗
  CANCELLED = 'cancelled'           // 付款取消
}
```

### 2. 完整訂單狀態系統
```typescript
enum OrderStatus {
  // 初始狀態
  PENDING = 'pending',               // 待確認（剛建立，等待付款）
  
  // 付款處理階段
  PAYMENT_PENDING = 'payment_pending',     // 等待付款
  PAYMENT_PROCESSING = 'payment_processing', // 付款處理中
  PAYMENT_FAILED = 'payment_failed',       // 付款失敗
  
  // 訂單確認階段
  CONFIRMED = 'confirmed',           // 已確認（付款成功，訂單生效）
  ON_HOLD = 'on_hold',              // 暫緩處理（需人工確認或庫存不足）
  
  // 處理階段
  PROCESSING = 'processing',         // 處理中（準備出貨）
  PICKING = 'picking',              // 撿貨中
  PACKED = 'packed',                // 已包裝
  
  // 物流階段
  SHIPPED = 'shipped',              // 已出貨
  IN_TRANSIT = 'in_transit',        // 運送中
  OUT_FOR_DELIVERY = 'out_for_delivery', // 配送中
  DELIVERED = 'delivered',          // 已送達
  
  // 完成階段
  COMPLETED = 'completed',          // 已完成
  
  // 異常處理階段
  CANCELLED = 'cancelled',          // 已取消
  REFUNDED = 'refunded',           // 已退款
  RETURNED = 'returned',           // 已退貨
  EXCHANGED = 'exchanged',         // 已換貨
  
  // 特殊狀態
  DISPUTED = 'disputed',           // 爭議中
  FRAUD = 'fraud'                  // 疑似詐騙
}

enum OrderType {
  NORMAL = 'normal',               // 一般訂單
  PRE_ORDER = 'pre_order',         // 預購訂單
  SUBSCRIPTION = 'subscription',    // 訂閱訂單
  GIFT = 'gift',                   // 禮品訂單
  SAMPLE = 'sample',               // 試用品訂單
  B2B = 'b2b',                     // 企業訂單
  WHOLESALE = 'wholesale',         // 批發訂單
  DROPSHIPPING = 'dropshipping'    // 直送訂單
}

enum OrderPriority {
  LOW = 'low',                     // 低優先級
  NORMAL = 'normal',               // 一般優先級
  HIGH = 'high',                   // 高優先級
  URGENT = 'urgent',               // 緊急訂單
  VIP = 'vip'                      // VIP客戶訂單
}
```

## 核心資料結構

### 1. 訂單主表
```typescript
interface Order {
  id: number;
  order_number: string;              // 訂單編號（唯一）
  parent_order_id?: number;          // 父訂單ID（用於拆單）
  
  // 基本資訊
  type: OrderType;
  status: OrderStatus;
  payment_status: PaymentStatus;
  priority: OrderPriority;
  
  // 客戶資訊
  customer_id?: number;              // 會員ID（guest為null）
  customer_type: 'member' | 'guest'; // 客戶類型
  customer_email: string;
  customer_phone?: string;
  customer_notes?: string;           // 客戶備註
  
  // 收件資訊
  shipping_address: Address;
  billing_address?: Address;         // 帳單地址（可與收件地址不同）
  
  // 商品資訊
  items: OrderItem[];               // 訂單商品明細
  
  // 金額計算
  subtotal: number;                 // 小計（商品總金額）
  shipping_fee: number;             // 運費
  insurance_fee: number;            // 保險費
  handling_fee: number;             // 手續費
  tax_amount: number;               // 稅額
  discount_amount: number;          // 折扣金額
  coupon_discount: number;          // 優惠券折扣
  point_discount: number;           // 點數折扣
  total_amount: number;             // 總金額
  paid_amount: number;              // 已付金額
  refunded_amount: number;          // 已退金額
  
  // 付款資訊
  payment_method: string;           // 付款方式
  payment_gateway?: string;         // 付款閘道
  payment_reference?: string;       // 付款參考號
  payment_date?: Date;              // 付款時間
  payment_deadline?: Date;          // 付款期限
  
  // 物流資訊
  shipping_method: string;          // 配送方式
  shipping_carrier?: string;        // 物流商
  tracking_number?: string;         // 追蹤號碼
  estimated_delivery?: Date;        // 預估送達時間
  actual_delivery?: Date;           // 實際送達時間
  
  // 優惠資訊
  coupons_used?: CouponUsage[];     // 使用的優惠券
  points_used?: number;             // 使用的點數
  points_earned?: number;           // 獲得的點數
  
  // 發票資訊
  invoice_type: InvoiceType;        // 發票類型
  invoice_data?: InvoiceData;       // 發票資料
  invoice_number?: string;          // 發票號碼
  invoice_date?: Date;              // 開立日期
  
  // 特殊處理
  is_gift: boolean;                 // 是否為禮品
  gift_message?: string;            // 禮品訊息
  gift_wrapping?: boolean;          // 是否需要包裝
  special_instructions?: string;     // 特殊指示
  internal_notes?: string;          // 內部備註
  
  // 風險控制
  risk_score?: number;              // 風險評分 (0-100)
  fraud_check_status?: FraudStatus; // 詐騙檢查狀態
  manual_review_required: boolean;   // 是否需人工審核
  
  // 時間戳記
  created_at: Date;
  updated_at: Date;
  confirmed_at?: Date;              // 確認時間
  shipped_at?: Date;                // 出貨時間
  delivered_at?: Date;              // 送達時間
  completed_at?: Date;              // 完成時間
  cancelled_at?: Date;              // 取消時間
  
  // 系統欄位
  created_by?: number;              // 建立者（後台建立時）
  assigned_to?: number;             // 負責人員
  tags?: string[];                  // 標籤
  source: OrderSource;              // 訂單來源
  channel: string;                  // 銷售渠道
}

enum OrderSource {
  WEBSITE = 'website',              // 官方網站
  MOBILE_APP = 'mobile_app',        // 手機APP
  ADMIN = 'admin',                  // 後台建立
  API = 'api',                      // API建立
  PHONE = 'phone',                  // 電話訂購
  STORE = 'store',                  // 門市
  MARKETPLACE = 'marketplace'       // 第三方平台
}

enum FraudStatus {
  PENDING = 'pending',              // 待檢查
  APPROVED = 'approved',            // 通過
  REJECTED = 'rejected',            // 拒絕
  MANUAL_REVIEW = 'manual_review'   // 需人工審核
}
```

### 2. 訂單商品明細
```typescript
interface OrderItem {
  id: number;
  order_id: number;
  
  // 商品資訊
  product_id: number;
  variant_id?: number;              // 商品規格ID
  sku: string;                      // 商品SKU
  product_name: string;             // 商品名稱（快照）
  variant_name?: string;            // 規格名稱（快照）
  product_image?: string;           // 商品圖片（快照）
  
  // 數量與價格
  quantity: number;                 // 數量
  unit_price: number;               // 單價（快照）
  original_price: number;           // 原價（快照）
  discount_amount: number;          // 商品折扣金額
  total_price: number;              // 小計
  
  // 商品屬性（快照）
  product_attributes?: {
    weight: number;                 // 重量
    dimensions?: {                  // 尺寸
      length: number;
      width: number;
      height: number;
    };
    [key: string]: any;
  };
  
  // 庫存管理
  stock_reserved: boolean;          // 是否已預留庫存
  stock_allocated: boolean;         // 是否已分配庫存
  
  // 特殊處理
  is_gift: boolean;                 // 是否為贈品
  is_sample: boolean;               // 是否為試用品
  gift_from_item_id?: number;       // 來自哪個商品的贈品
  
  // 狀態追蹤
  status: OrderItemStatus;          // 商品狀態
  shipped_quantity: number;         // 已出貨數量
  delivered_quantity: number;       // 已送達數量
  returned_quantity: number;        // 已退貨數量
  
  created_at: Date;
  updated_at: Date;
}

enum OrderItemStatus {
  PENDING = 'pending',              // 待處理
  IN_STOCK = 'in_stock',           // 有庫存
  OUT_OF_STOCK = 'out_of_stock',   // 缺貨
  BACKORDERED = 'backordered',     // 缺貨預訂
  PICKED = 'picked',               // 已撿貨
  PACKED = 'packed',               // 已包裝
  SHIPPED = 'shipped',             // 已出貨
  DELIVERED = 'delivered',         // 已送達
  RETURNED = 'returned',           // 已退貨
  EXCHANGED = 'exchanged'          // 已換貨
}
```

### 3. 地址資料結構
```typescript
interface Address {
  first_name: string;
  last_name: string;
  company?: string;
  address_line1: string;
  address_line2?: string;
  city: string;
  state: string;
  postal_code: string;
  country: string;
  phone?: string;
  email?: string;
  delivery_instructions?: string;    // 配送指示
  is_residential: boolean;          // 是否為住宅地址
}
```

### 4. 發票資料結構
```typescript
enum InvoiceType {
  PERSONAL = 'personal',            // 個人發票
  COMPANY = 'company',              // 公司發票
  DONATION = 'donation',            // 捐贈發票
  CARRIER = 'carrier'               // 載具發票
}

interface InvoiceData {
  type: InvoiceType;
  
  // 公司發票
  company_name?: string;
  tax_id?: string;                  // 統一編號
  
  // 載具發票
  carrier_type?: string;            // 載具類型
  carrier_id?: string;              // 載具號碼
  
  // 捐贈發票
  donation_code?: string;           // 愛心碼
  
  // 發票地址
  address?: Address;
}
```

## 訂單狀態流程管理

### 1. 狀態轉換規則
```typescript
interface OrderStatusTransition {
  id: number;
  from_status: OrderStatus;
  to_status: OrderStatus;
  condition?: string;               // 轉換條件
  required_permission?: string;     // 需要的權限
  auto_transition: boolean;         // 是否自動轉換
  notification_required: boolean;    // 是否需要通知
  webhook_trigger?: string;         // 觸發的Webhook
  created_at: Date;
}

// 狀態轉換日誌
interface OrderStatusHistory {
  id: number;
  order_id: number;
  from_status?: OrderStatus;
  to_status: OrderStatus;
  reason?: string;                  // 轉換原因
  notes?: string;                   // 備註
  changed_by?: number;              // 操作人員
  automated: boolean;               // 是否自動轉換
  metadata?: {                      // 額外資料
    [key: string]: any;
  };
  created_at: Date;
}
```

### 2. 自動化規則引擎
```typescript
interface OrderAutomationRule {
  id: number;
  name: string;
  description?: string;
  is_active: boolean;
  
  // 觸發條件
  trigger_event: OrderEvent;        // 觸發事件
  conditions: AutomationCondition[]; // 執行條件
  
  // 執行動作
  actions: AutomationAction[];      // 執行動作
  
  // 執行控制
  priority: number;                 // 優先級
  max_executions?: number;          // 最大執行次數
  execution_count: number;          // 已執行次數
  last_executed?: Date;             // 最後執行時間
  
  created_at: Date;
  updated_at: Date;
}

enum OrderEvent {
  ORDER_CREATED = 'order_created',
  PAYMENT_RECEIVED = 'payment_received',
  PAYMENT_FAILED = 'payment_failed',
  STATUS_CHANGED = 'status_changed',
  ITEM_SHIPPED = 'item_shipped',
  DELIVERY_CONFIRMED = 'delivery_confirmed',
  RETURN_REQUESTED = 'return_requested',
  TIMEOUT_REACHED = 'timeout_reached'
}

interface AutomationCondition {
  field: string;                    // 檢查欄位
  operator: 'eq' | 'ne' | 'gt' | 'lt' | 'gte' | 'lte' | 'in' | 'not_in' | 'contains';
  value: any;                       // 比較值
}

interface AutomationAction {
  type: ActionType;
  parameters: {
    [key: string]: any;
  };
}

enum ActionType {
  CHANGE_STATUS = 'change_status',
  SEND_EMAIL = 'send_email',
  SEND_SMS = 'send_sms',
  SEND_LINE = 'send_line',
  CREATE_SHIPMENT = 'create_shipment',
  RESERVE_STOCK = 'reserve_stock',
  GENERATE_INVOICE = 'generate_invoice',
  UPDATE_FIELD = 'update_field',
  CALL_WEBHOOK = 'call_webhook',
  ASSIGN_TO_USER = 'assign_to_user',
  ADD_TAG = 'add_tag',
  CREATE_TASK = 'create_task'
}
```

## 批次處理系統

### 1. 批次操作管理
```typescript
interface BatchOperation {
  id: number;
  name: string;
  type: BatchOperationType;
  status: BatchStatus;
  
  // 選擇條件
  selection_criteria: {
    order_ids?: number[];           // 指定訂單ID
    filters?: {                     // 篩選條件
      status?: OrderStatus[];
      payment_status?: PaymentStatus[];
      date_range?: {
        start: Date;
        end: Date;
      };
      customer_ids?: number[];
      [key: string]: any;
    };
  };
  
  // 操作參數
  operation_params: {
    [key: string]: any;
  };
  
  // 執行結果
  total_orders: number;             // 總訂單數
  processed_orders: number;         // 已處理數
  successful_orders: number;        // 成功數
  failed_orders: number;            // 失敗數
  error_details?: {                 // 錯誤詳情
    order_id: number;
    error_message: string;
  }[];
  
  // 執行資訊
  started_by: number;               // 執行人員
  started_at?: Date;                // 開始時間
  completed_at?: Date;              // 完成時間
  estimated_completion?: Date;       // 預估完成時間
  
  created_at: Date;
  updated_at: Date;
}

enum BatchOperationType {
  STATUS_UPDATE = 'status_update',  // 狀態更新
  BULK_SHIP = 'bulk_ship',         // 批次出貨
  GENERATE_INVOICES = 'generate_invoices', // 批次開發票
  EXPORT_DATA = 'export_data',     // 資料匯出
  APPLY_DISCOUNT = 'apply_discount', // 批次折扣
  SEND_NOTIFICATION = 'send_notification', // 批次通知
  TAG_UPDATE = 'tag_update',       // 標籤更新
  ASSIGN_STAFF = 'assign_staff'    // 指派人員
}

enum BatchStatus {
  PENDING = 'pending',
  RUNNING = 'running',
  COMPLETED = 'completed',
  FAILED = 'failed',
  CANCELLED = 'cancelled'
}
```

## 退換貨管理

### 1. 退貨/換貨申請
```typescript
interface ReturnRequest {
  id: number;
  return_number: string;            // 退換貨單號
  order_id: number;
  customer_id?: number;
  
  // 申請資訊
  type: ReturnType;
  status: ReturnStatus;
  reason: ReturnReason;
  description: string;              // 詳細說明
  images?: string[];                // 問題照片
  
  // 商品資訊
  items: ReturnItem[];
  
  // 金額計算
  refund_amount: number;            // 退款金額
  restocking_fee: number;           // 重新上架費
  return_shipping_fee: number;      // 退貨運費
  
  // 處理資訊
  approved_by?: number;             // 審核人員
  approved_at?: Date;               // 審核時間
  approval_notes?: string;          // 審核備註
  
  // 物流資訊
  return_address?: Address;         // 退貨地址
  return_tracking?: string;         // 退貨追蹤號
  received_at?: Date;               // 收到退貨時間
  
  // 處理結果
  refunded_at?: Date;               // 退款時間
  refund_reference?: string;        // 退款參考號
  replacement_order_id?: number;    // 換貨新訂單ID
  
  created_at: Date;
  updated_at: Date;
}

enum ReturnType {
  RETURN = 'return',                // 退貨
  EXCHANGE = 'exchange',            // 換貨
  REPAIR = 'repair'                 // 維修
}

enum ReturnStatus {
  PENDING = 'pending',              // 待審核
  APPROVED = 'approved',            // 已核准
  REJECTED = 'rejected',            // 已拒絕
  SHIPPED = 'shipped',              // 已寄回
  RECEIVED = 'received',            // 已收到
  PROCESSED = 'processed',          // 已處理
  COMPLETED = 'completed',          // 已完成
  CANCELLED = 'cancelled'           // 已取消
}

enum ReturnReason {
  DEFECTIVE = 'defective',          // 商品瑕疵
  WRONG_ITEM = 'wrong_item',        // 商品錯誤
  SIZE_ISSUE = 'size_issue',        // 尺寸問題
  COLOR_ISSUE = 'color_issue',      // 顏色問題
  NOT_AS_DESCRIBED = 'not_as_described', // 與描述不符
  DAMAGED_IN_SHIPPING = 'damaged_in_shipping', // 運送損壞
  CHANGED_MIND = 'changed_mind',    // 改變心意
  ALLERGIC_REACTION = 'allergic_reaction', // 過敏反應
  EXPIRED = 'expired',              // 過期
  OTHER = 'other'                   // 其他
}

interface ReturnItem {
  id: number;
  return_request_id: number;
  order_item_id: number;
  
  // 商品資訊
  product_id: number;
  variant_id?: number;
  sku: string;
  product_name: string;
  
  // 退換資訊
  quantity: number;                 // 退換數量
  unit_price: number;               // 單價
  refund_amount: number;            // 退款金額
  condition: ItemCondition;         // 商品狀態
  
  created_at: Date;
  updated_at: Date;
}

enum ItemCondition {
  NEW = 'new',                      // 全新
  OPENED = 'opened',                // 已開封
  USED = 'used',                    // 已使用
  DAMAGED = 'damaged',              // 損壞
  DEFECTIVE = 'defective'           // 瑕疵
}
```

## 訂單分析與報表

### 1. 訂單統計資料
```typescript
interface OrderStatistics {
  id: number;
  date: Date;                       // 統計日期
  period_type: 'daily' | 'weekly' | 'monthly' | 'yearly';
  
  // 訂單數量統計
  total_orders: number;             // 總訂單數
  new_orders: number;               // 新訂單數
  completed_orders: number;         // 完成訂單數
  cancelled_orders: number;         // 取消訂單數
  refunded_orders: number;          // 退款訂單數
  
  // 金額統計
  total_revenue: number;            // 總營收
  gross_revenue: number;            // 毛營收
  net_revenue: number;              // 淨營收
  average_order_value: number;      // 平均訂單金額
  
  // 客戶統計
  unique_customers: number;         // 獨立客戶數
  new_customers: number;            // 新客戶數
  returning_customers: number;      // 回購客戶數
  
  // 商品統計
  total_items_sold: number;         // 總銷售商品數
  unique_products_sold: number;     // 獨立商品數
  
  // 配送統計
  orders_shipped: number;           // 已出貨訂單數
  orders_delivered: number;         // 已送達訂單數
  average_delivery_time: number;    // 平均配送時間（小時）
  
  // 退換貨統計
  return_requests: number;          // 退貨申請數
  exchange_requests: number;        // 換貨申請數
  return_rate: number;              // 退貨率
  
  created_at: Date;
}

interface OrderMetrics {
  id: number;
  metric_name: string;
  metric_value: number;
  metric_type: 'count' | 'amount' | 'percentage' | 'ratio' | 'time';
  dimension?: string;               // 維度（如：channel, region等）
  calculated_at: Date;
  created_at: Date;
}
```

## API 設計規格

### 1. 訂單管理 API
```typescript
// 訂單列表
GET /api/admin/orders
Query: {
  page?: number;
  limit?: number;
  status?: OrderStatus[];
  payment_status?: PaymentStatus[];
  type?: OrderType;
  priority?: OrderPriority;
  customer_id?: number;
  date_range?: {
    start: string;
    end: string;
  };
  search?: string;                  // 搜尋訂單號、客戶資訊等
  sort?: string;
  order?: 'asc' | 'desc';
  include?: string[];              // 包含相關資料
}

// 建立訂單（後台）
POST /api/admin/orders
Body: {
  customer_id?: number;
  customer_email: string;
  items: {
    product_id: number;
    variant_id?: number;
    quantity: number;
    unit_price?: number;           // 可自定義價格
  }[];
  shipping_address: Address;
  billing_address?: Address;
  payment_method?: string;
  shipping_method?: string;
  notes?: string;
  tags?: string[];
}

// 取得訂單詳情
GET /api/admin/orders/{id}
Query: {
  include?: string[];              // timeline,items,customer,payments,shipments等
}

// 更新訂單
PUT /api/admin/orders/{id}
Body: {
  status?: OrderStatus;
  priority?: OrderPriority;
  shipping_address?: Address;
  billing_address?: Address;
  notes?: string;
  tags?: string[];
  assigned_to?: number;
}

// 更新訂單狀態
PATCH /api/admin/orders/{id}/status
Body: {
  status: OrderStatus;
  reason?: string;
  notify_customer?: boolean;
}

// 更新付款狀態
PATCH /api/admin/orders/{id}/payment-status
Body: {
  payment_status: PaymentStatus;
  payment_reference?: string;
  payment_date?: Date;
  notes?: string;
}

// 訂單商品管理
GET /api/admin/orders/{id}/items
POST /api/admin/orders/{id}/items
PUT /api/admin/orders/{id}/items/{item_id}
DELETE /api/admin/orders/{id}/items/{item_id}

// 拆單處理
POST /api/admin/orders/{id}/split
Body: {
  items: {
    order_item_id: number;
    quantity: number;
  }[];
  reason?: string;
}

// 合併訂單
POST /api/admin/orders/merge
Body: {
  order_ids: number[];
  reason?: string;
}

// 複製訂單
POST /api/admin/orders/{id}/duplicate
Body: {
  copy_items?: boolean;
  copy_address?: boolean;
  copy_customer?: boolean;
}
```

### 2. 批次操作 API
```typescript
// 批次狀態更新
POST /api/admin/orders/batch/status-update
Body: {
  order_ids?: number[];
  filters?: OrderFilters;
  new_status: OrderStatus;
  reason?: string;
  notify_customers?: boolean;
}

// 批次出貨
POST /api/admin/orders/batch/ship
Body: {
  order_ids: number[];
  shipping_carrier: string;
  tracking_numbers?: {
    order_id: number;
    tracking_number: string;
  }[];
  ship_date?: Date;
}

// 批次匯出
POST /api/admin/orders/batch/export
Body: {
  order_ids?: number[];
  filters?: OrderFilters;
  format: 'csv' | 'excel' | 'pdf';
  fields?: string[];
  include_items?: boolean;
}

// 批次標籤管理
POST /api/admin/orders/batch/tags
Body: {
  order_ids: number[];
  action: 'add' | 'remove' | 'replace';
  tags: string[];
}

// 批次指派人員
POST /api/admin/orders/batch/assign
Body: {
  order_ids: number[];
  assigned_to: number;
  notes?: string;
}
```

### 3. 退換貨管理 API
```typescript
// 退換貨申請列表
GET /api/admin/returns
Query: {
  status?: ReturnStatus[];
  type?: ReturnType[];
  customer_id?: number;
  order_id?: number;
  date_range?: DateRange;
}

// 審核退換貨申請
PATCH /api/admin/returns/{id}/review
Body: {
  status: 'approved' | 'rejected';
  notes?: string;
  approved_amount?: number;
  restocking_fee?: number;
}

// 處理退款
POST /api/admin/returns/{id}/refund
Body: {
  amount: number;
  refund_method: string;
  notes?: string;
}

// 建立換貨訂單
POST /api/admin/returns/{id}/exchange
Body: {
  items: {
    product_id: number;
    variant_id?: number;
    quantity: number;
  }[];
  price_difference_handling: 'refund' | 'charge' | 'ignore';
}
```

### 4. 分析報表 API
```typescript
// 訂單統計總覽
GET /api/admin/orders/statistics
Query: {
  period: 'today' | 'week' | 'month' | 'quarter' | 'year';
  compare_previous?: boolean;
  timezone?: string;
}

// 訂單趨勢分析
GET /api/admin/orders/trends
Query: {
  metric: 'count' | 'revenue' | 'aov' | 'conversion';
  period: 'daily' | 'weekly' | 'monthly';
  start_date: string;
  end_date: string;
  group_by?: string;
}

// 客戶訂單分析
GET /api/admin/orders/customer-analysis
Query: {
  customer_id?: number;
  segment?: string;
  date_range?: DateRange;
}

// 商品銷售分析
GET /api/admin/orders/product-analysis
Query: {
  product_ids?: number[];
  category_ids?: number[];
  date_range?: DateRange;
  sort_by?: 'quantity' | 'revenue' | 'profit';
}

// 地區銷售分析
GET /api/admin/orders/regional-analysis
Query: {
  level: 'country' | 'state' | 'city';
  date_range?: DateRange;
}

// 付款方式分析
GET /api/admin/orders/payment-analysis
Query: {
  date_range?: DateRange;
  group_by?: 'method' | 'gateway' | 'status';
}
```

## 資料庫設計

### 1. 核心資料表
```sql
-- 訂單主表
CREATE TABLE orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_number VARCHAR(50) UNIQUE NOT NULL,
    parent_order_id BIGINT NULL,
    
    -- 基本資訊
    type ENUM('normal', 'pre_order', 'subscription', 'gift', 'sample', 'b2b', 'wholesale', 'dropshipping') DEFAULT 'normal',
    status ENUM('pending', 'payment_pending', 'payment_processing', 'payment_failed', 'confirmed', 'on_hold', 'processing', 'picking', 'packed', 'shipped', 'in_transit', 'out_for_delivery', 'delivered', 'completed', 'cancelled', 'refunded', 'returned', 'exchanged', 'disputed', 'fraud') DEFAULT 'pending',
    payment_status ENUM('unpaid', 'paid', 'transferred', 'confirmed', 'partial_paid', 'refunded', 'partial_refunded', 'failed', 'cancelled') DEFAULT 'unpaid',
    priority ENUM('low', 'normal', 'high', 'urgent', 'vip') DEFAULT 'normal',
    
    -- 客戶資訊
    customer_id BIGINT NULL,
    customer_type ENUM('member', 'guest') DEFAULT 'guest',
    customer_email VARCHAR(255) NOT NULL,
    customer_phone VARCHAR(50),
    customer_notes TEXT,
    
    -- 收件資訊
    shipping_address JSON NOT NULL,
    billing_address JSON NULL,
    
    -- 金額計算
    subtotal DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    shipping_fee DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    insurance_fee DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    handling_fee DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    tax_amount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    discount_amount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    coupon_discount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    point_discount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    total_amount DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    paid_amount DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    refunded_amount DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    
    -- 付款資訊
    payment_method VARCHAR(50),
    payment_gateway VARCHAR(50),
    payment_reference VARCHAR(255),
    payment_date TIMESTAMP NULL,
    payment_deadline TIMESTAMP NULL,
    
    -- 物流資訊
    shipping_method VARCHAR(100),
    shipping_carrier VARCHAR(100),
    tracking_number VARCHAR(255),
    estimated_delivery TIMESTAMP NULL,
    actual_delivery TIMESTAMP NULL,
    
    -- 優惠資訊
    coupons_used JSON,
    points_used INT DEFAULT 0,
    points_earned INT DEFAULT 0,
    
    -- 發票資訊
    invoice_type ENUM('personal', 'company', 'donation', 'carrier') DEFAULT 'personal',
    invoice_data JSON,
    invoice_number VARCHAR(50),
    invoice_date TIMESTAMP NULL,
    
    -- 特殊處理
    is_gift BOOLEAN DEFAULT false,
    gift_message TEXT,
    gift_wrapping BOOLEAN DEFAULT false,
    special_instructions TEXT,
    internal_notes TEXT,
    
    -- 風險控制
    risk_score INT DEFAULT 0,
    fraud_check_status ENUM('pending', 'approved', 'rejected', 'manual_review') DEFAULT 'pending',
    manual_review_required BOOLEAN DEFAULT false,
    
    -- 系統欄位
    created_by BIGINT NULL,
    assigned_to BIGINT NULL,
    tags JSON,
    source ENUM('website', 'mobile_app', 'admin', 'api', 'phone', 'store', 'marketplace') DEFAULT 'website',
    channel VARCHAR(50) DEFAULT 'online',
    
    -- 時間戳記
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    confirmed_at TIMESTAMP NULL,
    shipped_at TIMESTAMP NULL,
    delivered_at TIMESTAMP NULL,
    completed_at TIMESTAMP NULL,
    cancelled_at TIMESTAMP NULL,
    
    -- 索引
    INDEX idx_order_number (order_number),
    INDEX idx_customer (customer_id, customer_type),
    INDEX idx_status_payment (status, payment_status),
    INDEX idx_dates (created_at, confirmed_at, shipped_at, delivered_at),
    INDEX idx_assignment (assigned_to, status),
    INDEX idx_priority_status (priority, status),
    INDEX idx_source_channel (source, channel),
    INDEX idx_parent (parent_order_id),
    FULLTEXT idx_search (order_number, customer_email, customer_phone, tracking_number)
);

-- 訂單商品明細表
CREATE TABLE order_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL,
    
    -- 商品資訊
    product_id BIGINT NOT NULL,
    variant_id BIGINT NULL,
    sku VARCHAR(100) NOT NULL,
    product_name VARCHAR(255) NOT NULL,
    variant_name VARCHAR(255),
    product_image VARCHAR(500),
    
    -- 數量與價格
    quantity INT NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL,
    original_price DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) DEFAULT 0.00,
    total_price DECIMAL(10,2) NOT NULL,
    
    -- 商品屬性（快照）
    product_attributes JSON,
    
    -- 庫存管理
    stock_reserved BOOLEAN DEFAULT false,
    stock_allocated BOOLEAN DEFAULT false,
    
    -- 特殊處理
    is_gift BOOLEAN DEFAULT false,
    is_sample BOOLEAN DEFAULT false,
    gift_from_item_id BIGINT NULL,
    
    -- 狀態追蹤
    status ENUM('pending', 'in_stock', 'out_of_stock', 'backordered', 'picked', 'packed', 'shipped', 'delivered', 'returned', 'exchanged') DEFAULT 'pending',
    shipped_quantity INT DEFAULT 0,
    delivered_quantity INT DEFAULT 0,
    returned_quantity INT DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_order (order_id),
    INDEX idx_product (product_id, variant_id),
    INDEX idx_sku (sku),
    INDEX idx_status (status),
    INDEX idx_gift_relation (gift_from_item_id)
);

-- 訂單狀態歷史記錄表
CREATE TABLE order_status_history (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL,
    from_status VARCHAR(50),
    to_status VARCHAR(50) NOT NULL,
    reason TEXT,
    notes TEXT,
    changed_by BIGINT,
    automated BOOLEAN DEFAULT false,
    metadata JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_order_date (order_id, created_at),
    INDEX idx_status_change (from_status, to_status),
    INDEX idx_user (changed_by, created_at)
);

-- 退換貨申請表
CREATE TABLE return_requests (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    return_number VARCHAR(50) UNIQUE NOT NULL,
    order_id BIGINT NOT NULL,
    customer_id BIGINT,
    
    -- 申請資訊
    type ENUM('return', 'exchange', 'repair') NOT NULL,
    status ENUM('pending', 'approved', 'rejected', 'shipped', 'received', 'processed', 'completed', 'cancelled') DEFAULT 'pending',
    reason ENUM('defective', 'wrong_item', 'size_issue', 'color_issue', 'not_as_described', 'damaged_in_shipping', 'changed_mind', 'allergic_reaction', 'expired', 'other') NOT NULL,
    description TEXT NOT NULL,
    images JSON,
    
    -- 金額計算
    refund_amount DECIMAL(10,2) DEFAULT 0.00,
    restocking_fee DECIMAL(10,2) DEFAULT 0.00,
    return_shipping_fee DECIMAL(10,2) DEFAULT 0.00,
    
    -- 處理資訊
    approved_by BIGINT,
    approved_at TIMESTAMP NULL,
    approval_notes TEXT,
    
    -- 物流資訊
    return_address JSON,
    return_tracking VARCHAR(255),
    received_at TIMESTAMP NULL,
    
    -- 處理結果
    refunded_at TIMESTAMP NULL,
    refund_reference VARCHAR(255),
    replacement_order_id BIGINT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_return_number (return_number),
    INDEX idx_order (order_id),
    INDEX idx_customer (customer_id),
    INDEX idx_status_type (status, type),
    INDEX idx_dates (created_at, approved_at, refunded_at)
);

-- 退換貨商品明細表
CREATE TABLE return_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    return_request_id BIGINT NOT NULL,
    order_item_id BIGINT NOT NULL,
    
    -- 商品資訊
    product_id BIGINT NOT NULL,
    variant_id BIGINT,
    sku VARCHAR(100) NOT NULL,
    product_name VARCHAR(255) NOT NULL,
    
    -- 退換資訊
    quantity INT NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL,
    refund_amount DECIMAL(10,2) NOT NULL,
    condition ENUM('new', 'opened', 'used', 'damaged', 'defective') NOT NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_return_request (return_request_id),
    INDEX idx_order_item (order_item_id),
    INDEX idx_product (product_id, variant_id)
);

-- 批次操作記錄表
CREATE TABLE batch_operations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    type ENUM('status_update', 'bulk_ship', 'generate_invoices', 'export_data', 'apply_discount', 'send_notification', 'tag_update', 'assign_staff') NOT NULL,
    status ENUM('pending', 'running', 'completed', 'failed', 'cancelled') DEFAULT 'pending',
    
    -- 選擇條件
    selection_criteria JSON NOT NULL,
    operation_params JSON NOT NULL,
    
    -- 執行結果
    total_orders INT DEFAULT 0,
    processed_orders INT DEFAULT 0,
    successful_orders INT DEFAULT 0,
    failed_orders INT DEFAULT 0,
    error_details JSON,
    
    -- 執行資訊
    started_by BIGINT NOT NULL,
    started_at TIMESTAMP NULL,
    completed_at TIMESTAMP NULL,
    estimated_completion TIMESTAMP NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_type_status (type, status),
    INDEX idx_user_date (started_by, created_at)
);

-- 訂單統計資料表
CREATE TABLE order_statistics (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    date DATE NOT NULL,
    period_type ENUM('daily', 'weekly', 'monthly', 'yearly') NOT NULL,
    
    -- 訂單數量統計
    total_orders INT DEFAULT 0,
    new_orders INT DEFAULT 0,
    completed_orders INT DEFAULT 0,
    cancelled_orders INT DEFAULT 0,
    refunded_orders INT DEFAULT 0,
    
    -- 金額統計
    total_revenue DECIMAL(15,2) DEFAULT 0.00,
    gross_revenue DECIMAL(15,2) DEFAULT 0.00,
    net_revenue DECIMAL(15,2) DEFAULT 0.00,
    average_order_value DECIMAL(10,2) DEFAULT 0.00,
    
    -- 客戶統計
    unique_customers INT DEFAULT 0,
    new_customers INT DEFAULT 0,
    returning_customers INT DEFAULT 0,
    
    -- 商品統計
    total_items_sold INT DEFAULT 0,
    unique_products_sold INT DEFAULT 0,
    
    -- 配送統計
    orders_shipped INT DEFAULT 0,
    orders_delivered INT DEFAULT 0,
    average_delivery_time DECIMAL(5,2) DEFAULT 0.00,
    
    -- 退換貨統計
    return_requests INT DEFAULT 0,
    exchange_requests INT DEFAULT 0,
    return_rate DECIMAL(5,4) DEFAULT 0.0000,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE KEY idx_date_period (date, period_type),
    INDEX idx_date (date),
    INDEX idx_period (period_type)
);
```

## 整合功能

### 1. 與庫存系統整合
- 下單時自動預留庫存
- 出貨時扣減實際庫存
- 取消訂單時釋放預留庫存
- 缺貨商品自動轉為預訂狀態

### 2. 與付款系統整合
- 支援多種付款方式
- 自動同步付款狀態
- 分期付款處理
- 退款自動化處理

### 3. 與物流系統整合
- 自動建立物流單
- 即時追蹤配送狀態
- 配送異常處理
- 簽收確認自動化

### 4. 與會員系統整合
- 會員等級優惠
- 點數累積與使用
- 購買歷史記錄
- 個人化推薦

### 5. 與財務系統整合
- 自動產生會計分錄
- 發票自動開立
- 營收確認處理
- 退款帳務處理

## 效能優化

### 1. 資料庫優化
- 適當索引設計
- 分區表處理大量歷史資料
- 讀寫分離
- 快取熱門查詢

### 2. 系統效能
- 異步處理狀態更新
- 批次處理減少系統負載
- API回應快取
- 分散式架構支援

### 3. 監控與告警
- 訂單處理時間監控
- 系統效能指標追蹤
- 異常狀態告警
- 業務指標儀表板

## 安全性設計

### 1. 資料保護
- 敏感資料加密
- 存取權限控制
- 操作日誌記錄
- 資料備份策略

### 2. 詐騙防護
- 風險評分機制
- 異常訂單檢測
- 黑名單管理
- 人工審核流程

### 3. 合規性
- 個資保護機制
- 消費者權益保障
- 電子商務法規遵循
- 資料保存期限管理

這個訂單管理系統提供了完整的訂單生命週期管理，從下單到完成的每個環節都有詳細的狀態追蹤和自動化處理，特別針對您在0.md中提到的付款狀態定義進行了精確的設計，確保能夠滿足美妝電商的所有訂單管理需求。