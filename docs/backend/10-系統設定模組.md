# 系統設定模組 (System Configuration Module)

## 1. 模組概述

系統設定模組是整個平台的配置中心，統一管理所有前台和後台的設定項目。此模組提供集中式的設定管理、權限控制、版本管理和設定同步功能。

### 1.1 核心功能
- 全域設定管理（系統級、模組級、用戶級）
- 設定權限控制與審核機制
- 設定版本管理與回滾
- 實時設定同步與推送
- 設定模板與預設值管理
- 設定變更審計追蹤
- 多環境設定管理（開發/測試/生產）

## 2. 系統架構

### 2.1 設定層級架構
```
系統設定 (System Level)
├── 全域設定 (Global Settings)
├── 模組設定 (Module Settings)
│   ├── 前台模組設定 (Frontend Module Settings)
│   └── 後台模組設定 (Backend Module Settings)
└── 用戶設定 (User Settings)
    ├── 個人偏好設定 (Personal Preferences)
    └── 角色權限設定 (Role Permissions)
```

### 2.2 設定分類體系
```typescript
enum SettingCategory {
  // 系統核心設定
  SYSTEM_CORE = 'system_core',
  SYSTEM_SECURITY = 'system_security',
  SYSTEM_PERFORMANCE = 'system_performance',
  
  // 業務模組設定
  USER_MANAGEMENT = 'user_management',
  PRODUCT_MANAGEMENT = 'product_management',
  INVENTORY_MANAGEMENT = 'inventory_management',
  ORDER_MANAGEMENT = 'order_management',
  PAYMENT_MANAGEMENT = 'payment_management',
  SHIPPING_MANAGEMENT = 'shipping_management',
  PROMOTION_MANAGEMENT = 'promotion_management',
  CONTENT_MANAGEMENT = 'content_management',
  NOTIFICATION_MANAGEMENT = 'notification_management',
  ANALYTICS_MANAGEMENT = 'analytics_management',
  
  // 第三方整合設定
  PAYMENT_GATEWAY = 'payment_gateway',
  LOGISTICS_PROVIDER = 'logistics_provider',
  EMAIL_SERVICE = 'email_service',
  SMS_SERVICE = 'sms_service',
  CLOUD_STORAGE = 'cloud_storage',
  
  // 前台設定
  FRONTEND_THEME = 'frontend_theme',
  FRONTEND_LAYOUT = 'frontend_layout',
  FRONTEND_SEO = 'frontend_seo',
  FRONTEND_ANALYTICS = 'frontend_analytics',
  
  // 後台設定
  BACKEND_INTERFACE = 'backend_interface',
  BACKEND_WORKFLOW = 'backend_workflow',
  BACKEND_REPORTING = 'backend_reporting'
}
```

## 3. 資料結構設計

### 3.1 設定項目資料結構
```typescript
interface SystemSetting {
  settingId: string;
  category: SettingCategory;
  moduleId?: string;
  key: string;
  displayName: string;
  description?: string;
  value: SettingValue;
  defaultValue: SettingValue;
  dataType: SettingDataType;
  constraints?: SettingConstraints;
  isRequired: boolean;
  isSystem: boolean;
  isUserConfigurable: boolean;
  requiresRestart: boolean;
  environmentSpecific: boolean;
  createdAt: Date;
  updatedAt: Date;
  createdBy: string;
  updatedBy: string;
  version: number;
  status: SettingStatus;
}

enum SettingDataType {
  STRING = 'string',
  NUMBER = 'number',
  BOOLEAN = 'boolean',
  JSON = 'json',
  ARRAY = 'array',
  FILE = 'file',
  IMAGE = 'image',
  URL = 'url',
  EMAIL = 'email',
  PASSWORD = 'password',
  TEXTAREA = 'textarea',
  SELECT = 'select',
  MULTI_SELECT = 'multi_select',
  DATE = 'date',
  TIME = 'time',
  DATETIME = 'datetime',
  COLOR = 'color',
  RANGE = 'range'
}

type SettingValue = string | number | boolean | object | Array<any>;

interface SettingConstraints {
  minLength?: number;
  maxLength?: number;
  minValue?: number;
  maxValue?: number;
  pattern?: string;
  options?: SettingOption[];
  required?: boolean;
  unique?: boolean;
  customValidator?: string;
}

interface SettingOption {
  value: string | number;
  label: string;
  description?: string;
  disabled?: boolean;
}

enum SettingStatus {
  ACTIVE = 'active',
  INACTIVE = 'inactive',
  DEPRECATED = 'deprecated',
  PENDING_APPROVAL = 'pending_approval'
}
```

### 3.2 設定分組與模板
```typescript
interface SettingGroup {
  groupId: string;
  name: string;
  description?: string;
  category: SettingCategory;
  moduleId?: string;
  order: number;
  isCollapsible: boolean;
  isExpanded: boolean;
  permissions: string[];
  settings: SystemSetting[];
}

interface SettingTemplate {
  templateId: string;
  name: string;
  description?: string;
  category: SettingCategory;
  moduleId?: string;
  settings: Partial<SystemSetting>[];
  isDefault: boolean;
  applicableEnvironments: Environment[];
  createdAt: Date;
  createdBy: string;
}

enum Environment {
  DEVELOPMENT = 'development',
  TESTING = 'testing',
  STAGING = 'staging',
  PRODUCTION = 'production'
}
```

### 3.3 設定變更紀錄
```typescript
interface SettingChangeLog {
  logId: string;
  settingId: string;
  changeType: SettingChangeType;
  oldValue?: SettingValue;
  newValue: SettingValue;
  reason?: string;
  changedBy: string;
  changedAt: Date;
  ipAddress?: string;
  userAgent?: string;
  approvedBy?: string;
  approvedAt?: Date;
  rollbackId?: string;
}

enum SettingChangeType {
  CREATE = 'create',
  UPDATE = 'update',
  DELETE = 'delete',
  ROLLBACK = 'rollback',
  BULK_UPDATE = 'bulk_update',
  TEMPLATE_APPLY = 'template_apply'
}
```

## 4. 核心功能設計

### 4.1 設定管理服務
```typescript
class SystemSettingService {
  // 基本 CRUD 操作
  async createSetting(setting: Partial<SystemSetting>): Promise<SystemSetting>;
  async updateSetting(settingId: string, updates: Partial<SystemSetting>): Promise<SystemSetting>;
  async deleteSetting(settingId: string): Promise<void>;
  async getSetting(settingId: string): Promise<SystemSetting | null>;
  async getSettingByKey(category: SettingCategory, key: string, moduleId?: string): Promise<SystemSetting | null>;
  
  // 批量操作
  async getSettingsByCategory(category: SettingCategory, moduleId?: string): Promise<SystemSetting[]>;
  async updateSettingsBatch(updates: SettingBatchUpdate[]): Promise<SystemSetting[]>;
  async importSettings(settings: Partial<SystemSetting>[], templateId?: string): Promise<SystemSetting[]>;
  async exportSettings(category?: SettingCategory, moduleId?: string): Promise<SystemSetting[]>;
  
  // 設定值獲取與設定
  async getValue<T = SettingValue>(category: SettingCategory, key: string, moduleId?: string): Promise<T>;
  async setValue(category: SettingCategory, key: string, value: SettingValue, moduleId?: string): Promise<void>;
  async getValues(keys: SettingKey[]): Promise<Record<string, SettingValue>>;
  async setValues(values: Record<string, SettingValue>): Promise<void>;
  
  // 設定驗證
  async validateSetting(setting: Partial<SystemSetting>): Promise<ValidationResult>;
  async validateSettingValue(settingId: string, value: SettingValue): Promise<ValidationResult>;
  
  // 版本管理
  async createSettingVersion(settingId: string, reason?: string): Promise<SettingVersion>;
  async rollbackSetting(settingId: string, versionId: string): Promise<SystemSetting>;
  async getSettingVersions(settingId: string): Promise<SettingVersion[]>;
  
  // 模板管理
  async createTemplate(template: Partial<SettingTemplate>): Promise<SettingTemplate>;
  async applyTemplate(templateId: string, targetEnvironment: Environment): Promise<SystemSetting[]>;
  async compareWithTemplate(templateId: string): Promise<SettingComparisonResult>;
}

interface SettingBatchUpdate {
  settingId: string;
  value: SettingValue;
  reason?: string;
}

interface SettingKey {
  category: SettingCategory;
  key: string;
  moduleId?: string;
}

interface ValidationResult {
  isValid: boolean;
  errors: ValidationError[];
  warnings: ValidationWarning[];
}

interface ValidationError {
  field: string;
  message: string;
  code: string;
}

interface ValidationWarning {
  field: string;
  message: string;
  suggestion?: string;
}
```

### 4.2 設定權限控制
```typescript
interface SettingPermission {
  permissionId: string;
  settingId: string;
  roleId: string;
  userId?: string;
  permissions: SettingPermissionType[];
  restrictions?: SettingRestriction[];
  grantedBy: string;
  grantedAt: Date;
  expiresAt?: Date;
}

enum SettingPermissionType {
  READ = 'read',
  WRITE = 'write',
  DELETE = 'delete',
  APPROVE = 'approve',
  AUDIT = 'audit',
  EXPORT = 'export',
  IMPORT = 'import',
  TEMPLATE_MANAGE = 'template_manage'
}

interface SettingRestriction {
  type: SettingRestrictionType;
  condition: string;
  message: string;
}

enum SettingRestrictionType {
  TIME_BASED = 'time_based',
  IP_BASED = 'ip_based',
  ENVIRONMENT_BASED = 'environment_based',
  VALUE_RANGE = 'value_range',
  APPROVAL_REQUIRED = 'approval_required'
}

class SettingPermissionService {
  async checkPermission(userId: string, settingId: string, permission: SettingPermissionType): Promise<boolean>;
  async grantPermission(permission: Partial<SettingPermission>): Promise<SettingPermission>;
  async revokePermission(permissionId: string): Promise<void>;
  async getUserPermissions(userId: string, category?: SettingCategory): Promise<SettingPermission[]>;
  async getSettingPermissions(settingId: string): Promise<SettingPermission[]>;
}
```

### 4.3 設定審核工作流
```typescript
interface SettingApproval {
  approvalId: string;
  settingId: string;
  changeType: SettingChangeType;
  oldValue?: SettingValue;
  newValue: SettingValue;
  reason: string;
  requestedBy: string;
  requestedAt: Date;
  status: ApprovalStatus;
  approvers: SettingApprover[];
  currentApproverLevel: number;
  approvalDeadline?: Date;
  priority: ApprovalPriority;
  riskLevel: RiskLevel;
}

enum ApprovalStatus {
  PENDING = 'pending',
  APPROVED = 'approved',
  REJECTED = 'rejected',
  CANCELLED = 'cancelled',
  EXPIRED = 'expired'
}

interface SettingApprover {
  userId: string;
  level: number;
  status: ApproverStatus;
  approvedAt?: Date;
  comments?: string;
  isRequired: boolean;
}

enum ApproverStatus {
  PENDING = 'pending',
  APPROVED = 'approved',
  REJECTED = 'rejected',
  SKIPPED = 'skipped'
}

enum ApprovalPriority {
  LOW = 'low',
  MEDIUM = 'medium',
  HIGH = 'high',
  CRITICAL = 'critical'
}

enum RiskLevel {
  MINIMAL = 'minimal',
  LOW = 'low',
  MEDIUM = 'medium',
  HIGH = 'high',
  CRITICAL = 'critical'
}
```

## 5. 具體設定項目規格

### 5.1 系統核心設定
```typescript
const SystemCoreSettings = {
  // 基本系統資訊
  'system.name': {
    displayName: '系統名稱',
    dataType: SettingDataType.STRING,
    defaultValue: 'MickeyShop Beauty',
    isRequired: true
  },
  'system.version': {
    displayName: '系統版本',
    dataType: SettingDataType.STRING,
    defaultValue: '1.0.0',
    isSystem: true
  },
  'system.environment': {
    displayName: '系統環境',
    dataType: SettingDataType.SELECT,
    options: [
      { value: 'development', label: '開發環境' },
      { value: 'testing', label: '測試環境' },
      { value: 'production', label: '生產環境' }
    ],
    defaultValue: 'production'
  },
  'system.timezone': {
    displayName: '系統時區',
    dataType: SettingDataType.SELECT,
    defaultValue: 'Asia/Taipei'
  },
  'system.language': {
    displayName: '預設語言',
    dataType: SettingDataType.SELECT,
    options: [
      { value: 'zh-TW', label: '繁體中文' },
      { value: 'en-US', label: 'English' }
    ],
    defaultValue: 'zh-TW'
  },
  'system.currency': {
    displayName: '預設貨幣',
    dataType: SettingDataType.SELECT,
    options: [
      { value: 'TWD', label: '新台幣' },
      { value: 'USD', label: '美元' }
    ],
    defaultValue: 'TWD'
  },
  'system.maintenance_mode': {
    displayName: '維護模式',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: false
  },
  'system.maintenance_message': {
    displayName: '維護訊息',
    dataType: SettingDataType.TEXTAREA,
    defaultValue: '系統維護中，請稍後再試'
  }
};
```

### 5.2 安全相關設定
```typescript
const SecuritySettings = {
  // 密碼政策
  'security.password.min_length': {
    displayName: '密碼最小長度',
    dataType: SettingDataType.NUMBER,
    defaultValue: 8,
    constraints: { minValue: 6, maxValue: 32 }
  },
  'security.password.require_uppercase': {
    displayName: '必須包含大寫字母',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: true
  },
  'security.password.require_lowercase': {
    displayName: '必須包含小寫字母',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: true
  },
  'security.password.require_numbers': {
    displayName: '必須包含數字',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: true
  },
  'security.password.require_symbols': {
    displayName: '必須包含符號',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: false
  },
  'security.password.expiry_days': {
    displayName: '密碼過期天數',
    dataType: SettingDataType.NUMBER,
    defaultValue: 90,
    constraints: { minValue: 30, maxValue: 365 }
  },
  
  // 會話管理
  'security.session.timeout_minutes': {
    displayName: '會話超時時間(分鐘)',
    dataType: SettingDataType.NUMBER,
    defaultValue: 30,
    constraints: { minValue: 5, maxValue: 480 }
  },
  'security.session.max_concurrent_sessions': {
    displayName: '最大同時會話數',
    dataType: SettingDataType.NUMBER,
    defaultValue: 3,
    constraints: { minValue: 1, maxValue: 10 }
  },
  
  // 登入限制
  'security.login.max_attempts': {
    displayName: '最大登入嘗試次數',
    dataType: SettingDataType.NUMBER,
    defaultValue: 5,
    constraints: { minValue: 3, maxValue: 10 }
  },
  'security.login.lockout_minutes': {
    displayName: '帳號鎖定時間(分鐘)',
    dataType: SettingDataType.NUMBER,
    defaultValue: 30,
    constraints: { minValue: 5, maxValue: 1440 }
  },
  
  // 兩步驗證
  'security.2fa.enabled': {
    displayName: '啟用兩步驗證',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: false
  },
  'security.2fa.required_for_admin': {
    displayName: '管理員必須使用兩步驗證',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: true
  }
};
```

### 5.3 效能相關設定
```typescript
const PerformanceSettings = {
  // 快取設定
  'performance.cache.enabled': {
    displayName: '啟用快取',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: true
  },
  'performance.cache.ttl_seconds': {
    displayName: '快取存活時間(秒)',
    dataType: SettingDataType.NUMBER,
    defaultValue: 3600,
    constraints: { minValue: 60, maxValue: 86400 }
  },
  'performance.cache.max_size_mb': {
    displayName: '最大快取大小(MB)',
    dataType: SettingDataType.NUMBER,
    defaultValue: 256,
    constraints: { minValue: 64, maxValue: 2048 }
  },
  
  // 資料庫連線池
  'performance.database.pool_size': {
    displayName: '資料庫連線池大小',
    dataType: SettingDataType.NUMBER,
    defaultValue: 20,
    constraints: { minValue: 5, maxValue: 100 }
  },
  'performance.database.max_idle_connections': {
    displayName: '最大閒置連線數',
    dataType: SettingDataType.NUMBER,
    defaultValue: 10,
    constraints: { minValue: 2, maxValue: 50 }
  },
  
  // API 限流
  'performance.rate_limiting.requests_per_minute': {
    displayName: '每分鐘請求限制',
    dataType: SettingDataType.NUMBER,
    defaultValue: 1000,
    constraints: { minValue: 100, maxValue: 10000 }
  },
  'performance.rate_limiting.burst_limit': {
    displayName: '突發請求限制',
    dataType: SettingDataType.NUMBER,
    defaultValue: 1500,
    constraints: { minValue: 150, maxValue: 15000 }
  }
};
```

### 5.4 業務模組設定
```typescript
const BusinessModuleSettings = {
  // 用戶管理設定
  'user.registration.enabled': {
    displayName: '允許用戶註冊',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: true
  },
  'user.registration.email_verification_required': {
    displayName: '註冊需要郵件驗證',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: true
  },
  'user.registration.auto_approve': {
    displayName: '自動審核通過註冊',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: false
  },
  'user.profile.allow_avatar_upload': {
    displayName: '允許上傳頭像',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: true
  },
  'user.profile.max_avatar_size_mb': {
    displayName: '頭像最大大小(MB)',
    dataType: SettingDataType.NUMBER,
    defaultValue: 2,
    constraints: { minValue: 1, maxValue: 10 }
  },
  
  // 商品管理設定
  'product.image.max_count': {
    displayName: '商品圖片最大數量',
    dataType: SettingDataType.NUMBER,
    defaultValue: 10,
    constraints: { minValue: 1, maxValue: 50 }
  },
  'product.image.max_size_mb': {
    displayName: '商品圖片最大大小(MB)',
    dataType: SettingDataType.NUMBER,
    defaultValue: 5,
    constraints: { minValue: 1, maxValue: 20 }
  },
  'product.review.auto_publish': {
    displayName: '自動發布商品評論',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: false
  },
  'product.review.require_purchase': {
    displayName: '評論需要購買記錄',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: true
  },
  
  // 訂單管理設定
  'order.auto_confirm_minutes': {
    displayName: '自動確認訂單時間(分鐘)',
    dataType: SettingDataType.NUMBER,
    defaultValue: 30,
    constraints: { minValue: 5, maxValue: 1440 }
  },
  'order.cancel_timeout_hours': {
    displayName: '訂單取消超時時間(小時)',
    dataType: SettingDataType.NUMBER,
    defaultValue: 24,
    constraints: { minValue: 1, maxValue: 168 }
  },
  'order.min_amount': {
    displayName: '最小訂單金額',
    dataType: SettingDataType.NUMBER,
    defaultValue: 100,
    constraints: { minValue: 0, maxValue: 10000 }
  },
  'order.free_shipping_threshold': {
    displayName: '免運費門檻',
    dataType: SettingDataType.NUMBER,
    defaultValue: 1000,
    constraints: { minValue: 0, maxValue: 50000 }
  },
  
  // 庫存管理設定
  'inventory.low_stock_threshold': {
    displayName: '低庫存警告閾值',
    dataType: SettingDataType.NUMBER,
    defaultValue: 10,
    constraints: { minValue: 1, maxValue: 1000 }
  },
  'inventory.auto_reserve_minutes': {
    displayName: '自動預留庫存時間(分鐘)',
    dataType: SettingDataType.NUMBER,
    defaultValue: 15,
    constraints: { minValue: 5, maxValue: 60 }
  }
};
```

### 5.5 第三方服務設定
```typescript
const ThirdPartySettings = {
  // 綠界金流設定
  'payment.ecpay.merchant_id': {
    displayName: 'ECPay 商店代號',
    dataType: SettingDataType.STRING,
    isRequired: true
  },
  'payment.ecpay.hash_key': {
    displayName: 'ECPay HashKey',
    dataType: SettingDataType.PASSWORD,
    isRequired: true
  },
  'payment.ecpay.hash_iv': {
    displayName: 'ECPay HashIV',
    dataType: SettingDataType.PASSWORD,
    isRequired: true
  },
  'payment.ecpay.test_mode': {
    displayName: 'ECPay 測試模式',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: false
  },
  
  // LINE Pay 設定
  'payment.linepay.channel_id': {
    displayName: 'LINE Pay Channel ID',
    dataType: SettingDataType.STRING
  },
  'payment.linepay.channel_secret': {
    displayName: 'LINE Pay Channel Secret',
    dataType: SettingDataType.PASSWORD
  },
  'payment.linepay.sandbox_mode': {
    displayName: 'LINE Pay 沙盒模式',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: false
  },
  
  // 物流設定
  'shipping.ecpay.cvs_enabled': {
    displayName: '啟用超商取貨',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: true
  },
  'shipping.ecpay.home_delivery_enabled': {
    displayName: '啟用宅配',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: true
  },
  'shipping.ecpay.pickup_enabled': {
    displayName: '啟用自取',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: false
  },
  
  // 簡訊服務設定
  'sms.provider': {
    displayName: '簡訊服務商',
    dataType: SettingDataType.SELECT,
    options: [
      { value: 'twilio', label: 'Twilio' },
      { value: 'mitake', label: '三竹簡訊' }
    ],
    defaultValue: 'twilio'
  },
  'sms.twilio.account_sid': {
    displayName: 'Twilio Account SID',
    dataType: SettingDataType.STRING
  },
  'sms.twilio.auth_token': {
    displayName: 'Twilio Auth Token',
    dataType: SettingDataType.PASSWORD
  },
  
  // 郵件服務設定
  'email.provider': {
    displayName: '郵件服務商',
    dataType: SettingDataType.SELECT,
    options: [
      { value: 'smtp', label: 'SMTP' },
      { value: 'sendgrid', label: 'SendGrid' },
      { value: 'ses', label: 'AWS SES' }
    ],
    defaultValue: 'smtp'
  },
  'email.smtp.host': {
    displayName: 'SMTP 主機',
    dataType: SettingDataType.STRING
  },
  'email.smtp.port': {
    displayName: 'SMTP 埠號',
    dataType: SettingDataType.NUMBER,
    defaultValue: 587
  },
  'email.smtp.username': {
    displayName: 'SMTP 用戶名',
    dataType: SettingDataType.STRING
  },
  'email.smtp.password': {
    displayName: 'SMTP 密碼',
    dataType: SettingDataType.PASSWORD
  }
};
```

### 5.6 前台設定
```typescript
const FrontendSettings = {
  // 主題設定
  'frontend.theme.primary_color': {
    displayName: '主要顏色',
    dataType: SettingDataType.COLOR,
    defaultValue: '#ff69b4'
  },
  'frontend.theme.secondary_color': {
    displayName: '次要顏色',
    dataType: SettingDataType.COLOR,
    defaultValue: '#ffc0cb'
  },
  'frontend.theme.font_family': {
    displayName: '字體家族',
    dataType: SettingDataType.SELECT,
    options: [
      { value: 'Arial, sans-serif', label: 'Arial' },
      { value: 'Microsoft JhengHei, sans-serif', label: '微軟正黑體' },
      { value: 'Roboto, sans-serif', label: 'Roboto' }
    ],
    defaultValue: 'Microsoft JhengHei, sans-serif'
  },
  
  // 佈局設定
  'frontend.layout.header_fixed': {
    displayName: '固定頂部導航',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: true
  },
  'frontend.layout.sidebar_collapsible': {
    displayName: '側邊欄可收合',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: true
  },
  'frontend.layout.products_per_page': {
    displayName: '每頁商品數量',
    dataType: SettingDataType.NUMBER,
    defaultValue: 12,
    constraints: { minValue: 6, maxValue: 60 }
  },
  
  // SEO 設定
  'frontend.seo.site_title': {
    displayName: '網站標題',
    dataType: SettingDataType.STRING,
    defaultValue: 'MickeyShop Beauty - 美妝保養專家'
  },
  'frontend.seo.meta_description': {
    displayName: '網站描述',
    dataType: SettingDataType.TEXTAREA,
    defaultValue: '專業的美妝保養品購物平台，提供優質的美妝產品與服務'
  },
  'frontend.seo.meta_keywords': {
    displayName: '關鍵字',
    dataType: SettingDataType.TEXTAREA,
    defaultValue: '美妝,保養,化妝品,護膚品'
  },
  
  // 社群媒體設定
  'frontend.social.facebook_url': {
    displayName: 'Facebook 專頁',
    dataType: SettingDataType.URL
  },
  'frontend.social.instagram_url': {
    displayName: 'Instagram 專頁',
    dataType: SettingDataType.URL
  },
  'frontend.social.line_url': {
    displayName: 'LINE 官方帳號',
    dataType: SettingDataType.URL
  }
};
```

### 5.7 後台設定
```typescript
const BackendSettings = {
  // 介面設定
  'backend.interface.theme': {
    displayName: '後台主題',
    dataType: SettingDataType.SELECT,
    options: [
      { value: 'light', label: '淺色主題' },
      { value: 'dark', label: '深色主題' },
      { value: 'auto', label: '自動切換' }
    ],
    defaultValue: 'light'
  },
  'backend.interface.sidebar_collapsed': {
    displayName: '預設收合側邊欄',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: false
  },
  'backend.interface.page_size': {
    displayName: '預設分頁大小',
    dataType: SettingDataType.NUMBER,
    defaultValue: 20,
    constraints: { minValue: 10, maxValue: 100 }
  },
  
  // 工作流程設定
  'backend.workflow.auto_assign_tasks': {
    displayName: '自動分配任務',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: true
  },
  'backend.workflow.task_reminder_hours': {
    displayName: '任務提醒時間(小時)',
    dataType: SettingDataType.NUMBER,
    defaultValue: 24,
    constraints: { minValue: 1, maxValue: 168 }
  },
  
  // 報表設定
  'backend.reporting.default_date_range': {
    displayName: '預設報表日期範圍',
    dataType: SettingDataType.SELECT,
    options: [
      { value: '7', label: '最近7天' },
      { value: '30', label: '最近30天' },
      { value: '90', label: '最近90天' }
    ],
    defaultValue: '30'
  },
  'backend.reporting.auto_generate': {
    displayName: '自動產生報表',
    dataType: SettingDataType.BOOLEAN,
    defaultValue: true
  }
};
```

## 6. API 介面設計

### 6.1 設定管理 API
```typescript
// GET /api/admin/settings
interface GetSettingsRequest {
  category?: SettingCategory;
  moduleId?: string;
  search?: string;
  page?: number;
  pageSize?: number;
}

interface GetSettingsResponse {
  settings: SystemSetting[];
  total: number;
  page: number;
  pageSize: number;
  categories: SettingCategory[];
}

// GET /api/admin/settings/groups
interface GetSettingGroupsResponse {
  groups: SettingGroup[];
}

// GET /api/admin/settings/:settingId
interface GetSettingDetailResponse {
  setting: SystemSetting;
  versions: SettingVersion[];
  permissions: SettingPermission[];
}

// POST /api/admin/settings
interface CreateSettingRequest {
  category: SettingCategory;
  moduleId?: string;
  key: string;
  displayName: string;
  description?: string;
  value: SettingValue;
  dataType: SettingDataType;
  constraints?: SettingConstraints;
  isRequired: boolean;
  isUserConfigurable: boolean;
  requiresRestart: boolean;
}

// PUT /api/admin/settings/:settingId
interface UpdateSettingRequest {
  displayName?: string;
  description?: string;
  value?: SettingValue;
  constraints?: SettingConstraints;
  isRequired?: boolean;
  isUserConfigurable?: boolean;
  status?: SettingStatus;
  reason?: string;
}

// PUT /api/admin/settings/batch
interface BatchUpdateSettingsRequest {
  updates: SettingBatchUpdate[];
  reason?: string;
  requireApproval?: boolean;
}

// DELETE /api/admin/settings/:settingId
interface DeleteSettingRequest {
  reason: string;
}
```

### 6.2 設定值操作 API
```typescript
// GET /api/admin/settings/values
interface GetSettingValuesRequest {
  keys: string[]; // 格式: "category.key" 或 "category.key@moduleId"
}

interface GetSettingValuesResponse {
  values: Record<string, SettingValue>;
}

// PUT /api/admin/settings/values
interface UpdateSettingValuesRequest {
  values: Record<string, SettingValue>;
  reason?: string;
  requireApproval?: boolean;
}

// GET /api/settings/public
interface GetPublicSettingsResponse {
  values: Record<string, SettingValue>; // 只返回可公開的設定
}

// 前台使用的設定獲取 API
// GET /api/frontend/settings
interface GetFrontendSettingsResponse {
  theme: {
    primaryColor: string;
    secondaryColor: string;
    fontFamily: string;
  };
  layout: {
    headerFixed: boolean;
    sidebarCollapsible: boolean;
    productsPerPage: number;
  };
  seo: {
    siteTitle: string;
    metaDescription: string;
    metaKeywords: string;
  };
  social: {
    facebookUrl?: string;
    instagramUrl?: string;
    lineUrl?: string;
  };
}
```

### 6.3 設定模板管理 API
```typescript
// GET /api/admin/settings/templates
interface GetSettingTemplatesResponse {
  templates: SettingTemplate[];
}

// POST /api/admin/settings/templates
interface CreateSettingTemplateRequest {
  name: string;
  description?: string;
  category: SettingCategory;
  moduleId?: string;
  settings: Partial<SystemSetting>[];
  applicableEnvironments: Environment[];
}

// PUT /api/admin/settings/templates/:templateId/apply
interface ApplySettingTemplateRequest {
  targetEnvironment: Environment;
  overrideExisting: boolean;
}

// GET /api/admin/settings/templates/:templateId/compare
interface CompareTemplateResponse {
  differences: SettingComparison[];
  summary: {
    total: number;
    missing: number;
    different: number;
    same: number;
  };
}

interface SettingComparison {
  key: string;
  templateValue: SettingValue;
  currentValue?: SettingValue;
  status: 'missing' | 'different' | 'same';
}
```

### 6.4 設定審核 API
```typescript
// GET /api/admin/settings/approvals
interface GetSettingApprovalsRequest {
  status?: ApprovalStatus;
  requestedBy?: string;
  priority?: ApprovalPriority;
  page?: number;
  pageSize?: number;
}

interface GetSettingApprovalsResponse {
  approvals: SettingApproval[];
  total: number;
  pending: number;
  approved: number;
  rejected: number;
}

// POST /api/admin/settings/approvals/:approvalId/approve
interface ApproveSettingRequest {
  comments?: string;
}

// POST /api/admin/settings/approvals/:approvalId/reject
interface RejectSettingRequest {
  reason: string;
  comments?: string;
}

// GET /api/admin/settings/:settingId/approval-workflow
interface GetApprovalWorkflowResponse {
  workflow: ApprovalWorkflow;
  requiredApprovers: ApprovalLevel[];
}

interface ApprovalWorkflow {
  workflowId: string;
  name: string;
  description?: string;
  levels: ApprovalLevel[];
  isActive: boolean;
}

interface ApprovalLevel {
  level: number;
  name: string;
  requiredApprovers: number;
  approvers: ApprovalUser[];
  conditions?: ApprovalCondition[];
}

interface ApprovalUser {
  userId: string;
  userName: string;
  email: string;
  isRequired: boolean;
}

interface ApprovalCondition {
  field: string;
  operator: string;
  value: any;
}
```

## 7. 資料庫結構設計

### 7.1 核心設定表
```sql
-- 系統設定主表
CREATE TABLE system_settings (
    setting_id VARCHAR(50) PRIMARY KEY,
    category VARCHAR(50) NOT NULL,
    module_id VARCHAR(50),
    key VARCHAR(100) NOT NULL,
    display_name VARCHAR(200) NOT NULL,
    description TEXT,
    value TEXT,
    default_value TEXT,
    data_type VARCHAR(20) NOT NULL,
    constraints JSON,
    is_required BOOLEAN DEFAULT FALSE,
    is_system BOOLEAN DEFAULT FALSE,
    is_user_configurable BOOLEAN DEFAULT TRUE,
    requires_restart BOOLEAN DEFAULT FALSE,
    environment_specific BOOLEAN DEFAULT FALSE,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    created_by VARCHAR(50) NOT NULL,
    updated_by VARCHAR(50) NOT NULL,
    version INT DEFAULT 1,
    status VARCHAR(20) DEFAULT 'active',
    
    UNIQUE KEY uk_setting_key (category, key, module_id),
    INDEX idx_category (category),
    INDEX idx_module (module_id),
    INDEX idx_status (status),
    INDEX idx_user_configurable (is_user_configurable)
);

-- 設定分組表
CREATE TABLE setting_groups (
    group_id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    category VARCHAR(50) NOT NULL,
    module_id VARCHAR(50),
    order_index INT DEFAULT 0,
    is_collapsible BOOLEAN DEFAULT TRUE,
    is_expanded BOOLEAN DEFAULT TRUE,
    permissions JSON,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    
    INDEX idx_category (category),
    INDEX idx_module (module_id),
    INDEX idx_order (order_index)
);

-- 設定與分組關聯表
CREATE TABLE setting_group_items (
    group_id VARCHAR(50),
    setting_id VARCHAR(50),
    order_index INT DEFAULT 0,
    
    PRIMARY KEY (group_id, setting_id),
    FOREIGN KEY (group_id) REFERENCES setting_groups(group_id) ON DELETE CASCADE,
    FOREIGN KEY (setting_id) REFERENCES system_settings(setting_id) ON DELETE CASCADE
);
```

### 7.2 版本管理表
```sql
-- 設定版本表
CREATE TABLE setting_versions (
    version_id VARCHAR(50) PRIMARY KEY,
    setting_id VARCHAR(50) NOT NULL,
    version_number INT NOT NULL,
    value TEXT,
    change_reason TEXT,
    created_at DATETIME NOT NULL,
    created_by VARCHAR(50) NOT NULL,
    
    FOREIGN KEY (setting_id) REFERENCES system_settings(setting_id) ON DELETE CASCADE,
    INDEX idx_setting_version (setting_id, version_number),
    INDEX idx_created_at (created_at)
);

-- 設定變更日誌表
CREATE TABLE setting_change_logs (
    log_id VARCHAR(50) PRIMARY KEY,
    setting_id VARCHAR(50) NOT NULL,
    change_type VARCHAR(20) NOT NULL,
    old_value TEXT,
    new_value TEXT,
    reason TEXT,
    changed_by VARCHAR(50) NOT NULL,
    changed_at DATETIME NOT NULL,
    ip_address VARCHAR(45),
    user_agent TEXT,
    approved_by VARCHAR(50),
    approved_at DATETIME,
    rollback_id VARCHAR(50),
    
    FOREIGN KEY (setting_id) REFERENCES system_settings(setting_id) ON DELETE CASCADE,
    INDEX idx_setting_id (setting_id),
    INDEX idx_changed_at (changed_at),
    INDEX idx_changed_by (changed_by),
    INDEX idx_change_type (change_type)
);
```

### 7.3 權限管理表
```sql
-- 設定權限表
CREATE TABLE setting_permissions (
    permission_id VARCHAR(50) PRIMARY KEY,
    setting_id VARCHAR(50) NOT NULL,
    role_id VARCHAR(50),
    user_id VARCHAR(50),
    permissions JSON NOT NULL,
    restrictions JSON,
    granted_by VARCHAR(50) NOT NULL,
    granted_at DATETIME NOT NULL,
    expires_at DATETIME,
    is_active BOOLEAN DEFAULT TRUE,
    
    FOREIGN KEY (setting_id) REFERENCES system_settings(setting_id) ON DELETE CASCADE,
    INDEX idx_setting_id (setting_id),
    INDEX idx_role_id (role_id),
    INDEX idx_user_id (user_id),
    INDEX idx_expires_at (expires_at)
);
```

### 7.4 審核工作流表
```sql
-- 設定審核表
CREATE TABLE setting_approvals (
    approval_id VARCHAR(50) PRIMARY KEY,
    setting_id VARCHAR(50) NOT NULL,
    change_type VARCHAR(20) NOT NULL,
    old_value TEXT,
    new_value TEXT,
    reason TEXT NOT NULL,
    requested_by VARCHAR(50) NOT NULL,
    requested_at DATETIME NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    current_approver_level INT DEFAULT 1,
    approval_deadline DATETIME,
    priority VARCHAR(20) DEFAULT 'medium',
    risk_level VARCHAR(20) DEFAULT 'low',
    completed_at DATETIME,
    
    FOREIGN KEY (setting_id) REFERENCES system_settings(setting_id) ON DELETE CASCADE,
    INDEX idx_setting_id (setting_id),
    INDEX idx_status (status),
    INDEX idx_requested_by (requested_by),
    INDEX idx_deadline (approval_deadline),
    INDEX idx_priority (priority)
);

-- 審核人員表
CREATE TABLE setting_approvers (
    approval_id VARCHAR(50),
    user_id VARCHAR(50),
    level INT NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    approved_at DATETIME,
    comments TEXT,
    is_required BOOLEAN DEFAULT TRUE,
    
    PRIMARY KEY (approval_id, user_id, level),
    FOREIGN KEY (approval_id) REFERENCES setting_approvals(approval_id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_level (level)
);
```

### 7.5 模板管理表
```sql
-- 設定模板表
CREATE TABLE setting_templates (
    template_id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    category VARCHAR(50),
    module_id VARCHAR(50),
    is_default BOOLEAN DEFAULT FALSE,
    applicable_environments JSON,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    created_by VARCHAR(50) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    
    INDEX idx_category (category),
    INDEX idx_module (module_id),
    INDEX idx_is_default (is_default),
    INDEX idx_created_by (created_by)
);

-- 模板設定項目表
CREATE TABLE template_settings (
    template_id VARCHAR(50),
    key VARCHAR(100) NOT NULL,
    display_name VARCHAR(200) NOT NULL,
    description TEXT,
    value TEXT,
    data_type VARCHAR(20) NOT NULL,
    constraints JSON,
    is_required BOOLEAN DEFAULT FALSE,
    order_index INT DEFAULT 0,
    
    PRIMARY KEY (template_id, key),
    FOREIGN KEY (template_id) REFERENCES setting_templates(template_id) ON DELETE CASCADE,
    INDEX idx_order (order_index)
);
```

## 8. 快取策略

### 8.1 多層快取架構
```typescript
class SettingCacheManager {
  // 快取層級
  private memoryCache: Map<string, CacheItem>; // L1: 記憶體快取
  private redisCache: RedisClient; // L2: Redis 快取
  private dbCache: DatabaseClient; // L3: 資料庫

  async getValue(key: string): Promise<SettingValue | null> {
    // L1: 檢查記憶體快取
    const memoryItem = this.memoryCache.get(key);
    if (memoryItem && !this.isExpired(memoryItem)) {
      return memoryItem.value;
    }

    // L2: 檢查 Redis 快取
    const redisValue = await this.redisCache.get(`setting:${key}`);
    if (redisValue) {
      const item = JSON.parse(redisValue);
      this.memoryCache.set(key, item); // 回寫到 L1
      return item.value;
    }

    // L3: 從資料庫載入
    const dbValue = await this.loadFromDatabase(key);
    if (dbValue) {
      await this.setValue(key, dbValue, 3600); // 快取 1 小時
      return dbValue;
    }

    return null;
  }

  async setValue(key: string, value: SettingValue, ttlSeconds: number = 3600): Promise<void> {
    const item: CacheItem = {
      value,
      expiresAt: Date.now() + ttlSeconds * 1000,
      version: Date.now()
    };

    // 同時寫入所有快取層
    this.memoryCache.set(key, item);
    await this.redisCache.setex(`setting:${key}`, ttlSeconds, JSON.stringify(item));
  }

  async invalidate(key: string): Promise<void> {
    this.memoryCache.delete(key);
    await this.redisCache.del(`setting:${key}`);
  }

  async invalidatePattern(pattern: string): Promise<void> {
    // 清除記憶體快取中符合模式的項目
    for (const key of this.memoryCache.keys()) {
      if (key.match(pattern)) {
        this.memoryCache.delete(key);
      }
    }

    // 清除 Redis 快取中符合模式的項目
    const keys = await this.redisCache.keys(`setting:${pattern}`);
    if (keys.length > 0) {
      await this.redisCache.del(...keys);
    }
  }
}

interface CacheItem {
  value: SettingValue;
  expiresAt: number;
  version: number;
}
```

### 8.2 快取更新策略
```typescript
class SettingCacheStrategy {
  // 寫入時快取更新
  async updateSettingWithCache(settingId: string, newValue: SettingValue): Promise<void> {
    // 1. 更新資料庫
    await this.settingRepository.updateValue(settingId, newValue);

    // 2. 更新快取
    const setting = await this.settingRepository.findById(settingId);
    const cacheKey = this.buildCacheKey(setting.category, setting.key, setting.moduleId);
    await this.cacheManager.setValue(cacheKey, newValue);

    // 3. 通知其他服務實例更新快取
    await this.pubSub.publish('setting:updated', {
      settingId,
      category: setting.category,
      key: setting.key,
      moduleId: setting.moduleId,
      newValue
    });

    // 4. 清除相關快取
    await this.invalidateRelatedCache(setting);
  }

  // 快取預熱
  async warmupCache(): Promise<void> {
    const criticalSettings = await this.settingRepository.getCriticalSettings();
    
    for (const setting of criticalSettings) {
      const cacheKey = this.buildCacheKey(setting.category, setting.key, setting.moduleId);
      await this.cacheManager.setValue(cacheKey, setting.value);
    }
  }

  // 快取驗證
  async validateCache(): Promise<CacheValidationResult> {
    const result: CacheValidationResult = {
      valid: 0,
      invalid: 0,
      missing: 0,
      details: []
    };

    const settings = await this.settingRepository.getAllSettings();
    
    for (const setting of settings) {
      const cacheKey = this.buildCacheKey(setting.category, setting.key, setting.moduleId);
      const cachedValue = await this.cacheManager.getValue(cacheKey);
      
      if (cachedValue === null) {
        result.missing++;
        result.details.push({
          key: cacheKey,
          status: 'missing',
          dbValue: setting.value
        });
      } else if (JSON.stringify(cachedValue) !== JSON.stringify(setting.value)) {
        result.invalid++;
        result.details.push({
          key: cacheKey,
          status: 'invalid',
          dbValue: setting.value,
          cachedValue
        });
      } else {
        result.valid++;
      }
    }

    return result;
  }

  private buildCacheKey(category: SettingCategory, key: string, moduleId?: string): string {
    return moduleId ? `${category}.${key}@${moduleId}` : `${category}.${key}`;
  }

  private async invalidateRelatedCache(setting: SystemSetting): Promise<void> {
    // 清除模組相關快取
    if (setting.moduleId) {
      await this.cacheManager.invalidatePattern(`${setting.category}.*@${setting.moduleId}`);
    }

    // 清除分類相關快取
    await this.cacheManager.invalidatePattern(`frontend:${setting.category}.*`);

    // 清除公開設定快取
    await this.cacheManager.invalidate('public:settings');
  }
}

interface CacheValidationResult {
  valid: number;
  invalid: number;
  missing: number;
  details: CacheValidationDetail[];
}

interface CacheValidationDetail {
  key: string;
  status: 'valid' | 'invalid' | 'missing';
  dbValue: SettingValue;
  cachedValue?: SettingValue;
}
```

## 9. 實時同步機制

### 9.1 WebSocket 推送
```typescript
class SettingWebSocketService {
  private clients = new Map<string, WebSocket>();
  private subscriptions = new Map<string, Set<string>>(); // userId -> settingKeys

  async subscribe(userId: string, settingKeys: string[]): Promise<void> {
    const userSubs = this.subscriptions.get(userId) || new Set();
    settingKeys.forEach(key => userSubs.add(key));
    this.subscriptions.set(userId, userSubs);
  }

  async unsubscribe(userId: string, settingKeys?: string[]): Promise<void> {
    if (!settingKeys) {
      this.subscriptions.delete(userId);
      return;
    }

    const userSubs = this.subscriptions.get(userId);
    if (userSubs) {
      settingKeys.forEach(key => userSubs.delete(key));
    }
  }

  async broadcastSettingChange(change: SettingChange): Promise<void> {
    const message = {
      type: 'SETTING_CHANGED',
      data: change
    };

    for (const [userId, subscribedKeys] of this.subscriptions.entries()) {
      if (subscribedKeys.has(change.key)) {
        const client = this.clients.get(userId);
        if (client && client.readyState === WebSocket.OPEN) {
          client.send(JSON.stringify(message));
        }
      }
    }
  }

  async broadcastSystemNotification(notification: SystemNotification): Promise<void> {
    const message = {
      type: 'SYSTEM_NOTIFICATION',
      data: notification
    };

    for (const client of this.clients.values()) {
      if (client.readyState === WebSocket.OPEN) {
        client.send(JSON.stringify(message));
      }
    }
  }
}

interface SettingChange {
  key: string;
  category: SettingCategory;
  moduleId?: string;
  oldValue?: SettingValue;
  newValue: SettingValue;
  changedBy: string;
  changedAt: Date;
  requiresRefresh: boolean;
}

interface SystemNotification {
  type: 'maintenance' | 'update' | 'warning' | 'info';
  title: string;
  message: string;
  actionUrl?: string;
  actionText?: string;
  expiresAt?: Date;
}
```

### 9.2 前台自動更新
```typescript
// 前台設定同步服務
class FrontendSettingService {
  private ws: WebSocket | null = null;
  private settings = new Map<string, SettingValue>();
  private listeners = new Map<string, Set<(value: SettingValue) => void>>();

  async connect(): Promise<void> {
    this.ws = new WebSocket(`${WEBSOCKET_URL}/settings`);
    
    this.ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      this.handleMessage(message);
    };

    this.ws.onopen = () => {
      // 訂閱前台設定
      this.subscribe([
        'frontend.theme.*',
        'frontend.layout.*',
        'frontend.seo.*',
        'system.maintenance_mode',
        'system.maintenance_message'
      ]);
    };
  }

  private handleMessage(message: any): void {
    switch (message.type) {
      case 'SETTING_CHANGED':
        this.handleSettingChange(message.data);
        break;
      case 'SYSTEM_NOTIFICATION':
        this.handleSystemNotification(message.data);
        break;
    }
  }

  private handleSettingChange(change: SettingChange): void {
    this.settings.set(change.key, change.newValue);
    
    // 通知監聽器
    const keyListeners = this.listeners.get(change.key);
    if (keyListeners) {
      keyListeners.forEach(listener => listener(change.newValue));
    }

    // 自動應用主題變更
    if (change.key.startsWith('frontend.theme.')) {
      this.applyThemeChange(change.key, change.newValue);
    }

    // 維護模式處理
    if (change.key === 'system.maintenance_mode' && change.newValue === true) {
      this.showMaintenanceMessage();
    }

    // 需要刷新頁面的設定
    if (change.requiresRefresh) {
      this.showRefreshNotification();
    }
  }

  private applyThemeChange(key: string, value: SettingValue): void {
    const root = document.documentElement;
    
    switch (key) {
      case 'frontend.theme.primary_color':
        root.style.setProperty('--primary-color', value as string);
        break;
      case 'frontend.theme.secondary_color':
        root.style.setProperty('--secondary-color', value as string);
        break;
      case 'frontend.theme.font_family':
        root.style.setProperty('--font-family', value as string);
        break;
    }
  }

  subscribe(keys: string[]): void {
    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
      this.ws.send(JSON.stringify({
        type: 'SUBSCRIBE',
        keys
      }));
    }
  }

  listen(key: string, callback: (value: SettingValue) => void): () => void {
    const keyListeners = this.listeners.get(key) || new Set();
    keyListeners.add(callback);
    this.listeners.set(key, keyListeners);

    // 返回取消監聽函數
    return () => {
      keyListeners.delete(callback);
      if (keyListeners.size === 0) {
        this.listeners.delete(key);
      }
    };
  }

  getValue(key: string): SettingValue | undefined {
    return this.settings.get(key);
  }
}
```

## 10. 安全考量

### 10.1 資料加密
```typescript
class SettingEncryption {
  private encryptionKey: string;

  constructor(encryptionKey: string) {
    this.encryptionKey = encryptionKey;
  }

  // 敏感設定值加密
  encrypt(value: string): string {
    const cipher = crypto.createCipher('aes-256-gcm', this.encryptionKey);
    let encrypted = cipher.update(value, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    const authTag = cipher.getAuthTag();
    return `${encrypted}:${authTag.toString('hex')}`;
  }

  // 敏感設定值解密
  decrypt(encryptedValue: string): string {
    const [encrypted, authTag] = encryptedValue.split(':');
    const decipher = crypto.createDecipher('aes-256-gcm', this.encryptionKey);
    decipher.setAuthTag(Buffer.from(authTag, 'hex'));
    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    return decrypted;
  }

  // 判斷是否需要加密
  shouldEncrypt(setting: SystemSetting): boolean {
    return setting.dataType === SettingDataType.PASSWORD ||
           setting.key.includes('secret') ||
           setting.key.includes('key') ||
           setting.key.includes('token') ||
           setting.category === SettingCategory.PAYMENT_GATEWAY;
  }
}

// 安全設定存儲服務
class SecureSettingStorage {
  private encryption: SettingEncryption;

  constructor(encryption: SettingEncryption) {
    this.encryption = encryption;
  }

  async storeSetting(setting: SystemSetting): Promise<void> {
    if (this.encryption.shouldEncrypt(setting)) {
      setting.value = this.encryption.encrypt(setting.value as string);
      setting.isEncrypted = true;
    }
    
    await this.settingRepository.save(setting);
  }

  async retrieveSetting(settingId: string): Promise<SystemSetting> {
    const setting = await this.settingRepository.findById(settingId);
    
    if (setting.isEncrypted) {
      setting.value = this.encryption.decrypt(setting.value as string);
    }
    
    return setting;
  }
}
```

### 10.2 存取控制
```typescript
class SettingAccessControl {
  async checkAccess(userId: string, settingId: string, action: SettingPermissionType): Promise<AccessResult> {
    // 1. 檢查用戶角色
    const userRoles = await this.userService.getUserRoles(userId);
    
    // 2. 檢查設定權限
    const permissions = await this.permissionService.getSettingPermissions(settingId);
    
    // 3. 檢查是否有對應權限
    const hasPermission = permissions.some(permission => 
      (permission.roleId && userRoles.includes(permission.roleId) ||
       permission.userId === userId) &&
      permission.permissions.includes(action)
    );

    if (!hasPermission) {
      return {
        allowed: false,
        reason: 'insufficient_permissions'
      };
    }

    // 4. 檢查限制條件
    const setting = await this.settingService.getSetting(settingId);
    const restrictionCheck = await this.checkRestrictions(userId, setting, action);
    
    if (!restrictionCheck.allowed) {
      return restrictionCheck;
    }

    // 5. 記錄存取日誌
    await this.logAccess(userId, settingId, action, 'allowed');

    return { allowed: true };
  }

  private async checkRestrictions(userId: string, setting: SystemSetting, action: SettingPermissionType): Promise<AccessResult> {
    const user = await this.userService.getUser(userId);
    
    // 檢查時間限制
    const now = new Date();
    const currentHour = now.getHours();
    if (setting.accessTimeRestriction && 
        (currentHour < setting.accessTimeRestriction.startHour || 
         currentHour > setting.accessTimeRestriction.endHour)) {
      return {
        allowed: false,
        reason: 'time_restriction',
        message: '當前時間不允許存取此設定'
      };
    }

    // 檢查 IP 限制
    if (setting.ipRestriction && 
        !setting.ipRestriction.includes(user.currentIpAddress)) {
      return {
        allowed: false,
        reason: 'ip_restriction',
        message: 'IP 地址不允許存取此設定'
      };
    }

    // 檢查環境限制
    if (setting.environmentRestriction &&
        !setting.environmentRestriction.includes(process.env.NODE_ENV)) {
      return {
        allowed: false,
        reason: 'environment_restriction',
        message: '當前環境不允許存取此設定'
      };
    }

    return { allowed: true };
  }
}

interface AccessResult {
  allowed: boolean;
  reason?: string;
  message?: string;
}
```

## 11. 監控與維運

### 11.1 設定變更監控
```typescript
class SettingMonitoringService {
  // 監控設定變更頻率
  async monitorChangeFrequency(): Promise<void> {
    const changes = await this.getRecentChanges(24); // 最近24小時
    
    // 檢查異常變更頻率
    const changesByUser = this.groupBy(changes, 'changedBy');
    for (const [userId, userChanges] of Object.entries(changesByUser)) {
      if (userChanges.length > 50) { // 24小時內超過50次變更
        await this.alertService.sendAlert({
          type: 'HIGH_CHANGE_FREQUENCY',
          severity: 'WARNING',
          message: `用戶 ${userId} 在24小時內變更設定 ${userChanges.length} 次`,
          data: { userId, changeCount: userChanges.length }
        });
      }
    }

    // 檢查敏感設定變更
    const sensitiveChanges = changes.filter(change => 
      this.isSensitiveSetting(change.settingId)
    );
    
    if (sensitiveChanges.length > 0) {
      await this.alertService.sendAlert({
        type: 'SENSITIVE_SETTING_CHANGED',
        severity: 'HIGH',
        message: `檢測到 ${sensitiveChanges.length} 個敏感設定變更`,
        data: { changes: sensitiveChanges }
      });
    }
  }

  // 監控設定一致性
  async monitorConsistency(): Promise<void> {
    const inconsistencies = [];

    // 檢查跨環境一致性
    const environments = ['development', 'testing', 'production'];
    const criticalSettings = await this.getCriticalSettings();

    for (const setting of criticalSettings) {
      const values = new Map();
      for (const env of environments) {
        const value = await this.getSettingValue(setting.key, env);
        values.set(env, value);
      }

      // 檢查是否所有環境的值都相同
      const uniqueValues = new Set(values.values());
      if (uniqueValues.size > 1 && setting.shouldBeConsistent) {
        inconsistencies.push({
          settingKey: setting.key,
          values: Object.fromEntries(values)
        });
      }
    }

    if (inconsistencies.length > 0) {
      await this.alertService.sendAlert({
        type: 'SETTING_INCONSISTENCY',
        severity: 'MEDIUM',
        message: `發現 ${inconsistencies.length} 個設定跨環境不一致`,
        data: { inconsistencies }
      });
    }
  }

  // 監控設定效能
  async monitorPerformance(): Promise<void> {
    const metrics = await this.collectPerformanceMetrics();

    // 檢查快取命中率
    if (metrics.cacheHitRate < 0.8) {
      await this.alertService.sendAlert({
        type: 'LOW_CACHE_HIT_RATE',
        severity: 'MEDIUM',
        message: `設定快取命中率過低: ${metrics.cacheHitRate * 100}%`,
        data: { cacheHitRate: metrics.cacheHitRate }
      });
    }

    // 檢查查詢響應時間
    if (metrics.averageQueryTime > 100) {
      await this.alertService.sendAlert({
        type: 'SLOW_SETTING_QUERIES',
        severity: 'MEDIUM',
        message: `設定查詢平均響應時間過長: ${metrics.averageQueryTime}ms`,
        data: { averageQueryTime: metrics.averageQueryTime }
      });
    }
  }
}
```

### 11.2 健康檢查
```typescript
class SettingHealthChecker {
  async performHealthCheck(): Promise<HealthCheckResult> {
    const checks = [];

    // 檢查資料庫連線
    try {
      await this.settingRepository.ping();
      checks.push({ name: 'database', status: 'healthy' });
    } catch (error) {
      checks.push({ 
        name: 'database', 
        status: 'unhealthy', 
        error: error.message 
      });
    }

    // 檢查快取連線
    try {
      await this.cacheManager.ping();
      checks.push({ name: 'cache', status: 'healthy' });
    } catch (error) {
      checks.push({ 
        name: 'cache', 
        status: 'unhealthy', 
        error: error.message 
      });
    }

    // 檢查關鍵設定
    const criticalSettings = await this.getCriticalSettings();
    let criticalSettingsHealthy = true;
    
    for (const setting of criticalSettings) {
      try {
        const value = await this.settingService.getValue(
          setting.category, 
          setting.key, 
          setting.moduleId
        );
        if (value === null || value === undefined) {
          criticalSettingsHealthy = false;
          break;
        }
      } catch (error) {
        criticalSettingsHealthy = false;
        break;
      }
    }

    checks.push({ 
      name: 'critical_settings', 
      status: criticalSettingsHealthy ? 'healthy' : 'unhealthy' 
    });

    // 檢查快取一致性
    try {
      const validationResult = await this.cacheStrategy.validateCache();
      const consistencyRatio = validationResult.valid / 
        (validationResult.valid + validationResult.invalid + validationResult.missing);
      
      checks.push({ 
        name: 'cache_consistency', 
        status: consistencyRatio > 0.95 ? 'healthy' : 'degraded',
        details: validationResult
      });
    } catch (error) {
      checks.push({ 
        name: 'cache_consistency', 
        status: 'unhealthy', 
        error: error.message 
      });
    }

    const overallStatus = checks.every(check => check.status === 'healthy') 
      ? 'healthy' 
      : checks.some(check => check.status === 'unhealthy') 
        ? 'unhealthy' 
        : 'degraded';

    return {
      status: overallStatus,
      timestamp: new Date(),
      checks
    };
  }
}

interface HealthCheckResult {
  status: 'healthy' | 'degraded' | 'unhealthy';
  timestamp: Date;
  checks: HealthCheck[];
}

interface HealthCheck {
  name: string;
  status: 'healthy' | 'degraded' | 'unhealthy';
  error?: string;
  details?: any;
}
```

## 12. 部署與配置

### 12.1 環境變數配置
```bash
# 基本配置
NODE_ENV=production
SETTING_DB_HOST=localhost
SETTING_DB_PORT=3306
SETTING_DB_NAME=mickeyshop_settings
SETTING_DB_USER=setting_user
SETTING_DB_PASSWORD=secure_password

# 快取配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=redis_password
CACHE_TTL_SECONDS=3600

# 加密配置
SETTING_ENCRYPTION_KEY=your-256-bit-encryption-key
SETTING_HASH_SALT=your-hash-salt

# WebSocket 配置
WS_PORT=8080
WS_PATH=/settings

# 監控配置
MONITORING_ENABLED=true
ALERT_WEBHOOK_URL=https://your-monitoring-service.com/webhook
```

### 12.2 Docker 配置
```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000 8080

CMD ["npm", "start"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  setting-service:
    build: .
    ports:
      - "3000:3000"
      - "8080:8080"
    environment:
      - NODE_ENV=production
      - SETTING_DB_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis
    networks:
      - mickeyshop-network

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=mickeyshop_settings
      - MYSQL_USER=setting_user
      - MYSQL_PASSWORD=secure_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - mickeyshop-network

  redis:
    image: redis:7-alpine
    command: redis-server --requirepass redis_password
    networks:
      - mickeyshop-network

volumes:
  mysql_data:

networks:
  mickeyshop-network:
    driver: bridge
```

### 12.3 初始化數據
```sql
-- init.sql
INSERT INTO system_settings (
  setting_id, category, key, display_name, 
  value, default_value, data_type, is_required,
  created_at, updated_at, created_by, updated_by
) VALUES 
-- 系統核心設定
('sys_001', 'system_core', 'system.name', '系統名稱', 
 'MickeyShop Beauty', 'MickeyShop Beauty', 'string', true,
 NOW(), NOW(), 'system', 'system'),

('sys_002', 'system_core', 'system.timezone', '系統時區', 
 'Asia/Taipei', 'Asia/Taipei', 'select', true,
 NOW(), NOW(), 'system', 'system'),

('sys_003', 'system_core', 'system.language', '預設語言', 
 'zh-TW', 'zh-TW', 'select', true,
 NOW(), NOW(), 'system', 'system'),

-- 前台主題設定
('fe_001', 'frontend_theme', 'frontend.theme.primary_color', '主要顏色', 
 '#ff69b4', '#ff69b4', 'color', false,
 NOW(), NOW(), 'system', 'system'),

('fe_002', 'frontend_theme', 'frontend.theme.secondary_color', '次要顏色', 
 '#ffc0cb', '#ffc0cb', 'color', false,
 NOW(), NOW(), 'system', 'system'),

-- 安全設定
('sec_001', 'system_security', 'security.password.min_length', '密碼最小長度', 
 '8', '8', 'number', true,
 NOW(), NOW(), 'system', 'system'),

('sec_002', 'system_security', 'security.session.timeout_minutes', '會話超時時間', 
 '30', '30', 'number', true,
 NOW(), NOW(), 'system', 'system');

-- 建立預設設定分組
INSERT INTO setting_groups (
  group_id, name, description, category, order_index,
  created_at, updated_at
) VALUES 
('grp_001', '基本資訊', '系統基本資訊設定', 'system_core', 1, NOW(), NOW()),
('grp_002', '安全設定', '系統安全相關設定', 'system_security', 2, NOW(), NOW()),
('grp_003', '主題外觀', '前台主題與外觀設定', 'frontend_theme', 3, NOW(), NOW());

-- 設定與分組關聯
INSERT INTO setting_group_items (group_id, setting_id, order_index) VALUES 
('grp_001', 'sys_001', 1),
('grp_001', 'sys_002', 2),
('grp_001', 'sys_003', 3),
('grp_002', 'sec_001', 1),
('grp_002', 'sec_002', 2),
('grp_003', 'fe_001', 1),
('grp_003', 'fe_002', 2);
```

此系統設定模組設計提供了完整的配置管理解決方案，能夠統一管理整個平台的所有設定項目，並提供強大的權限控制、版本管理、實時同步等功能。

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"content": "設計系統設定模組功能規格", "status": "completed", "activeForm": "設計系統設定模組功能規格"}, {"content": "設計完整的单據流程", "status": "in_progress", "activeForm": "設計完整的单據流程"}, {"content": "設計綠界物流整合架構", "status": "pending", "activeForm": "設計綠界物流整合架構"}, {"content": "完善前台與後台API整合規格", "status": "pending", "activeForm": "完善前台與後台API整合規格"}, {"content": "確認架構設計完整性", "status": "pending", "activeForm": "確認架構設計完整性"}]