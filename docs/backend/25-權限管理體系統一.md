# 權限管理體系統一 (Unified Permission Management System)

## 1. 概述

本文檔建立 MickeyShop Beauty 系統統一的權限管理體系，解決目前系統中權限檢查方式不一致、權限資料結構衝突、權限顆粒度不統一等問題，確保整個平台的安全性和一致性。

## 2. 發現的問題分析

### 2.1 權限檢查方式不一致問題

**發現的差異：**
```javascript
// 管理員管理系統中
requirePermission('admin', 'read')

// 商品管理系統中  
requirePermission('product', 'read')

// 系統設定模組中
// 使用完全不同的權限體系
permissions: SettingPermissionType[]
```

### 2.2 權限資料結構衝突問題

**問題：**
- JSON 格式權限 vs 陣列格式權限
- 權限顆粒度不統一
- 權限繼承規則不明確

### 2.3 權限檢查邏輯分散問題

**問題：**
- 每個模組都有自己的權限檢查邏輯
- 缺乏統一的權限驗證中間件
- 權限快取機制不一致

## 3. 統一權限管理架構設計

### 3.1 權限體系架構

```
┌─────────────────────────────────────┐
│            權限檢查層                │
│   (中間件、裝飾器、工具函數)         │
└─────────────────────────────────────┘
                    │
┌─────────────────────────────────────┐
│            權限管理層                │
│   (權限驗證、角色解析、快取管理)     │
└─────────────────────────────────────┘
                    │
┌─────────────────────────────────────┐
│            權限儲存層                │
│   (用戶-角色-權限關聯、資料庫存取)   │
└─────────────────────────────────────┘
```

### 3.2 核心元件設計

```typescript
interface PermissionSystem {
  // 權限管理器
  permissionManager: PermissionManager;
  
  // 角色管理器
  roleManager: RoleManager;
  
  // 權限檢查器
  permissionChecker: PermissionChecker;
  
  // 權限快取
  permissionCache: PermissionCache;
  
  // 權限同步器
  permissionSynchronizer: PermissionSynchronizer;
}
```

## 4. 統一權限資料模型

### 4.1 權限定義

```typescript
interface Permission {
  permissionId: string;
  permissionName: string;
  module: string;
  operation: string;
  resource?: string;
  description: string;
  isSystemPermission: boolean;
  createdAt: Date;
  updatedAt: Date;
}

// 權限命名規範：{module}.{operation}.{resource?}
enum StandardPermissions {
  // 管理員管理
  ADMIN_USER_READ = 'admin.read.user',
  ADMIN_USER_CREATE = 'admin.create.user',
  ADMIN_USER_UPDATE = 'admin.update.user',
  ADMIN_USER_DELETE = 'admin.delete.user',
  ADMIN_ROLE_MANAGE = 'admin.manage.role',
  ADMIN_PERMISSION_MANAGE = 'admin.manage.permission',
  
  // 商品管理
  PRODUCT_READ = 'product.read',
  PRODUCT_CREATE = 'product.create',
  PRODUCT_UPDATE = 'product.update',
  PRODUCT_DELETE = 'product.delete',
  PRODUCT_PUBLISH = 'product.publish',
  PRODUCT_BATCH_IMPORT = 'product.batch.import',
  PRODUCT_BATCH_EXPORT = 'product.batch.export',
  
  // 商品分類
  CATEGORY_READ = 'category.read',
  CATEGORY_MANAGE = 'category.manage',
  
  // 商品SKU
  SKU_READ = 'sku.read',
  SKU_CREATE = 'sku.create',
  SKU_UPDATE = 'sku.update',
  SKU_DELETE = 'sku.delete',
  
  // 庫存管理
  INVENTORY_READ = 'inventory.read',
  INVENTORY_UPDATE = 'inventory.update',
  INVENTORY_ADJUST = 'inventory.adjust',
  INVENTORY_TRANSFER = 'inventory.transfer',
  INVENTORY_STOCKTAKE = 'inventory.stocktake',
  
  // 訂單管理
  ORDER_READ = 'order.read',
  ORDER_UPDATE = 'order.update',
  ORDER_CANCEL = 'order.cancel',
  ORDER_REFUND = 'order.refund',
  ORDER_SHIP = 'order.ship',
  ORDER_EXPORT = 'order.export',
  
  // 客戶管理
  CUSTOMER_READ = 'customer.read',
  CUSTOMER_UPDATE = 'customer.update',
  CUSTOMER_DELETE = 'customer.delete',
  CUSTOMER_EXPORT = 'customer.export',
  
  // 促銷管理
  PROMOTION_READ = 'promotion.read',
  PROMOTION_CREATE = 'promotion.create',
  PROMOTION_UPDATE = 'promotion.update',
  PROMOTION_DELETE = 'promotion.delete',
  PROMOTION_ACTIVATE = 'promotion.activate',
  
  // 優惠券管理
  COUPON_READ = 'coupon.read',
  COUPON_CREATE = 'coupon.create',
  COUPON_UPDATE = 'coupon.update',
  COUPON_DELETE = 'coupon.delete',
  COUPON_GENERATE = 'coupon.generate',
  
  // 贈品管理
  GIFT_READ = 'gift.read',
  GIFT_MANAGE = 'gift.manage',
  
  // 供應商管理
  SUPPLIER_READ = 'supplier.read',
  SUPPLIER_CREATE = 'supplier.create',
  SUPPLIER_UPDATE = 'supplier.update',
  SUPPLIER_DELETE = 'supplier.delete',
  
  // 採購管理
  PURCHASE_READ = 'purchase.read',
  PURCHASE_CREATE = 'purchase.create',
  PURCHASE_UPDATE = 'purchase.update',
  PURCHASE_APPROVE = 'purchase.approve',
  
  // 物流管理
  LOGISTICS_READ = 'logistics.read',
  LOGISTICS_CREATE = 'logistics.create',
  LOGISTICS_UPDATE = 'logistics.update',
  LOGISTICS_TRACK = 'logistics.track',
  
  // 通知管理
  NOTIFICATION_READ = 'notification.read',
  NOTIFICATION_SEND = 'notification.send',
  NOTIFICATION_MANAGE = 'notification.manage',
  
  // 內容管理
  CONTENT_READ = 'content.read',
  CONTENT_CREATE = 'content.create',
  CONTENT_UPDATE = 'content.update',
  CONTENT_DELETE = 'content.delete',
  CONTENT_PUBLISH = 'content.publish',
  
  // 會計處理
  ACCOUNTING_READ = 'accounting.read',
  ACCOUNTING_CREATE = 'accounting.create',
  ACCOUNTING_UPDATE = 'accounting.update',
  ACCOUNTING_EXPORT = 'accounting.export',
  
  // 數據分析
  ANALYTICS_READ = 'analytics.read',
  ANALYTICS_EXPORT = 'analytics.export',
  
  // 儀表板
  DASHBOARD_READ = 'dashboard.read',
  DASHBOARD_CUSTOMIZE = 'dashboard.customize',
  
  // 系統設定
  SETTING_READ = 'setting.read',
  SETTING_UPDATE = 'setting.update',
  SETTING_SYSTEM = 'setting.system',
  
  // 系統監控
  SYSTEM_MONITOR = 'system.monitor',
  SYSTEM_BACKUP = 'system.backup',
  SYSTEM_MAINTENANCE = 'system.maintenance'
}
```

### 4.2 角色定義

```typescript
interface Role {
  roleId: string;
  roleName: string;
  displayName: string;
  description: string;
  roleType: RoleType;
  isSystemRole: boolean;
  isActive: boolean;
  permissions: string[]; // Permission IDs
  createdAt: Date;
  updatedAt: Date;
}

enum RoleType {
  SUPER_ADMIN = 'super_admin',
  ADMIN = 'admin',
  MANAGER = 'manager',
  OPERATOR = 'operator',
  VIEWER = 'viewer',
  CUSTOM = 'custom'
}

// 預定義角色
const SystemRoles = {
  SUPER_ADMIN: {
    roleId: 'super_admin',
    roleName: 'super_admin',
    displayName: '超級管理員',
    description: '擁有所有權限的超級管理員',
    roleType: RoleType.SUPER_ADMIN,
    isSystemRole: true,
    permissions: ['*'] // 所有權限
  },
  
  SYSTEM_ADMIN: {
    roleId: 'system_admin',
    roleName: 'system_admin',
    displayName: '系統管理員',
    description: '系統管理與設定權限',
    roleType: RoleType.ADMIN,
    isSystemRole: true,
    permissions: [
      StandardPermissions.ADMIN_USER_READ,
      StandardPermissions.ADMIN_USER_CREATE,
      StandardPermissions.ADMIN_USER_UPDATE,
      StandardPermissions.ADMIN_ROLE_MANAGE,
      StandardPermissions.SETTING_READ,
      StandardPermissions.SETTING_UPDATE,
      StandardPermissions.SYSTEM_MONITOR
    ]
  },
  
  PRODUCT_MANAGER: {
    roleId: 'product_manager',
    roleName: 'product_manager',
    displayName: '商品經理',
    description: '商品與庫存管理權限',
    roleType: RoleType.MANAGER,
    isSystemRole: true,
    permissions: [
      StandardPermissions.PRODUCT_READ,
      StandardPermissions.PRODUCT_CREATE,
      StandardPermissions.PRODUCT_UPDATE,
      StandardPermissions.PRODUCT_PUBLISH,
      StandardPermissions.CATEGORY_MANAGE,
      StandardPermissions.INVENTORY_READ,
      StandardPermissions.INVENTORY_UPDATE
    ]
  },
  
  ORDER_MANAGER: {
    roleId: 'order_manager',
    roleName: 'order_manager',
    displayName: '訂單經理',
    description: '訂單處理與客戶管理權限',
    roleType: RoleType.MANAGER,
    isSystemRole: true,
    permissions: [
      StandardPermissions.ORDER_READ,
      StandardPermissions.ORDER_UPDATE,
      StandardPermissions.ORDER_CANCEL,
      StandardPermissions.ORDER_REFUND,
      StandardPermissions.ORDER_SHIP,
      StandardPermissions.CUSTOMER_READ,
      StandardPermissions.CUSTOMER_UPDATE,
      StandardPermissions.LOGISTICS_READ,
      StandardPermissions.LOGISTICS_CREATE
    ]
  },
  
  SALES_OPERATOR: {
    roleId: 'sales_operator',
    roleName: 'sales_operator',
    displayName: '銷售專員',
    description: '銷售相關操作權限',
    roleType: RoleType.OPERATOR,
    isSystemRole: true,
    permissions: [
      StandardPermissions.ORDER_READ,
      StandardPermissions.ORDER_UPDATE,
      StandardPermissions.CUSTOMER_READ,
      StandardPermissions.PROMOTION_READ,
      StandardPermissions.COUPON_READ,
      StandardPermissions.PRODUCT_READ
    ]
  },
  
  WAREHOUSE_OPERATOR: {
    roleId: 'warehouse_operator',
    roleName: 'warehouse_operator',
    displayName: '倉庫專員',
    description: '倉庫管理操作權限',
    roleType: RoleType.OPERATOR,
    isSystemRole: true,
    permissions: [
      StandardPermissions.INVENTORY_READ,
      StandardPermissions.INVENTORY_UPDATE,
      StandardPermissions.INVENTORY_ADJUST,
      StandardPermissions.INVENTORY_TRANSFER,
      StandardPermissions.ORDER_READ,
      StandardPermissions.ORDER_SHIP,
      StandardPermissions.PURCHASE_READ,
      StandardPermissions.SUPPLIER_READ
    ]
  },
  
  DATA_ANALYST: {
    roleId: 'data_analyst',
    roleName: 'data_analyst',
    displayName: '數據分析師',
    description: '數據查看與分析權限',
    roleType: RoleType.VIEWER,
    isSystemRole: true,
    permissions: [
      StandardPermissions.ANALYTICS_READ,
      StandardPermissions.ANALYTICS_EXPORT,
      StandardPermissions.DASHBOARD_READ,
      StandardPermissions.ORDER_READ,
      StandardPermissions.CUSTOMER_READ,
      StandardPermissions.PRODUCT_READ,
      StandardPermissions.INVENTORY_READ
    ]
  }
};
```

### 4.3 用戶角色關聯

```typescript
interface UserRole {
  userRoleId: string;
  userId: string;
  roleId: string;
  grantedBy: string;
  grantedAt: Date;
  expiresAt?: Date;
  isActive: boolean;
  metadata?: Record<string, any>; // 額外的權限限制或配置
}

interface UserPermission {
  userPermissionId: string;
  userId: string;
  permissionId: string;
  grantedBy: string;
  grantedAt: Date;
  expiresAt?: Date;
  isActive: boolean;
  isDenied: boolean; // 明確拒絕的權限
  source: PermissionSource; // 權限來源
}

enum PermissionSource {
  ROLE = 'role',           // 來自角色
  DIRECT = 'direct',       // 直接授予
  TEMPORARY = 'temporary'  // 臨時權限
}
```

## 5. 權限管理核心服務

### 5.1 權限管理器

```typescript
class PermissionManager {
  private permissionRepository: PermissionRepository;
  private roleRepository: RoleRepository;
  private userRoleRepository: UserRoleRepository;
  private permissionCache: PermissionCache;

  // 檢查用戶權限
  async checkUserPermission(
    userId: string, 
    permission: string,
    resource?: string
  ): Promise<boolean> {
    try {
      // 1. 從快取獲取用戶權限
      let userPermissions = await this.permissionCache.getUserPermissions(userId);
      
      if (!userPermissions) {
        // 2. 計算用戶所有權限
        userPermissions = await this.calculateUserPermissions(userId);
        await this.permissionCache.setUserPermissions(userId, userPermissions, 3600); // 快取1小時
      }

      // 3. 檢查權限
      return this.hasPermission(userPermissions, permission, resource);
      
    } catch (error) {
      console.error('Permission check failed:', error);
      return false; // 預設拒絕
    }
  }

  // 計算用戶的所有權限
  private async calculateUserPermissions(userId: string): Promise<UserPermissions> {
    const permissions = new Set<string>();
    const deniedPermissions = new Set<string>();

    // 1. 獲取用戶的所有有效角色
    const userRoles = await this.userRoleRepository.findActiveUserRoles(userId);
    
    // 2. 收集角色權限
    for (const userRole of userRoles) {
      const role = await this.roleRepository.findById(userRole.roleId);
      if (role && role.isActive) {
        // 超級管理員擁有所有權限
        if (role.permissions.includes('*')) {
          permissions.add('*');
          break;
        }
        
        role.permissions.forEach(permission => {
          permissions.add(permission);
        });
      }
    }

    // 3. 獲取直接授予的權限
    const directPermissions = await this.userPermissionRepository.findActiveUserPermissions(userId);
    
    for (const userPermission of directPermissions) {
      if (userPermission.isDenied) {
        deniedPermissions.add(userPermission.permissionId);
      } else {
        permissions.add(userPermission.permissionId);
      }
    }

    // 4. 排除被明確拒絕的權限
    deniedPermissions.forEach(permission => {
      permissions.delete(permission);
    });

    return {
      userId,
      permissions: Array.from(permissions),
      deniedPermissions: Array.from(deniedPermissions),
      calculatedAt: new Date()
    };
  }

  // 檢查是否有特定權限
  private hasPermission(
    userPermissions: UserPermissions, 
    requiredPermission: string,
    resource?: string
  ): boolean {
    // 超級權限
    if (userPermissions.permissions.includes('*')) {
      return true;
    }

    // 明確被拒絕的權限
    if (userPermissions.deniedPermissions.includes(requiredPermission)) {
      return false;
    }

    // 精確匹配
    if (userPermissions.permissions.includes(requiredPermission)) {
      return true;
    }

    // 模式匹配（如 product.* 匹配 product.read）
    const permissionParts = requiredPermission.split('.');
    for (let i = permissionParts.length - 1; i >= 0; i--) {
      const pattern = permissionParts.slice(0, i + 1).join('.') + '.*';
      if (userPermissions.permissions.includes(pattern)) {
        return true;
      }
    }

    // 資源級別權限檢查
    if (resource) {
      const resourcePermission = `${requiredPermission}.${resource}`;
      if (userPermissions.permissions.includes(resourcePermission)) {
        return true;
      }
    }

    return false;
  }

  // 授予角色權限
  async grantRoleToUser(
    userId: string, 
    roleId: string, 
    grantedBy: string,
    expiresAt?: Date
  ): Promise<void> {
    // 檢查角色是否存在
    const role = await this.roleRepository.findById(roleId);
    if (!role) {
      throw new Error('Role not found');
    }

    // 檢查是否已經有此角色
    const existingUserRole = await this.userRoleRepository.findUserRole(userId, roleId);
    if (existingUserRole && existingUserRole.isActive) {
      throw new Error('User already has this role');
    }

    // 建立用戶角色關聯
    const userRole: UserRole = {
      userRoleId: generateId(),
      userId,
      roleId,
      grantedBy,
      grantedAt: new Date(),
      expiresAt,
      isActive: true
    };

    await this.userRoleRepository.save(userRole);

    // 清除用戶權限快取
    await this.permissionCache.clearUserPermissions(userId);

    // 記錄權限變更日誌
    await this.logPermissionChange({
      userId,
      action: 'ROLE_GRANTED',
      roleId,
      grantedBy,
      timestamp: new Date()
    });
  }

  // 撤銷角色權限
  async revokeRoleFromUser(
    userId: string, 
    roleId: string, 
    revokedBy: string
  ): Promise<void> {
    const userRole = await this.userRoleRepository.findUserRole(userId, roleId);
    if (!userRole || !userRole.isActive) {
      throw new Error('User does not have this role');
    }

    // 停用角色關聯
    userRole.isActive = false;
    userRole.revokedBy = revokedBy;
    userRole.revokedAt = new Date();

    await this.userRoleRepository.save(userRole);

    // 清除權限快取
    await this.permissionCache.clearUserPermissions(userId);

    // 記錄權限變更日誌
    await this.logPermissionChange({
      userId,
      action: 'ROLE_REVOKED',
      roleId,
      revokedBy,
      timestamp: new Date()
    });
  }

  // 直接授予權限
  async grantPermissionToUser(
    userId: string,
    permissionId: string,
    grantedBy: string,
    expiresAt?: Date
  ): Promise<void> {
    const permission = await this.permissionRepository.findById(permissionId);
    if (!permission) {
      throw new Error('Permission not found');
    }

    const userPermission: UserPermission = {
      userPermissionId: generateId(),
      userId,
      permissionId,
      grantedBy,
      grantedAt: new Date(),
      expiresAt,
      isActive: true,
      isDenied: false,
      source: PermissionSource.DIRECT
    };

    await this.userPermissionRepository.save(userPermission);
    await this.permissionCache.clearUserPermissions(userId);

    await this.logPermissionChange({
      userId,
      action: 'PERMISSION_GRANTED',
      permissionId,
      grantedBy,
      timestamp: new Date()
    });
  }

  // 獲取用戶所有權限
  async getUserPermissions(userId: string): Promise<UserPermissionSummary> {
    const userPermissions = await this.calculateUserPermissions(userId);
    const roles = await this.getUserRoles(userId);

    return {
      userId,
      roles,
      permissions: userPermissions.permissions,
      deniedPermissions: userPermissions.deniedPermissions,
      lastCalculated: userPermissions.calculatedAt
    };
  }

  // 獲取用戶角色
  async getUserRoles(userId: string): Promise<Role[]> {
    const userRoles = await this.userRoleRepository.findActiveUserRoles(userId);
    const roles: Role[] = [];

    for (const userRole of userRoles) {
      const role = await this.roleRepository.findById(userRole.roleId);
      if (role && role.isActive) {
        roles.push(role);
      }
    }

    return roles;
  }
}

interface UserPermissions {
  userId: string;
  permissions: string[];
  deniedPermissions: string[];
  calculatedAt: Date;
}

interface UserPermissionSummary {
  userId: string;
  roles: Role[];
  permissions: string[];
  deniedPermissions: string[];
  lastCalculated: Date;
}
```

### 5.2 權限檢查中間件

```typescript
class PermissionMiddleware {
  constructor(
    private permissionManager: PermissionManager,
    private requiredPermissions: string | string[],
    private options?: PermissionCheckOptions
  ) {}

  async handle(request: Request, next: Function): Promise<Response> {
    // 獲取當前用戶
    const user = request.user;
    if (!user) {
      return this.createUnauthorizedResponse();
    }

    const permissions = Array.isArray(this.requiredPermissions) 
      ? this.requiredPermissions 
      : [this.requiredPermissions];

    // 檢查權限
    const hasPermission = await this.checkPermissions(user.id, permissions);
    
    if (!hasPermission) {
      return this.createForbiddenResponse();
    }

    return next();
  }

  private async checkPermissions(
    userId: string, 
    permissions: string[]
  ): Promise<boolean> {
    const { requireAll = true } = this.options || {};

    if (requireAll) {
      // 需要所有權限
      for (const permission of permissions) {
        const hasPermission = await this.permissionManager.checkUserPermission(
          userId, 
          permission
        );
        if (!hasPermission) {
          return false;
        }
      }
      return true;
    } else {
      // 只需要其中一個權限
      for (const permission of permissions) {
        const hasPermission = await this.permissionManager.checkUserPermission(
          userId, 
          permission
        );
        if (hasPermission) {
          return true;
        }
      }
      return false;
    }
  }

  private createUnauthorizedResponse(): Response {
    return Response.json({
      success: false,
      error: {
        code: 'UNAUTHORIZED',
        message: '請先登入'
      }
    }, { status: 401 });
  }

  private createForbiddenResponse(): Response {
    return Response.json({
      success: false,
      error: {
        code: 'FORBIDDEN',
        message: '您沒有執行此操作的權限'
      }
    }, { status: 403 });
  }
}

interface PermissionCheckOptions {
  requireAll?: boolean; // 是否需要所有權限，預設 true
  resource?: string;    // 資源標識符
  skipCache?: boolean;  // 跳過快取
}

// 使用範例
const productRoutes = new Router()
  .get('/products', 
    new PermissionMiddleware(StandardPermissions.PRODUCT_READ),
    ProductController.list
  )
  .post('/products',
    new PermissionMiddleware(StandardPermissions.PRODUCT_CREATE),
    ProductController.create
  )
  .delete('/products/:id',
    new PermissionMiddleware([
      StandardPermissions.PRODUCT_DELETE,
      StandardPermissions.PRODUCT_UPDATE
    ], { requireAll: false }),
    ProductController.delete
  );
```

### 5.3 權限檢查裝飾器

```typescript
// 權限檢查裝飾器（用於類方法）
function RequirePermission(
  permission: string | string[],
  options?: PermissionCheckOptions
) {
  return function (
    target: any,
    propertyName: string,
    descriptor: PropertyDescriptor
  ) {
    const method = descriptor.value;
    
    descriptor.value = async function (...args: any[]) {
      const request = args[0] as Request;
      const user = request.user;
      
      if (!user) {
        throw new UnauthorizedError('Authentication required');
      }

      const permissionManager = getPermissionManager();
      const permissions = Array.isArray(permission) ? permission : [permission];
      const { requireAll = true } = options || {};

      let hasPermission = false;
      
      if (requireAll) {
        hasPermission = true;
        for (const perm of permissions) {
          const result = await permissionManager.checkUserPermission(user.id, perm);
          if (!result) {
            hasPermission = false;
            break;
          }
        }
      } else {
        for (const perm of permissions) {
          const result = await permissionManager.checkUserPermission(user.id, perm);
          if (result) {
            hasPermission = true;
            break;
          }
        }
      }

      if (!hasPermission) {
        throw new ForbiddenError('Insufficient permissions');
      }

      return method.apply(this, args);
    };
  };
}

// 使用範例
class ProductController {
  @RequirePermission(StandardPermissions.PRODUCT_READ)
  async list(request: Request): Promise<Response> {
    // 控制器邏輯
  }

  @RequirePermission(StandardPermissions.PRODUCT_CREATE)
  async create(request: Request): Promise<Response> {
    // 控制器邏輯
  }

  @RequirePermission([
    StandardPermissions.PRODUCT_UPDATE,
    StandardPermissions.PRODUCT_DELETE
  ], { requireAll: false })
  async update(request: Request): Promise<Response> {
    // 控制器邏輯
  }
}
```

### 5.4 權限快取服務

```typescript
class PermissionCache {
  private cache = new Map<string, CacheEntry>();
  private defaultTTL = 3600; // 1小時

  async getUserPermissions(userId: string): Promise<UserPermissions | null> {
    const cacheKey = `user_permissions:${userId}`;
    const entry = this.cache.get(cacheKey);
    
    if (!entry || this.isExpired(entry)) {
      return null;
    }
    
    return entry.data;
  }

  async setUserPermissions(
    userId: string, 
    permissions: UserPermissions,
    ttl: number = this.defaultTTL
  ): Promise<void> {
    const cacheKey = `user_permissions:${userId}`;
    const entry: CacheEntry = {
      data: permissions,
      expiresAt: Date.now() + ttl * 1000
    };
    
    this.cache.set(cacheKey, entry);
  }

  async clearUserPermissions(userId: string): Promise<void> {
    const cacheKey = `user_permissions:${userId}`;
    this.cache.delete(cacheKey);
  }

  async clearAllUserPermissions(): Promise<void> {
    for (const key of this.cache.keys()) {
      if (key.startsWith('user_permissions:')) {
        this.cache.delete(key);
      }
    }
  }

  // 批量預熱快取
  async warmupCache(userIds: string[]): Promise<void> {
    const permissionManager = getPermissionManager();
    
    for (const userId of userIds) {
      try {
        const permissions = await permissionManager.calculateUserPermissions(userId);
        await this.setUserPermissions(userId, permissions);
      } catch (error) {
        console.error(`Failed to warm up cache for user ${userId}:`, error);
      }
    }
  }

  private isExpired(entry: CacheEntry): boolean {
    return Date.now() > entry.expiresAt;
  }

  // 清理過期快取
  cleanup(): void {
    const now = Date.now();
    for (const [key, entry] of this.cache.entries()) {
      if (now > entry.expiresAt) {
        this.cache.delete(key);
      }
    }
  }
}

interface CacheEntry {
  data: any;
  expiresAt: number;
}

// 定期清理過期快取
setInterval(() => {
  getPermissionCache().cleanup();
}, 300000); // 每5分鐘清理一次
```

## 6. 權限工具函數

### 6.1 權限檢查工具

```typescript
class PermissionUtils {
  private static permissionManager: PermissionManager;

  // 簡化的權限檢查函數
  static async can(
    userId: string, 
    permission: string,
    resource?: string
  ): Promise<boolean> {
    return await this.permissionManager.checkUserPermission(
      userId, 
      permission, 
      resource
    );
  }

  // 批量權限檢查
  static async canAll(
    userId: string, 
    permissions: string[]
  ): Promise<boolean> {
    for (const permission of permissions) {
      const result = await this.can(userId, permission);
      if (!result) {
        return false;
      }
    }
    return true;
  }

  // 任一權限檢查
  static async canAny(
    userId: string, 
    permissions: string[]
  ): Promise<boolean> {
    for (const permission of permissions) {
      const result = await this.can(userId, permission);
      if (result) {
        return true;
      }
    }
    return false;
  }

  // 權限斷言（會拋出異常）
  static async assertPermission(
    userId: string, 
    permission: string,
    resource?: string
  ): Promise<void> {
    const hasPermission = await this.can(userId, permission, resource);
    if (!hasPermission) {
      throw new ForbiddenError(`Permission denied: ${permission}`);
    }
  }

  // 過濾有權限的項目
  static async filterByPermission<T>(
    userId: string,
    items: T[],
    permissionGetter: (item: T) => string
  ): Promise<T[]> {
    const results: T[] = [];
    
    for (const item of items) {
      const permission = permissionGetter(item);
      const hasPermission = await this.can(userId, permission);
      if (hasPermission) {
        results.push(item);
      }
    }
    
    return results;
  }

  // 權限樹形結構檢查
  static async getPermissionTree(
    userId: string
  ): Promise<PermissionNode[]> {
    const userPermissions = await this.permissionManager.getUserPermissions(userId);
    return this.buildPermissionTree(userPermissions.permissions);
  }

  private static buildPermissionTree(permissions: string[]): PermissionNode[] {
    const tree: Map<string, PermissionNode> = new Map();
    
    permissions.forEach(permission => {
      const parts = permission.split('.');
      let currentLevel = tree;
      let currentPath = '';
      
      parts.forEach((part, index) => {
        currentPath = currentPath ? `${currentPath}.${part}` : part;
        
        if (!currentLevel.has(part)) {
          currentLevel.set(part, {
            name: part,
            fullPath: currentPath,
            children: new Map(),
            hasPermission: false
          });
        }
        
        const node = currentLevel.get(part)!;
        
        if (index === parts.length - 1) {
          node.hasPermission = true;
        }
        
        currentLevel = node.children;
      });
    });
    
    return Array.from(tree.values()).map(this.convertMapToArray);
  }

  private static convertMapToArray(node: PermissionNode): PermissionNode {
    return {
      ...node,
      children: Array.from(node.children.values()).map(this.convertMapToArray)
    };
  }
}

interface PermissionNode {
  name: string;
  fullPath: string;
  hasPermission: boolean;
  children: PermissionNode[] | Map<string, PermissionNode>;
}
```

### 6.2 前端權限檢查

```typescript
// 前端權限檢查服務
class FrontendPermissionService {
  private userPermissions: Set<string> = new Set();

  // 初始化用戶權限
  async initializePermissions(userId: string): Promise<void> {
    try {
      const response = await fetch(`/api/admin/v1/users/${userId}/permissions`);
      const data = await response.json();
      
      if (data.success) {
        this.userPermissions = new Set(data.data.permissions);
      }
    } catch (error) {
      console.error('Failed to load user permissions:', error);
    }
  }

  // 檢查權限
  hasPermission(permission: string): boolean {
    // 超級權限
    if (this.userPermissions.has('*')) {
      return true;
    }

    // 精確匹配
    if (this.userPermissions.has(permission)) {
      return true;
    }

    // 模式匹配
    const parts = permission.split('.');
    for (let i = parts.length - 1; i >= 0; i--) {
      const pattern = parts.slice(0, i + 1).join('.') + '.*';
      if (this.userPermissions.has(pattern)) {
        return true;
      }
    }

    return false;
  }

  // 批量檢查
  hasAllPermissions(permissions: string[]): boolean {
    return permissions.every(permission => this.hasPermission(permission));
  }

  hasAnyPermission(permissions: string[]): boolean {
    return permissions.some(permission => this.hasPermission(permission));
  }

  // 過濾選單項目
  filterMenuItems(menuItems: MenuItem[]): MenuItem[] {
    return menuItems.filter(item => {
      if (!item.requiredPermission) {
        return true;
      }
      return this.hasPermission(item.requiredPermission);
    }).map(item => ({
      ...item,
      children: item.children ? this.filterMenuItems(item.children) : undefined
    }));
  }
}

interface MenuItem {
  id: string;
  title: string;
  path?: string;
  requiredPermission?: string;
  children?: MenuItem[];
}

// Vue.js 權限指令
const permissionDirective = {
  mounted(el: HTMLElement, binding: any) {
    const permission = binding.value;
    const permissionService = getPermissionService();
    
    if (!permissionService.hasPermission(permission)) {
      el.style.display = 'none';
    }
  },
  
  updated(el: HTMLElement, binding: any) {
    const permission = binding.value;
    const permissionService = getPermissionService();
    
    if (!permissionService.hasPermission(permission)) {
      el.style.display = 'none';
    } else {
      el.style.display = '';
    }
  }
};

// 使用方式：<button v-permission="'product.create'">新增商品</button>
```

## 7. 資料庫設計

### 7.1 權限相關表結構

```sql
-- 權限表
CREATE TABLE permissions (
    permission_id VARCHAR(50) PRIMARY KEY,
    permission_name VARCHAR(100) NOT NULL UNIQUE,
    module VARCHAR(50) NOT NULL,
    operation VARCHAR(50) NOT NULL,
    resource VARCHAR(50),
    description TEXT,
    is_system_permission BOOLEAN DEFAULT FALSE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_permission_module_operation (module, operation, resource),
    INDEX idx_module (module),
    INDEX idx_operation (operation),
    INDEX idx_system_permission (is_system_permission)
);

-- 角色表
CREATE TABLE roles (
    role_id VARCHAR(50) PRIMARY KEY,
    role_name VARCHAR(100) NOT NULL UNIQUE,
    display_name VARCHAR(100) NOT NULL,
    description TEXT,
    role_type VARCHAR(50) NOT NULL DEFAULT 'custom',
    is_system_role BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_role_name (role_name),
    INDEX idx_role_type (role_type),
    INDEX idx_system_role (is_system_role),
    INDEX idx_is_active (is_active)
);

-- 角色權限關聯表
CREATE TABLE role_permissions (
    role_id VARCHAR(50),
    permission_id VARCHAR(50),
    granted_by VARCHAR(50),
    granted_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (role_id, permission_id),
    FOREIGN KEY (role_id) REFERENCES roles(role_id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(permission_id) ON DELETE CASCADE,
    FOREIGN KEY (granted_by) REFERENCES admin_users(admin_user_id) ON DELETE SET NULL,
    INDEX idx_role_id (role_id),
    INDEX idx_permission_id (permission_id)
);

-- 用戶角色關聯表
CREATE TABLE user_roles (
    user_role_id VARCHAR(50) PRIMARY KEY,
    user_id VARCHAR(50) NOT NULL,
    role_id VARCHAR(50) NOT NULL,
    granted_by VARCHAR(50),
    granted_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at DATETIME,
    is_active BOOLEAN DEFAULT TRUE,
    revoked_by VARCHAR(50),
    revoked_at DATETIME,
    metadata JSON,
    
    FOREIGN KEY (user_id) REFERENCES admin_users(admin_user_id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(role_id) ON DELETE CASCADE,
    FOREIGN KEY (granted_by) REFERENCES admin_users(admin_user_id) ON DELETE SET NULL,
    FOREIGN KEY (revoked_by) REFERENCES admin_users(admin_user_id) ON DELETE SET NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_role_id (role_id),
    INDEX idx_is_active (is_active),
    INDEX idx_expires_at (expires_at)
);

-- 用戶直接權限表
CREATE TABLE user_permissions (
    user_permission_id VARCHAR(50) PRIMARY KEY,
    user_id VARCHAR(50) NOT NULL,
    permission_id VARCHAR(50) NOT NULL,
    granted_by VARCHAR(50),
    granted_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at DATETIME,
    is_active BOOLEAN DEFAULT TRUE,
    is_denied BOOLEAN DEFAULT FALSE,
    source VARCHAR(20) NOT NULL DEFAULT 'direct',
    revoked_by VARCHAR(50),
    revoked_at DATETIME,
    
    FOREIGN KEY (user_id) REFERENCES admin_users(admin_user_id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(permission_id) ON DELETE CASCADE,
    FOREIGN KEY (granted_by) REFERENCES admin_users(admin_user_id) ON DELETE SET NULL,
    FOREIGN KEY (revoked_by) REFERENCES admin_users(admin_user_id) ON DELETE SET NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_permission_id (permission_id),
    INDEX idx_is_active (is_active),
    INDEX idx_is_denied (is_denied),
    INDEX idx_expires_at (expires_at)
);

-- 權限變更日誌表
CREATE TABLE permission_change_logs (
    log_id VARCHAR(50) PRIMARY KEY,
    user_id VARCHAR(50) NOT NULL,
    action VARCHAR(50) NOT NULL,
    role_id VARCHAR(50),
    permission_id VARCHAR(50),
    old_value JSON,
    new_value JSON,
    changed_by VARCHAR(50),
    changed_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ip_address VARCHAR(45),
    user_agent TEXT,
    reason TEXT,
    
    FOREIGN KEY (user_id) REFERENCES admin_users(admin_user_id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(role_id) ON DELETE SET NULL,
    FOREIGN KEY (permission_id) REFERENCES permissions(permission_id) ON DELETE SET NULL,
    FOREIGN KEY (changed_by) REFERENCES admin_users(admin_user_id) ON DELETE SET NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_action (action),
    INDEX idx_changed_at (changed_at)
);
```

### 7.2 初始化權限數據

```sql
-- 插入基本權限
INSERT INTO permissions (permission_id, permission_name, module, operation, description, is_system_permission) VALUES 
-- 管理員管理
('perm_admin_user_read', 'admin.read.user', 'admin', 'read', '查看管理員', TRUE),
('perm_admin_user_create', 'admin.create.user', 'admin', 'create', '建立管理員', TRUE),
('perm_admin_user_update', 'admin.update.user', 'admin', 'update', '更新管理員', TRUE),
('perm_admin_user_delete', 'admin.delete.user', 'admin', 'delete', '刪除管理員', TRUE),
('perm_admin_role_manage', 'admin.manage.role', 'admin', 'manage', '管理角色', TRUE),

-- 商品管理
('perm_product_read', 'product.read', 'product', 'read', '查看商品', TRUE),
('perm_product_create', 'product.create', 'product', 'create', '建立商品', TRUE),
('perm_product_update', 'product.update', 'product', 'update', '更新商品', TRUE),
('perm_product_delete', 'product.delete', 'product', 'delete', '刪除商品', TRUE),
('perm_product_publish', 'product.publish', 'product', 'publish', '發布商品', TRUE),

-- 訂單管理
('perm_order_read', 'order.read', 'order', 'read', '查看訂單', TRUE),
('perm_order_update', 'order.update', 'order', 'update', '更新訂單', TRUE),
('perm_order_cancel', 'order.cancel', 'order', 'cancel', '取消訂單', TRUE),
('perm_order_refund', 'order.refund', 'order', 'refund', '處理退款', TRUE),

-- 庫存管理
('perm_inventory_read', 'inventory.read', 'inventory', 'read', '查看庫存', TRUE),
('perm_inventory_update', 'inventory.update', 'inventory', 'update', '更新庫存', TRUE),
('perm_inventory_adjust', 'inventory.adjust', 'inventory', 'adjust', '調整庫存', TRUE),

-- 系統設定
('perm_setting_read', 'setting.read', 'setting', 'read', '查看設定', TRUE),
('perm_setting_update', 'setting.update', 'setting', 'update', '更新設定', TRUE),
('perm_setting_system', 'setting.system', 'setting', 'system', '系統設定', TRUE);

-- 插入系統角色
INSERT INTO roles (role_id, role_name, display_name, description, role_type, is_system_role) VALUES 
('role_super_admin', 'super_admin', '超級管理員', '擁有所有權限', 'super_admin', TRUE),
('role_system_admin', 'system_admin', '系統管理員', '系統管理權限', 'admin', TRUE),
('role_product_manager', 'product_manager', '商品經理', '商品管理權限', 'manager', TRUE),
('role_order_manager', 'order_manager', '訂單經理', '訂單管理權限', 'manager', TRUE),
('role_sales_operator', 'sales_operator', '銷售專員', '銷售操作權限', 'operator', TRUE),
('role_warehouse_operator', 'warehouse_operator', '倉庫專員', '倉庫操作權限', 'operator', TRUE);

-- 分配角色權限
INSERT INTO role_permissions (role_id, permission_id, granted_by) 
SELECT 'role_product_manager', permission_id, 'system'
FROM permissions 
WHERE permission_name LIKE 'product.%' OR permission_name LIKE 'inventory.%';

INSERT INTO role_permissions (role_id, permission_id, granted_by)
SELECT 'role_order_manager', permission_id, 'system'
FROM permissions 
WHERE permission_name LIKE 'order.%' OR permission_name = 'customer.read';
```

## 8. API 介面設計

### 8.1 權限管理 API

```typescript
// 獲取用戶權限
// GET /api/admin/v1/users/{userId}/permissions
interface GetUserPermissionsResponse {
  success: true;
  data: {
    userId: string;
    roles: Role[];
    permissions: string[];
    deniedPermissions: string[];
    lastCalculated: string;
  };
}

// 授予角色
// POST /api/admin/v1/users/{userId}/roles
interface GrantRoleRequest {
  roleId: string;
  expiresAt?: string;
  reason?: string;
}

// 撤銷角色
// DELETE /api/admin/v1/users/{userId}/roles/{roleId}
interface RevokeRoleRequest {
  reason: string;
}

// 直接授予權限
// POST /api/admin/v1/users/{userId}/permissions
interface GrantPermissionRequest {
  permissionId: string;
  expiresAt?: string;
  reason?: string;
}

// 獲取所有權限列表
// GET /api/admin/v1/permissions
interface GetPermissionsResponse {
  success: true;
  data: Permission[];
  meta: {
    total: number;
    byModule: Record<string, number>;
  };
}

// 獲取所有角色列表
// GET /api/admin/v1/roles
interface GetRolesResponse {
  success: true;
  data: Role[];
}

// 檢查權限
// POST /api/admin/v1/permissions/check
interface CheckPermissionRequest {
  userId: string;
  permissions: string[];
  requireAll?: boolean;
}

interface CheckPermissionResponse {
  success: true;
  data: {
    hasPermission: boolean;
    results: Array<{
      permission: string;
      hasPermission: boolean;
    }>;
  };
}
```

這個統一的權限管理體系解決了權限檢查方式不一致、權限資料結構衝突等問題，為整個系統提供了標準化、安全且高效的權限控制機制。

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"content": "\u4fee\u6b63\u8cc7\u6599\u5eab\u8a2d\u8a08\u4e0d\u4e00\u81f4\u6027\u554f\u984c", "status": "completed", "activeForm": "\u4fee\u6b63\u8cc7\u6599\u5eab\u8a2d\u8a08\u4e0d\u4e00\u81f4\u6027\u554f\u984c"}, {"content": "\u7d71\u4e00 API \u4ecb\u9762\u898f\u7bc4", "status": "completed", "activeForm": "\u7d71\u4e00 API \u4ecb\u9762\u898f\u7bc4"}, {"content": "\u7d71\u4e00\u6b0a\u9650\u7ba1\u7406\u9ad4\u7cfb", "status": "completed", "activeForm": "\u7d71\u4e00\u6b0a\u9650\u7ba1\u7406\u9ad4\u7cfb"}, {"content": "\u88dc\u5145\u7f3a\u5931\u7684\u6838\u5fc3\u6a21\u7d44", "status": "in_progress", "activeForm": "\u88dc\u5145\u7f3a\u5931\u7684\u6838\u5fc3\u6a21\u7d44"}, {"content": "\u5b8c\u5584\u524d\u53f0\u8207\u5f8c\u53f0API\u6574\u5408\u898f\u683c", "status": "pending", "activeForm": "\u5b8c\u5584\u524d\u53f0\u8207\u5f8c\u53f0API\u6574\u5408\u898f\u683c"}, {"content": "\u9a57\u8b49\u67b6\u69cb\u8a2d\u8a08\u5b8c\u6574\u6027", "status": "pending", "activeForm": "\u9a57\u8b49\u67b6\u69cb\u8a2d\u8a08\u5b8c\u6574\u6027"}]