# 資料庫設計標準化 (Database Design Standardization)

## 1. 概述

本文檔旨在解決 MickeyShop Beauty 系統中發現的資料庫設計不一致性問題，建立統一的資料庫設計標準，確保所有模組間的資料結構一致性和完整性。

## 2. 發現的問題分析

### 2.1 表名不一致問題

**問題：**
- `01-系統架構設計.md` 使用 `admins` 表
- `01-管理員管理系統.md` 使用 `admin_users` 表
- 其他模組引用時混用兩種表名

**解決方案：**
統一採用複數形式的表名，使用下劃線分隔：
```sql
-- 統一表名規範
admin_users        (管理員表)
customers         (客戶表)
products          (商品表)
product_skus      (商品SKU表)
orders            (訂單表)
order_items       (訂單明細表)
```

### 2.2 外鍵關聯不一致問題

**問題：**
- 不同模組中相同關聯使用不同的外鍵約束
- 部分表缺少必要的外鍵約束
- 刪除策略不統一

**解決方案：**
建立統一的外鍵約束規範。

### 2.3 資料類型不一致問題

**問題：**
- ID 欄位有時使用 VARCHAR(50)，有時使用 INT
- 金額欄位精度不統一
- 時間欄位格式不統一

## 3. 統一資料庫設計標準

### 3.1 表命名規範

```sql
-- 表名規範：
-- 1. 使用複數形式
-- 2. 使用下劃線分隔單字
-- 3. 全小寫字母

正確範例：
admin_users          -- 管理員
customers           -- 客戶
products            -- 商品
product_categories  -- 商品分類
product_skus        -- 商品SKU
product_variants    -- 商品變體
inventory_records   -- 庫存記錄
orders              -- 訂單
order_items         -- 訂單明細
shipping_orders     -- 物流訂單
payment_records     -- 付款記錄
promotion_rules     -- 促銷規則
gift_products       -- 贈品
supplier_companies  -- 供應商
purchase_orders     -- 採購訂單
```

### 3.2 欄位命名規範

```sql
-- 主鍵命名：{table_name_singular}_id
user_id              -- 用戶ID
product_id           -- 商品ID
order_id             -- 訂單ID

-- 外鍵命名：{referenced_table_singular}_id
customer_id          -- 引用客戶表
product_id           -- 引用商品表
category_id          -- 引用分類表

-- 布林值欄位：is_{condition} 或 has_{condition}
is_active            -- 是否啟用
is_deleted           -- 是否刪除
has_variants         -- 是否有變體

-- 時間欄位
created_at           -- 建立時間
updated_at           -- 更新時間
deleted_at           -- 刪除時間
expired_at           -- 過期時間
```

### 3.3 資料類型標準

```sql
-- ID 欄位統一使用 VARCHAR(50)
VARCHAR(50) PRIMARY KEY

-- 金額欄位統一使用 DECIMAL(15,2)
DECIMAL(15,2) NOT NULL DEFAULT 0

-- 時間欄位統一使用 DATETIME
DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP

-- 狀態欄位統一使用 VARCHAR(50)
VARCHAR(50) NOT NULL DEFAULT 'active'

-- 文字欄位
VARCHAR(255)         -- 短文字（姓名、標題等）
TEXT                 -- 長文字（描述、備註等）
JSON                 -- JSON 資料

-- 數值欄位
INT                  -- 整數
DECIMAL(10,2)        -- 小數
DECIMAL(15,2)        -- 金額
```

## 4. 核心資料表標準化設計

### 4.1 管理員相關表
```sql
-- 管理員表（統一使用 admin_users）
CREATE TABLE admin_users (
    admin_user_id VARCHAR(50) PRIMARY KEY,
    username VARCHAR(100) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    avatar_url VARCHAR(500),
    status VARCHAR(50) NOT NULL DEFAULT 'active',
    last_login_at DATETIME,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_status (status)
);

-- 管理員角色表
CREATE TABLE admin_roles (
    role_id VARCHAR(50) PRIMARY KEY,
    role_name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    is_system_role BOOLEAN DEFAULT FALSE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 管理員角色關聯表
CREATE TABLE admin_user_roles (
    admin_user_id VARCHAR(50),
    role_id VARCHAR(50),
    granted_by VARCHAR(50),
    granted_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (admin_user_id, role_id),
    FOREIGN KEY (admin_user_id) REFERENCES admin_users(admin_user_id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES admin_roles(role_id) ON DELETE CASCADE,
    FOREIGN KEY (granted_by) REFERENCES admin_users(admin_user_id)
);

-- 權限表
CREATE TABLE permissions (
    permission_id VARCHAR(50) PRIMARY KEY,
    permission_name VARCHAR(100) NOT NULL UNIQUE,
    module VARCHAR(50) NOT NULL,
    operation VARCHAR(50) NOT NULL,
    description TEXT,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 角色權限關聯表
CREATE TABLE role_permissions (
    role_id VARCHAR(50),
    permission_id VARCHAR(50),
    
    PRIMARY KEY (role_id, permission_id),
    FOREIGN KEY (role_id) REFERENCES admin_roles(role_id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(permission_id) ON DELETE CASCADE
);
```

### 4.2 客戶相關表
```sql
-- 客戶表（統一使用 customers）
CREATE TABLE customers (
    customer_id VARCHAR(50) PRIMARY KEY,
    email VARCHAR(255) UNIQUE, -- 可為 NULL（訪客）
    password_hash VARCHAR(255), -- 可為 NULL（訪客）
    full_name VARCHAR(100),
    phone VARCHAR(20),
    gender VARCHAR(10),
    birth_date DATE,
    customer_type VARCHAR(20) NOT NULL DEFAULT 'guest', -- 'member', 'guest'
    status VARCHAR(50) NOT NULL DEFAULT 'active',
    email_verified_at DATETIME,
    phone_verified_at DATETIME,
    last_login_at DATETIME,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_email (email),
    INDEX idx_phone (phone),
    INDEX idx_customer_type (customer_type),
    INDEX idx_status (status)
);

-- 客戶地址表
CREATE TABLE customer_addresses (
    address_id VARCHAR(50) PRIMARY KEY,
    customer_id VARCHAR(50) NOT NULL,
    recipient_name VARCHAR(100) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    zip_code VARCHAR(10) NOT NULL,
    city VARCHAR(50) NOT NULL,
    district VARCHAR(50) NOT NULL,
    address_line VARCHAR(255) NOT NULL,
    address_type VARCHAR(20) DEFAULT 'shipping', -- 'shipping', 'billing'
    is_default BOOLEAN DEFAULT FALSE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (customer_id) REFERENCES customers(customer_id) ON DELETE CASCADE,
    INDEX idx_customer_id (customer_id),
    INDEX idx_is_default (is_default)
);
```

### 4.3 商品相關表
```sql
-- 商品分類表
CREATE TABLE product_categories (
    category_id VARCHAR(50) PRIMARY KEY,
    parent_category_id VARCHAR(50),
    category_name VARCHAR(100) NOT NULL,
    category_slug VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    image_url VARCHAR(500),
    sort_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    seo_title VARCHAR(255),
    seo_description TEXT,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (parent_category_id) REFERENCES product_categories(category_id) ON DELETE SET NULL,
    INDEX idx_parent_category (parent_category_id),
    INDEX idx_slug (category_slug),
    INDEX idx_active (is_active),
    INDEX idx_sort_order (sort_order)
);

-- 商品表
CREATE TABLE products (
    product_id VARCHAR(50) PRIMARY KEY,
    category_id VARCHAR(50),
    product_name VARCHAR(255) NOT NULL,
    product_slug VARCHAR(255) NOT NULL UNIQUE,
    short_description TEXT,
    full_description TEXT,
    base_price DECIMAL(15,2) NOT NULL DEFAULT 0,
    compare_at_price DECIMAL(15,2),
    cost_price DECIMAL(15,2),
    product_type VARCHAR(50) DEFAULT 'physical', -- 'physical', 'digital', 'service'
    status VARCHAR(50) NOT NULL DEFAULT 'draft', -- 'draft', 'active', 'inactive', 'archived'
    
    -- SEO 欄位
    seo_title VARCHAR(255),
    seo_description TEXT,
    meta_keywords TEXT,
    
    -- 商品屬性
    weight DECIMAL(8,2), -- 公克
    length DECIMAL(8,2), -- 公分
    width DECIMAL(8,2),  -- 公分
    height DECIMAL(8,2), -- 公分
    volume DECIMAL(8,2), -- 立方公分
    
    -- 運送相關
    requires_shipping BOOLEAN DEFAULT TRUE,
    is_digital BOOLEAN DEFAULT FALSE,
    shipping_class VARCHAR(50),
    
    -- 庫存相關
    track_inventory BOOLEAN DEFAULT TRUE,
    continue_selling_when_out_of_stock BOOLEAN DEFAULT FALSE,
    
    -- 變體相關
    has_variants BOOLEAN DEFAULT FALSE,
    
    -- 時間欄位
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    published_at DATETIME,
    
    FOREIGN KEY (category_id) REFERENCES product_categories(category_id) ON DELETE SET NULL,
    INDEX idx_category (category_id),
    INDEX idx_slug (product_slug),
    INDEX idx_status (status),
    INDEX idx_product_type (product_type)
);

-- 商品SKU表（統一使用 product_skus）
CREATE TABLE product_skus (
    sku_id VARCHAR(50) PRIMARY KEY,
    product_id VARCHAR(50) NOT NULL,
    sku_code VARCHAR(100) NOT NULL UNIQUE,
    barcode VARCHAR(100),
    
    -- 價格資訊
    price DECIMAL(15,2) NOT NULL,
    compare_at_price DECIMAL(15,2),
    cost_price DECIMAL(15,2) NOT NULL DEFAULT 0,
    
    -- 庫存資訊
    inventory_quantity INT NOT NULL DEFAULT 0,
    reserved_quantity INT NOT NULL DEFAULT 0,
    available_quantity INT GENERATED ALWAYS AS (inventory_quantity - reserved_quantity) VIRTUAL,
    
    -- SKU 屬性
    weight DECIMAL(8,2),
    length DECIMAL(8,2),
    width DECIMAL(8,2),
    height DECIMAL(8,2),
    
    -- 變體屬性 JSON
    variant_attributes JSON,
    
    -- 狀態
    is_active BOOLEAN DEFAULT TRUE,
    
    -- 時間欄位
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (product_id) REFERENCES products(product_id) ON DELETE CASCADE,
    INDEX idx_product_id (product_id),
    INDEX idx_sku_code (sku_code),
    INDEX idx_barcode (barcode),
    INDEX idx_is_active (is_active)
);

-- 商品圖片表
CREATE TABLE product_images (
    image_id VARCHAR(50) PRIMARY KEY,
    product_id VARCHAR(50) NOT NULL,
    sku_id VARCHAR(50), -- 可為 NULL，表示商品主圖
    image_url VARCHAR(500) NOT NULL,
    alt_text VARCHAR(255),
    sort_order INT DEFAULT 0,
    is_primary BOOLEAN DEFAULT FALSE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (product_id) REFERENCES products(product_id) ON DELETE CASCADE,
    FOREIGN KEY (sku_id) REFERENCES product_skus(sku_id) ON DELETE CASCADE,
    INDEX idx_product_id (product_id),
    INDEX idx_sku_id (sku_id),
    INDEX idx_sort_order (sort_order)
);
```

### 4.4 訂單相關表
```sql
-- 訂單表（統一使用 orders）
CREATE TABLE orders (
    order_id VARCHAR(50) PRIMARY KEY,
    order_number VARCHAR(100) NOT NULL UNIQUE,
    customer_id VARCHAR(50), -- 可為 NULL（訪客訂單）
    customer_type VARCHAR(20) NOT NULL DEFAULT 'guest', -- 'member', 'guest'
    
    -- 訂單狀態
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    payment_status VARCHAR(50) NOT NULL DEFAULT 'pending',
    shipping_status VARCHAR(50) NOT NULL DEFAULT 'pending',
    fulfillment_status VARCHAR(50) NOT NULL DEFAULT 'unfulfilled',
    
    -- 金額資訊
    currency VARCHAR(10) DEFAULT 'TWD',
    exchange_rate DECIMAL(12,6) DEFAULT 1.0,
    subtotal_amount DECIMAL(15,2) NOT NULL DEFAULT 0,
    shipping_amount DECIMAL(15,2) NOT NULL DEFAULT 0,
    tax_amount DECIMAL(15,2) NOT NULL DEFAULT 0,
    discount_amount DECIMAL(15,2) NOT NULL DEFAULT 0,
    total_amount DECIMAL(15,2) NOT NULL DEFAULT 0,
    
    -- 客戶資訊
    customer_email VARCHAR(255),
    customer_phone VARCHAR(20),
    billing_address JSON,
    shipping_address JSON,
    
    -- 備註
    customer_notes TEXT,
    internal_notes TEXT,
    
    -- 時間欄位
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    confirmed_at DATETIME,
    shipped_at DATETIME,
    delivered_at DATETIME,
    cancelled_at DATETIME,
    
    FOREIGN KEY (customer_id) REFERENCES customers(customer_id) ON DELETE SET NULL,
    INDEX idx_order_number (order_number),
    INDEX idx_customer_id (customer_id),
    INDEX idx_status (status),
    INDEX idx_payment_status (payment_status),
    INDEX idx_created_at (created_at)
);

-- 訂單明細表（統一使用 order_items）
CREATE TABLE order_items (
    order_item_id VARCHAR(50) PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL,
    product_id VARCHAR(50) NOT NULL,
    sku_id VARCHAR(50) NOT NULL,
    
    -- 商品資訊快照
    product_name VARCHAR(255) NOT NULL,
    sku_code VARCHAR(100) NOT NULL,
    variant_attributes JSON,
    
    -- 數量和價格
    quantity INT NOT NULL,
    unit_price DECIMAL(15,2) NOT NULL,
    total_price DECIMAL(15,2) NOT NULL,
    
    -- 成本資訊
    unit_cost DECIMAL(15,2) NOT NULL DEFAULT 0,
    total_cost DECIMAL(15,2) NOT NULL DEFAULT 0,
    
    -- 履行狀態
    fulfillment_status VARCHAR(50) NOT NULL DEFAULT 'unfulfilled',
    fulfilled_quantity INT NOT NULL DEFAULT 0,
    
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(product_id) ON DELETE RESTRICT,
    FOREIGN KEY (sku_id) REFERENCES product_skus(sku_id) ON DELETE RESTRICT,
    INDEX idx_order_id (order_id),
    INDEX idx_product_id (product_id),
    INDEX idx_sku_id (sku_id)
);
```

### 4.5 庫存相關表
```sql
-- 庫存記錄表
CREATE TABLE inventory_records (
    record_id VARCHAR(50) PRIMARY KEY,
    sku_id VARCHAR(50) NOT NULL,
    transaction_type VARCHAR(50) NOT NULL, -- 'in', 'out', 'adjustment', 'transfer', 'reserved', 'unreserved'
    reference_type VARCHAR(50), -- 'order', 'purchase', 'adjustment', 'transfer'
    reference_id VARCHAR(50),
    
    -- 數量變化
    quantity_before INT NOT NULL,
    quantity_change INT NOT NULL,
    quantity_after INT NOT NULL,
    
    -- 成本資訊
    unit_cost DECIMAL(15,2),
    total_cost DECIMAL(15,2),
    
    -- 備註
    notes TEXT,
    
    -- 操作人員
    operated_by VARCHAR(50),
    operated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (sku_id) REFERENCES product_skus(sku_id) ON DELETE CASCADE,
    FOREIGN KEY (operated_by) REFERENCES admin_users(admin_user_id) ON DELETE SET NULL,
    INDEX idx_sku_id (sku_id),
    INDEX idx_transaction_type (transaction_type),
    INDEX idx_reference (reference_type, reference_id),
    INDEX idx_operated_at (operated_at)
);

-- 庫存預留記錄表
CREATE TABLE inventory_reservations (
    reservation_id VARCHAR(50) PRIMARY KEY,
    sku_id VARCHAR(50) NOT NULL,
    order_id VARCHAR(50) NOT NULL,
    reserved_quantity INT NOT NULL,
    expires_at DATETIME NOT NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'active', -- 'active', 'fulfilled', 'expired', 'cancelled'
    
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (sku_id) REFERENCES product_skus(sku_id) ON DELETE CASCADE,
    FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE CASCADE,
    INDEX idx_sku_id (sku_id),
    INDEX idx_order_id (order_id),
    INDEX idx_expires_at (expires_at),
    INDEX idx_status (status)
);
```

## 5. 外鍵約束標準化

### 5.1 刪除策略統一規範

```sql
-- 主要業務實體關聯：RESTRICT（防止意外刪除）
FOREIGN KEY (product_id) REFERENCES products(product_id) ON DELETE RESTRICT
FOREIGN KEY (sku_id) REFERENCES product_skus(sku_id) ON DELETE RESTRICT
FOREIGN KEY (customer_id) REFERENCES customers(customer_id) ON DELETE RESTRICT

-- 從屬關聯：CASCADE（級聯刪除）
FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE CASCADE
FOREIGN KEY (product_id) REFERENCES products(product_id) ON DELETE CASCADE

-- 可選關聯：SET NULL（設為空值）
FOREIGN KEY (category_id) REFERENCES product_categories(category_id) ON DELETE SET NULL
FOREIGN KEY (customer_id) REFERENCES customers(customer_id) ON DELETE SET NULL
```

### 5.2 外鍵命名規範

```sql
-- 外鍵約束命名：fk_{table_name}_{referenced_table}_{column}
CONSTRAINT fk_orders_customers_customer_id 
    FOREIGN KEY (customer_id) REFERENCES customers(customer_id)

CONSTRAINT fk_order_items_orders_order_id 
    FOREIGN KEY (order_id) REFERENCES orders(order_id)

CONSTRAINT fk_product_skus_products_product_id 
    FOREIGN KEY (product_id) REFERENCES products(product_id)
```

## 6. 索引標準化

### 6.1 索引命名規範

```sql
-- 主鍵索引：自動生成，不需額外命名
PRIMARY KEY (id)

-- 唯一索引：uk_{table_name}_{column_name}
UNIQUE KEY uk_admin_users_username (username)
UNIQUE KEY uk_admin_users_email (email)

-- 普通索引：idx_{table_name}_{column_name}
INDEX idx_orders_customer_id (customer_id)
INDEX idx_orders_status (status)
INDEX idx_orders_created_at (created_at)

-- 複合索引：idx_{table_name}_{column1}_{column2}
INDEX idx_orders_status_created_at (status, created_at)
INDEX idx_order_items_order_product (order_id, product_id)
```

### 6.2 必要索引清單

```sql
-- 所有表都必須有的索引
1. 主鍵索引（自動）
2. 外鍵欄位索引
3. 狀態欄位索引
4. 時間欄位索引（created_at, updated_at）
5. 查詢頻繁的欄位索引

-- 效能關鍵索引
1. 訂單查詢：(customer_id, status, created_at)
2. 商品查詢：(category_id, status, created_at)
3. 庫存查詢：(sku_id, transaction_type, operated_at)
```

## 7. JSON 欄位標準化

### 7.1 JSON 欄位使用規範

```sql
-- 地址資訊 JSON 格式
{
  "recipient_name": "王小明",
  "phone": "0912345678",
  "zip_code": "10049",
  "city": "台北市",
  "district": "中正區",
  "address_line": "重慶南路一段122號"
}

-- 商品變體屬性 JSON 格式
{
  "color": "紅色",
  "size": "M",
  "material": "棉質"
}

-- 訂單促銷資訊 JSON 格式
{
  "applied_promotions": [
    {
      "promotion_id": "PROMO001",
      "promotion_name": "新會員優惠",
      "discount_type": "percentage",
      "discount_value": 10,
      "discount_amount": 100
    }
  ]
}
```

### 7.2 JSON 欄位索引

```sql
-- 對常查詢的 JSON 欄位建立虛擬欄位索引
ALTER TABLE products 
ADD COLUMN variant_color VARCHAR(50) 
GENERATED ALWAYS AS (JSON_UNQUOTE(JSON_EXTRACT(variant_attributes, '$.color'))) VIRTUAL,
ADD INDEX idx_variant_color (variant_color);
```

## 8. 資料庫遷移腳本

### 8.1 表名統一遷移

```sql
-- 1. 重命名現有表
RENAME TABLE admins TO admin_users_old;
RENAME TABLE admin TO admin_users;

-- 2. 更新所有引用
UPDATE information_schema.KEY_COLUMN_USAGE 
SET REFERENCED_TABLE_NAME = 'admin_users' 
WHERE REFERENCED_TABLE_NAME = 'admins';

-- 3. 重建外鍵約束
-- （需要根據具體情況編寫）
```

### 8.2 欄位類型統一遷移

```sql
-- 統一 ID 欄位類型
ALTER TABLE orders MODIFY COLUMN order_id VARCHAR(50);
ALTER TABLE customers MODIFY COLUMN customer_id VARCHAR(50);
ALTER TABLE products MODIFY COLUMN product_id VARCHAR(50);

-- 統一金額欄位精度
ALTER TABLE orders MODIFY COLUMN total_amount DECIMAL(15,2);
ALTER TABLE order_items MODIFY COLUMN unit_price DECIMAL(15,2);
ALTER TABLE products MODIFY COLUMN base_price DECIMAL(15,2);
```

## 9. 資料完整性檢查

### 9.1 約束檢查腳本

```sql
-- 檢查孤立記錄
SELECT 'order_items' AS table_name, COUNT(*) AS orphan_count
FROM order_items oi
LEFT JOIN orders o ON oi.order_id = o.order_id
WHERE o.order_id IS NULL

UNION ALL

SELECT 'product_skus' AS table_name, COUNT(*) AS orphan_count
FROM product_skus ps
LEFT JOIN products p ON ps.product_id = p.product_id
WHERE p.product_id IS NULL;

-- 檢查資料一致性
SELECT 
    o.order_id,
    o.total_amount,
    SUM(oi.total_price) AS calculated_total,
    (o.total_amount - SUM(oi.total_price)) AS difference
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
GROUP BY o.order_id, o.total_amount
HAVING ABS(difference) > 0.01;
```

### 9.2 資料修復腳本

```sql
-- 修復訂單總額不一致
UPDATE orders o 
SET total_amount = (
    SELECT SUM(total_price) 
    FROM order_items 
    WHERE order_id = o.order_id
)
WHERE EXISTS (
    SELECT 1 FROM order_items 
    WHERE order_id = o.order_id
);

-- 清理孤立記錄
DELETE FROM order_items 
WHERE order_id NOT IN (SELECT order_id FROM orders);
```

## 10. 監控與維護

### 10.1 資料一致性監控

```sql
-- 建立監控視圖
CREATE VIEW data_integrity_check AS
SELECT 
    'orders_items_total_mismatch' AS check_type,
    COUNT(*) AS issue_count
FROM orders o
JOIN (
    SELECT order_id, SUM(total_price) as calculated_total
    FROM order_items 
    GROUP BY order_id
) oi ON o.order_id = oi.order_id
WHERE ABS(o.total_amount - oi.calculated_total) > 0.01

UNION ALL

SELECT 
    'orphaned_order_items' AS check_type,
    COUNT(*) AS issue_count
FROM order_items oi
LEFT JOIN orders o ON oi.order_id = o.order_id
WHERE o.order_id IS NULL;
```

### 10.2 定期維護任務

```sql
-- 清理過期的庫存預留
DELETE FROM inventory_reservations 
WHERE status = 'active' AND expires_at < NOW();

-- 更新庫存可用數量
UPDATE product_skus SET available_quantity = inventory_quantity - reserved_quantity;

-- 重建索引統計資訊
ANALYZE TABLE orders, order_items, products, product_skus, customers;
```

## 11. 遷移執行計劃

### 11.1 第一階段：核心表結構統一（高優先級）

1. **管理員表統一**
   - 統一使用 `admin_users` 表名
   - 更新所有引用模組

2. **客戶表統一**
   - 確認使用 `customers` 表名
   - 統一 customer_type 欄位

3. **商品SKU表統一**
   - 確認使用 `product_skus` 表名
   - 統一價格和庫存欄位

### 11.2 第二階段：外鍵約束統一（中優先級）

1. 建立統一的外鍵約束
2. 統一刪除策略
3. 建立必要的索引

### 11.3 第三階段：資料類型統一（低優先級）

1. 統一 ID 欄位類型
2. 統一金額欄位精度
3. 統一時間欄位格式

這個標準化設計將解決目前系統中的資料庫不一致性問題，為後續的統一 API 設計和權限管理奠定堅實基礎。

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"content": "\u4fee\u6b63\u8cc7\u6599\u5eab\u8a2d\u8a08\u4e0d\u4e00\u81f4\u6027\u554f\u984c", "status": "completed", "activeForm": "\u4fee\u6b63\u8cc7\u6599\u5eab\u8a2d\u8a08\u4e0d\u4e00\u81f4\u6027\u554f\u984c"}, {"content": "\u7d71\u4e00 API \u4ecb\u9762\u898f\u7bc4", "status": "in_progress", "activeForm": "\u7d71\u4e00 API \u4ecb\u9762\u898f\u7bc4"}, {"content": "\u7d71\u4e00\u6b0a\u9650\u7ba1\u7406\u9ad4\u7cfb", "status": "pending", "activeForm": "\u7d71\u4e00\u6b0a\u9650\u7ba1\u7406\u9ad4\u7cfb"}, {"content": "\u88dc\u5145\u7f3a\u5931\u7684\u6838\u5fc3\u6a21\u7d44", "status": "pending", "activeForm": "\u88dc\u5145\u7f3a\u5931\u7684\u6838\u5fc3\u6a21\u7d44"}, {"content": "\u5b8c\u5584\u524d\u53f0\u8207\u5f8c\u53f0API\u6574\u5408\u898f\u683c", "status": "pending", "activeForm": "\u5b8c\u5584\u524d\u53f0\u8207\u5f8c\u53f0API\u6574\u5408\u898f\u683c"}, {"content": "\u9a57\u8b49\u67b6\u69cb\u8a2d\u8a08\u5b8c\u6574\u6027", "status": "pending", "activeForm": "\u9a57\u8b49\u67b6\u69cb\u8a2d\u8a08\u5b8c\u6574\u6027"}]