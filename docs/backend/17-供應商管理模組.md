# 模組 17: 供應商管理模組 (Supplier Management Module)

## 模組概述

供應商管理模組提供完整的供應商生命週期管理，包含供應商基本資料、商品與贈品關聯、採購歷史追蹤、績效評估、自動補貨提醒，以及多元化付款方式支援。整合商品管理、贈品管理、採購管理模組，提供全方位的供應商關係管理功能。

## 核心功能架構

### 1. 供應商基本資料管理

#### 1.1 公司基本資訊
```typescript
interface Supplier {
  id: string
  companyName: string
  companyNameEn?: string
  taxId: string // 統一編號
  businessLicense: string
  establishedDate?: Date
  companyType: CompanyType
  industry: string
  scale: CompanyScale
  website?: string
  description?: string
  logo?: string
  status: SupplierStatus
  createdAt: Date
  updatedAt: Date
}

enum CompanyType {
  CORPORATION = 'corporation',     // 股份有限公司
  LIMITED = 'limited',            // 有限公司
  PARTNERSHIP = 'partnership',    // 合夥企業
  SOLE_PROPRIETORSHIP = 'sole',   // 獨資企業
  FOREIGN = 'foreign'             // 外商企業
}

enum CompanyScale {
  LARGE = 'large',               // 大型企業
  MEDIUM = 'medium',             // 中型企業
  SMALL = 'small',               // 小型企業
  STARTUP = 'startup'            // 新創企業
}

enum SupplierStatus {
  ACTIVE = 'active',             // 活躍供應商
  INACTIVE = 'inactive',         // 停用供應商
  PENDING = 'pending',           // 待審核
  SUSPENDED = 'suspended',       // 暫停合作
  BLACKLISTED = 'blacklisted'    // 黑名單
}
```

#### 1.2 聯絡資訊管理
```typescript
interface SupplierContact {
  id: string
  supplierId: string
  contactType: ContactType
  name: string
  title: string
  department?: string
  phone: string
  mobile?: string
  email: string
  wechat?: string
  line?: string
  address?: Address
  isPrimary: boolean
  isActive: boolean
  notes?: string
}

enum ContactType {
  PRIMARY = 'primary',           // 主要負責人
  SALES = 'sales',              // 業務聯絡人
  TECHNICAL = 'technical',       // 技術聯絡人
  FINANCE = 'finance',          // 財務聯絡人
  LOGISTICS = 'logistics',       // 物流聯絡人
  QUALITY = 'quality'           // 品管聯絡人
}

interface Address {
  country: string
  state: string
  city: string
  district: string
  street: string
  postalCode: string
  fullAddress: string
}
```

#### 1.3 認證文件管理
```typescript
interface SupplierDocument {
  id: string
  supplierId: string
  documentType: DocumentType
  documentName: string
  documentNumber?: string
  fileUrl: string
  fileName: string
  fileSize: number
  issueDate?: Date
  expiryDate?: Date
  issuingAuthority?: string
  status: DocumentStatus
  verifiedBy?: string
  verifiedAt?: Date
  notes?: string
  uploadedAt: Date
}

enum DocumentType {
  BUSINESS_LICENSE = 'business_license',        // 營業執照
  TAX_CERTIFICATE = 'tax_certificate',         // 稅務登記證
  QUALITY_CERTIFICATE = 'quality_certificate', // 品質認證
  ISO_CERTIFICATE = 'iso_certificate',         // ISO認證
  INSURANCE_POLICY = 'insurance_policy',       // 保險證書
  BANK_ACCOUNT = 'bank_account',               // 銀行帳戶證明
  PRODUCT_CATALOG = 'product_catalog',         // 產品型錄
  CONTRACT = 'contract',                       // 合約文件
  OTHER = 'other'                             // 其他文件
}

enum DocumentStatus {
  PENDING = 'pending',         // 待審核
  APPROVED = 'approved',       // 已審核通過
  REJECTED = 'rejected',       // 審核不通過
  EXPIRED = 'expired'          // 已過期
}
```

### 2. 商品關聯管理系統

#### 2.1 供應商商品關聯
```typescript
interface SupplierProduct {
  id: string
  supplierId: string
  productId: string
  supplierProductCode: string  // 供應商商品編號
  supplierProductName: string  // 供應商商品名稱
  supplierPrice: number        // 供貨價格
  currency: string
  minOrderQuantity: number     // 最小訂購量
  maxOrderQuantity?: number    // 最大訂購量
  leadTimeDays: number         // 交貨期（天）
  availability: ProductAvailability
  supplierStock?: number       // 供應商庫存
  lastPriceUpdate: Date
  priceHistory: PriceHistory[]
  isMainSupplier: boolean      // 是否為主要供應商
  priority: number             // 優先級
  notes?: string
  status: 'active' | 'inactive' | 'discontinued'
  createdAt: Date
  updatedAt: Date
}

enum ProductAvailability {
  IN_STOCK = 'in_stock',           // 有庫存
  LIMITED_STOCK = 'limited_stock', // 庫存不足
  OUT_OF_STOCK = 'out_of_stock',   // 缺貨
  DISCONTINUED = 'discontinued',    // 停產
  SEASONAL = 'seasonal',           // 季節性商品
  PRE_ORDER = 'pre_order'          // 預購商品
}

interface PriceHistory {
  price: number
  effectiveDate: Date
  reason?: string
  updatedBy: string
}
```

#### 2.2 多供應商商品管理
```typescript
class SupplierProductService {
  // 取得商品的所有供應商
  async getProductSuppliers(productId: string): Promise<SupplierProductInfo[]> {
    const suppliers = await this.supplierProductRepository.findByProductId(productId)
    
    return suppliers.map(supplier => ({
      ...supplier,
      totalPurchaseAmount: await this.calculateTotalPurchase(supplier.supplierId, productId),
      averageLeadTime: await this.calculateAverageLeadTime(supplier.supplierId, productId),
      qualityRating: await this.getSupplierQualityRating(supplier.supplierId),
      priceCompetitiveness: this.calculatePriceCompetitiveness(supplier.supplierPrice, suppliers)
    }))
  }
  
  // 推薦最佳供應商
  recommendBestSupplier(
    productId: string, 
    quantity: number,
    urgencyLevel: UrgencyLevel
  ): Promise<SupplierRecommendation> {
    const criteria = {
      price: urgencyLevel === 'high' ? 0.3 : 0.4,
      leadTime: urgencyLevel === 'high' ? 0.4 : 0.3,
      quality: 0.2,
      reliability: 0.1
    }
    
    return this.calculateSupplierScore(productId, quantity, criteria)
  }
}
```

### 3. 贈品關聯管理系統

#### 3.1 供應商贈品關聯
```typescript
interface SupplierGift {
  id: string
  supplierId: string
  giftId: string
  supplierGiftCode: string     // 供應商贈品編號
  supplierGiftName: string     // 供應商贈品名稱
  supplierCost: number         // 贈品成本
  currency: string
  minOrderQuantity: number     // 最小訂購量
  productionLeadTime: number   // 製作工期（天）
  customizationOptions: CustomizationOption[]
  seasonalAvailability?: SeasonalAvailability
  campaignSupport: CampaignSupport
  qualityStandards: QualityStandard[]
  packagingOptions: PackagingOption[]
  isExclusive: boolean         // 是否獨家供應
  priority: number
  status: 'active' | 'inactive' | 'seasonal_only'
  createdAt: Date
  updatedAt: Date
}

interface CustomizationOption {
  type: 'logo' | 'color' | 'packaging' | 'text' | 'shape'
  description: string
  additionalCost: number
  minQuantity: number
  additionalLeadTime: number
}

interface SeasonalAvailability {
  availableSeasons: string[]   // 可供應季節
  peakSeason: string          // 旺季
  seasonalPricing: SeasonalPrice[]
}

interface CampaignSupport {
  festivalSupport: boolean     // 節慶活動支援
  marketingSupport: boolean    // 行銷活動支援
  rushOrderCapability: boolean // 急單處理能力
  volumeDiscountTiers: VolumeTier[]
}
```

#### 3.2 贈品供應商服務
```typescript
class SupplierGiftService {
  // 尋找最適合的贈品供應商
  async findOptimalGiftSupplier(
    giftRequirements: GiftRequirements
  ): Promise<GiftSupplierRecommendation[]> {
    
    const availableSuppliers = await this.supplierGiftRepository.findByRequirements(giftRequirements)
    
    return availableSuppliers.map(supplier => ({
      ...supplier,
      totalScore: this.calculateGiftSupplierScore(supplier, giftRequirements),
      estimatedTotalCost: this.calculateTotalGiftCost(supplier, giftRequirements),
      deliveryFeasibility: this.checkDeliveryFeasibility(supplier, giftRequirements.requiredDate),
      customizationCapability: this.assessCustomizationCapability(supplier, giftRequirements.customization)
    })).sort((a, b) => b.totalScore - a.totalScore)
  }
  
  // 節慶贈品供應商推薦
  async getFestivalGiftSuppliers(
    festivalType: string,
    expectedVolume: number,
    budget: number
  ): Promise<FestivalGiftSupplierOption[]> {
    
    return this.supplierGiftRepository.findFestivalCapableSuppliers({
      festivalType,
      expectedVolume,
      budget,
      leadTimeConstraint: this.getFestivalLeadTimeConstraint(festivalType)
    })
  }
}
```

### 4. 採購歷史管理系統

#### 4.1 採購單歷史追蹤
```typescript
interface SupplierPurchaseHistory {
  supplierId: string
  totalPurchaseOrders: number
  totalPurchaseAmount: number
  averageOrderValue: number
  purchaseFrequency: PurchaseFrequency
  recentOrders: PurchaseOrderSummary[]
  purchasesByCategory: CategoryPurchase[]
  purchasesByMonth: MonthlyPurchase[]
  performanceMetrics: SupplierPerformanceMetrics
  paymentHistory: PaymentHistorySummary
}

interface PurchaseOrderSummary {
  purchaseOrderId: string
  orderNumber: string
  orderDate: Date
  totalAmount: number
  currency: string
  status: PurchaseOrderStatus
  deliveryDate?: Date
  actualDeliveryDate?: Date
  items: PurchaseOrderItem[]
  paymentStatus: PaymentStatus
  qualityIssues?: QualityIssue[]
}

interface SupplierPerformanceMetrics {
  onTimeDeliveryRate: number      // 準時交貨率
  qualityPassRate: number         // 品質合格率
  orderAccuracyRate: number       // 訂單準確率
  responseTime: number            // 回應時間（小時）
  defectRate: number              // 不良品率
  returnRate: number              // 退貨率
  averageLeadTime: number         // 平均交期
  priceStability: number          // 價格穩定性
  communicationRating: number     // 溝通評分
  overallRating: number           // 整體評分
}
```

#### 4.2 採購分析與報表
```typescript
class SupplierPurchaseAnalytics {
  // 供應商採購分析
  async generateSupplierPurchaseReport(
    supplierId: string,
    dateRange: DateRange
  ): Promise<SupplierPurchaseReport> {
    
    const purchaseData = await this.purchaseRepository.getSupplierPurchases(supplierId, dateRange)
    
    return {
      supplierInfo: await this.supplierService.findById(supplierId),
      purchaseSummary: this.calculatePurchaseSummary(purchaseData),
      trendAnalysis: this.analyzePurchaseTrends(purchaseData),
      performanceAnalysis: await this.analyzeSupplierPerformance(supplierId, dateRange),
      costAnalysis: this.analyzePurchaseCosts(purchaseData),
      recommendedActions: this.generateRecommendations(purchaseData)
    }
  }
  
  // 供應商比較分析
  async compareSuppliers(
    supplierIds: string[],
    comparisonCriteria: ComparisonCriteria
  ): Promise<SupplierComparisonReport> {
    
    const suppliers = await Promise.all(
      supplierIds.map(id => this.generateSupplierMetrics(id, comparisonCriteria))
    )
    
    return {
      suppliers,
      ranking: this.rankSuppliers(suppliers, comparisonCriteria.weights),
      insights: this.generateComparisonInsights(suppliers),
      recommendations: this.generateSwitchingRecommendations(suppliers)
    }
  }
}
```

### 5. 多元付款方式管理

#### 5.1 付款方式設定
```typescript
interface SupplierPaymentMethod {
  id: string
  supplierId: string
  paymentType: PaymentType
  paymentDetails: PaymentDetails
  isPreferred: boolean
  isActive: boolean
  setupDate: Date
  lastUsed?: Date
  transactionFees?: TransactionFee
  limits?: PaymentLimits
  notes?: string
}

enum PaymentType {
  BANK_TRANSFER = 'bank_transfer',           // 銀行轉帳
  CREDIT_CARD = 'credit_card',               // 信用卡
  CHECK = 'check',                           // 支票
  CASH = 'cash',                             // 現金
  LETTER_OF_CREDIT = 'letter_of_credit',     // 信用狀
  WIRE_TRANSFER = 'wire_transfer',           // 電匯
  E_WALLET = 'e_wallet',                     // 電子錢包
  CRYPTOCURRENCY = 'cryptocurrency'          // 加密貨幣
}

interface PaymentDetails {
  // 銀行轉帳資訊
  bankTransfer?: {
    bankName: string
    bankCode: string
    accountNumber: string
    accountName: string
    swiftCode?: string
    routingNumber?: string
  }
  
  // 信用卡資訊（加密存儲）
  creditCard?: {
    cardType: 'visa' | 'mastercard' | 'amex' | 'jcb'
    lastFourDigits: string
    expiryMonth: number
    expiryYear: number
    cardholderName: string
    billingAddress: Address
    processorId: string      // 第三方支付處理器ID
  }
  
  // 支票資訊
  check?: {
    payeeName: string
    mailingAddress: Address
    checkProcessingTime: number // 處理天數
  }
  
  // 其他付款方式
  other?: {
    providerName: string
    accountIdentifier: string
    processingInstructions: string
  }
}

interface TransactionFee {
  feeType: 'fixed' | 'percentage' | 'tiered'
  feeAmount?: number
  feePercentage?: number
  minimumFee?: number
  maximumFee?: number
  feeTiers?: FeeTier[]
}

interface PaymentLimits {
  dailyLimit?: number
  monthlyLimit?: number
  transactionLimit?: number
  minimumAmount?: number
}
```

#### 5.2 付款條件管理
```typescript
interface SupplierPaymentTerms {
  id: string
  supplierId: string
  paymentTermType: PaymentTermType
  paymentDays: number              // 付款期限（天）
  discountTerms?: EarlyPaymentDiscount[]
  latePaymentPenalty?: LatePaymentPenalty
  paymentMethods: string[]         // 允許的付款方式ID
  currency: string
  creditLimit?: number
  requiresPrepayment: boolean
  prepaymentPercentage?: number
  isActive: boolean
  effectiveDate: Date
  expiryDate?: Date
  negotiatedBy: string
  approvedBy: string
  notes?: string
}

enum PaymentTermType {
  NET_30 = 'net_30',               // 30天付款
  NET_60 = 'net_60',               // 60天付款
  NET_90 = 'net_90',               // 90天付款
  COD = 'cod',                     // 貨到付款
  PREPAYMENT = 'prepayment',       // 預付款
  CUSTOM = 'custom'                // 客製化條件
}

interface EarlyPaymentDiscount {
  discountPercentage: number
  earlyPaymentDays: number         // 提前付款天數
  description: string
}

interface LatePaymentPenalty {
  penaltyType: 'fixed' | 'percentage' | 'compound'
  penaltyAmount?: number
  penaltyPercentage?: number
  gracePeriodDays: number
  compoundingFrequency?: 'daily' | 'monthly'
}
```

#### 5.3 信用卡支付整合
```typescript
class SupplierCreditCardService {
  // 新增信用卡付款方式
  async addCreditCardPayment(
    supplierId: string,
    cardDetails: CreditCardDetails
  ): Promise<PaymentMethodResult> {
    
    // 使用第三方支付服務加密存儲卡片資訊
    const encryptedCard = await this.paymentProcessor.secureStoreCard(cardDetails)
    
    // 驗證卡片有效性
    const validationResult = await this.paymentProcessor.validateCard(encryptedCard)
    
    if (!validationResult.isValid) {
      throw new Error('Invalid credit card details')
    }
    
    const paymentMethod = await this.supplierPaymentRepository.create({
      supplierId,
      paymentType: PaymentType.CREDIT_CARD,
      paymentDetails: {
        creditCard: {
          cardType: validationResult.cardType,
          lastFourDigits: cardDetails.cardNumber.slice(-4),
          expiryMonth: cardDetails.expiryMonth,
          expiryYear: cardDetails.expiryYear,
          cardholderName: cardDetails.cardholderName,
          billingAddress: cardDetails.billingAddress,
          processorId: encryptedCard.processorId
        }
      },
      transactionFees: await this.getCardTransactionFees(validationResult.cardType),
      limits: this.getCardLimits(validationResult.cardType)
    })
    
    return {
      paymentMethodId: paymentMethod.id,
      maskedCardNumber: `****-****-****-${cardDetails.cardNumber.slice(-4)}`,
      isSetupSuccessful: true
    }
  }
  
  // 處理信用卡付款
  async processCreditCardPayment(
    purchaseOrderId: string,
    paymentMethodId: string,
    amount: number
  ): Promise<PaymentResult> {
    
    const paymentMethod = await this.supplierPaymentRepository.findById(paymentMethodId)
    const purchaseOrder = await this.purchaseOrderService.findById(purchaseOrderId)
    
    // 檢查付款限制
    await this.validatePaymentLimits(paymentMethod, amount)
    
    // 處理信用卡扣款
    const paymentResult = await this.paymentProcessor.processPayment({
      processorId: paymentMethod.paymentDetails.creditCard.processorId,
      amount,
      currency: purchaseOrder.currency,
      description: `Purchase Order ${purchaseOrder.orderNumber}`,
      metadata: {
        purchaseOrderId,
        supplierId: paymentMethod.supplierId
      }
    })
    
    // 記錄付款交易
    await this.paymentTransactionService.recordTransaction({
      purchaseOrderId,
      paymentMethodId,
      amount,
      transactionId: paymentResult.transactionId,
      status: paymentResult.status,
      fees: paymentResult.fees
    })
    
    return paymentResult
  }
}
```

### 6. 自動補貨提醒系統

#### 6.1 補貨提醒設定
```typescript
interface RestockNotificationConfig {
  id: string
  supplierId: string
  productId?: string               // 特定商品，null表示供應商所有商品
  notificationType: NotificationType
  triggerConditions: RestockTriggerCondition[]
  recipients: NotificationRecipient[]
  reminderFrequency: ReminderFrequency
  advanceNoticeDays: number        // 提前通知天數
  isActive: boolean
  createdBy: string
  createdAt: Date
  lastTriggered?: Date
  lastModified: Date
}

enum NotificationType {
  LOW_STOCK_ALERT = 'low_stock_alert',           // 低庫存警報
  REORDER_REMINDER = 'reorder_reminder',         // 補貨提醒
  LEAD_TIME_ALERT = 'lead_time_alert',          // 交期警報
  SEASONAL_REMINDER = 'seasonal_reminder',       // 季節性補貨
  CAMPAIGN_PREPARATION = 'campaign_preparation', // 活動準備提醒
  SUPPLIER_PERFORMANCE = 'supplier_performance'  // 供應商績效提醒
}

interface RestockTriggerCondition {
  conditionType: TriggerConditionType
  thresholdValue: number
  comparisonOperator: '<' | '<=' | '>' | '>=' | '=='
  isPercentage: boolean            // 是否為百分比
  evaluationPeriod?: number        // 評估期間（天）
}

enum TriggerConditionType {
  CURRENT_STOCK = 'current_stock',               // 當前庫存
  AVAILABLE_STOCK = 'available_stock',           // 可用庫存
  STOCK_TURNOVER_RATE = 'stock_turnover_rate',   // 庫存週轉率
  DAYS_OF_INVENTORY = 'days_of_inventory',       // 庫存天數
  DEMAND_FORECAST = 'demand_forecast',           // 需求預測
  LEAD_TIME_COVERAGE = 'lead_time_coverage'      // 交期覆蓋率
}

interface NotificationRecipient {
  recipientType: 'user' | 'role' | 'email' | 'webhook'
  identifier: string               // 用戶ID、角色名稱、郵件地址或Webhook URL
  notificationChannels: NotificationChannel[]
  isActive: boolean
}

enum NotificationChannel {
  EMAIL = 'email',
  SMS = 'sms',
  PUSH = 'push',
  SLACK = 'slack',
  WEBHOOK = 'webhook',
  IN_APP = 'in_app'
}
```

#### 6.2 智能補貨提醒引擎
```typescript
class SmartRestockEngine {
  // 執行補貨檢查
  async executeRestockCheck(): Promise<RestockCheckResult[]> {
    const activeConfigs = await this.restockConfigRepository.findActive()
    const results: RestockCheckResult[] = []
    
    for (const config of activeConfigs) {
      try {
        const checkResult = await this.evaluateRestockCondition(config)
        if (checkResult.shouldTrigger) {
          await this.triggerRestockNotification(config, checkResult)
          results.push(checkResult)
        }
      } catch (error) {
        await this.logRestockCheckError(config.id, error)
      }
    }
    
    return results
  }
  
  // 評估補貨條件
  private async evaluateRestockCondition(
    config: RestockNotificationConfig
  ): Promise<RestockCheckResult> {
    
    const productInfo = config.productId 
      ? await this.productService.findById(config.productId)
      : null
      
    const supplierProducts = config.productId
      ? [await this.supplierProductService.findByProductAndSupplier(config.productId, config.supplierId)]
      : await this.supplierProductService.findBySupplier(config.supplierId)
    
    const conditionResults = await Promise.all(
      config.triggerConditions.map(condition => 
        this.evaluateSingleCondition(condition, supplierProducts)
      )
    )
    
    const shouldTrigger = conditionResults.every(result => result.isMet)
    
    if (shouldTrigger) {
      const restockRecommendations = await this.generateRestockRecommendations(
        supplierProducts,
        config
      )
      
      return {
        configId: config.id,
        shouldTrigger: true,
        triggeredConditions: conditionResults.filter(r => r.isMet),
        affectedProducts: supplierProducts,
        recommendations: restockRecommendations,
        priority: this.calculateRestockPriority(conditionResults),
        estimatedImpact: await this.calculateEstimatedImpact(supplierProducts)
      }
    }
    
    return { configId: config.id, shouldTrigger: false }
  }
  
  // 生成補貨建議
  private async generateRestockRecommendations(
    products: SupplierProduct[],
    config: RestockNotificationConfig
  ): Promise<RestockRecommendation[]> {
    
    return Promise.all(products.map(async (product) => {
      const demandForecast = await this.demandForecastService.getForecast(
        product.productId,
        30 // 未來30天預測
      )
      
      const optimalOrderQuantity = await this.calculateOptimalOrderQuantity(
        product,
        demandForecast
      )
      
      const urgency = await this.calculateRestockUrgency(product)
      
      return {
        productId: product.productId,
        supplierId: product.supplierId,
        recommendedQuantity: optimalOrderQuantity,
        estimatedCost: optimalOrderQuantity * product.supplierPrice,
        urgencyLevel: urgency,
        suggestedOrderDate: this.calculateOptimalOrderDate(
          product.leadTimeDays,
          urgency
        ),
        reasoning: this.generateRecommendationReasoning(
          product,
          demandForecast,
          urgency
        ),
        alternativeSuppliers: await this.findAlternativeSuppliers(product.productId)
      }
    }))
  }
  
  // 發送補貨通知
  private async triggerRestockNotification(
    config: RestockNotificationConfig,
    checkResult: RestockCheckResult
  ): Promise<void> {
    
    const notification = {
      configId: config.id,
      notificationType: config.notificationType,
      priority: checkResult.priority,
      title: this.generateNotificationTitle(config, checkResult),
      message: this.generateNotificationMessage(config, checkResult),
      actionItems: this.generateActionItems(checkResult.recommendations),
      metadata: {
        supplierId: config.supplierId,
        productIds: checkResult.affectedProducts.map(p => p.productId),
        estimatedImpact: checkResult.estimatedImpact,
        recommendations: checkResult.recommendations
      }
    }
    
    // 發送到各個通知渠道
    for (const recipient of config.recipients) {
      if (recipient.isActive) {
        await this.sendNotificationToChannels(
          notification,
          recipient.notificationChannels,
          recipient.identifier
        )
      }
    }
    
    // 更新最後觸發時間
    await this.restockConfigRepository.updateLastTriggered(config.id, new Date())
    
    // 記錄通知歷史
    await this.notificationHistoryService.recordNotification(notification)
  }
}

interface RestockRecommendation {
  productId: string
  supplierId: string
  recommendedQuantity: number
  estimatedCost: number
  urgencyLevel: 'low' | 'medium' | 'high' | 'critical'
  suggestedOrderDate: Date
  reasoning: string[]
  alternativeSuppliers: AlternativeSupplierOption[]
}

interface AlternativeSupplierOption {
  supplierId: string
  supplierName: string
  price: number
  leadTimeDays: number
  qualityRating: number
  availableQuantity?: number
  notes?: string
}
```

#### 6.3 補貨提醒管理介面
```typescript
interface RestockNotificationUI {
  // 提醒設定頁面
  notificationConfigPage: {
    components: [
      'RestockConfigList',
      'ConditionBuilder',
      'RecipientManager',
      'NotificationPreview'
    ]
  }
  
  // 補貨儀表板
  restockDashboard: {
    components: [
      'ActiveAlertsPanel',
      'StockLevelChart',
      'SupplierPerformanceMetrics',
      'RestockRecommendations',
      'NotificationHistory'
    ]
  }
  
  // 補貨建議頁面
  restockRecommendationsPage: {
    components: [
      'RecommendationsList',
      'BulkOrderCreator',
      'SupplierComparison',
      'CostAnalysis'
    ]
  }
}

class RestockNotificationController {
  // 取得補貨提醒配置
  async getRestockConfigs(
    supplierId?: string,
    productId?: string
  ): Promise<RestockNotificationConfig[]> {
    return this.restockConfigRepository.findByFilters({ supplierId, productId })
  }
  
  // 建立補貨提醒配置
  async createRestockConfig(
    configData: CreateRestockConfigRequest
  ): Promise<RestockNotificationConfig> {
    
    // 驗證配置有效性
    await this.validateRestockConfig(configData)
    
    // 建立配置
    const config = await this.restockConfigRepository.create(configData)
    
    // 立即執行一次檢查以驗證配置
    await this.smartRestockEngine.evaluateRestockCondition(config)
    
    return config
  }
  
  // 測試補貨提醒
  async testRestockNotification(
    configId: string
  ): Promise<RestockTestResult> {
    
    const config = await this.restockConfigRepository.findById(configId)
    const testResult = await this.smartRestockEngine.evaluateRestockCondition(config)
    
    if (testResult.shouldTrigger) {
      // 發送測試通知
      await this.smartRestockEngine.triggerRestockNotification(config, testResult)
    }
    
    return {
      configId,
      testExecutedAt: new Date(),
      conditionsMet: testResult.shouldTrigger,
      triggeredConditions: testResult.triggeredConditions || [],
      recommendations: testResult.recommendations || [],
      testNotificationSent: testResult.shouldTrigger
    }
  }
}
```

### 7. 供應商評估與分級系統

#### 7.1 績效評估指標
```typescript
interface SupplierEvaluation {
  id: string
  supplierId: string
  evaluationPeriod: DateRange
  evaluationType: 'quarterly' | 'annual' | 'ad_hoc'
  overallRating: number        // 總體評分 (1-5)
  performanceMetrics: PerformanceMetrics
  qualitativeAssessment: QualitativeAssessment
  improvementAreas: ImprovementArea[]
  strengths: string[]
  actionPlan: ActionPlan[]
  nextReviewDate: Date
  evaluatedBy: string
  approvedBy?: string
  status: 'draft' | 'completed' | 'approved'
  createdAt: Date
  updatedAt: Date
}

interface PerformanceMetrics {
  qualityScore: QualityMetrics
  deliveryScore: DeliveryMetrics  
  serviceScore: ServiceMetrics
  costScore: CostMetrics
  complianceScore: ComplianceMetrics
  innovationScore: InnovationMetrics
}

interface QualityMetrics {
  defectRate: number              // 不良品率
  returnRate: number              // 退貨率
  customerComplaintRate: number   // 客戶投訴率
  qualityCertifications: string[] // 品質認證
  qualityImprovementTrends: number
  score: number // 1-5
}

interface DeliveryMetrics {
  onTimeDeliveryRate: number      // 準時交貨率
  averageLeadTime: number         // 平均交期
  deliveryReliability: number     // 交貨可靠性
  urgentOrderResponse: number     // 急單回應能力
  score: number // 1-5
}

interface ServiceMetrics {
  responsiveness: number          // 回應速度
  communicationQuality: number    // 溝通品質
  problemResolution: number       // 問題解決能力
  technicalSupport: number        // 技術支援
  customerServiceRating: number   // 客戶服務評分
  score: number // 1-5
}
```

#### 7.2 供應商分級管理
```typescript
enum SupplierGrade {
  A_STRATEGIC = 'A',              // A級：策略性供應商
  B_PREFERRED = 'B',              // B級：優選供應商
  C_QUALIFIED = 'C',              // C級：合格供應商
  D_CONDITIONAL = 'D',            // D級：條件性供應商
  E_UNQUALIFIED = 'E'             // E級：不合格供應商
}

interface SupplierGrading {
  supplierId: string
  currentGrade: SupplierGrade
  previousGrade?: SupplierGrade
  gradeChangeDate: Date
  gradeChangeReason: string
  gradingCriteria: GradingCriteria
  privilegesAndRestrictions: SupplierPrivileges
  reviewSchedule: ReviewSchedule
  nextReviewDate: Date
}

interface GradingCriteria {
  minimumOverallRating: number
  requiredCertifications: string[]
  minimumBusinessVolume: number
  strategicImportance: 'high' | 'medium' | 'low'
  riskLevel: 'low' | 'medium' | 'high'
  innovationCapability: number
  marketPosition: number
}

interface SupplierPrivileges {
  grade: SupplierGrade
  privileges: {
    prioritySupport: boolean
    earlyPaymentDiscounts: number[]
    exclusiveProducts: boolean
    jointMarketingOpportunities: boolean
    longTermContracts: boolean
    advanceOrderInformation: boolean
    directCommunicationChannels: boolean
  }
  restrictions: {
    orderValueLimits: number[]
    approvalRequirements: ApprovalLevel[]
    monitoringLevel: 'basic' | 'enhanced' | 'strict'
    contractTerms: string[]
  }
}
```

### 8. 後台管理介面

#### 8.1 供應商管理控制台
```typescript
interface SupplierManagementUI {
  // 供應商總覽頁面
  supplierOverview: {
    components: [
      'SupplierStatsCards',
      'SupplierGradeDistribution',
      'ActiveSuppliersMap',
      'RecentActivities',
      'PerformanceAlerts'
    ]
  }
  
  // 供應商清單頁面
  supplierDirectory: {
    components: [
      'SupplierDataTable',
      'AdvancedFilters',
      'BulkActions',
      'QuickActions',
      'ExportOptions'
    ]
    filters: [
      'supplier_grade',
      'business_category',
      'geographic_region',
      'payment_terms',
      'performance_rating',
      'last_order_date'
    ]
  }
  
  // 供應商詳情頁面
  supplierDetails: {
    sections: [
      'BasicInformation',
      'ContactManagement',
      'DocumentCenter',
      'ProductAssociations',
      'GiftAssociations',
      'PurchaseHistory',
      'PaymentMethods',
      'PerformanceMetrics',
      'RestockAlerts',
      'EvaluationHistory'
    ]
  }
  
  // 供應商關聯頁面
  supplierAssociations: {
    tabs: [
      'AssociatedProducts',
      'AssociatedGifts',
      'PurchaseOrders',
      'PaymentHistory',
      'PerformanceReports'
    ]
  }
}
```

#### 8.2 補貨提醒介面
```typescript
interface RestockManagementUI {
  // 補貨儀表板
  restockDashboard: {
    widgets: [
      'ActiveRestockAlerts',
      'CriticalStockLevels',
      'SupplierLeadTimes',
      'RestockRecommendations',
      'CostProjections'
    ]
  }
  
  // 提醒設定頁面
  alertConfigurationPage: {
    components: [
      'ConfigurationWizard',
      'ConditionBuilder',
      'NotificationChannelSetup',
      'TestNotification',
      'ConfigurationPreview'
    ]
  }
  
  // 補貨建議頁面
  restockRecommendations: {
    components: [
      'RecommendationTable',
      'SupplierComparison',
      'BatchOrderCreation',
      'CostBenefitAnalysis',
      'ActionTracker'
    ]
  }
}
```

### 9. API 介面規格

#### 9.1 供應商管理API
```typescript
// 供應商基本管理
GET /admin/api/suppliers
POST /admin/api/suppliers
GET /admin/api/suppliers/:id
PUT /admin/api/suppliers/:id
DELETE /admin/api/suppliers/:id

// 供應商關聯管理
GET /admin/api/suppliers/:id/products
POST /admin/api/suppliers/:id/products/associate
DELETE /admin/api/suppliers/:id/products/:productId

GET /admin/api/suppliers/:id/gifts
POST /admin/api/suppliers/:id/gifts/associate
DELETE /admin/api/suppliers/:id/gifts/:giftId

GET /admin/api/suppliers/:id/purchase-history
GET /admin/api/suppliers/:id/performance-metrics

// 付款方式管理
GET /admin/api/suppliers/:id/payment-methods
POST /admin/api/suppliers/:id/payment-methods
PUT /admin/api/suppliers/:id/payment-methods/:methodId
DELETE /admin/api/suppliers/:id/payment-methods/:methodId

// 補貨提醒管理
GET /admin/api/restock-notifications/configs
POST /admin/api/restock-notifications/configs
PUT /admin/api/restock-notifications/configs/:id
DELETE /admin/api/restock-notifications/configs/:id
POST /admin/api/restock-notifications/configs/:id/test

// 供應商評估
GET /admin/api/suppliers/:id/evaluations
POST /admin/api/suppliers/:id/evaluations
GET /admin/api/supplier-grades
PUT /admin/api/suppliers/:id/grade
```

#### 9.2 補貨提醒Webhook
```typescript
// 補貨提醒Webhook
POST /api/webhooks/restock-notification
Body: {
  configId: string
  triggeredConditions: TriggerCondition[]
  affectedProducts: ProductInfo[]
  recommendations: RestockRecommendation[]
  priority: 'low' | 'medium' | 'high' | 'critical'
  metadata: object
}
```

### 10. 資料庫設計

#### 10.1 核心資料表
```sql
-- 供應商基本資料表
CREATE TABLE suppliers (
  id VARCHAR(36) PRIMARY KEY,
  company_name VARCHAR(255) NOT NULL,
  company_name_en VARCHAR(255),
  tax_id VARCHAR(20) UNIQUE NOT NULL,
  business_license VARCHAR(50),
  established_date DATE,
  company_type ENUM('corporation', 'limited', 'partnership', 'sole', 'foreign'),
  industry VARCHAR(100),
  scale ENUM('large', 'medium', 'small', 'startup'),
  website VARCHAR(255),
  description TEXT,
  logo VARCHAR(255),
  status ENUM('active', 'inactive', 'pending', 'suspended', 'blacklisted') DEFAULT 'active',
  current_grade ENUM('A', 'B', 'C', 'D', 'E'),
  overall_rating DECIMAL(3,2),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_suppliers_status (status),
  INDEX idx_suppliers_grade (current_grade),
  INDEX idx_suppliers_tax_id (tax_id)
);

-- 供應商商品關聯表
CREATE TABLE supplier_products (
  id VARCHAR(36) PRIMARY KEY,
  supplier_id VARCHAR(36) NOT NULL,
  product_id VARCHAR(36) NOT NULL,
  supplier_product_code VARCHAR(100),
  supplier_product_name VARCHAR(255),
  supplier_price DECIMAL(12,2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'TWD',
  min_order_quantity INT NOT NULL DEFAULT 1,
  max_order_quantity INT,
  lead_time_days INT NOT NULL,
  availability ENUM('in_stock', 'limited_stock', 'out_of_stock', 'discontinued', 'seasonal', 'pre_order'),
  supplier_stock INT,
  last_price_update TIMESTAMP,
  is_main_supplier BOOLEAN DEFAULT FALSE,
  priority INT DEFAULT 0,
  status ENUM('active', 'inactive', 'discontinued') DEFAULT 'active',
  notes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (supplier_id) REFERENCES suppliers(id) ON DELETE CASCADE,
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
  UNIQUE KEY uk_supplier_product (supplier_id, product_id),
  INDEX idx_supplier_products_supplier (supplier_id),
  INDEX idx_supplier_products_product (product_id),
  INDEX idx_supplier_products_main (is_main_supplier)
);

-- 供應商贈品關聯表
CREATE TABLE supplier_gifts (
  id VARCHAR(36) PRIMARY KEY,
  supplier_id VARCHAR(36) NOT NULL,
  gift_id VARCHAR(36) NOT NULL,
  supplier_gift_code VARCHAR(100),
  supplier_gift_name VARCHAR(255),
  supplier_cost DECIMAL(12,2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'TWD',
  min_order_quantity INT NOT NULL DEFAULT 1,
  production_lead_time INT NOT NULL,
  customization_options JSON,
  seasonal_availability JSON,
  campaign_support JSON,
  is_exclusive BOOLEAN DEFAULT FALSE,
  priority INT DEFAULT 0,
  status ENUM('active', 'inactive', 'seasonal_only') DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (supplier_id) REFERENCES suppliers(id) ON DELETE CASCADE,
  FOREIGN KEY (gift_id) REFERENCES gifts(id) ON DELETE CASCADE,
  UNIQUE KEY uk_supplier_gift (supplier_id, gift_id),
  INDEX idx_supplier_gifts_supplier (supplier_id),
  INDEX idx_supplier_gifts_gift (gift_id)
);

-- 供應商付款方式表
CREATE TABLE supplier_payment_methods (
  id VARCHAR(36) PRIMARY KEY,
  supplier_id VARCHAR(36) NOT NULL,
  payment_type ENUM('bank_transfer', 'credit_card', 'check', 'cash', 'letter_of_credit', 'wire_transfer', 'e_wallet', 'cryptocurrency'),
  payment_details JSON NOT NULL,
  is_preferred BOOLEAN DEFAULT FALSE,
  is_active BOOLEAN DEFAULT TRUE,
  transaction_fees JSON,
  payment_limits JSON,
  setup_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_used TIMESTAMP,
  notes TEXT,
  
  FOREIGN KEY (supplier_id) REFERENCES suppliers(id) ON DELETE CASCADE,
  INDEX idx_payment_methods_supplier (supplier_id),
  INDEX idx_payment_methods_type (payment_type)
);

-- 補貨提醒配置表
CREATE TABLE restock_notification_configs (
  id VARCHAR(36) PRIMARY KEY,
  supplier_id VARCHAR(36) NOT NULL,
  product_id VARCHAR(36),
  notification_type ENUM('low_stock_alert', 'reorder_reminder', 'lead_time_alert', 'seasonal_reminder', 'campaign_preparation', 'supplier_performance'),
  trigger_conditions JSON NOT NULL,
  recipients JSON NOT NULL,
  reminder_frequency ENUM('daily', 'weekly', 'monthly'),
  advance_notice_days INT DEFAULT 0,
  is_active BOOLEAN DEFAULT TRUE,
  created_by VARCHAR(36),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_triggered TIMESTAMP,
  last_modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (supplier_id) REFERENCES suppliers(id) ON DELETE CASCADE,
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
  INDEX idx_restock_configs_supplier (supplier_id),
  INDEX idx_restock_configs_product (product_id),
  INDEX idx_restock_configs_active (is_active)
);
```

## 整合規格

### 與商品管理整合
- 商品頁面顯示供應商資訊
- 多供應商商品的價格比較
- 供應商商品的自動同步

### 與採購管理整合
- 採購單建立時的供應商選擇
- 供應商履約表現追蹤
- 付款方式在採購流程中的應用

### 與庫存管理整合
- 庫存不足時的自動補貨建議
- 供應商交期對庫存預測的影響
- 多供應商庫存的統一管理

### 與贈品管理整合
- 贈品供應商的特殊管理需求
- 節慶贈品的供應商協調
- 客製贈品的供應商選擇

### 與會計管理整合
- 應付帳款的供應商對帳
- 付款方式對財務流程的影響
- 供應商發票的自動匹配

### 與物流管理整合
- 供應商發貨資訊的整合
- 直送訂單的供應商協調
- 退貨處理的供應商配合

## 效能考量

### 快取策略
- 供應商基本資料快取 (TTL: 4小時)
- 供應商商品關聯快取 (TTL: 2小時)
- 補貨提醒結果快取 (TTL: 30分鐘)

### 效能目標
- 供應商查詢響應時間 < 100ms
- 補貨檢查執行時間 < 30秒
- 關聯資料載入時間 < 200ms
- 批量操作處理效率 > 500筆/分鐘

### 可靠性設計
- 補貨提醒的容錯機制
- 付款資訊的加密保護
- 供應商資料的備份策略
- 系統異常的自動恢復

---

本模組確保供應商管理的完整性和實用性，提供全方位的供應商關係管理功能，支援智能補貨提醒和多元付款方式，同時整合商品、贈品、採購等相關模組。