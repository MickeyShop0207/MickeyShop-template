# 模組 13: 贈品管理模組 (Gift Management Module)

## 模組概述

贈品管理模組負責管理所有贈品的基本資訊、檔期關聯、商品關聯規則，以及階梯式贈品方案的設定與執行。支援多種贈品觸發條件、會員等級限定、以及智能庫存狀態管理。

## 核心功能架構

### 1. 贈品基本管理

#### 1.1 贈品資訊設定
```typescript
interface Gift {
  id: string
  name: string
  description: string
  images: GiftImage[]
  category: string
  tags: string[]
  weight: number
  dimensions: {
    length: number
    width: number
    height: number
  }
  inventory: GiftInventory
  status: GiftStatus
  createdAt: Date
  updatedAt: Date
}

interface GiftImage {
  id: string
  url: string
  alt: string
  sort: number
  isMain: boolean
}

interface GiftInventory {
  total: number
  available: number
  reserved: number
  alertThreshold: number
  isUnlimited: boolean
}

enum GiftStatus {
  ACTIVE = 'active',
  INACTIVE = 'inactive', 
  OUT_OF_STOCK = 'out_of_stock'
}
```

#### 1.2 智能狀態管理
```typescript
interface GiftStatusManager {
  // 自動狀態更新邏輯
  updateStatus(giftId: string): Promise<GiftStatus>
  
  // 庫存變動監聽
  onInventoryChange(giftId: string, newInventory: number): Promise<void>
  
  // 批量狀態檢查
  checkAllGiftStatus(): Promise<GiftStatusReport[]>
}

// 自動狀態變更規則
const statusRules = {
  autoOutOfStock: {
    condition: 'inventory.available <= 0',
    action: 'set status to OUT_OF_STOCK'
  },
  autoActive: {
    condition: 'inventory.available > 0 && status === OUT_OF_STOCK',
    action: 'set status to ACTIVE'
  }
}
```

### 2. 階梯式贈品規則系統

#### 2.1 階梯規則設定
```typescript
interface TierGiftRule {
  id: string
  name: string
  campaignId: string
  targetProduct: ProductTarget
  tiers: GiftTier[]
  memberRestrictions: MemberRestriction[]
  dateRange: DateRange
  status: 'active' | 'inactive'
}

interface GiftTier {
  level: number
  condition: TierCondition
  giftOptions: GiftOption[]
  selectionType: 'single' | 'multiple' | 'fixed_combo'
  maxSelections?: number
}

interface TierCondition {
  type: 'quantity' | 'amount'
  value: number
  operator: '>=' | '>' | '=='
}

interface GiftOption {
  giftId: string
  quantity: number
  priority: number
}
```

#### 2.2 階梯邏輯範例
```typescript
// 階梯贈品規則範例
const tierExample: TierGiftRule = {
  id: 'tier_001',
  name: '保養品階梯贈品',
  campaignId: 'festival_001',
  targetProduct: {
    type: 'category',
    categoryIds: ['skincare_001']
  },
  tiers: [
    {
      level: 1,
      condition: { type: 'quantity', value: 1, operator: '>=' },
      giftOptions: [
        { giftId: 'gift_001', quantity: 1, priority: 1 }
      ],
      selectionType: 'fixed_combo'
    },
    {
      level: 2,
      condition: { type: 'quantity', value: 2, operator: '>=' },
      giftOptions: [
        { giftId: 'gift_002', quantity: 1, priority: 1 },
        { giftId: 'gift_003', quantity: 1, priority: 2 }
      ],
      selectionType: 'single'
    },
    {
      level: 3,
      condition: { type: 'quantity', value: 5, operator: '>=' },
      giftOptions: [
        { giftId: 'gift_004', quantity: 1, priority: 1 },
        { giftId: 'gift_005', quantity: 1, priority: 1 }
      ],
      selectionType: 'multiple',
      maxSelections: 2
    }
  ]
}
```

### 3. 贈品選擇機制

#### 3.1 選擇模式設定
```typescript
interface GiftSelectionConfig {
  selectionType: GiftSelectionType
  maxSelections: number
  minSelections: number
  allowDuplicates: boolean
  timeoutMinutes: number
}

enum GiftSelectionType {
  SINGLE = 'single',           // 單選：從多個贈品中選1個
  MULTIPLE = 'multiple',       // 多選：可選多個贈品
  FIXED_COMBO = 'fixed_combo', // 固定組合：系統預設組合
  WEIGHTED = 'weighted'        // 權重選擇：根據庫存/優先級自動分配
}
```

#### 3.2 客戶端選擇介面
```typescript
interface GiftSelectionUI {
  // 贈品選擇彈窗
  showSelectionModal(
    availableGifts: Gift[],
    selectionConfig: GiftSelectionConfig,
    onSelection: (selectedGifts: string[]) => void
  ): void
  
  // 購物車中的贈品顯示
  displayCartGifts(cartGifts: CartGift[]): JSX.Element
  
  // 結帳時贈品確認
  confirmGiftsAtCheckout(gifts: Gift[]): Promise<boolean>
}

interface CartGift {
  giftId: string
  giftName: string
  quantity: number
  source: 'tier_rule' | 'member_bonus' | 'campaign'
  canModify: boolean
}
```

### 4. 會員等級限定系統

#### 4.1 會員等級贈品設定
```typescript
interface MemberGiftRule {
  id: string
  name: string
  memberLevels: MemberLevel[]
  giftPool: MemberGiftPool
  restrictions: MemberGiftRestriction
  exclusiveGifts: string[] // 專屬贈品ID列表
}

interface MemberGiftPool {
  regularGifts: string[]     // 一般會員可選贈品
  silverGifts: string[]      // 銀卡會員額外贈品
  goldGifts: string[]        // 金卡會員額外贈品
  platinumGifts: string[]    // 白金會員額外贈品
  vipGifts: string[]         // VIP專屬贈品
}

interface MemberGiftRestriction {
  dailyLimit: Record<MemberLevel, number>
  monthlyLimit: Record<MemberLevel, number>
  requiresMinSpend: Record<MemberLevel, number>
  newMemberWelcomeGifts: string[]
}
```

#### 4.2 會員贈品邏輯
```typescript
class MemberGiftService {
  // 取得會員可選贈品清單
  async getAvailableGifts(
    memberId: string,
    memberLevel: MemberLevel,
    cartData: CartData
  ): Promise<Gift[]> {
    const memberRule = await this.getMemberGiftRule(memberLevel)
    const usageHistory = await this.getMemberGiftUsage(memberId)
    
    return this.filterAvailableGifts(
      memberRule.giftPool,
      usageHistory,
      memberRule.restrictions
    )
  }
  
  // 檢查贈品選擇是否有效
  validateGiftSelection(
    memberId: string,
    selectedGifts: string[],
    memberLevel: MemberLevel
  ): Promise<GiftValidationResult>
}
```

### 5. 檔期整合系統

#### 5.1 檔期贈品方案
```typescript
interface CampaignGiftScheme {
  campaignId: string
  campaignType: 'festival' | 'marketing' | 'flash_sale' | 'member_exclusive'
  giftRules: GiftRule[]
  priority: number
  conflictResolution: ConflictResolutionStrategy
}

interface GiftRule {
  id: string
  name: string
  conditions: GiftCondition[]
  gifts: GiftReward[]
  limitations: GiftLimitation[]
  targetAudience: TargetAudience
}

interface GiftCondition {
  type: 'product_purchase' | 'amount_threshold' | 'quantity_threshold' | 'category_purchase'
  productIds?: string[]
  categoryIds?: string[]
  amount?: number
  quantity?: number
  operator: '>=' | '>' | '==' | 'in'
}
```

#### 5.2 檔期衝突處理
```typescript
enum ConflictResolutionStrategy {
  PRIORITY_BASED = 'priority',     // 優先級高的方案優先
  MOST_BENEFICIAL = 'beneficial',  // 對客戶最有利的方案
  STACKABLE = 'stackable',         // 可疊加享受
  EXCLUSIVE = 'exclusive'          // 互斥，只能選一個
}

class CampaignGiftResolver {
  // 解決贈品方案衝突
  resolveConflicts(
    applicableRules: GiftRule[],
    strategy: ConflictResolutionStrategy
  ): GiftRule[]
  
  // 計算最優贈品組合
  calculateOptimalGifts(
    cartData: CartData,
    memberLevel: MemberLevel
  ): Promise<OptimalGiftResult>
}
```

### 6. 觸發條件與限制管理

#### 6.1 觸發條件設定
```typescript
interface GiftTriggerCondition {
  // 商品購買條件
  productConditions: ProductCondition[]
  
  // 金額條件
  amountConditions: AmountCondition[]
  
  // 數量條件
  quantityConditions: QuantityCondition[]
  
  // 會員條件
  memberConditions: MemberCondition[]
  
  // 時間條件
  timeConditions: TimeCondition[]
}

interface ProductCondition {
  type: 'specific_product' | 'product_category' | 'brand' | 'any_product'
  productIds?: string[]
  categoryIds?: string[]
  brandIds?: string[]
  requiredQuantity: number
  logicalOperator: 'AND' | 'OR'
}

interface AmountCondition {
  minAmount: number
  maxAmount?: number
  currency: string
  includeShipping: boolean
  includeDiscount: boolean
}
```

#### 6.2 數量限制管理
```typescript
interface GiftLimitation {
  // 每筆訂單限制
  perOrderLimit: number
  
  // 每位會員限制
  perMemberLimit: PerMemberLimit
  
  // 每日限制
  dailyLimit: number
  
  // 檔期內總限制
  campaignLimit: number
  
  // 庫存限制
  inventoryLimit: number
}

interface PerMemberLimit {
  total: number
  daily: number
  monthly: number
  resetCycle: 'never' | 'daily' | 'monthly' | 'yearly'
}
```

### 7. 贈品發送與追蹤

#### 7.1 贈品發送邏輯
```typescript
class GiftFulfillmentService {
  // 訂單確認時分配贈品
  async allocateGifts(orderId: string): Promise<GiftAllocation[]>
  
  // 更新贈品庫存
  async updateGiftInventory(
    giftId: string,
    quantity: number,
    operation: 'reserve' | 'release' | 'consume'
  ): Promise<void>
  
  // 贈品發送狀態追蹤
  async trackGiftDelivery(orderId: string): Promise<GiftDeliveryStatus>
}

interface GiftAllocation {
  orderId: string
  giftId: string
  quantity: number
  allocationTime: Date
  status: 'allocated' | 'reserved' | 'sent' | 'delivered'
  trackingInfo?: string
}
```

#### 7.2 贈品運費處理
```typescript
interface GiftShippingConfig {
  includedInShipping: boolean // 固定為 true，贈品包含在訂單運費中
  separatePackage: boolean    // 是否需要分開包裝
  weightCalculation: boolean  // 是否計入重量（影響包裝但不計費）
}

const GIFT_SHIPPING_RULES = {
  feeCalculation: false,      // 贈品不收取額外運費
  weightImpact: true,         // 影響包裝重量
  packageOptimization: true   // 優化包裝配置
}
```

### 8. 後台管理介面

#### 8.1 贈品管理頁面
```typescript
interface GiftManagementUI {
  // 贈品清單頁面
  giftListPage: {
    components: [
      'GiftDataTable',
      'GiftSearchFilter', 
      'GiftBatchActions',
      'GiftStatusIndicator'
    ]
    features: [
      'bulk_status_update',
      'inventory_alerts',
      'usage_statistics',
      'export_data'
    ]
  }
  
  // 贈品編輯頁面
  giftEditPage: {
    sections: [
      'basic_info',
      'inventory_management',
      'campaign_association',
      'tier_rules_config',
      'member_restrictions'
    ]
  }
}
```

#### 8.2 規則設定介面
```typescript
interface GiftRuleManagementUI {
  // 階梯規則設定
  tierRuleBuilder: {
    components: [
      'TierConfigWizard',
      'ConditionBuilder',
      'GiftSelectionConfig',
      'PreviewSimulator'
    ]
  }
  
  // 會員等級設定
  memberRuleBuilder: {
    components: [
      'MemberLevelSelector',
      'GiftPoolManager', 
      'RestrictionConfig',
      'ExclusiveGiftAssigner'
    ]
  }
}
```

### 9. 前台整合介面

#### 9.1 購物車贈品顯示
```typescript
interface CartGiftDisplay {
  // 自動觸發的贈品顯示
  autoGifts: {
    display: '✨ 恭喜！您已獲得以下贈品'
    style: 'highlight_box'
    animation: 'fade_in'
  }
  
  // 需要選擇的贈品
  selectableGifts: {
    modal: 'GiftSelectionModal'
    timeout: 300 // 5分鐘選擇時限
    reminder: true
  }
}
```

#### 9.2 商品頁面贈品提示
```typescript
interface ProductPageGiftHint {
  // 當前贈品資訊
  currentGifts: Gift[]
  
  // 下一階贈品提示
  nextTierHint: {
    message: '再購買 {quantity} 件，即可獲得 {giftName}'
    style: 'progress_bar'
    animation: 'pulse'
  }
  
  // 會員專屬贈品
  memberExclusiveHint: {
    message: '升級為 {memberLevel} 可獲得專屬贈品'
    cta: '查看會員權益'
  }
}
```

### 10. 數據分析與報表

#### 10.1 贈品效果分析
```typescript
interface GiftAnalytics {
  // 贈品受歡迎程度
  giftPopularity: {
    giftId: string
    selectionCount: number
    selectionRate: number
    memberLevelBreakdown: Record<MemberLevel, number>
  }[]
  
  // 階梯達成率
  tierAchievementRate: {
    tierLevel: number
    totalTriggers: number
    completionRate: number
    averageOrderValue: number
  }[]
  
  // 贈品成本分析
  giftCostAnalysis: {
    totalGiftValue: number
    giftCostRatio: number // 贈品成本占營收比例
    roi: number // 贈品帶來的額外營收
  }
}
```

#### 10.2 庫存預警系統
```typescript
interface GiftInventoryAlert {
  // 低庫存警報
  lowStockAlerts: {
    giftId: string
    currentStock: number
    alertThreshold: number
    estimatedDaysLeft: number
    activeRulesCount: number
  }[]
  
  // 熱門贈品預測
  popularGiftForecast: {
    giftId: string
    predictedDemand: number
    recommendedStock: number
    seasonalFactor: number
  }[]
}
```

## API 介面規格

### 後台 API (Admin Panel)

#### 贈品基本管理
```typescript
// 取得贈品清單
GET /admin/api/gifts
Query: {
  page: number
  limit: number
  status?: GiftStatus
  category?: string
  search?: string
}

// 建立贈品
POST /admin/api/gifts
Body: CreateGiftRequest

// 更新贈品
PUT /admin/api/gifts/:id
Body: UpdateGiftRequest

// 刪除贈品
DELETE /admin/api/gifts/:id

// 批量更新庫存
PATCH /admin/api/gifts/inventory
Body: BatchInventoryUpdate[]
```

#### 贈品規則管理
```typescript
// 取得階梯規則清單
GET /admin/api/gift-rules/tier
Query: GiftRuleQuery

// 建立階梯規則
POST /admin/api/gift-rules/tier
Body: CreateTierRuleRequest

// 會員等級規則管理
GET /admin/api/gift-rules/member
POST /admin/api/gift-rules/member
Body: CreateMemberRuleRequest
```

### 前台 API (Customer Site)

#### 贈品查詢與選擇
```typescript
// 取得購物車可用贈品
GET /api/cart/available-gifts
Headers: { Authorization: string }

// 選擇贈品
POST /api/cart/select-gifts
Body: {
  giftSelections: GiftSelection[]
}

// 取得商品頁面贈品資訊
GET /api/products/:id/gifts
Query: {
  memberId?: string
  quantity?: number
}
```

## 資料庫設計

### 核心資料表

#### gifts 表
```sql
CREATE TABLE gifts (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  category VARCHAR(100),
  tags JSON,
  weight DECIMAL(8,3),
  dimensions JSON,
  total_inventory INT DEFAULT 0,
  available_inventory INT DEFAULT 0,
  reserved_inventory INT DEFAULT 0,
  alert_threshold INT DEFAULT 10,
  is_unlimited BOOLEAN DEFAULT FALSE,
  status ENUM('active', 'inactive', 'out_of_stock') DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_gifts_status (status),
  INDEX idx_gifts_category (category),
  INDEX idx_gifts_inventory (available_inventory)
);
```

#### gift_tier_rules 表
```sql
CREATE TABLE gift_tier_rules (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  campaign_id VARCHAR(36),
  target_type ENUM('product', 'category', 'brand', 'amount') NOT NULL,
  target_config JSON NOT NULL,
  member_restrictions JSON,
  date_start DATE,
  date_end DATE,
  status ENUM('active', 'inactive') DEFAULT 'active',
  priority INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_tier_rules_campaign (campaign_id),
  INDEX idx_tier_rules_status_date (status, date_start, date_end)
);
```

#### gift_tier_levels 表  
```sql
CREATE TABLE gift_tier_levels (
  id VARCHAR(36) PRIMARY KEY,
  rule_id VARCHAR(36) NOT NULL,
  level INT NOT NULL,
  condition_type ENUM('quantity', 'amount') NOT NULL,
  condition_value DECIMAL(12,2) NOT NULL,
  condition_operator ENUM('>=', '>', '==') DEFAULT '>=',
  selection_type ENUM('single', 'multiple', 'fixed_combo', 'weighted') NOT NULL,
  max_selections INT DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (rule_id) REFERENCES gift_tier_rules(id) ON DELETE CASCADE,
  UNIQUE KEY uk_rule_level (rule_id, level),
  INDEX idx_tier_levels_rule (rule_id)
);
```

#### gift_allocations 表
```sql
CREATE TABLE gift_allocations (
  id VARCHAR(36) PRIMARY KEY,
  order_id VARCHAR(36) NOT NULL,
  gift_id VARCHAR(36) NOT NULL,
  quantity INT NOT NULL,
  allocation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  status ENUM('allocated', 'reserved', 'sent', 'delivered') DEFAULT 'allocated',
  rule_id VARCHAR(36),
  rule_type ENUM('tier', 'member', 'campaign') NOT NULL,
  
  FOREIGN KEY (gift_id) REFERENCES gifts(id),
  INDEX idx_allocations_order (order_id),
  INDEX idx_allocations_gift (gift_id),
  INDEX idx_allocations_status (status)
);
```

## 整合規格

### 與節慶管理模組整合
- 節慶活動自動關聯對應的贈品方案
- 節慶主題贈品的動態顯示效果
- 節慶期間的特殊贈品規則

### 與行銷管理模組整合  
- 行銷活動的贈品策略設定
- 廣告推廣中的贈品資訊展示
- 個人化贈品推薦

### 與會員系統整合
- 會員等級的贈品權益差異化
- 會員專屬贈品的發放與管理
- 會員贈品使用歷程記錄

### 與訂單系統整合
- 結帳流程中的贈品確認
- 訂單狀態變更時的贈品處理
- 退貨退款時的贈品回收機制

### 與庫存管理整合
- 贈品庫存的即時同步
- 贈品缺貨時的替代方案
- 贈品補貨需求預測

### 與物流系統整合
- 贈品的包裝配置優化
- 贈品不計入運費的邏輯處理
- 贈品的分拆出貨策略

## 效能考量

### 快取策略
- 熱門贈品資訊快取 (TTL: 1小時)
- 階梯規則快取 (TTL: 4小時)  
- 會員贈品權益快取 (TTL: 24小時)

### 效能目標
- 贈品資格檢查 < 100ms
- 贈品選擇頁面載入 < 200ms
- 庫存狀態更新 < 50ms
- 規則變更生效 < 5分鐘

### 擴展性設計
- 支援大量商品的階梯規則
- 高併發的贈品選擇處理
- 分散式贈品庫存管理

## 測試策略

### 單元測試
- 階梯規則計算邏輯
- 庫存狀態自動更新
- 贈品選擇驗證邏輯

### 整合測試  
- 與訂單系統的整合流程
- 與會員系統的權益驗證
- 與庫存系統的同步機制

### 效能測試
- 大量規則的匹配效能
- 高併發贈品分配處理
- 庫存更新的並發安全性

---

本模組設計確保贈品管理的完整性和靈活性，支援各種複雜的贈品發放邏輯，同時保持良好的效能和可維護性。