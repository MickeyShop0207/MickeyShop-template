# 會員管理系統 (Member Management System)

## 1. 模組概述

會員管理系統負責處理客戶註冊、登入、個人資料管理、會員等級、點數系統、會員行為追蹤等功能，為電商平台提供完整的客戶關係管理解決方案。

### 1.1 核心功能
- 會員註冊與認證
- 會員等級與權益管理
- 點數累積與兌換系統
- 會員行為分析與追蹤
- 個人資料與偏好設定
- 社交登入整合
- 會員溝通與行銷

## 2. 系統架構設計

### 2.1 架構層級
```
┌─────────────────────────────────────┐
│          會員前台介面                │
│   (註冊、登入、個人中心、點數查詢)   │
└─────────────────────────────────────┘
                    │
┌─────────────────────────────────────┐
│          會員管理服務層              │
│   (認證、等級管理、點數計算)         │
└─────────────────────────────────────┘
                    │
┌─────────────────────────────────────┐
│        會員資料儲存層                │
│   (會員資料、點數紀錄、行為日誌)     │
└─────────────────────────────────────┘
```

### 2.2 核心元件
```typescript
interface MemberSystemComponents {
  // 會員管理
  memberManager: MemberManager;
  authenticationService: AuthenticationService;
  
  // 等級與點數
  memberTierService: MemberTierService;
  pointsService: PointsService;
  
  // 行為追蹤
  memberBehaviorTracker: MemberBehaviorTracker;
  
  // 偏好管理
  memberPreferenceService: MemberPreferenceService;
  
  // 通訊服務
  memberCommunicationService: MemberCommunicationService;
}
```

## 3. 會員資料模型

### 3.1 會員基本資料
```typescript
interface Member {
  memberId: string;
  memberNumber: string; // 會員編號
  email: string;
  passwordHash?: string; // 社交登入可能為空
  
  // 基本資訊
  firstName: string;
  lastName: string;
  fullName: string;
  displayName?: string;
  avatar?: string;
  
  // 聯絡資訊
  phone?: string;
  phoneVerified: boolean;
  emailVerified: boolean;
  
  // 個人資訊
  gender?: Gender;
  birthDate?: Date;
  age?: number;
  
  // 會員狀態
  status: MemberStatus;
  memberTier: MemberTier;
  memberType: MemberType;
  
  // 註冊資訊
  registrationSource: RegistrationSource;
  registrationDate: Date;
  referredBy?: string; // 推薦人會員ID
  
  // 驗證狀態
  emailVerifiedAt?: Date;
  phoneVerifiedAt?: Date;
  identityVerifiedAt?: Date;
  
  // 登入資訊
  lastLoginAt?: Date;
  lastLoginIp?: string;
  loginCount: number;
  
  // 點數資訊
  currentPoints: number;
  totalPointsEarned: number;
  totalPointsSpent: number;
  lifetimeValue: number; // 終身價值
  
  // 偏好設定
  preferences: MemberPreferences;
  
  // 地址資訊
  addresses: MemberAddress[];
  defaultBillingAddressId?: string;
  defaultShippingAddressId?: string;
  
  // 社交登入
  socialLogins: SocialLogin[];
  
  // 標籤與分群
  tags: string[];
  segments: string[];
  
  // 時間戳記
  createdAt: Date;
  updatedAt: Date;
  deletedAt?: Date;
}

enum Gender {
  MALE = 'male',
  FEMALE = 'female',
  OTHER = 'other',
  PREFER_NOT_TO_SAY = 'prefer_not_to_say'
}

enum MemberStatus {
  ACTIVE = 'active',
  INACTIVE = 'inactive',
  SUSPENDED = 'suspended',
  PENDING_VERIFICATION = 'pending_verification',
  BLOCKED = 'blocked'
}

enum MemberType {
  REGULAR = 'regular',
  VIP = 'vip',
  CORPORATE = 'corporate',
  WHOLESALE = 'wholesale'
}

enum RegistrationSource {
  WEBSITE = 'website',
  MOBILE_APP = 'mobile_app',
  SOCIAL_FACEBOOK = 'social_facebook',
  SOCIAL_GOOGLE = 'social_google',
  SOCIAL_LINE = 'social_line',
  REFERRAL = 'referral',
  IMPORT = 'import'
}
```

### 3.2 會員等級系統
```typescript
interface MemberTier {
  tierId: string;
  tierName: string;
  displayName: string;
  description: string;
  level: number; // 等級順序
  
  // 升級條件
  requirements: TierRequirement[];
  
  // 會員權益
  benefits: TierBenefit[];
  
  // 樣式設定
  color: string;
  icon: string;
  badge: string;
  
  // 狀態
  isActive: boolean;
  isDefault: boolean;
  
  // 時間設定
  createdAt: Date;
  updatedAt: Date;
}

interface TierRequirement {
  requirementId: string;
  type: RequirementType;
  operator: RequirementOperator;
  value: number;
  period: RequirementPeriod;
  description: string;
}

enum RequirementType {
  TOTAL_SPENDING = 'total_spending',      // 累計消費金額
  ORDER_COUNT = 'order_count',            // 訂單數量
  POINTS_EARNED = 'points_earned',        // 累計點數
  REGISTRATION_DAYS = 'registration_days', // 註冊天數
  REFERRAL_COUNT = 'referral_count',      // 推薦人數
  PRODUCT_REVIEWS = 'product_reviews'     // 商品評論數
}

enum RequirementOperator {
  GREATER_THAN = 'gt',
  GREATER_THAN_OR_EQUAL = 'gte',
  EQUAL = 'eq'
}

enum RequirementPeriod {
  LIFETIME = 'lifetime',
  YEARLY = 'yearly',
  MONTHLY = 'monthly',
  ROLLING_12_MONTHS = 'rolling_12_months'
}

interface TierBenefit {
  benefitId: string;
  type: BenefitType;
  value: number;
  unit: BenefitUnit;
  description: string;
  conditions?: BenefitCondition[];
}

enum BenefitType {
  DISCOUNT_PERCENTAGE = 'discount_percentage',    // 折扣百分比
  DISCOUNT_FIXED = 'discount_fixed',              // 固定金額折扣
  FREE_SHIPPING = 'free_shipping',                // 免運費
  POINTS_MULTIPLIER = 'points_multiplier',        // 點數倍率
  EARLY_ACCESS = 'early_access',                  // 早鳥優惠
  BIRTHDAY_GIFT = 'birthday_gift',                // 生日禮品
  PRIORITY_SUPPORT = 'priority_support',          // 優先客服
  EXCLUSIVE_PRODUCTS = 'exclusive_products'       // 專屬商品
}

enum BenefitUnit {
  PERCENTAGE = 'percentage',
  FIXED_AMOUNT = 'fixed_amount',
  MULTIPLIER = 'multiplier',
  BOOLEAN = 'boolean'
}

// 預定義會員等級
const DefaultMemberTiers = [
  {
    tierId: 'tier_bronze',
    tierName: 'bronze',
    displayName: '銅牌會員',
    level: 1,
    requirements: [],
    benefits: [
      {
        type: BenefitType.POINTS_MULTIPLIER,
        value: 1,
        description: '購物享 1 倍點數回饋'
      }
    ],
    isDefault: true
  },
  {
    tierId: 'tier_silver',
    tierName: 'silver',
    displayName: '銀牌會員',
    level: 2,
    requirements: [
      {
        type: RequirementType.TOTAL_SPENDING,
        operator: RequirementOperator.GREATER_THAN_OR_EQUAL,
        value: 10000,
        period: RequirementPeriod.ROLLING_12_MONTHS,
        description: '近12個月累計消費滿10,000元'
      }
    ],
    benefits: [
      {
        type: BenefitType.DISCOUNT_PERCENTAGE,
        value: 5,
        description: '全館商品享95折優惠'
      },
      {
        type: BenefitType.POINTS_MULTIPLIER,
        value: 1.2,
        description: '購物享 1.2 倍點數回饋'
      }
    ]
  },
  {
    tierId: 'tier_gold',
    tierName: 'gold',
    displayName: '金牌會員',
    level: 3,
    requirements: [
      {
        type: RequirementType.TOTAL_SPENDING,
        operator: RequirementOperator.GREATER_THAN_OR_EQUAL,
        value: 50000,
        period: RequirementPeriod.ROLLING_12_MONTHS,
        description: '近12個月累計消費滿50,000元'
      }
    ],
    benefits: [
      {
        type: BenefitType.DISCOUNT_PERCENTAGE,
        value: 10,
        description: '全館商品享9折優惠'
      },
      {
        type: BenefitType.POINTS_MULTIPLIER,
        value: 1.5,
        description: '購物享 1.5 倍點數回饋'
      },
      {
        type: BenefitType.FREE_SHIPPING,
        value: 1,
        description: '全館免運費'
      }
    ]
  },
  {
    tierId: 'tier_platinum',
    tierName: 'platinum',
    displayName: '白金會員',
    level: 4,
    requirements: [
      {
        type: RequirementType.TOTAL_SPENDING,
        operator: RequirementOperator.GREATER_THAN_OR_EQUAL,
        value: 100000,
        period: RequirementPeriod.ROLLING_12_MONTHS,
        description: '近12個月累計消費滿100,000元'
      }
    ],
    benefits: [
      {
        type: BenefitType.DISCOUNT_PERCENTAGE,
        value: 15,
        description: '全館商品享85折優惠'
      },
      {
        type: BenefitType.POINTS_MULTIPLIER,
        value: 2,
        description: '購物享 2 倍點數回饋'
      },
      {
        type: BenefitType.FREE_SHIPPING,
        value: 1,
        description: '全館免運費'
      },
      {
        type: BenefitType.PRIORITY_SUPPORT,
        value: 1,
        description: '專屬客服優先處理'
      }
    ]
  }
];
```

### 3.3 點數系統
```typescript
interface PointsTransaction {
  transactionId: string;
  memberId: string;
  type: PointsTransactionType;
  points: number; // 正數為獲得，負數為消費
  
  // 關聯資訊
  referenceType?: string; // 'order', 'review', 'referral', 'manual'
  referenceId?: string;
  
  // 描述資訊
  description: string;
  details?: Record<string, any>;
  
  // 有效期限
  expiresAt?: Date;
  
  // 狀態
  status: TransactionStatus;
  
  // 操作資訊
  createdBy?: string; // 系統自動或管理員手動
  createdAt: Date;
  processedAt?: Date;
  cancelledAt?: Date;
}

enum PointsTransactionType {
  EARN_PURCHASE = 'earn_purchase',          // 購物獲得
  EARN_REVIEW = 'earn_review',              // 評論獲得
  EARN_REFERRAL = 'earn_referral',          // 推薦獲得
  EARN_BIRTHDAY = 'earn_birthday',          // 生日贈送
  EARN_SIGNUP = 'earn_signup',              // 註冊贈送
  EARN_SOCIAL_SHARE = 'earn_social_share',  // 社群分享
  EARN_EVENT = 'earn_event',                // 活動贈送
  EARN_MANUAL = 'earn_manual',              // 手動調整
  
  SPEND_DISCOUNT = 'spend_discount',        // 折抵消費
  SPEND_GIFT = 'spend_gift',                // 兌換贈品
  SPEND_COUPON = 'spend_coupon',            // 兌換優惠券
  
  EXPIRE = 'expire',                        // 過期扣除
  CANCEL = 'cancel',                        // 取消交易
  ADJUST = 'adjust'                         // 調整
}

enum TransactionStatus {
  PENDING = 'pending',
  COMPLETED = 'completed',
  CANCELLED = 'cancelled',
  EXPIRED = 'expired'
}

interface PointsRule {
  ruleId: string;
  name: string;
  description: string;
  type: PointsTransactionType;
  
  // 計算規則
  pointsPerUnit: number; // 每單位獲得點數
  unit: PointsUnit;      // 計算單位
  
  // 條件限制
  conditions: PointsCondition[];
  
  // 會員等級限制
  applicableTiers: string[]; // 空數組表示適用所有等級
  
  // 時間限制
  startDate?: Date;
  endDate?: Date;
  
  // 限制條件
  maxPointsPerTransaction?: number;
  maxPointsPerDay?: number;
  maxPointsPerMonth?: number;
  
  // 點數有效期
  pointsExpiryDays?: number;
  
  // 狀態
  isActive: boolean;
  priority: number; // 規則優先順序
  
  createdAt: Date;
  updatedAt: Date;
}

enum PointsUnit {
  PER_DOLLAR = 'per_dollar',        // 每元
  PER_ORDER = 'per_order',          // 每筆訂單
  PER_ITEM = 'per_item',            // 每項商品
  PER_ACTION = 'per_action',        // 每次行為
  FIXED_AMOUNT = 'fixed_amount'     // 固定數量
}

interface PointsCondition {
  field: string;
  operator: string;
  value: any;
}

// 預設點數規則
const DefaultPointsRules = [
  {
    ruleId: 'rule_purchase',
    name: 'purchase_points',
    description: '購物點數回饋',
    type: PointsTransactionType.EARN_PURCHASE,
    pointsPerUnit: 1,
    unit: PointsUnit.PER_DOLLAR,
    conditions: [
      {
        field: 'order.status',
        operator: 'in',
        value: ['completed', 'delivered']
      }
    ],
    pointsExpiryDays: 365,
    isActive: true,
    priority: 1
  },
  {
    ruleId: 'rule_review',
    name: 'review_points',
    description: '商品評論點數',
    type: PointsTransactionType.EARN_REVIEW,
    pointsPerUnit: 50,
    unit: PointsUnit.PER_ACTION,
    maxPointsPerDay: 200, // 每日最多獲得200點
    pointsExpiryDays: 365,
    isActive: true,
    priority: 2
  },
  {
    ruleId: 'rule_signup',
    name: 'signup_bonus',
    description: '註冊贈送點數',
    type: PointsTransactionType.EARN_SIGNUP,
    pointsPerUnit: 100,
    unit: PointsUnit.FIXED_AMOUNT,
    pointsExpiryDays: 90, // 90天內使用
    isActive: true,
    priority: 3
  }
];
```

## 4. 核心服務實現

### 4.1 會員管理服務
```typescript
class MemberManager {
  private memberRepository: MemberRepository;
  private authService: AuthenticationService;
  private tierService: MemberTierService;
  private pointsService: PointsService;

  // 註冊新會員
  async registerMember(registrationData: MemberRegistrationData): Promise<Member> {
    // 1. 驗證註冊資料
    await this.validateRegistrationData(registrationData);

    // 2. 檢查郵箱是否已存在
    const existingMember = await this.memberRepository.findByEmail(registrationData.email);
    if (existingMember) {
      throw new Error('Email already registered');
    }

    // 3. 產生會員編號
    const memberNumber = await this.generateMemberNumber();

    // 4. 建立會員記錄
    const member: Member = {
      memberId: generateId(),
      memberNumber,
      email: registrationData.email.toLowerCase(),
      passwordHash: registrationData.password ? 
        await this.hashPassword(registrationData.password) : undefined,
      
      firstName: registrationData.firstName,
      lastName: registrationData.lastName,
      fullName: `${registrationData.firstName} ${registrationData.lastName}`,
      phone: registrationData.phone,
      gender: registrationData.gender,
      birthDate: registrationData.birthDate,
      
      status: MemberStatus.PENDING_VERIFICATION,
      memberTier: await this.tierService.getDefaultTier(),
      memberType: MemberType.REGULAR,
      registrationSource: registrationData.source,
      registrationDate: new Date(),
      referredBy: registrationData.referredBy,
      
      emailVerified: false,
      phoneVerified: false,
      loginCount: 0,
      currentPoints: 0,
      totalPointsEarned: 0,
      totalPointsSpent: 0,
      lifetimeValue: 0,
      
      preferences: this.getDefaultPreferences(),
      addresses: [],
      socialLogins: [],
      tags: [],
      segments: ['new_member'],
      
      createdAt: new Date(),
      updatedAt: new Date()
    };

    // 5. 儲存會員資料
    await this.memberRepository.save(member);

    // 6. 發送驗證郵件
    if (registrationData.email) {
      await this.sendEmailVerification(member);
    }

    // 7. 發送註冊點數（如果有設定）
    await this.pointsService.awardSignupBonus(member.memberId);

    // 8. 處理推薦獎勵
    if (registrationData.referredBy) {
      await this.handleReferralReward(registrationData.referredBy, member.memberId);
    }

    // 9. 記錄註冊事件
    await this.recordMemberEvent(member.memberId, 'member_registered', {
      source: registrationData.source,
      referredBy: registrationData.referredBy
    });

    return member;
  }

  // 會員登入
  async authenticateMember(credentials: LoginCredentials): Promise<AuthenticationResult> {
    const { email, password, loginSource } = credentials;

    // 1. 查找會員
    const member = await this.memberRepository.findByEmail(email.toLowerCase());
    if (!member) {
      throw new AuthenticationError('Invalid email or password');
    }

    // 2. 檢查會員狀態
    if (member.status === MemberStatus.BLOCKED) {
      throw new AuthenticationError('Account is blocked');
    }

    if (member.status === MemberStatus.SUSPENDED) {
      throw new AuthenticationError('Account is suspended');
    }

    // 3. 驗證密碼
    if (!member.passwordHash || !await this.verifyPassword(password, member.passwordHash)) {
      // 記錄登入失敗
      await this.recordLoginAttempt(member.memberId, false, loginSource);
      throw new AuthenticationError('Invalid email or password');
    }

    // 4. 更新登入資訊
    member.lastLoginAt = new Date();
    member.lastLoginIp = credentials.ipAddress;
    member.loginCount += 1;
    
    // 首次登入後激活帳號
    if (member.status === MemberStatus.PENDING_VERIFICATION && member.emailVerified) {
      member.status = MemberStatus.ACTIVE;
    }
    
    await this.memberRepository.save(member);

    // 5. 記錄登入成功
    await this.recordLoginAttempt(member.memberId, true, loginSource);

    // 6. 產生 JWT Token
    const token = await this.authService.generateToken(member);

    // 7. 檢查會員等級是否需要更新
    await this.tierService.checkAndUpdateTier(member.memberId);

    return {
      member,
      token,
      expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24小時
    };
  }

  // 更新會員資料
  async updateMemberProfile(
    memberId: string, 
    updateData: MemberUpdateData
  ): Promise<Member> {
    const member = await this.memberRepository.findById(memberId);
    if (!member) {
      throw new Error('Member not found');
    }

    // 更新允許的欄位
    const allowedFields = [
      'firstName', 'lastName', 'displayName', 'phone', 'gender', 
      'birthDate', 'preferences'
    ];

    const changes: string[] = [];
    allowedFields.forEach(field => {
      if (updateData[field] !== undefined && updateData[field] !== member[field]) {
        member[field] = updateData[field];
        changes.push(field);
      }
    });

    // 更新全名
    if (updateData.firstName || updateData.lastName) {
      member.fullName = `${member.firstName} ${member.lastName}`;
      changes.push('fullName');
    }

    // 計算年齡
    if (updateData.birthDate) {
      member.age = this.calculateAge(updateData.birthDate);
      changes.push('age');
    }

    member.updatedAt = new Date();
    await this.memberRepository.save(member);

    // 記錄變更事件
    if (changes.length > 0) {
      await this.recordMemberEvent(memberId, 'profile_updated', { changes });
    }

    return member;
  }

  // 郵箱驗證
  async verifyEmail(memberId: string, verificationToken: string): Promise<boolean> {
    const isValid = await this.authService.verifyEmailToken(memberId, verificationToken);
    
    if (!isValid) {
      return false;
    }

    const member = await this.memberRepository.findById(memberId);
    if (!member) {
      return false;
    }

    member.emailVerified = true;
    member.emailVerifiedAt = new Date();
    
    // 如果帳號還在等待驗證，則激活
    if (member.status === MemberStatus.PENDING_VERIFICATION) {
      member.status = MemberStatus.ACTIVE;
    }

    await this.memberRepository.save(member);
    
    // 記錄驗證事件
    await this.recordMemberEvent(memberId, 'email_verified');

    return true;
  }

  // 獲取會員統計資訊
  async getMemberStats(memberId: string): Promise<MemberStats> {
    const member = await this.memberRepository.findById(memberId);
    if (!member) {
      throw new Error('Member not found');
    }

    // 訂單統計
    const orderStats = await this.orderRepository.getMemberOrderStats(memberId);
    
    // 點數統計
    const pointsStats = await this.pointsService.getMemberPointsStats(memberId);
    
    // 等級進度
    const tierProgress = await this.tierService.getTierProgress(memberId);

    return {
      memberId,
      memberSince: member.registrationDate,
      
      // 訂單統計
      totalOrders: orderStats.totalOrders,
      totalSpent: orderStats.totalSpent,
      averageOrderValue: orderStats.averageOrderValue,
      lastOrderDate: orderStats.lastOrderDate,
      
      // 點數統計
      currentPoints: pointsStats.currentPoints,
      totalPointsEarned: pointsStats.totalPointsEarned,
      totalPointsSpent: pointsStats.totalPointsSpent,
      pointsExpiringIn30Days: pointsStats.pointsExpiringIn30Days,
      
      // 等級資訊
      currentTier: member.memberTier,
      nextTier: tierProgress.nextTier,
      progressToNextTier: tierProgress.progressPercentage,
      
      // 其他統計
      loginCount: member.loginCount,
      lastLoginAt: member.lastLoginAt,
      lifetimeValue: member.lifetimeValue
    };
  }

  private async generateMemberNumber(): Promise<string> {
    const year = new Date().getFullYear();
    const sequence = await this.memberRepository.getNextSequence(year);
    return `M${year}${sequence.toString().padStart(6, '0')}`;
  }

  private async validateRegistrationData(data: MemberRegistrationData): Promise<void> {
    const errors: string[] = [];

    if (!data.email || !this.isValidEmail(data.email)) {
      errors.push('Invalid email address');
    }

    if (!data.firstName || data.firstName.trim().length < 1) {
      errors.push('First name is required');
    }

    if (!data.lastName || data.lastName.trim().length < 1) {
      errors.push('Last name is required');
    }

    if (data.password && data.password.length < 8) {
      errors.push('Password must be at least 8 characters long');
    }

    if (errors.length > 0) {
      throw new ValidationError('Registration data validation failed', errors);
    }
  }

  private async recordMemberEvent(
    memberId: string, 
    eventType: string, 
    data?: any
  ): Promise<void> {
    await this.memberEventRepository.create({
      eventId: generateId(),
      memberId,
      eventType,
      eventData: data,
      occurredAt: new Date()
    });
  }
}

interface MemberRegistrationData {
  email: string;
  password?: string;
  firstName: string;
  lastName: string;
  phone?: string;
  gender?: Gender;
  birthDate?: Date;
  source: RegistrationSource;
  referredBy?: string;
  agreeToTerms: boolean;
  agreeToMarketing?: boolean;
}

interface AuthenticationResult {
  member: Member;
  token: string;
  expiresAt: Date;
}

interface MemberStats {
  memberId: string;
  memberSince: Date;
  totalOrders: number;
  totalSpent: number;
  averageOrderValue: number;
  lastOrderDate?: Date;
  currentPoints: number;
  totalPointsEarned: number;
  totalPointsSpent: number;
  pointsExpiringIn30Days: number;
  currentTier: MemberTier;
  nextTier?: MemberTier;
  progressToNextTier: number;
  loginCount: number;
  lastLoginAt?: Date;
  lifetimeValue: number;
}
```

### 4.2 點數服務
```typescript
class PointsService {
  private pointsRepository: PointsTransactionRepository;
  private pointsRuleRepository: PointsRuleRepository;
  private memberRepository: MemberRepository;

  // 獎勵點數
  async awardPoints(
    memberId: string,
    type: PointsTransactionType,
    referenceId?: string,
    customPoints?: number
  ): Promise<PointsTransaction> {
    // 1. 獲取適用的點數規則
    const rules = await this.getApplicableRules(memberId, type);
    if (rules.length === 0) {
      throw new Error('No applicable points rules found');
    }

    // 2. 計算點數
    const points = customPoints || await this.calculatePoints(memberId, type, referenceId, rules);
    
    if (points <= 0) {
      throw new Error('Points calculation resulted in zero or negative points');
    }

    // 3. 建立點數交易記錄
    const transaction: PointsTransaction = {
      transactionId: generateId(),
      memberId,
      type,
      points,
      referenceId,
      description: this.getTransactionDescription(type, referenceId),
      status: TransactionStatus.COMPLETED,
      expiresAt: this.calculateExpiryDate(rules[0]),
      createdAt: new Date(),
      processedAt: new Date()
    };

    // 4. 保存交易記錄
    await this.pointsRepository.save(transaction);

    // 5. 更新會員點數餘額
    await this.updateMemberPoints(memberId);

    // 6. 發送點數獲得通知
    await this.sendPointsNotification(memberId, transaction);

    return transaction;
  }

  // 消費點數
  async spendPoints(
    memberId: string,
    points: number,
    type: PointsTransactionType,
    referenceId?: string,
    description?: string
  ): Promise<PointsTransaction> {
    // 1. 檢查會員點數餘額
    const member = await this.memberRepository.findById(memberId);
    if (!member || member.currentPoints < points) {
      throw new InsufficientPointsError('Insufficient points balance');
    }

    // 2. 建立消費記錄
    const transaction: PointsTransaction = {
      transactionId: generateId(),
      memberId,
      type,
      points: -points, // 負數表示消費
      referenceId,
      description: description || this.getTransactionDescription(type, referenceId),
      status: TransactionStatus.COMPLETED,
      createdAt: new Date(),
      processedAt: new Date()
    };

    // 3. 保存交易記錄
    await this.pointsRepository.save(transaction);

    // 4. 更新會員點數餘額
    await this.updateMemberPoints(memberId);

    // 5. 發送點數消費通知
    await this.sendPointsNotification(memberId, transaction);

    return transaction;
  }

  // 獲取會員點數餘額
  async getMemberPointsBalance(memberId: string): Promise<PointsBalance> {
    const transactions = await this.pointsRepository.findByMemberId(memberId);
    
    let totalEarned = 0;
    let totalSpent = 0;
    let currentBalance = 0;
    let expiringIn30Days = 0;

    const now = new Date();
    const in30Days = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);

    transactions.forEach(transaction => {
      if (transaction.status === TransactionStatus.COMPLETED) {
        if (transaction.points > 0) {
          totalEarned += transaction.points;
          // 檢查是否即將過期
          if (transaction.expiresAt && transaction.expiresAt <= in30Days) {
            expiringIn30Days += transaction.points;
          }
        } else {
          totalSpent += Math.abs(transaction.points);
        }
        currentBalance += transaction.points;
      }
    });

    return {
      memberId,
      currentBalance,
      totalEarned,
      totalSpent,
      expiringIn30Days,
      lastUpdated: new Date()
    };
  }

  // 計算購物點數
  async calculatePurchasePoints(
    memberId: string,
    orderAmount: number,
    memberTier?: MemberTier
  ): Promise<number> {
    const rules = await this.getApplicableRules(memberId, PointsTransactionType.EARN_PURCHASE);
    if (rules.length === 0) return 0;

    const rule = rules[0]; // 取優先順序最高的規則
    let basePoints = 0;

    switch (rule.unit) {
      case PointsUnit.PER_DOLLAR:
        basePoints = Math.floor(orderAmount * rule.pointsPerUnit);
        break;
      case PointsUnit.FIXED_AMOUNT:
        basePoints = rule.pointsPerUnit;
        break;
    }

    // 應用會員等級倍率
    if (memberTier?.benefits) {
      const pointsMultiplier = memberTier.benefits.find(
        b => b.type === BenefitType.POINTS_MULTIPLIER
      );
      if (pointsMultiplier) {
        basePoints = Math.floor(basePoints * pointsMultiplier.value);
      }
    }

    // 應用規則限制
    if (rule.maxPointsPerTransaction && basePoints > rule.maxPointsPerTransaction) {
      basePoints = rule.maxPointsPerTransaction;
    }

    return basePoints;
  }

  // 處理點數過期
  async processExpiredPoints(): Promise<void> {
    const expiredTransactions = await this.pointsRepository.findExpiredPoints();
    
    for (const transaction of expiredTransactions) {
      // 建立過期扣除記錄
      const expireTransaction: PointsTransaction = {
        transactionId: generateId(),
        memberId: transaction.memberId,
        type: PointsTransactionType.EXPIRE,
        points: -transaction.points,
        referenceId: transaction.transactionId,
        description: '點數過期扣除',
        status: TransactionStatus.COMPLETED,
        createdBy: 'system',
        createdAt: new Date(),
        processedAt: new Date()
      };

      await this.pointsRepository.save(expireTransaction);
      
      // 更新會員點數餘額
      await this.updateMemberPoints(transaction.memberId);
    }
  }

  private async updateMemberPoints(memberId: string): Promise<void> {
    const balance = await this.getMemberPointsBalance(memberId);
    
    await this.memberRepository.updatePoints(memberId, {
      currentPoints: balance.currentBalance,
      totalPointsEarned: balance.totalEarned,
      totalPointsSpent: balance.totalSpent
    });
  }
}

interface PointsBalance {
  memberId: string;
  currentBalance: number;
  totalEarned: number;
  totalSpent: number;
  expiringIn30Days: number;
  lastUpdated: Date;
}
```

## 5. API 介面設計

### 5.1 會員管理 API
```typescript
// 會員註冊
// POST /api/v1/members/register
interface RegisterMemberRequest {
  email: string;
  password?: string;
  firstName: string;
  lastName: string;
  phone?: string;
  gender?: Gender;
  birthDate?: string;
  referralCode?: string;
  agreeToTerms: boolean;
  agreeToMarketing?: boolean;
}

// 會員登入
// POST /api/v1/members/login
interface LoginRequest {
  email: string;
  password: string;
}

interface LoginResponse {
  success: true;
  data: {
    member: Member;
    token: string;
    expiresAt: string;
  };
}

// 獲取會員資料
// GET /api/v1/members/profile
interface GetProfileResponse {
  success: true;
  data: Member;
}

// 更新會員資料
// PUT /api/v1/members/profile
interface UpdateProfileRequest {
  firstName?: string;
  lastName?: string;
  displayName?: string;
  phone?: string;
  gender?: Gender;
  birthDate?: string;
  preferences?: MemberPreferences;
}

// 獲取會員統計
// GET /api/v1/members/stats
interface GetMemberStatsResponse {
  success: true;
  data: MemberStats;
}

// 獲取點數餘額
// GET /api/v1/members/points/balance
interface GetPointsBalanceResponse {
  success: true;
  data: PointsBalance;
}

// 獲取點數交易記錄
// GET /api/v1/members/points/transactions
interface GetPointsTransactionsResponse {
  success: true;
  data: PointsTransaction[];
  meta: {
    pagination: PaginationMeta;
    summary: {
      totalEarned: number;
      totalSpent: number;
      expiringIn30Days: number;
    };
  };
}

// 兌換點數
// POST /api/v1/members/points/redeem
interface RedeemPointsRequest {
  points: number;
  rewardId: string;
  deliveryAddress?: string;
}
```

### 5.2 後台管理 API
```typescript
// 獲取會員列表
// GET /api/admin/v1/members
interface GetMembersRequest {
  page?: number;
  pageSize?: number;
  search?: string;
  status?: MemberStatus;
  tier?: string;
  registrationSource?: RegistrationSource;
  dateFrom?: string;
  dateTo?: string;
}

// 更新會員狀態
// PUT /api/admin/v1/members/{id}/status
interface UpdateMemberStatusRequest {
  status: MemberStatus;
  reason?: string;
}

// 手動調整點數
// POST /api/admin/v1/members/{id}/points/adjust
interface AdjustPointsRequest {
  points: number; // 正數增加，負數扣除
  reason: string;
  description?: string;
}

// 會員等級管理
// GET /api/admin/v1/member-tiers
// POST /api/admin/v1/member-tiers
// PUT /api/admin/v1/member-tiers/{id}

// 點數規則管理
// GET /api/admin/v1/points-rules
// POST /api/admin/v1/points-rules
// PUT /api/admin/v1/points-rules/{id}
```

## 6. 資料庫設計

```sql
-- 會員表（與之前設計的 customers 表整合）
ALTER TABLE customers 
ADD COLUMN member_number VARCHAR(50) UNIQUE,
ADD COLUMN member_tier_id VARCHAR(50),
ADD COLUMN current_points INT DEFAULT 0,
ADD COLUMN total_points_earned INT DEFAULT 0,
ADD COLUMN total_points_spent INT DEFAULT 0,
ADD COLUMN lifetime_value DECIMAL(15,2) DEFAULT 0,
ADD COLUMN registration_source VARCHAR(50) DEFAULT 'website',
ADD COLUMN referred_by VARCHAR(50),
ADD COLUMN login_count INT DEFAULT 0,
ADD COLUMN preferences JSON,
ADD COLUMN tags JSON,
ADD COLUMN segments JSON,
ADD INDEX idx_member_number (member_number),
ADD INDEX idx_member_tier (member_tier_id),
ADD INDEX idx_registration_source (registration_source);

-- 會員等級表
CREATE TABLE member_tiers (
    tier_id VARCHAR(50) PRIMARY KEY,
    tier_name VARCHAR(100) NOT NULL UNIQUE,
    display_name VARCHAR(100) NOT NULL,
    description TEXT,
    level_order INT NOT NULL,
    requirements JSON,
    benefits JSON,
    color VARCHAR(20),
    icon VARCHAR(100),
    badge VARCHAR(500),
    is_active BOOLEAN DEFAULT TRUE,
    is_default BOOLEAN DEFAULT FALSE,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_level_order (level_order),
    INDEX idx_is_active (is_active)
);

-- 點數交易表
CREATE TABLE points_transactions (
    transaction_id VARCHAR(50) PRIMARY KEY,
    member_id VARCHAR(50) NOT NULL,
    transaction_type VARCHAR(50) NOT NULL,
    points INT NOT NULL,
    reference_type VARCHAR(50),
    reference_id VARCHAR(50),
    description TEXT NOT NULL,
    details JSON,
    expires_at DATETIME,
    status VARCHAR(20) DEFAULT 'completed',
    created_by VARCHAR(50),
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    processed_at DATETIME,
    cancelled_at DATETIME,
    
    FOREIGN KEY (member_id) REFERENCES customers(customer_id) ON DELETE CASCADE,
    INDEX idx_member_id (member_id),
    INDEX idx_transaction_type (transaction_type),
    INDEX idx_status (status),
    INDEX idx_expires_at (expires_at),
    INDEX idx_reference (reference_type, reference_id),
    INDEX idx_created_at (created_at)
);

-- 點數規則表
CREATE TABLE points_rules (
    rule_id VARCHAR(50) PRIMARY KEY,
    rule_name VARCHAR(100) NOT NULL,
    description TEXT,
    transaction_type VARCHAR(50) NOT NULL,
    points_per_unit DECIMAL(10,2) NOT NULL,
    calculation_unit VARCHAR(50) NOT NULL,
    conditions JSON,
    applicable_tiers JSON,
    start_date DATETIME,
    end_date DATETIME,
    max_points_per_transaction INT,
    max_points_per_day INT,
    max_points_per_month INT,
    points_expiry_days INT,
    is_active BOOLEAN DEFAULT TRUE,
    priority INT DEFAULT 0,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_transaction_type (transaction_type),
    INDEX idx_is_active (is_active),
    INDEX idx_priority (priority)
);

-- 會員事件日誌表
CREATE TABLE member_events (
    event_id VARCHAR(50) PRIMARY KEY,
    member_id VARCHAR(50) NOT NULL,
    event_type VARCHAR(100) NOT NULL,
    event_data JSON,
    ip_address VARCHAR(45),
    user_agent TEXT,
    occurred_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (member_id) REFERENCES customers(customer_id) ON DELETE CASCADE,
    INDEX idx_member_id (member_id),
    INDEX idx_event_type (event_type),
    INDEX idx_occurred_at (occurred_at)
);

-- 社交登入關聯表
CREATE TABLE member_social_logins (
    social_login_id VARCHAR(50) PRIMARY KEY,
    member_id VARCHAR(50) NOT NULL,
    provider VARCHAR(50) NOT NULL,
    provider_user_id VARCHAR(255) NOT NULL,
    provider_data JSON,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (member_id) REFERENCES customers(customer_id) ON DELETE CASCADE,
    UNIQUE KEY uk_provider_user (provider, provider_user_id),
    INDEX idx_member_id (member_id),
    INDEX idx_provider (provider)
);
```

這個會員管理系統提供了完整的會員生命週期管理，包括註冊、認證、等級管理、點數系統等核心功能，為電商平台打造良好的客戶關係管理基礎。

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"content": "\u4fee\u6b63\u8cc7\u6599\u5eab\u8a2d\u8a08\u4e0d\u4e00\u81f4\u6027\u554f\u984c", "status": "completed", "activeForm": "\u4fee\u6b63\u8cc7\u6599\u5eab\u8a2d\u8a08\u4e0d\u4e00\u81f4\u6027\u554f\u984c"}, {"content": "\u7d71\u4e00 API \u4ecb\u9762\u898f\u7bc4", "status": "completed", "activeForm": "\u7d71\u4e00 API \u4ecb\u9762\u898f\u7bc4"}, {"content": "\u7d71\u4e00\u6b0a\u9650\u7ba1\u7406\u9ad4\u7cfb", "status": "completed", "activeForm": "\u7d71\u4e00\u6b0a\u9650\u7ba1\u7406\u9ad4\u7cfb"}, {"content": "\u88dc\u5145\u6a21\u7d44 05 - \u6703\u54e1\u7ba1\u7406\u7cfb\u7d71", "status": "completed", "activeForm": "\u88dc\u5145\u6a21\u7d44 05 - \u6703\u54e1\u7ba1\u7406\u7cfb\u7d71"}, {"content": "\u88dc\u5145\u6a21\u7d44 08 - \u8ca1\u52d9\u7ba1\u7406\u7cfb\u7d71", "status": "in_progress", "activeForm": "\u88dc\u5145\u6a21\u7d44 08 - \u8ca1\u52d9\u7ba1\u7406\u7cfb\u7d71"}, {"content": "\u88dc\u5145\u6a21\u7d44 20 - \u7cfb\u7d71\u76e3\u63a7\u6a21\u7d44", "status": "pending", "activeForm": "\u88dc\u5145\u6a21\u7d44 20 - \u7cfb\u7d71\u76e3\u63a7\u6a21\u7d44"}, {"content": "\u5b8c\u5584\u524d\u53f0\u8207\u5f8c\u53f0API\u6574\u5408\u898f\u683c", "status": "pending", "activeForm": "\u5b8c\u5584\u524d\u53f0\u8207\u5f8c\u53f0API\u6574\u5408\u898f\u683c"}, {"content": "\u9a57\u8b49\u67b6\u69cb\u8a2d\u8a08\u5b8c\u6574\u6027", "status": "pending", "activeForm": "\u9a57\u8b49\u67b6\u69cb\u8a2d\u8a08\u5b8c\u6574\u6027"}]