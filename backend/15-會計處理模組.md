# 會計處理模組 (Accounting Management System)

## 模組概述
會計處理系統是電商後台的財務核心，負責所有的財務管理、帳務記錄、會計科目管理、財務報表生成等功能，確保企業財務透明化和合規性。

## 會計科目系統

### 1. 會計科目架構
```typescript
enum AccountType {
  ASSET = 'asset',                  // 資產
  LIABILITY = 'liability',          // 負債
  EQUITY = 'equity',                // 權益
  REVENUE = 'revenue',              // 收入
  EXPENSE = 'expense',              // 費用
  COST_OF_GOODS = 'cost_of_goods'   // 銷貨成本
}

enum AccountCategory {
  // 資產類別
  CURRENT_ASSETS = 'current_assets',           // 流動資產
  NON_CURRENT_ASSETS = 'non_current_assets',   // 非流動資產
  
  // 負債類別
  CURRENT_LIABILITIES = 'current_liabilities', // 流動負債
  NON_CURRENT_LIABILITIES = 'non_current_liabilities', // 非流動負債
  
  // 權益類別
  OWNERS_EQUITY = 'owners_equity',             // 業主權益
  RETAINED_EARNINGS = 'retained_earnings',     // 保留盈餘
  
  // 收入類別
  OPERATING_REVENUE = 'operating_revenue',     // 營業收入
  NON_OPERATING_REVENUE = 'non_operating_revenue', // 營業外收入
  
  // 費用類別
  OPERATING_EXPENSES = 'operating_expenses',   // 營業費用
  NON_OPERATING_EXPENSES = 'non_operating_expenses', // 營業外費用
  
  // 成本類別
  DIRECT_COSTS = 'direct_costs',               // 直接成本
  INDIRECT_COSTS = 'indirect_costs'            // 間接成本
}

interface AccountChart {
  id: number;
  account_code: string;             // 會計科目代碼
  account_name: string;             // 會計科目名稱
  account_name_en?: string;         // 英文名稱
  parent_id?: number;               // 上層科目
  type: AccountType;                // 科目類型
  category: AccountCategory;        // 科目類別
  level: number;                    // 階層層級
  is_active: boolean;               // 是否啟用
  is_system: boolean;               // 是否系統預設科目
  description?: string;             // 說明
  balance_type: 'debit' | 'credit'; // 餘額性質
  
  // 控制設定
  allow_posting: boolean;           // 是否允許過帳
  require_department: boolean;      // 是否需要部門
  require_project: boolean;         // 是否需要專案
  
  // 稅務設定
  tax_code?: string;               // 稅務代碼
  is_tax_account: boolean;         // 是否為稅務科目
  
  created_at: Date;
  updated_at: Date;
}
```

### 2. 預設會計科目設定
```typescript
const DefaultAccounts = {
  // 資產科目
  '1001': { name: '現金', type: 'asset', category: 'current_assets' },
  '1101': { name: '銀行存款-第一銀行', type: 'asset', category: 'current_assets' },
  '1102': { name: '銀行存款-玉山銀行', type: 'asset', category: 'current_assets' },
  '1131': { name: '應收帳款', type: 'asset', category: 'current_assets' },
  '1132': { name: '應收票據', type: 'asset', category: 'current_assets' },
  '1141': { name: '存貨-商品', type: 'asset', category: 'current_assets' },
  '1142': { name: '存貨-原物料', type: 'asset', category: 'current_assets' },
  '1201': { name: '預付費用', type: 'asset', category: 'current_assets' },
  '1301': { name: '固定資產-設備', type: 'asset', category: 'non_current_assets' },
  '1302': { name: '累計折舊-設備', type: 'asset', category: 'non_current_assets' },
  
  // 負債科目
  '2101': { name: '應付帳款', type: 'liability', category: 'current_liabilities' },
  '2102': { name: '應付票據', type: 'liability', category: 'current_liabilities' },
  '2131': { name: '應付薪資', type: 'liability', category: 'current_liabilities' },
  '2141': { name: '應付稅金', type: 'liability', category: 'current_liabilities' },
  '2151': { name: '預收貨款', type: 'liability', category: 'current_liabilities' },
  '2161': { name: '代收款', type: 'liability', category: 'current_liabilities' },
  
  // 權益科目
  '3101': { name: '資本', type: 'equity', category: 'owners_equity' },
  '3201': { name: '保留盈餘', type: 'equity', category: 'retained_earnings' },
  '3301': { name: '本期損益', type: 'equity', category: 'retained_earnings' },
  
  // 收入科目
  '4101': { name: '商品銷售收入', type: 'revenue', category: 'operating_revenue' },
  '4102': { name: '服務收入', type: 'revenue', category: 'operating_revenue' },
  '4103': { name: '運費收入', type: 'revenue', category: 'operating_revenue' },
  '4201': { name: '利息收入', type: 'revenue', category: 'non_operating_revenue' },
  '4202': { name: '其他收入', type: 'revenue', category: 'non_operating_revenue' },
  
  // 成本科目
  '5101': { name: '銷貨成本', type: 'cost_of_goods', category: 'direct_costs' },
  '5102': { name: '運費成本', type: 'cost_of_goods', category: 'direct_costs' },
  '5103': { name: '包裝成本', type: 'cost_of_goods', category: 'direct_costs' },
  
  // 費用科目
  '6101': { name: '薪資費用', type: 'expense', category: 'operating_expenses' },
  '6102': { name: '租金費用', type: 'expense', category: 'operating_expenses' },
  '6103': { name: '水電費', type: 'expense', category: 'operating_expenses' },
  '6104': { name: '電話費', type: 'expense', category: 'operating_expenses' },
  '6105': { name: '網路費', type: 'expense', category: 'operating_expenses' },
  '6106': { name: '廣告費', type: 'expense', category: 'operating_expenses' },
  '6107': { name: '行銷費用', type: 'expense', category: 'operating_expenses' },
  '6108': { name: '包裝費', type: 'expense', category: 'operating_expenses' },
  '6109': { name: '運費費用', type: 'expense', category: 'operating_expenses' },
  '6110': { name: '手續費', type: 'expense', category: 'operating_expenses' },
  '6111': { name: '刷卡手續費', type: 'expense', category: 'operating_expenses' },
  '6112': { name: '銀行手續費', type: 'expense', category: 'operating_expenses' },
  '6113': { name: '平台手續費', type: 'expense', category: 'operating_expenses' },
  '6114': { name: '維修費', type: 'expense', category: 'operating_expenses' },
  '6115': { name: '折舊費用', type: 'expense', category: 'operating_expenses' },
  '6116': { name: '保險費', type: 'expense', category: 'operating_expenses' },
  '6117': { name: '稅金費用', type: 'expense', category: 'operating_expenses' },
  '6201': { name: '利息費用', type: 'expense', category: 'non_operating_expenses' },
  '6202': { name: '雜項費用', type: 'expense', category: 'non_operating_expenses' }
};
```

## 會計分錄系統

### 1. 會計分錄結構
```typescript
interface JournalEntry {
  id: number;
  entry_number: string;             // 分錄編號
  entry_date: Date;                 // 分錄日期
  period: string;                   // 會計期間 (YYYY-MM)
  
  // 來源資訊
  source_type: EntrySourceType;     // 來源類型
  source_id?: number;               // 來源單據ID
  reference_number?: string;        // 參考編號
  
  // 基本資訊
  description: string;              // 摘要說明
  total_debit: number;              // 借方總金額
  total_credit: number;             // 貸方總金額
  
  // 狀態管理
  status: EntryStatus;              // 分錄狀態
  posted_at?: Date;                 // 過帳時間
  posted_by?: number;               // 過帳人員
  
  // 審核流程
  reviewed_by?: number;             // 審核人員
  reviewed_at?: Date;               // 審核時間
  review_notes?: string;            // 審核備註
  
  // 調整資訊
  is_adjustment: boolean;           // 是否為調整分錄
  adjustment_reason?: string;       // 調整原因
  original_entry_id?: number;       // 原始分錄ID
  reversed_entry_id?: number;       // 沖銷分錄ID
  
  // 附件資訊
  attachments?: string[];           // 附件檔案
  
  created_by: number;               // 建立人員
  created_at: Date;
  updated_at: Date;
}

enum EntrySourceType {
  MANUAL = 'manual',                // 手動建立
  ORDER = 'order',                  // 訂單
  PAYMENT = 'payment',              // 付款
  REFUND = 'refund',                // 退款
  PURCHASE = 'purchase',            // 採購
  INVENTORY = 'inventory',          // 庫存
  EXPENSE = 'expense',              // 費用
  PAYROLL = 'payroll',              // 薪資
  DEPRECIATION = 'depreciation',    // 折舊
  ADJUSTMENT = 'adjustment',        // 調整
  CLOSING = 'closing'               // 結帳
}

enum EntryStatus {
  DRAFT = 'draft',                  // 草稿
  PENDING = 'pending',              // 待審核
  APPROVED = 'approved',            // 已核准
  POSTED = 'posted',                // 已過帳
  REVERSED = 'reversed'             // 已沖銷
}
```

### 2. 分錄明細
```typescript
interface JournalEntryLine {
  id: number;
  journal_entry_id: number;
  line_number: number;              // 行號
  
  // 科目資訊
  account_id: number;               // 會計科目ID
  account_code: string;             // 科目代碼（快照）
  account_name: string;             // 科目名稱（快照）
  
  // 金額資訊
  debit_amount: number;             // 借方金額
  credit_amount: number;            // 貸方金額
  
  // 描述資訊
  description?: string;             // 分錄描述
  memo?: string;                    // 備註
  
  // 輔助資訊
  department_id?: number;           // 部門
  project_id?: number;              // 專案
  customer_id?: number;             // 客戶
  supplier_id?: number;             // 供應商
  
  // 稅務資訊
  tax_code?: string;               // 稅務代碼
  tax_amount?: number;             // 稅額
  
  created_at: Date;
  updated_at: Date;
}
```

## 付款方式與會計科目整合

### 1. 付款方式科目設定
```typescript
interface PaymentMethodAccount {
  id: number;
  payment_method: string;           // 付款方式代碼
  payment_method_name: string;      // 付款方式名稱
  
  // 會計科目對應
  receivable_account_id: number;    // 應收科目（收款時用）
  cash_account_id: number;          // 現金/銀行科目
  fee_account_id?: number;          // 手續費科目
  
  // 手續費設定
  has_fee: boolean;                 // 是否有手續費
  fee_rate?: number;                // 手續費率
  fee_fixed?: number;               // 固定手續費
  
  // 對帳設定
  requires_reconciliation: boolean;  // 是否需要對帳
  reconciliation_account_id?: number; // 對帳科目
  
  // 自動分錄設定
  auto_posting: boolean;            // 是否自動過帳
  posting_template?: string;        // 過帳模板
  
  is_active: boolean;
  created_at: Date;
  updated_at: Date;
}

// 預設付款方式科目設定
const DefaultPaymentAccountMapping = {
  'credit_card': {
    receivable_account: '1131',     // 應收帳款
    cash_account: '1101',           // 銀行存款
    fee_account: '6111',            // 刷卡手續費
    has_fee: true,
    fee_rate: 0.028                 // 2.8%
  },
  'bank_transfer': {
    receivable_account: '1131',     // 應收帳款
    cash_account: '1101',           // 銀行存款
    fee_account: '6112',            // 銀行手續費
    has_fee: true,
    fee_fixed: 15                   // 固定15元
  },
  'line_pay': {
    receivable_account: '1131',     // 應收帳款
    cash_account: '1102',           // 銀行存款-玉山銀行
    fee_account: '6113',            // 平台手續費
    has_fee: true,
    fee_rate: 0.021                 // 2.1%
  },
  'cash_on_delivery': {
    receivable_account: '1131',     // 應收帳款
    cash_account: '1001',           // 現金
    fee_account: '6109',            // 運費費用
    has_fee: false
  },
  'store_pickup': {
    receivable_account: '1131',     // 應收帳款
    cash_account: '1001',           // 現金
    has_fee: false
  }
};
```

## 自動會計分錄規則

### 1. 訂單相關分錄規則
```typescript
interface AutoJournalRule {
  id: number;
  name: string;                     // 規則名稱
  description?: string;             // 規則說明
  
  // 觸發條件
  trigger_event: TriggerEvent;      // 觸發事件
  conditions: RuleCondition[];      // 觸發條件
  
  // 分錄模板
  entry_template: EntryTemplate;    // 分錄模板
  
  // 執行控制
  is_active: boolean;               // 是否啟用
  priority: number;                 // 優先級
  auto_post: boolean;               // 是否自動過帳
  
  created_at: Date;
  updated_at: Date;
}

enum TriggerEvent {
  ORDER_CONFIRMED = 'order_confirmed',         // 訂單確認
  PAYMENT_RECEIVED = 'payment_received',       // 收到付款
  ORDER_SHIPPED = 'order_shipped',             // 訂單出貨
  ORDER_COMPLETED = 'order_completed',         // 訂單完成
  ORDER_CANCELLED = 'order_cancelled',         // 訂單取消
  REFUND_ISSUED = 'refund_issued',            // 退款
  PURCHASE_RECEIVED = 'purchase_received',     // 採購入庫
  EXPENSE_APPROVED = 'expense_approved',       // 費用核准
  INVENTORY_ADJUSTMENT = 'inventory_adjustment' // 庫存調整
}

interface RuleCondition {
  field: string;                    // 判斷欄位
  operator: 'eq' | 'ne' | 'gt' | 'lt' | 'in' | 'not_in';
  value: any;                       // 比較值
}

interface EntryTemplate {
  description: string;              // 分錄摘要模板
  lines: EntryLineTemplate[];       // 分錄行模板
}

interface EntryLineTemplate {
  account_code: string;             // 科目代碼
  debit_formula?: string;           // 借方金額公式
  credit_formula?: string;          // 貸方金額公式
  description?: string;             // 行描述
}

// 預設分錄規則
const DefaultJournalRules = {
  // 訂單確認時的銷售分錄
  order_confirmed: {
    name: '訂單確認-銷售收入',
    trigger_event: 'order_confirmed',
    entry_template: {
      description: '銷售商品-訂單#{order_number}',
      lines: [
        {
          account_code: '1131',      // 應收帳款
          debit_formula: 'order.total_amount',
          description: '商品銷售'
        },
        {
          account_code: '4101',      // 銷售收入
          credit_formula: 'order.subtotal',
          description: '商品銷售收入'
        },
        {
          account_code: '4103',      // 運費收入
          credit_formula: 'order.shipping_fee',
          description: '運費收入'
        }
      ]
    }
  },
  
  // 收到付款時的分錄
  payment_received: {
    name: '收到付款',
    trigger_event: 'payment_received',
    entry_template: {
      description: '收到付款-訂單#{order_number}',
      lines: [
        {
          account_code: '${payment_method_account}', // 銀行存款科目
          debit_formula: 'payment.amount - payment.fee',
          description: '收到付款'
        },
        {
          account_code: '${fee_account}',            // 手續費科目
          debit_formula: 'payment.fee',
          description: '付款手續費'
        },
        {
          account_code: '1131',      // 應收帳款
          credit_formula: 'payment.amount',
          description: '收回應收帳款'
        }
      ]
    }
  },
  
  // 出貨時的成本分錄
  order_shipped: {
    name: '出貨成本',
    trigger_event: 'order_shipped',
    entry_template: {
      description: '出貨成本-訂單#{order_number}',
      lines: [
        {
          account_code: '5101',      // 銷貨成本
          debit_formula: 'sum(order_items.cost_amount)',
          description: '銷貨成本'
        },
        {
          account_code: '1141',      // 存貨
          credit_formula: 'sum(order_items.cost_amount)',
          description: '存貨減少'
        }
      ]
    }
  }
};
```

## 財務報表系統

### 1. 基本財務報表
```typescript
interface FinancialReport {
  id: number;
  report_type: ReportType;
  report_name: string;
  period_type: PeriodType;          // 期間類型
  period_start: Date;               // 期間開始
  period_end: Date;                 // 期間結束
  
  // 報表資料
  report_data: ReportData;          // 報表內容
  comparative_data?: ReportData;    // 比較期資料
  
  // 產生資訊
  generated_at: Date;               // 產生時間
  generated_by: number;             // 產生人員
  status: ReportStatus;             // 報表狀態
  
  // 檔案資訊
  file_path?: string;               // 檔案路徑
  file_format: 'pdf' | 'excel' | 'html'; // 檔案格式
  
  created_at: Date;
}

enum ReportType {
  BALANCE_SHEET = 'balance_sheet',           // 資產負債表
  INCOME_STATEMENT = 'income_statement',     // 損益表
  CASH_FLOW = 'cash_flow',                   // 現金流量表
  TRIAL_BALANCE = 'trial_balance',           // 試算表
  GENERAL_LEDGER = 'general_ledger',         // 總分類帳
  ACCOUNTS_RECEIVABLE = 'accounts_receivable', // 應收帳款明細
  ACCOUNTS_PAYABLE = 'accounts_payable',     // 應付帳款明細
  INVENTORY_REPORT = 'inventory_report',     // 存貨報表
  SALES_REPORT = 'sales_report',             // 銷售報表
  EXPENSE_REPORT = 'expense_report'          // 費用報表
}

enum PeriodType {
  MONTHLY = 'monthly',              // 月報
  QUARTERLY = 'quarterly',          // 季報
  YEARLY = 'yearly',               // 年報
  CUSTOM = 'custom'                // 自訂期間
}

enum ReportStatus {
  GENERATING = 'generating',        // 產生中
  COMPLETED = 'completed',          // 已完成
  FAILED = 'failed'                // 產生失敗
}

interface ReportData {
  sections: ReportSection[];
  totals: { [key: string]: number };
  metadata: { [key: string]: any };
}

interface ReportSection {
  section_name: string;
  section_type: 'header' | 'detail' | 'total' | 'subtotal';
  items: ReportItem[];
}

interface ReportItem {
  account_code?: string;
  account_name: string;
  current_amount: number;
  previous_amount?: number;
  variance?: number;
  variance_percentage?: number;
}
```

### 2. 專用電商報表
```typescript
interface ECommerceFinancialReport {
  id: number;
  report_type: ECommerceReportType;
  period_start: Date;
  period_end: Date;
  
  // 銷售分析
  sales_summary: {
    total_orders: number;
    total_revenue: number;
    total_cost: number;
    gross_profit: number;
    gross_margin_rate: number;
    
    // 按管道分析
    channel_breakdown: {
      channel: string;
      orders: number;
      revenue: number;
      percentage: number;
    }[];
    
    // 按商品分析
    product_breakdown: {
      product_id: number;
      product_name: string;
      quantity_sold: number;
      revenue: number;
      cost: number;
      profit: number;
    }[];
  };
  
  // 付款分析
  payment_analysis: {
    payment_method: string;
    transaction_count: number;
    total_amount: number;
    fee_amount: number;
    net_amount: number;
    percentage: number;
  }[];
  
  // 費用分析
  expense_analysis: {
    category: string;
    amount: number;
    percentage: number;
    variance_from_previous: number;
  }[];
  
  // 庫存分析
  inventory_analysis: {
    total_inventory_value: number;
    inventory_turnover: number;
    slow_moving_items: {
      product_id: number;
      product_name: string;
      quantity: number;
      value: number;
      days_in_stock: number;
    }[];
  };
  
  generated_at: Date;
  generated_by: number;
}

enum ECommerceReportType {
  SALES_PERFORMANCE = 'sales_performance',   // 銷售績效
  PAYMENT_ANALYSIS = 'payment_analysis',     // 付款分析
  EXPENSE_BREAKDOWN = 'expense_breakdown',   // 費用分析
  INVENTORY_VALUATION = 'inventory_valuation', // 庫存評價
  PROFIT_MARGIN = 'profit_margin',           // 毛利分析
  CUSTOMER_PROFITABILITY = 'customer_profitability' // 客戶獲利分析
}
```

## 對帳與調節功能

### 1. 銀行對帳系統
```typescript
interface BankReconciliation {
  id: number;
  bank_account_id: number;          // 銀行帳戶ID
  statement_date: Date;             // 對帳日期
  statement_balance: number;        // 銀行對帳單餘額
  book_balance: number;             // 帳面餘額
  
  // 調節項目
  deposits_in_transit: BankReconciliationItem[]; // 在途存款
  outstanding_checks: BankReconciliationItem[];  // 未兌現支票
  bank_charges: BankReconciliationItem[];        // 銀行費用
  interest_earned: BankReconciliationItem[];     // 利息收入
  errors: BankReconciliationItem[];              // 錯誤調整
  
  // 調節結果
  adjusted_bank_balance: number;    // 調節後銀行餘額
  adjusted_book_balance: number;    // 調節後帳面餘額
  is_reconciled: boolean;           // 是否調節平衡
  variance: number;                 // 差異金額
  
  // 處理資訊
  reconciled_by?: number;           // 調節人員
  reconciled_at?: Date;             // 調節時間
  notes?: string;                   // 備註
  
  created_at: Date;
  updated_at: Date;
}

interface BankReconciliationItem {
  id: number;
  reconciliation_id: number;
  item_type: ReconciliationItemType;
  description: string;
  amount: number;
  transaction_date: Date;
  reference_number?: string;
  journal_entry_id?: number;        // 相關分錄ID
  is_cleared: boolean;              // 是否已清除
  created_at: Date;
}

enum ReconciliationItemType {
  DEPOSIT_IN_TRANSIT = 'deposit_in_transit',   // 在途存款
  OUTSTANDING_CHECK = 'outstanding_check',     // 未兌現支票
  BANK_CHARGE = 'bank_charge',                 // 銀行費用
  INTEREST_EARNED = 'interest_earned',         // 利息收入
  NSF_CHECK = 'nsf_check',                     // 跳票
  BANK_ERROR = 'bank_error',                   // 銀行錯誤
  BOOK_ERROR = 'book_error'                    // 帳面錯誤
}
```

### 2. 應收應付對帳
```typescript
interface AccountsReconciliation {
  id: number;
  account_type: 'receivable' | 'payable';
  customer_supplier_id: number;     // 客戶/供應商ID
  reconciliation_date: Date;
  
  // 帳面記錄
  book_balance: number;             // 帳面餘額
  book_transactions: ReconciliationTransaction[];
  
  // 對方記錄
  statement_balance: number;        // 對帳單餘額
  statement_transactions: ReconciliationTransaction[];
  
  // 調節結果
  matched_transactions: TransactionMatch[];
  unmatched_book: ReconciliationTransaction[];
  unmatched_statement: ReconciliationTransaction[];
  variance: number;
  
  status: 'pending' | 'completed' | 'dispute';
  reconciled_by?: number;
  reconciled_at?: Date;
  
  created_at: Date;
  updated_at: Date;
}

interface ReconciliationTransaction {
  transaction_date: Date;
  reference_number: string;
  description: string;
  amount: number;
  transaction_type: 'invoice' | 'payment' | 'credit_memo' | 'debit_memo';
}

interface TransactionMatch {
  book_transaction: ReconciliationTransaction;
  statement_transaction: ReconciliationTransaction;
  match_confidence: number;         // 匹配信心度 (0-100)
  variance: number;                 // 金額差異
}
```

## 稅務處理

### 1. 稅務設定
```typescript
interface TaxSetting {
  id: number;
  tax_code: string;                 // 稅務代碼
  tax_name: string;                 // 稅務名稱
  tax_rate: number;                 // 稅率
  tax_type: TaxType;                // 稅務類型
  
  // 適用條件
  applicable_accounts: string[];     // 適用科目
  applicable_categories: string[];   // 適用分類
  minimum_amount?: number;          // 最低適用金額
  
  // 會計科目
  tax_receivable_account?: string;  // 進項稅額科目
  tax_payable_account?: string;     // 銷項稅額科目
  
  // 申報設定
  reporting_frequency: 'monthly' | 'bimonthly' | 'quarterly';
  
  is_active: boolean;
  effective_date: Date;             // 生效日期
  expiry_date?: Date;               // 失效日期
  
  created_at: Date;
  updated_at: Date;
}

enum TaxType {
  VAT = 'vat',                      // 營業稅
  WITHHOLDING = 'withholding',      // 代扣所得稅
  CUSTOMS = 'customs',              // 關稅
  EXCISE = 'excise',                // 貨物稅
  OTHER = 'other'                   // 其他稅費
}

// 台灣稅務設定範例
const TaiwanTaxSettings = {
  'VAT_5': {
    tax_code: 'VAT_5',
    tax_name: '營業稅 5%',
    tax_rate: 0.05,
    tax_type: 'vat',
    tax_payable_account: '2141'
  },
  'VAT_0': {
    tax_code: 'VAT_0',
    tax_name: '營業稅 0% (零稅率)',
    tax_rate: 0.00,
    tax_type: 'vat',
    tax_payable_account: '2141'
  },
  'WHT_10': {
    tax_code: 'WHT_10',
    tax_name: '扣繳稅額 10%',
    tax_rate: 0.10,
    tax_type: 'withholding',
    tax_receivable_account: '1201'
  }
};
```

### 2. 稅務申報
```typescript
interface TaxReturn {
  id: number;
  tax_code: string;
  reporting_period: string;         // 申報期間 (YYYY-MM)
  filing_deadline: Date;            // 申報截止日
  
  // 稅務資料
  tax_transactions: TaxTransaction[];
  
  // 計算結果
  total_sales: number;              // 總銷售額
  taxable_sales: number;            // 應稅銷售額
  tax_payable: number;              // 應納稅額
  tax_receivable: number;           // 可扣抵稅額
  net_tax: number;                  // 淨稅額
  
  // 申報狀態
  status: TaxReturnStatus;
  filed_at?: Date;                  // 申報時間
  filed_by?: number;                // 申報人員
  
  // 附件
  supporting_documents: string[];   // 支援文件
  
  created_at: Date;
  updated_at: Date;
}

interface TaxTransaction {
  transaction_date: Date;
  transaction_type: string;
  reference_number: string;
  customer_supplier: string;
  tax_invoice_number?: string;      // 統一發票號碼
  sales_amount: number;             // 銷售金額
  tax_amount: number;               // 稅額
  tax_rate: number;                 // 適用稅率
}

enum TaxReturnStatus {
  DRAFT = 'draft',                  // 草稿
  REVIEWING = 'reviewing',          // 審核中
  READY_TO_FILE = 'ready_to_file',  // 待申報
  FILED = 'filed',                  // 已申報
  AMENDED = 'amended'               // 已修正
}
```

## API 設計規格

### 1. 會計科目管理 API
```typescript
// 會計科目列表
GET /api/admin/accounting/accounts
Query: {
  type?: AccountType;
  category?: AccountCategory;
  level?: number;
  is_active?: boolean;
  parent_id?: number;
}

// 建立會計科目
POST /api/admin/accounting/accounts
Body: {
  account_code: string;
  account_name: string;
  parent_id?: number;
  type: AccountType;
  category: AccountCategory;
  description?: string;
  balance_type: 'debit' | 'credit';
  allow_posting: boolean;
}

// 更新會計科目
PUT /api/admin/accounting/accounts/{id}

// 會計科目餘額
GET /api/admin/accounting/accounts/{id}/balance
Query: {
  as_of_date?: string;             // 截至日期
  include_pending?: boolean;        // 是否包含未過帳分錄
}

// 會計科目明細帳
GET /api/admin/accounting/accounts/{id}/ledger
Query: {
  start_date: string;
  end_date: string;
  page?: number;
  limit?: number;
}
```

### 2. 會計分錄管理 API
```typescript
// 分錄列表
GET /api/admin/accounting/journal-entries
Query: {
  period?: string;                 // 會計期間
  status?: EntryStatus;
  source_type?: EntrySourceType;
  account_code?: string;
  start_date?: string;
  end_date?: string;
  search?: string;
}

// 建立分錄
POST /api/admin/accounting/journal-entries
Body: {
  entry_date: string;
  description: string;
  source_type: EntrySourceType;
  source_id?: number;
  reference_number?: string;
  lines: {
    account_code: string;
    debit_amount?: number;
    credit_amount?: number;
    description?: string;
    memo?: string;
    department_id?: number;
    project_id?: number;
  }[];
  attachments?: string[];
}

// 分錄詳情
GET /api/admin/accounting/journal-entries/{id}

// 過帳分錄
POST /api/admin/accounting/journal-entries/{id}/post
Body: {
  post_date?: string;              // 過帳日期（預設為today）
  notes?: string;
}

// 沖銷分錄
POST /api/admin/accounting/journal-entries/{id}/reverse
Body: {
  reverse_date: string;            // 沖銷日期
  reason: string;                  // 沖銷原因
}

// 批次過帳
POST /api/admin/accounting/journal-entries/batch-post
Body: {
  entry_ids: number[];
  post_date?: string;
  notes?: string;
}
```

### 3. 財務報表 API
```typescript
// 產生財務報表
POST /api/admin/accounting/reports/generate
Body: {
  report_type: ReportType;
  period_type: PeriodType;
  period_start: string;
  period_end: string;
  comparative_period?: {
    start: string;
    end: string;
  };
  format: 'pdf' | 'excel' | 'html';
  options?: {
    include_zero_balance?: boolean;
    show_account_codes?: boolean;
    group_by_category?: boolean;
  };
}

// 報表列表
GET /api/admin/accounting/reports
Query: {
  report_type?: ReportType;
  period_start?: string;
  period_end?: string;
  status?: ReportStatus;
}

// 下載報表
GET /api/admin/accounting/reports/{id}/download

// 試算表
GET /api/admin/accounting/reports/trial-balance
Query: {
  as_of_date: string;
  include_zero_balance?: boolean;
}

// 損益表
GET /api/admin/accounting/reports/income-statement
Query: {
  start_date: string;
  end_date: string;
  comparative_start?: string;
  comparative_end?: string;
}

// 資產負債表
GET /api/admin/accounting/reports/balance-sheet
Query: {
  as_of_date: string;
  comparative_date?: string;
}
```

### 4. 對帳功能 API
```typescript
// 銀行對帳
POST /api/admin/accounting/bank-reconciliation
Body: {
  bank_account_id: number;
  statement_date: string;
  statement_balance: number;
  statement_transactions: {
    date: string;
    description: string;
    amount: number;
    reference: string;
  }[];
}

// 自動匹配交易
POST /api/admin/accounting/bank-reconciliation/{id}/auto-match
Body: {
  match_tolerance?: number;        // 匹配容差金額
  date_tolerance?: number;         // 日期容差天數
}

// 手動匹配交易
POST /api/admin/accounting/bank-reconciliation/{id}/manual-match
Body: {
  book_transaction_id: number;
  statement_transaction_id: number;
}

// 完成對帳
POST /api/admin/accounting/bank-reconciliation/{id}/complete
Body: {
  create_adjusting_entries?: boolean; // 是否建立調整分錄
}
```

### 5. 稅務管理 API
```typescript
// 稅務設定
GET /api/admin/accounting/tax-settings
POST /api/admin/accounting/tax-settings
PUT /api/admin/accounting/tax-settings/{id}

// 稅務申報資料
GET /api/admin/accounting/tax-returns/{period}
Body: {
  tax_code: string;
  start_date: string;
  end_date: string;
}

// 產生申報檔案
POST /api/admin/accounting/tax-returns/{period}/generate
Body: {
  format: 'xml' | 'csv' | 'txt';
  include_supporting_docs?: boolean;
}
```

## 資料庫設計

### 1. 核心資料表
```sql
-- 會計科目表
CREATE TABLE account_chart (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    account_code VARCHAR(20) UNIQUE NOT NULL,
    account_name VARCHAR(255) NOT NULL,
    account_name_en VARCHAR(255),
    parent_id BIGINT NULL,
    type ENUM('asset', 'liability', 'equity', 'revenue', 'expense', 'cost_of_goods') NOT NULL,
    category VARCHAR(50) NOT NULL,
    level INT NOT NULL DEFAULT 1,
    is_active BOOLEAN DEFAULT true,
    is_system BOOLEAN DEFAULT false,
    description TEXT,
    balance_type ENUM('debit', 'credit') NOT NULL,
    allow_posting BOOLEAN DEFAULT true,
    require_department BOOLEAN DEFAULT false,
    require_project BOOLEAN DEFAULT false,
    tax_code VARCHAR(20),
    is_tax_account BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_code (account_code),
    INDEX idx_type_category (type, category),
    INDEX idx_parent (parent_id),
    INDEX idx_active (is_active),
    FULLTEXT idx_search (account_name, account_name_en, description)
);

-- 會計分錄主表
CREATE TABLE journal_entries (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    entry_number VARCHAR(50) UNIQUE NOT NULL,
    entry_date DATE NOT NULL,
    period VARCHAR(7) NOT NULL,           -- YYYY-MM
    source_type ENUM('manual', 'order', 'payment', 'refund', 'purchase', 'inventory', 'expense', 'payroll', 'depreciation', 'adjustment', 'closing') NOT NULL,
    source_id BIGINT,
    reference_number VARCHAR(100),
    description TEXT NOT NULL,
    total_debit DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    total_credit DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    status ENUM('draft', 'pending', 'approved', 'posted', 'reversed') DEFAULT 'draft',
    posted_at TIMESTAMP NULL,
    posted_by BIGINT,
    reviewed_by BIGINT,
    reviewed_at TIMESTAMP NULL,
    review_notes TEXT,
    is_adjustment BOOLEAN DEFAULT false,
    adjustment_reason TEXT,
    original_entry_id BIGINT,
    reversed_entry_id BIGINT,
    attachments JSON,
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_entry_number (entry_number),
    INDEX idx_date_period (entry_date, period),
    INDEX idx_source (source_type, source_id),
    INDEX idx_status (status),
    INDEX idx_posted (posted_at),
    FULLTEXT idx_search (entry_number, reference_number, description)
);

-- 會計分錄明細表
CREATE TABLE journal_entry_lines (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    journal_entry_id BIGINT NOT NULL,
    line_number INT NOT NULL,
    account_id BIGINT NOT NULL,
    account_code VARCHAR(20) NOT NULL,
    account_name VARCHAR(255) NOT NULL,
    debit_amount DECIMAL(15,2) DEFAULT 0.00,
    credit_amount DECIMAL(15,2) DEFAULT 0.00,
    description TEXT,
    memo TEXT,
    department_id BIGINT,
    project_id BIGINT,
    customer_id BIGINT,
    supplier_id BIGINT,
    tax_code VARCHAR(20),
    tax_amount DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_journal_entry (journal_entry_id),
    INDEX idx_account (account_id, account_code),
    INDEX idx_amounts (debit_amount, credit_amount),
    INDEX idx_references (customer_id, supplier_id, department_id, project_id)
);

-- 付款方式會計科目對應表
CREATE TABLE payment_method_accounts (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    payment_method VARCHAR(50) UNIQUE NOT NULL,
    payment_method_name VARCHAR(100) NOT NULL,
    receivable_account_id BIGINT NOT NULL,
    cash_account_id BIGINT NOT NULL,
    fee_account_id BIGINT,
    has_fee BOOLEAN DEFAULT false,
    fee_rate DECIMAL(6,4),
    fee_fixed DECIMAL(10,2),
    requires_reconciliation BOOLEAN DEFAULT false,
    reconciliation_account_id BIGINT,
    auto_posting BOOLEAN DEFAULT true,
    posting_template TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_payment_method (payment_method),
    INDEX idx_active (is_active)
);

-- 自動分錄規則表
CREATE TABLE auto_journal_rules (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    trigger_event VARCHAR(50) NOT NULL,
    conditions JSON,
    entry_template JSON NOT NULL,
    is_active BOOLEAN DEFAULT true,
    priority INT DEFAULT 0,
    auto_post BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_trigger (trigger_event, is_active),
    INDEX idx_priority (priority)
);

-- 財務報表記錄表
CREATE TABLE financial_reports (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    report_type VARCHAR(50) NOT NULL,
    report_name VARCHAR(255) NOT NULL,
    period_type ENUM('monthly', 'quarterly', 'yearly', 'custom') NOT NULL,
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    report_data JSON,
    comparative_data JSON,
    generated_at TIMESTAMP NOT NULL,
    generated_by BIGINT NOT NULL,
    status ENUM('generating', 'completed', 'failed') DEFAULT 'generating',
    file_path VARCHAR(500),
    file_format ENUM('pdf', 'excel', 'html') DEFAULT 'pdf',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_type_period (report_type, period_start, period_end),
    INDEX idx_status (status),
    INDEX idx_generated (generated_at, generated_by)
);

-- 銀行對帳記錄表
CREATE TABLE bank_reconciliations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    bank_account_id BIGINT NOT NULL,
    statement_date DATE NOT NULL,
    statement_balance DECIMAL(15,2) NOT NULL,
    book_balance DECIMAL(15,2) NOT NULL,
    adjusted_bank_balance DECIMAL(15,2) NOT NULL,
    adjusted_book_balance DECIMAL(15,2) NOT NULL,
    is_reconciled BOOLEAN DEFAULT false,
    variance DECIMAL(15,2) DEFAULT 0.00,
    reconciled_by BIGINT,
    reconciled_at TIMESTAMP NULL,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_bank_date (bank_account_id, statement_date),
    INDEX idx_reconciled (is_reconciled, reconciled_at)
);

-- 銀行對帳明細表
CREATE TABLE bank_reconciliation_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    reconciliation_id BIGINT NOT NULL,
    item_type ENUM('deposit_in_transit', 'outstanding_check', 'bank_charge', 'interest_earned', 'nsf_check', 'bank_error', 'book_error') NOT NULL,
    description VARCHAR(255) NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    transaction_date DATE NOT NULL,
    reference_number VARCHAR(100),
    journal_entry_id BIGINT,
    is_cleared BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_reconciliation (reconciliation_id),
    INDEX idx_type (item_type),
    INDEX idx_cleared (is_cleared)
);

-- 稅務設定表
CREATE TABLE tax_settings (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tax_code VARCHAR(20) UNIQUE NOT NULL,
    tax_name VARCHAR(100) NOT NULL,
    tax_rate DECIMAL(6,4) NOT NULL,
    tax_type ENUM('vat', 'withholding', 'customs', 'excise', 'other') NOT NULL,
    applicable_accounts JSON,
    applicable_categories JSON,
    minimum_amount DECIMAL(10,2),
    tax_receivable_account VARCHAR(20),
    tax_payable_account VARCHAR(20),
    reporting_frequency ENUM('monthly', 'bimonthly', 'quarterly') DEFAULT 'monthly',
    is_active BOOLEAN DEFAULT true,
    effective_date DATE NOT NULL,
    expiry_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_code (tax_code),
    INDEX idx_active_effective (is_active, effective_date),
    INDEX idx_type (tax_type)
);

-- 稅務申報記錄表
CREATE TABLE tax_returns (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tax_code VARCHAR(20) NOT NULL,
    reporting_period VARCHAR(7) NOT NULL, -- YYYY-MM
    filing_deadline DATE NOT NULL,
    tax_transactions JSON,
    total_sales DECIMAL(15,2) DEFAULT 0.00,
    taxable_sales DECIMAL(15,2) DEFAULT 0.00,
    tax_payable DECIMAL(15,2) DEFAULT 0.00,
    tax_receivable DECIMAL(15,2) DEFAULT 0.00,
    net_tax DECIMAL(15,2) DEFAULT 0.00,
    status ENUM('draft', 'reviewing', 'ready_to_file', 'filed', 'amended') DEFAULT 'draft',
    filed_at TIMESTAMP NULL,
    filed_by BIGINT,
    supporting_documents JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_tax_period (tax_code, reporting_period),
    INDEX idx_status_deadline (status, filing_deadline),
    INDEX idx_filed (filed_at, filed_by)
);
```

## 整合功能

### 1. 與訂單系統整合
- 訂單確認自動產生應收分錄
- 收款自動沖銷應收帳款
- 出貨自動結轉存貨成本
- 退貨自動產生沖銷分錄

### 2. 與採購系統整合
- 採購入庫自動產生應付分錄
- 付款自動沖銷應付帳款
- 存貨成本自動計算與分攤
- 採購費用自動歸類

### 3. 與庫存系統整合
- 庫存異動自動調整存貨科目
- 盤點差異自動產生調整分錄
- 存貨評價定期調整
- 呆滯庫存提列減損

### 4. 與薪資系統整合
- 薪資費用自動計提
- 勞健保費用分攤
- 扣繳稅額自動計算
- 薪資支付自動過帳

## 效能與安全性

### 1. 效能優化
- 分錄資料分區儲存
- 關鍵查詢索引優化
- 報表快取機制
- 批次處理優化

### 2. 資料安全
- 財務資料存取權限控制
- 敏感資料加密儲存
- 完整操作稽核軌跡
- 定期資料備份

### 3. 內控機制
- 分錄審核流程
- 權限分工控制
- 異常交易監控
- 合規性檢查

### 4. 監控與告警
- 財務異常指標監控
- 重要分錄即時告警
- 系統效能監控
- 合規性狀態追蹤

這個會計處理系統提供了完整的財務管理功能，從基礎的會計科目管理到進階的財務分析報表，並且與其他電商模組緊密整合，確保財務資料的準確性和即時性，滿足企業財務管理和合規要求。