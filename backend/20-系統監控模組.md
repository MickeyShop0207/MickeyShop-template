# 系統監控模組 (System Monitoring Module)

## 模組概述
系統監控模組負責監控系統運行狀態、性能指標、錯誤日誌和業務指標，提供實時監控、告警通知和數據分析功能。

## 核心功能

### 1. 系統性能監控
- CPU使用率監控
- 內存使用監控
- 數據庫連接池狀態
- API響應時間統計
- 請求量統計

### 2. 業務指標監控
- 訂單成功率
- 支付成功率
- 庫存預警
- 會員活躍度
- 銷售趨勢

### 3. 錯誤監控與告警
- 錯誤日誌收集
- 異常統計分析
- 告警規則配置
- 通知渠道管理

### 4. 日誌管理
- 結構化日誌記錄
- 日誌輪轉管理
- 日誌檢索與分析
- 日誌歸檔

## 數據模型

### 監控指標表 (system_metrics)
```sql
CREATE TABLE system_metrics (
    metric_id VARCHAR(50) PRIMARY KEY,
    metric_name VARCHAR(100) NOT NULL,
    metric_type ENUM('performance', 'business', 'error', 'custom') NOT NULL,
    metric_value DECIMAL(15,4) NOT NULL,
    unit VARCHAR(20) DEFAULT '',
    tags JSON,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_metric_name (metric_name),
    INDEX idx_metric_type (metric_type),
    INDEX idx_timestamp (timestamp)
);
```

### 告警規則表 (alert_rules)
```sql
CREATE TABLE alert_rules (
    rule_id VARCHAR(50) PRIMARY KEY,
    rule_name VARCHAR(100) NOT NULL,
    metric_name VARCHAR(100) NOT NULL,
    condition_operator ENUM('>', '<', '>=', '<=', '=', '!=') NOT NULL,
    threshold_value DECIMAL(15,4) NOT NULL,
    severity ENUM('low', 'medium', 'high', 'critical') NOT NULL,
    is_active BOOLEAN DEFAULT true,
    notification_channels JSON,
    cooldown_minutes INT DEFAULT 5,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_metric_name (metric_name),
    INDEX idx_is_active (is_active)
);
```

### 告警記錄表 (alert_logs)
```sql
CREATE TABLE alert_logs (
    log_id VARCHAR(50) PRIMARY KEY,
    rule_id VARCHAR(50) NOT NULL,
    alert_status ENUM('triggered', 'resolved') NOT NULL,
    current_value DECIMAL(15,4) NOT NULL,
    threshold_value DECIMAL(15,4) NOT NULL,
    message TEXT,
    notified_at DATETIME,
    resolved_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (rule_id) REFERENCES alert_rules(rule_id) ON DELETE CASCADE,
    INDEX idx_rule_id (rule_id),
    INDEX idx_alert_status (alert_status),
    INDEX idx_created_at (created_at)
);
```

### 系統日誌表 (system_logs)
```sql
CREATE TABLE system_logs (
    log_id VARCHAR(50) PRIMARY KEY,
    level ENUM('DEBUG', 'INFO', 'WARN', 'ERROR', 'FATAL') NOT NULL,
    module VARCHAR(50) NOT NULL,
    action VARCHAR(100),
    message TEXT NOT NULL,
    context JSON,
    user_id VARCHAR(50),
    ip_address VARCHAR(45),
    user_agent VARCHAR(500),
    request_id VARCHAR(50),
    execution_time DECIMAL(8,3),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_level (level),
    INDEX idx_module (module),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at),
    INDEX idx_request_id (request_id)
);
```

## TypeScript 接口定義

```typescript
// 監控指標接口
interface SystemMetric {
  metricId: string;
  metricName: string;
  metricType: 'performance' | 'business' | 'error' | 'custom';
  metricValue: number;
  unit?: string;
  tags?: Record<string, any>;
  timestamp: Date;
  createdAt: Date;
}

// 告警規則接口
interface AlertRule {
  ruleId: string;
  ruleName: string;
  metricName: string;
  conditionOperator: '>' | '<' | '>=' | '<=' | '=' | '!=';
  thresholdValue: number;
  severity: 'low' | 'medium' | 'high' | 'critical';
  isActive: boolean;
  notificationChannels: NotificationChannel[];
  cooldownMinutes: number;
  createdAt: Date;
  updatedAt: Date;
}

// 通知渠道配置
interface NotificationChannel {
  type: 'email' | 'sms' | 'webhook' | 'slack';
  config: Record<string, any>;
  isEnabled: boolean;
}

// 告警記錄接口
interface AlertLog {
  logId: string;
  ruleId: string;
  alertStatus: 'triggered' | 'resolved';
  currentValue: number;
  thresholdValue: number;
  message?: string;
  notifiedAt?: Date;
  resolvedAt?: Date;
  createdAt: Date;
}

// 系統日誌接口
interface SystemLog {
  logId: string;
  level: 'DEBUG' | 'INFO' | 'WARN' | 'ERROR' | 'FATAL';
  module: string;
  action?: string;
  message: string;
  context?: Record<string, any>;
  userId?: string;
  ipAddress?: string;
  userAgent?: string;
  requestId?: string;
  executionTime?: number;
  createdAt: Date;
}

// 監控儀表板數據
interface DashboardData {
  systemHealth: {
    cpu: number;
    memory: number;
    dbConnections: number;
    activeUsers: number;
  };
  businessMetrics: {
    dailyOrders: number;
    orderSuccessRate: number;
    paymentSuccessRate: number;
    activeMembers: number;
  };
  alerts: {
    active: number;
    resolved: number;
    critical: number;
  };
  performance: {
    avgResponseTime: number;
    requestsPerMinute: number;
    errorRate: number;
  };
}
```

## API 端點設計

### 監控數據 API

#### 獲取系統指標
```typescript
// GET /api/admin/v1/monitoring/metrics
interface GetMetricsRequest {
  metricNames?: string[];
  metricType?: string;
  startTime?: string;
  endTime?: string;
  page?: number;
  limit?: number;
}

interface GetMetricsResponse {
  success: true;
  data: {
    metrics: SystemMetric[];
    aggregations?: Record<string, number>;
  };
  meta: PaginationMeta;
}
```

#### 記錄系統指標
```typescript
// POST /api/admin/v1/monitoring/metrics
interface RecordMetricRequest {
  metricName: string;
  metricType: 'performance' | 'business' | 'error' | 'custom';
  metricValue: number;
  unit?: string;
  tags?: Record<string, any>;
}

interface RecordMetricResponse {
  success: true;
  data: { metricId: string };
}
```

#### 獲取儀表板數據
```typescript
// GET /api/admin/v1/monitoring/dashboard
interface GetDashboardResponse {
  success: true;
  data: DashboardData;
}
```

### 告警管理 API

#### 創建告警規則
```typescript
// POST /api/admin/v1/monitoring/alert-rules
interface CreateAlertRuleRequest {
  ruleName: string;
  metricName: string;
  conditionOperator: '>' | '<' | '>=' | '<=' | '=' | '!=';
  thresholdValue: number;
  severity: 'low' | 'medium' | 'high' | 'critical';
  notificationChannels: NotificationChannel[];
  cooldownMinutes?: number;
}

interface CreateAlertRuleResponse {
  success: true;
  data: { ruleId: string };
}
```

#### 獲取告警規則列表
```typescript
// GET /api/admin/v1/monitoring/alert-rules
interface GetAlertRulesResponse {
  success: true;
  data: AlertRule[];
}
```

#### 獲取告警記錄
```typescript
// GET /api/admin/v1/monitoring/alert-logs
interface GetAlertLogsRequest {
  ruleId?: string;
  status?: 'triggered' | 'resolved';
  startTime?: string;
  endTime?: string;
  page?: number;
  limit?: number;
}

interface GetAlertLogsResponse {
  success: true;
  data: AlertLog[];
  meta: PaginationMeta;
}
```

### 日誌管理 API

#### 記錄系統日誌
```typescript
// POST /api/admin/v1/monitoring/logs
interface LogRequest {
  level: 'DEBUG' | 'INFO' | 'WARN' | 'ERROR' | 'FATAL';
  module: string;
  action?: string;
  message: string;
  context?: Record<string, any>;
  executionTime?: number;
}

interface LogResponse {
  success: true;
  data: { logId: string };
}
```

#### 查詢系統日誌
```typescript
// GET /api/admin/v1/monitoring/logs
interface GetLogsRequest {
  level?: string;
  module?: string;
  keyword?: string;
  startTime?: string;
  endTime?: string;
  page?: number;
  limit?: number;
}

interface GetLogsResponse {
  success: true;
  data: SystemLog[];
  meta: PaginationMeta;
}
```

## 監控中間件

### 性能監控中間件
```typescript
export const performanceMonitoring = (): Middleware => {
  return async (c, next) => {
    const startTime = Date.now();
    const requestId = generateId();
    
    // 設置請求ID
    c.set('requestId', requestId);
    
    try {
      await next();
      
      const executionTime = Date.now() - startTime;
      
      // 記錄API響應時間
      await recordMetric({
        metricName: 'api_response_time',
        metricType: 'performance',
        metricValue: executionTime,
        unit: 'ms',
        tags: {
          path: c.req.path,
          method: c.req.method,
          status: c.res.status
        }
      });
      
      // 記錄請求日誌
      await recordLog({
        level: 'INFO',
        module: 'API',
        action: 'REQUEST',
        message: `${c.req.method} ${c.req.path}`,
        context: {
          status: c.res.status,
          executionTime,
          requestId
        },
        executionTime
      });
      
    } catch (error) {
      const executionTime = Date.now() - startTime;
      
      // 記錄錯誤指標
      await recordMetric({
        metricName: 'api_error_rate',
        metricType: 'error',
        metricValue: 1,
        tags: {
          path: c.req.path,
          method: c.req.method,
          error: error.name
        }
      });
      
      // 記錄錯誤日誌
      await recordLog({
        level: 'ERROR',
        module: 'API',
        action: 'ERROR',
        message: error.message,
        context: {
          stack: error.stack,
          requestId,
          path: c.req.path,
          method: c.req.method
        },
        executionTime
      });
      
      throw error;
    }
  };
};
```

## 監控服務實現

### 指標收集服務
```typescript
class MetricsCollector {
  private db: Database;
  private cache: Cache;
  
  constructor(db: Database, cache: Cache) {
    this.db = db;
    this.cache = cache;
  }
  
  async recordMetric(metric: Omit<SystemMetric, 'metricId' | 'createdAt'>): Promise<string> {
    const metricId = generateId();
    
    const newMetric: SystemMetric = {
      metricId,
      ...metric,
      createdAt: new Date()
    };
    
    // 插入數據庫
    await this.db.execute(`
      INSERT INTO system_metrics (
        metric_id, metric_name, metric_type, metric_value,
        unit, tags, timestamp, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    `, [
      newMetric.metricId,
      newMetric.metricName,
      newMetric.metricType,
      newMetric.metricValue,
      newMetric.unit || '',
      JSON.stringify(newMetric.tags || {}),
      newMetric.timestamp.toISOString(),
      newMetric.createdAt.toISOString()
    ]);
    
    // 更新緩存中的實時指標
    await this.cache.set(
      `metric:${metric.metricName}:latest`,
      JSON.stringify(newMetric),
      300 // 5分鐘緩存
    );
    
    // 檢查告警規則
    await this.checkAlertRules(metric.metricName, metric.metricValue);
    
    return metricId;
  }
  
  async getMetrics(params: GetMetricsRequest): Promise<{ metrics: SystemMetric[], total: number }> {
    let query = `
      SELECT * FROM system_metrics
      WHERE 1=1
    `;
    const queryParams: any[] = [];
    
    if (params.metricNames?.length) {
      query += ` AND metric_name IN (${params.metricNames.map(() => '?').join(',')})`;
      queryParams.push(...params.metricNames);
    }
    
    if (params.metricType) {
      query += ` AND metric_type = ?`;
      queryParams.push(params.metricType);
    }
    
    if (params.startTime) {
      query += ` AND timestamp >= ?`;
      queryParams.push(params.startTime);
    }
    
    if (params.endTime) {
      query += ` AND timestamp <= ?`;
      queryParams.push(params.endTime);
    }
    
    query += ` ORDER BY timestamp DESC`;
    
    if (params.limit) {
      query += ` LIMIT ?`;
      queryParams.push(params.limit);
      
      if (params.page && params.page > 1) {
        query += ` OFFSET ?`;
        queryParams.push((params.page - 1) * params.limit);
      }
    }
    
    const result = await this.db.prepare(query).all(...queryParams);
    
    // 計算總數
    const countQuery = query.replace('SELECT *', 'SELECT COUNT(*) as total').split(' ORDER BY')[0];
    const countResult = await this.db.prepare(countQuery).first(...queryParams.slice(0, -2));
    
    return {
      metrics: result.map(this.mapRowToMetric),
      total: countResult.total
    };
  }
  
  private async checkAlertRules(metricName: string, currentValue: number): Promise<void> {
    const rules = await this.db.prepare(`
      SELECT * FROM alert_rules
      WHERE metric_name = ? AND is_active = true
    `).all(metricName);
    
    for (const rule of rules) {
      const shouldAlert = this.evaluateCondition(
        currentValue,
        rule.condition_operator,
        rule.threshold_value
      );
      
      if (shouldAlert) {
        await this.triggerAlert(rule, currentValue);
      }
    }
  }
  
  private evaluateCondition(value: number, operator: string, threshold: number): boolean {
    switch (operator) {
      case '>': return value > threshold;
      case '<': return value < threshold;
      case '>=': return value >= threshold;
      case '<=': return value <= threshold;
      case '=': return value === threshold;
      case '!=': return value !== threshold;
      default: return false;
    }
  }
  
  private mapRowToMetric(row: any): SystemMetric {
    return {
      metricId: row.metric_id,
      metricName: row.metric_name,
      metricType: row.metric_type,
      metricValue: row.metric_value,
      unit: row.unit || undefined,
      tags: row.tags ? JSON.parse(row.tags) : undefined,
      timestamp: new Date(row.timestamp),
      createdAt: new Date(row.created_at)
    };
  }
}
```

### 告警管理服務
```typescript
class AlertManager {
  private db: Database;
  private notificationService: NotificationService;
  
  constructor(db: Database, notificationService: NotificationService) {
    this.db = db;
    this.notificationService = notificationService;
  }
  
  async createAlertRule(rule: Omit<AlertRule, 'ruleId' | 'createdAt' | 'updatedAt'>): Promise<string> {
    const ruleId = generateId();
    
    await this.db.execute(`
      INSERT INTO alert_rules (
        rule_id, rule_name, metric_name, condition_operator,
        threshold_value, severity, is_active, notification_channels,
        cooldown_minutes, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `, [
      ruleId,
      rule.ruleName,
      rule.metricName,
      rule.conditionOperator,
      rule.thresholdValue,
      rule.severity,
      rule.isActive,
      JSON.stringify(rule.notificationChannels),
      rule.cooldownMinutes,
      new Date().toISOString(),
      new Date().toISOString()
    ]);
    
    return ruleId;
  }
  
  async triggerAlert(rule: any, currentValue: number): Promise<void> {
    // 檢查冷卻時間
    const lastAlert = await this.db.prepare(`
      SELECT created_at FROM alert_logs
      WHERE rule_id = ? AND alert_status = 'triggered'
      ORDER BY created_at DESC LIMIT 1
    `).first(rule.rule_id);
    
    if (lastAlert) {
      const timeSinceLastAlert = Date.now() - new Date(lastAlert.created_at).getTime();
      const cooldownMs = rule.cooldown_minutes * 60 * 1000;
      
      if (timeSinceLastAlert < cooldownMs) {
        return; // 還在冷卻時間內
      }
    }
    
    // 記錄告警日誌
    const logId = generateId();
    await this.db.execute(`
      INSERT INTO alert_logs (
        log_id, rule_id, alert_status, current_value,
        threshold_value, message, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?)
    `, [
      logId,
      rule.rule_id,
      'triggered',
      currentValue,
      rule.threshold_value,
      `Alert triggered: ${rule.rule_name}`,
      new Date().toISOString()
    ]);
    
    // 發送通知
    const channels = JSON.parse(rule.notification_channels);
    for (const channel of channels) {
      if (channel.isEnabled) {
        await this.notificationService.send(channel, {
          title: `Alert: ${rule.rule_name}`,
          message: `Metric ${rule.metric_name} value ${currentValue} ${rule.condition_operator} ${rule.threshold_value}`,
          severity: rule.severity,
          timestamp: new Date()
        });
      }
    }
  }
}
```

### 日誌管理服務
```typescript
class LogManager {
  private db: Database;
  
  constructor(db: Database) {
    this.db = db;
  }
  
  async recordLog(log: Omit<SystemLog, 'logId' | 'createdAt'>): Promise<string> {
    const logId = generateId();
    
    const newLog: SystemLog = {
      logId,
      ...log,
      createdAt: new Date()
    };
    
    await this.db.execute(`
      INSERT INTO system_logs (
        log_id, level, module, action, message, context,
        user_id, ip_address, user_agent, request_id,
        execution_time, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `, [
      newLog.logId,
      newLog.level,
      newLog.module,
      newLog.action || null,
      newLog.message,
      JSON.stringify(newLog.context || {}),
      newLog.userId || null,
      newLog.ipAddress || null,
      newLog.userAgent || null,
      newLog.requestId || null,
      newLog.executionTime || null,
      newLog.createdAt.toISOString()
    ]);
    
    return logId;
  }
  
  async queryLogs(params: GetLogsRequest): Promise<{ logs: SystemLog[], total: number }> {
    let query = `
      SELECT * FROM system_logs
      WHERE 1=1
    `;
    const queryParams: any[] = [];
    
    if (params.level) {
      query += ` AND level = ?`;
      queryParams.push(params.level);
    }
    
    if (params.module) {
      query += ` AND module = ?`;
      queryParams.push(params.module);
    }
    
    if (params.keyword) {
      query += ` AND (message LIKE ? OR action LIKE ?)`;
      queryParams.push(`%${params.keyword}%`, `%${params.keyword}%`);
    }
    
    if (params.startTime) {
      query += ` AND created_at >= ?`;
      queryParams.push(params.startTime);
    }
    
    if (params.endTime) {
      query += ` AND created_at <= ?`;
      queryParams.push(params.endTime);
    }
    
    query += ` ORDER BY created_at DESC`;
    
    if (params.limit) {
      query += ` LIMIT ?`;
      queryParams.push(params.limit);
      
      if (params.page && params.page > 1) {
        query += ` OFFSET ?`;
        queryParams.push((params.page - 1) * params.limit);
      }
    }
    
    const result = await this.db.prepare(query).all(...queryParams);
    
    // 計算總數
    const countQuery = query.replace('SELECT *', 'SELECT COUNT(*) as total').split(' ORDER BY')[0];
    const countResult = await this.db.prepare(countQuery).first(...queryParams.slice(0, -2));
    
    return {
      logs: result.map(this.mapRowToLog),
      total: countResult.total
    };
  }
  
  private mapRowToLog(row: any): SystemLog {
    return {
      logId: row.log_id,
      level: row.level,
      module: row.module,
      action: row.action || undefined,
      message: row.message,
      context: row.context ? JSON.parse(row.context) : undefined,
      userId: row.user_id || undefined,
      ipAddress: row.ip_address || undefined,
      userAgent: row.user_agent || undefined,
      requestId: row.request_id || undefined,
      executionTime: row.execution_time || undefined,
      createdAt: new Date(row.created_at)
    };
  }
}
```

## 通知服務

### 通知渠道實現
```typescript
interface NotificationMessage {
  title: string;
  message: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  timestamp: Date;
}

class NotificationService {
  async send(channel: NotificationChannel, message: NotificationMessage): Promise<void> {
    switch (channel.type) {
      case 'email':
        await this.sendEmail(channel.config, message);
        break;
      case 'webhook':
        await this.sendWebhook(channel.config, message);
        break;
      case 'slack':
        await this.sendSlack(channel.config, message);
        break;
    }
  }
  
  private async sendEmail(config: any, message: NotificationMessage): Promise<void> {
    // Email 發送實現
  }
  
  private async sendWebhook(config: any, message: NotificationMessage): Promise<void> {
    await fetch(config.url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...config.headers
      },
      body: JSON.stringify({
        ...message,
        timestamp: message.timestamp.toISOString()
      })
    });
  }
  
  private async sendSlack(config: any, message: NotificationMessage): Promise<void> {
    // Slack 發送實現
  }
}
```

## 錯誤處理與驗證

### 輸入驗證
```typescript
const alertRuleSchema = {
  ruleName: { required: true, type: 'string', maxLength: 100 },
  metricName: { required: true, type: 'string', maxLength: 100 },
  conditionOperator: { required: true, enum: ['>', '<', '>=', '<=', '=', '!='] },
  thresholdValue: { required: true, type: 'number' },
  severity: { required: true, enum: ['low', 'medium', 'high', 'critical'] },
  notificationChannels: { required: true, type: 'array' },
  cooldownMinutes: { type: 'number', min: 1, max: 1440 }
};

const logSchema = {
  level: { required: true, enum: ['DEBUG', 'INFO', 'WARN', 'ERROR', 'FATAL'] },
  module: { required: true, type: 'string', maxLength: 50 },
  message: { required: true, type: 'string' },
  action: { type: 'string', maxLength: 100 },
  executionTime: { type: 'number', min: 0 }
};
```

## 權限控制
```typescript
// 監控數據查看權限
const MONITORING_VIEW = 'monitoring.view';
// 監控配置管理權限
const MONITORING_MANAGE = 'monitoring.manage';
// 告警規則管理權限
const ALERT_MANAGE = 'alert.manage';
// 日誌管理權限
const LOG_MANAGE = 'log.manage';
```

## 性能優化策略

1. **指標聚合**：定期聚合歷史指標數據，減少查詢負載
2. **分區存儲**：按時間分區存儲日誌和指標數據
3. **索引優化**：為常用查詢欄位建立適當索引
4. **緩存機制**：實時指標使用Redis緩存
5. **異步處理**：告警通知使用異步隊列處理

## 部署考量

1. **數據保留策略**：定期清理過期的日誌和指標數據
2. **備份恢復**：重要監控數據的備份策略
3. **高可用性**：監控服務本身的高可用部署
4. **資源監控**：監控系統自身的性能監控

該模組提供了完整的系統監控功能，包括性能指標收集、業務指標監控、告警管理和日誌記錄，確保系統運行狀態的全面監控和及時告警。