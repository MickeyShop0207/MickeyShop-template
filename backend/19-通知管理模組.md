# 模組 19: 通知管理模組 (Notification Management Module)

## 模組概述

通知管理模組提供完整的多渠道通知服務，包含豐富的範本變數系統、多樣化的觸發機制、巢狀分類的變數管理，以及完整的通知歷史追蹤功能。所有變數都與系統資料庫實際資料欄位對應，確保能回傳正確的值。

## 核心功能架構

### 1. 通知渠道整合

#### 1.1 支援的通知渠道
```typescript
enum NotificationChannel {
  EMAIL_TEXT = 'email_text',           // Email(文字) - 使用自有網域
  EMAIL_HTML = 'email_html',           // Email(HTML) - 使用自有網域  
  SMS = 'sms',                         // SMS 簡訊
  LINE_TEXT = 'line_text',             // LINE 文字訊息
  LINE_FLEX = 'line_flex',             // LINE Flex Message
  PUSH_APP = 'push_app',               // 手機App推播
  PUSH_WEB = 'push_web'                // 瀏覽器推播
}

interface NotificationChannelConfig {
  channel: NotificationChannel
  isEnabled: boolean
  config: ChannelSpecificConfig
  testRecipients: string[]
}

// Email 配置
interface EmailConfig {
  smtpHost: string
  smtpPort: number
  username: string
  password: string
  fromEmail: string
  fromName: string
  replyTo?: string
  domain: string                       // 自有網域
}

// LINE 配置
interface LineConfig {
  channelAccessToken: string
  channelSecret: string
  webhookUrl: string
}

// 推播配置
interface PushConfig {
  fcmServerKey: string                 // Firebase Cloud Messaging
  vapidPublicKey: string               // Web Push VAPID
  vapidPrivateKey: string
}
```

#### 1.2 渠道測試功能
```typescript
class NotificationChannelTester {
  // 測試Email發送
  async testEmailChannel(
    config: EmailConfig,
    testRecipient: string,
    templateContent: string
  ): Promise<TestResult> {
    try {
      const transporter = nodemailer.createTransporter({
        host: config.smtpHost,
        port: config.smtpPort,
        secure: config.smtpPort === 465,
        auth: {
          user: config.username,
          pass: config.password
        }
      })

      const result = await transporter.sendMail({
        from: `${config.fromName} <${config.fromEmail}>`,
        to: testRecipient,
        subject: '通知系統測試 - Email渠道',
        text: templateContent,
        html: templateContent
      })

      return {
        success: true,
        messageId: result.messageId,
        response: result.response,
        testTime: new Date()
      }
    } catch (error) {
      return {
        success: false,
        error: error.message,
        testTime: new Date()
      }
    }
  }

  // 測試LINE發送
  async testLineChannel(
    config: LineConfig,
    testRecipient: string,
    messageType: 'text' | 'flex',
    content: string | FlexMessage
  ): Promise<TestResult> {
    try {
      const lineBot = new LineBot({
        channelAccessToken: config.channelAccessToken,
        channelSecret: config.channelSecret
      })

      let message: any
      if (messageType === 'text') {
        message = { type: 'text', text: content as string }
      } else {
        message = { type: 'flex', altText: 'Flex Message', contents: content as FlexMessage }
      }

      await lineBot.pushMessage(testRecipient, message)
      
      return {
        success: true,
        testTime: new Date()
      }
    } catch (error) {
      return {
        success: false,
        error: error.message,
        testTime: new Date()
      }
    }
  }

  // 測試SMS發送
  async testSmsChannel(
    config: SmsConfig,
    testRecipient: string,
    content: string
  ): Promise<TestResult> {
    try {
      // 整合SMS服務商API (如台灣大哥大、中華電信等)
      const smsService = new SmsService(config)
      const result = await smsService.sendSms(testRecipient, content)
      
      return {
        success: true,
        messageId: result.messageId,
        testTime: new Date()
      }
    } catch (error) {
      return {
        success: false,
        error: error.message,
        testTime: new Date()
      }
    }
  }

  // 測試推播通知
  async testPushChannel(
    config: PushConfig,
    testRecipient: string,
    title: string,
    content: string
  ): Promise<TestResult> {
    try {
      const admin = require('firebase-admin')
      
      const message = {
        token: testRecipient,
        notification: {
          title: title,
          body: content
        },
        data: {
          testMessage: 'true',
          timestamp: new Date().toISOString()
        }
      }

      const response = await admin.messaging().send(message)
      
      return {
        success: true,
        messageId: response,
        testTime: new Date()
      }
    } catch (error) {
      return {
        success: false,
        error: error.message,
        testTime: new Date()
      }
    }
  }
}
```

### 2. 真實資料變數系統

#### 2.1 變數資料來源映射
```typescript
// 變數與資料庫欄位的真實映射關係
class NotificationVariableResolver {
  // 用戶變數解析 - 對應 users 表
  async resolveUserVariables(userId: string): Promise<UserVariables> {
    const user = await this.userRepository.findById(userId)
    const memberInfo = await this.memberService.getMemberInfo(userId)
    const defaultAddress = await this.addressService.getDefaultAddress(userId)
    
    return {
      // 基本資訊 - 來自 users 表
      'user.id': user.id,
      'user.name': user.name || `${user.firstName} ${user.lastName}`,
      'user.firstName': user.firstName,
      'user.lastName': user.lastName,
      'user.email': user.email,
      'user.phone': user.phone,
      'user.gender': user.gender,
      'user.birthday': this.formatDate(user.birthday),
      'user.age': this.calculateAge(user.birthday),
      'user.avatar': user.avatarUrl || this.getDefaultAvatar(),
      
      // 會員資訊 - 來自 members 表和計算
      'user.memberLevel': memberInfo.currentLevel,
      'user.memberLevelName': memberInfo.levelName,
      'user.points': memberInfo.currentPoints,
      'user.accumulatedPoints': memberInfo.accumulatedPoints,
      'user.nextLevelPoints': memberInfo.pointsToNextLevel,
      'user.joinDate': this.formatDate(user.createdAt),
      'user.lastLoginDate': this.formatDate(user.lastLoginAt),
      'user.totalSpent': await this.orderService.getTotalSpentByUser(userId),
      'user.totalOrders': await this.orderService.getOrderCountByUser(userId),
      
      // 地址資訊 - 來自 addresses 表
      'user.defaultAddress.name': defaultAddress?.recipientName || user.name,
      'user.defaultAddress.phone': defaultAddress?.recipientPhone || user.phone,
      'user.defaultAddress.address': defaultAddress?.fullAddress || '',
      'user.defaultAddress.city': defaultAddress?.city || '',
      'user.defaultAddress.postalCode': defaultAddress?.postalCode || ''
    }
  }

  // 訂單變數解析 - 對應 orders 表及相關表
  async resolveOrderVariables(orderId: string): Promise<OrderVariables> {
    const order = await this.orderRepository.findByIdWithDetails(orderId)
    const orderItems = await this.orderItemService.getOrderItems(orderId)
    const payment = await this.paymentService.getOrderPayment(orderId)
    const shipping = await this.shippingService.getOrderShipping(orderId)
    
    return {
      // 基本資訊 - 來自 orders 表
      'order.id': order.id,
      'order.number': order.orderNumber,
      'order.status': order.status,
      'order.statusName': this.getOrderStatusName(order.status),
      'order.date': this.formatDateTime(order.createdAt),
      'order.paymentDate': payment?.paidAt ? this.formatDateTime(payment.paidAt) : '',
      'order.shippingDate': shipping?.shippedAt ? this.formatDateTime(shipping.shippedAt) : '',
      'order.deliveryDate': shipping?.deliveredAt ? this.formatDateTime(shipping.deliveredAt) : '',
      
      // 金額資訊 - 來自 orders 表計算
      'order.subtotal': this.formatCurrency(order.subtotal),
      'order.shippingFee': this.formatCurrency(order.shippingFee),
      'order.discount': this.formatCurrency(order.discountAmount),
      'order.tax': this.formatCurrency(order.taxAmount),
      'order.total': this.formatCurrency(order.totalAmount),
      'order.paidAmount': this.formatCurrency(payment?.paidAmount || 0),
      'order.remainingAmount': this.formatCurrency(order.totalAmount - (payment?.paidAmount || 0)),
      
      // 商品資訊 - 來自 order_items 表
      'order.itemCount': orderItems.reduce((sum, item) => sum + item.quantity, 0),
      'order.items': orderItems.map(item => ({
        name: item.productName,
        price: this.formatCurrency(item.price),
        quantity: item.quantity,
        subtotal: this.formatCurrency(item.price * item.quantity),
        image: item.productImage
      })),
      
      // 收件資訊 - 來自 orders 表
      'order.recipient.name': order.recipientName,
      'order.recipient.phone': order.recipientPhone,
      'order.recipient.email': order.recipientEmail,
      'order.recipient.address': order.shippingAddress,
      'order.recipient.notes': order.deliveryNotes || ''
    }
  }

  // 商品變數解析 - 對應 products 表及相關表
  async resolveProductVariables(productId: string, userId?: string): Promise<ProductVariables> {
    const product = await this.productRepository.findByIdWithDetails(productId)
    const inventory = await this.inventoryService.getProductInventory(productId)
    const pricing = await this.pricingService.getProductPricing(productId, userId)
    
    return {
      // 基本資訊 - 來自 products 表
      'product.id': product.id,
      'product.sku': product.sku,
      'product.name': product.name,
      'product.description': product.description,
      'product.shortDescription': product.shortDescription || product.description?.substring(0, 100) + '...',
      
      // 價格資訊 - 來自 product_prices 表和計算
      'product.price': this.formatCurrency(pricing.currentPrice),
      'product.originalPrice': this.formatCurrency(product.originalPrice),
      'product.memberPrice': this.formatCurrency(pricing.memberPrice),
      'product.festivalPrice': this.formatCurrency(pricing.festivalPrice),
      'product.discountRate': this.formatPercentage(pricing.discountRate),
      'product.savings': this.formatCurrency(product.originalPrice - pricing.currentPrice),
      
      // 分類資訊 - 來自 categories 表
      'product.category': product.category?.name || '',
      'product.subcategory': product.subcategory?.name || '',
      'product.brand': product.brand?.name || '',
      'product.tags': product.tags?.map(tag => tag.name) || [],
      
      // 媒體資訊 - 來自 product_images 表
      'product.mainImage': product.images?.find(img => img.isMain)?.url || '',
      'product.images': product.images?.map(img => img.url) || [],
      'product.video': product.videoUrl || '',
      
      // 庫存資訊 - 來自 inventory 表
      'product.stock': inventory.availableQuantity,
      'product.stockStatus': this.getStockStatus(inventory.availableQuantity),
      'product.isInStock': inventory.availableQuantity > 0,
      'product.lowStockThreshold': inventory.lowStockThreshold
    }
  }

  // 活動變數解析 - 對應 campaigns 表
  async resolveCampaignVariables(campaignId: string): Promise<CampaignVariables> {
    const campaign = await this.campaignRepository.findById(campaignId)
    const usage = await this.campaignService.getCampaignUsage(campaignId)
    
    return {
      'campaign.id': campaign.id,
      'campaign.name': campaign.name,
      'campaign.type': campaign.type,
      'campaign.description': campaign.description,
      'campaign.startDate': this.formatDateTime(campaign.startDate),
      'campaign.endDate': this.formatDateTime(campaign.endDate),
      'campaign.status': campaign.status,
      'campaign.discountType': campaign.discountType,
      'campaign.discountValue': campaign.discountValue,
      'campaign.minAmount': this.formatCurrency(campaign.minPurchaseAmount),
      'campaign.maxDiscount': this.formatCurrency(campaign.maxDiscountAmount),
      'campaign.usageLimit': campaign.usageLimit,
      'campaign.remainingUsage': campaign.usageLimit - usage.usedCount
    }
  }

  // 物流變數解析 - 對應 shipping 表
  async resolveShippingVariables(shippingId: string): Promise<ShippingVariables> {
    const shipping = await this.shippingRepository.findById(shippingId)
    const trackingInfo = await this.logisticsService.getTrackingInfo(shipping.trackingNumber)
    
    return {
      'shipping.id': shipping.id,
      'shipping.number': shipping.trackingNumber,
      'shipping.method': shipping.shippingMethod,
      'shipping.methodName': this.getShippingMethodName(shipping.shippingMethod),
      'shipping.status': shipping.status,
      'shipping.statusName': this.getShippingStatusName(shipping.status),
      'shipping.createDate': this.formatDateTime(shipping.createdAt),
      'shipping.pickupDate': shipping.pickupDate ? this.formatDateTime(shipping.pickupDate) : '',
      'shipping.estimatedDelivery': shipping.estimatedDeliveryDate ? this.formatDate(shipping.estimatedDeliveryDate) : '',
      'shipping.actualDelivery': shipping.actualDeliveryDate ? this.formatDateTime(shipping.actualDeliveryDate) : '',
      'shipping.deliveryDays': this.calculateDeliveryDays(shipping.pickupDate, shipping.actualDeliveryDate),
      'shipping.senderAddress': shipping.senderAddress,
      'shipping.receiverAddress': shipping.receiverAddress,
      'shipping.storeInfo': trackingInfo?.storeInfo || '',
      'shipping.storeName': trackingInfo?.storeName || '',
      'shipping.storeAddress': trackingInfo?.storeAddress || ''
    }
  }

  // 支付變數解析 - 對應 payments 表
  async resolvePaymentVariables(paymentId: string): Promise<PaymentVariables> {
    const payment = await this.paymentRepository.findById(paymentId)
    
    return {
      'payment.id': payment.id,
      'payment.method': payment.paymentMethod,
      'payment.methodName': this.getPaymentMethodName(payment.paymentMethod),
      'payment.status': payment.status,
      'payment.statusName': this.getPaymentStatusName(payment.status),
      'payment.amount': this.formatCurrency(payment.amount),
      'payment.fee': this.formatCurrency(payment.processingFee),
      'payment.actualAmount': this.formatCurrency(payment.amount - payment.processingFee),
      'payment.currency': payment.currency,
      'payment.createDate': this.formatDateTime(payment.createdAt),
      'payment.paidDate': payment.paidAt ? this.formatDateTime(payment.paidAt) : '',
      'payment.expireDate': payment.expireAt ? this.formatDateTime(payment.expireAt) : '',
      'payment.transactionId': payment.transactionId || ''
    }
  }

  // 系統變數解析 - 來自系統設定和當前時間
  async resolveSystemVariables(): Promise<SystemVariables> {
    const settings = await this.systemSettingService.getSettings()
    const now = new Date()
    
    return {
      'system.siteName': settings.siteName,
      'system.siteUrl': settings.siteUrl,
      'system.logo': settings.logoUrl,
      'system.contactEmail': settings.contactEmail,
      'system.contactPhone': settings.contactPhone,
      'system.address': settings.companyAddress,
      'system.currentDate': this.formatDate(now),
      'system.currentTime': this.formatTime(now),
      'system.year': now.getFullYear().toString(),
      'system.month': (now.getMonth() + 1).toString().padStart(2, '0'),
      'system.day': now.getDate().toString().padStart(2, '0'),
      'system.randomCode': this.generateRandomCode(6),
      'system.resetPasswordLink': `${settings.siteUrl}/reset-password?token={{resetToken}}`,
      'system.verificationLink': `${settings.siteUrl}/verify-email?token={{verifyToken}}`,
      'system.loginLink': `${settings.siteUrl}/login`
    }
  }
}
```

### 3. 範本管理系統

#### 3.1 範本結構設計
```typescript
interface NotificationTemplate {
  id: string
  name: string
  description: string
  category: TemplateCategory
  subcategory?: string
  trigger: NotificationTrigger
  channels: ChannelTemplate[]
  variables: TemplateVariable[]
  conditions?: TemplateCondition[]
  priority: NotificationPriority
  isActive: boolean
  createdBy: string
  createdAt: Date
  updatedAt: Date
  version: number
  tags: string[]
}

enum TemplateCategory {
  ORDER = 'order',                     // 訂單相關
  USER = 'user',                       // 用戶相關
  MARKETING = 'marketing',             // 行銷相關
  SYSTEM = 'system',                   // 系統相關
  PRODUCT = 'product',                 // 商品相關
  LOGISTICS = 'logistics'              // 物流相關
}

interface ChannelTemplate {
  channel: NotificationChannel
  subject?: string                     // Email主旨或推播標題
  content: string                      // 範本內容
  htmlContent?: string                 // HTML內容（Email HTML使用）
  flexContent?: FlexMessage           // LINE Flex Message內容
  attachments?: TemplateAttachment[]   // 附件
  isEnabled: boolean
}

interface TemplateVariable {
  name: string                        // 變數名稱，如 user.name
  displayName: string                 // 顯示名稱，如 用戶姓名
  category: VariableCategory          // 變數分類
  dataType: 'string' | 'number' | 'date' | 'boolean' | 'array' | 'object'
  isRequired: boolean
  defaultValue?: any
  description?: string
  example?: string
}

enum VariableCategory {
  USER = 'user',
  ORDER = 'order', 
  PRODUCT = 'product',
  CAMPAIGN = 'campaign',
  SHIPPING = 'shipping',
  PAYMENT = 'payment',
  SYSTEM = 'system'
}
```

#### 3.2 巢狀變數分類系統
```typescript
class TemplateVariableManager {
  // 取得巢狀分類的變數結構
  getVariableCategories(): VariableCategoryTree {
    return {
      user: {
        name: '用戶變數',
        icon: 'user',
        subcategories: {
          basic: {
            name: '基本資訊',
            variables: [
              { name: 'user.id', displayName: '用戶ID', type: 'string', example: 'U001' },
              { name: 'user.name', displayName: '用戶姓名', type: 'string', example: '王小明' },
              { name: 'user.firstName', displayName: '名字', type: 'string', example: '小明' },
              { name: 'user.lastName', displayName: '姓氏', type: 'string', example: '王' },
              { name: 'user.email', displayName: '電子郵箱', type: 'string', example: 'user@example.com' },
              { name: 'user.phone', displayName: '手機號碼', type: 'string', example: '0912345678' },
              { name: 'user.gender', displayName: '性別', type: 'string', example: '男' },
              { name: 'user.birthday', displayName: '生日', type: 'date', example: '1990-01-01' },
              { name: 'user.age', displayName: '年齡', type: 'number', example: '33' },
              { name: 'user.avatar', displayName: '頭像URL', type: 'string', example: 'https://...' }
            ]
          },
          member: {
            name: '會員資訊',
            variables: [
              { name: 'user.memberLevel', displayName: '會員等級', type: 'string', example: 'GOLD' },
              { name: 'user.memberLevelName', displayName: '會員等級名稱', type: 'string', example: '金卡會員' },
              { name: 'user.points', displayName: '當前點數', type: 'number', example: '1500' },
              { name: 'user.accumulatedPoints', displayName: '累積點數', type: 'number', example: '15000' },
              { name: 'user.nextLevelPoints', displayName: '升級所需點數', type: 'number', example: '2500' },
              { name: 'user.joinDate', displayName: '加入日期', type: 'date', example: '2020-03-15' },
              { name: 'user.lastLoginDate', displayName: '最後登入時間', type: 'date', example: '2024-01-15 14:30' },
              { name: 'user.totalSpent', displayName: '累計消費金額', type: 'number', example: '50,000' },
              { name: 'user.totalOrders', displayName: '總訂單數', type: 'number', example: '25' }
            ]
          },
          address: {
            name: '地址資訊',
            variables: [
              { name: 'user.defaultAddress.name', displayName: '預設收件人姓名', type: 'string', example: '王小明' },
              { name: 'user.defaultAddress.phone', displayName: '預設收件人電話', type: 'string', example: '0912345678' },
              { name: 'user.defaultAddress.address', displayName: '預設地址', type: 'string', example: '台北市信義區信義路五段7號' },
              { name: 'user.defaultAddress.city', displayName: '預設城市', type: 'string', example: '台北市' },
              { name: 'user.defaultAddress.postalCode', displayName: '郵遞區號', type: 'string', example: '110' }
            ]
          }
        }
      },
      order: {
        name: '訂單變數',
        icon: 'shopping-cart',
        subcategories: {
          basic: {
            name: '基本資訊',
            variables: [
              { name: 'order.id', displayName: '訂單ID', type: 'string', example: 'ORD001' },
              { name: 'order.number', displayName: '訂單編號', type: 'string', example: '2024011500001' },
              { name: 'order.status', displayName: '訂單狀態', type: 'string', example: 'PAID' },
              { name: 'order.statusName', displayName: '訂單狀態名稱', type: 'string', example: '已付款' },
              { name: 'order.date', displayName: '訂單建立時間', type: 'date', example: '2024-01-15 10:30:00' },
              { name: 'order.paymentDate', displayName: '付款時間', type: 'date', example: '2024-01-15 10:35:00' },
              { name: 'order.shippingDate', displayName: '出貨時間', type: 'date', example: '2024-01-16 14:00:00' },
              { name: 'order.deliveryDate', displayName: '到貨時間', type: 'date', example: '2024-01-18 16:30:00' }
            ]
          },
          amount: {
            name: '金額資訊',
            variables: [
              { name: 'order.subtotal', displayName: '商品小計', type: 'number', example: '$2,580' },
              { name: 'order.shippingFee', displayName: '運費', type: 'number', example: '$100' },
              { name: 'order.discount', displayName: '折扣金額', type: 'number', example: '$258' },
              { name: 'order.tax', displayName: '稅額', type: 'number', example: '$131' },
              { name: 'order.total', displayName: '訂單總金額', type: 'number', example: '$2,553' },
              { name: 'order.paidAmount', displayName: '已付金額', type: 'number', example: '$2,553' },
              { name: 'order.remainingAmount', displayName: '待付金額', type: 'number', example: '$0' }
            ]
          },
          items: {
            name: '商品資訊',
            variables: [
              { name: 'order.itemCount', displayName: '商品總數量', type: 'number', example: '3' },
              { name: 'order.items', displayName: '商品清單', type: 'array', example: '[{商品1}, {商品2}]' },
              { name: 'order.items[].name', displayName: '商品名稱', type: 'string', example: '保濕精華液' },
              { name: 'order.items[].price', displayName: '商品價格', type: 'number', example: '$860' },
              { name: 'order.items[].quantity', displayName: '商品數量', type: 'number', example: '2' },
              { name: 'order.items[].subtotal', displayName: '商品小計', type: 'number', example: '$1,720' },
              { name: 'order.items[].image', displayName: '商品圖片', type: 'string', example: 'https://...' }
            ]
          },
          recipient: {
            name: '收件資訊',
            variables: [
              { name: 'order.recipient.name', displayName: '收件人姓名', type: 'string', example: '王小明' },
              { name: 'order.recipient.phone', displayName: '收件人電話', type: 'string', example: '0912345678' },
              { name: 'order.recipient.email', displayName: '收件人郵箱', type: 'string', example: 'user@example.com' },
              { name: 'order.recipient.address', displayName: '收件地址', type: 'string', example: '台北市信義區信義路五段7號' },
              { name: 'order.recipient.notes', displayName: '配送備註', type: 'string', example: '請放管理室' }
            ]
          }
        }
      },
      // ... 其他分類類似結構
    }
  }

  // 變數搜索功能
  searchVariables(keyword: string): TemplateVariable[] {
    const allVariables = this.flattenVariableTree(this.getVariableCategories())
    return allVariables.filter(variable => 
      variable.name.toLowerCase().includes(keyword.toLowerCase()) ||
      variable.displayName.includes(keyword) ||
      variable.example?.toString().includes(keyword)
    )
  }

  // 變數驗證
  validateVariable(variableName: string): boolean {
    const allVariables = this.flattenVariableTree(this.getVariableCategories())
    return allVariables.some(variable => variable.name === variableName)
  }
}
```

### 4. 觸發機制系統

#### 4.1 觸發器定義
```typescript
interface NotificationTrigger {
  id: string
  name: string
  eventType: TriggerEventType
  conditions: TriggerCondition[]
  delay?: TriggerDelay
  frequency?: TriggerFrequency
  isActive: boolean
}

enum TriggerEventType {
  // 訂單事件
  ORDER_CREATED = 'order_created',
  ORDER_PAID = 'order_paid',
  ORDER_SHIPPED = 'order_shipped',
  ORDER_DELIVERED = 'order_delivered',
  ORDER_CANCELLED = 'order_cancelled',
  ORDER_REFUNDED = 'order_refunded',
  
  // 用戶事件
  USER_REGISTERED = 'user_registered',
  USER_EMAIL_VERIFIED = 'user_email_verified',
  USER_BIRTHDAY = 'user_birthday',
  USER_LEVEL_UPGRADED = 'user_level_upgraded',
  USER_POINTS_EARNED = 'user_points_earned',
  USER_POINTS_EXPIRED = 'user_points_expired',
  USER_INACTIVE = 'user_inactive',
  
  // 商品事件
  PRODUCT_LOW_STOCK = 'product_low_stock',
  PRODUCT_OUT_OF_STOCK = 'product_out_of_stock',
  PRODUCT_BACK_IN_STOCK = 'product_back_in_stock',
  PRODUCT_PRICE_CHANGED = 'product_price_changed',
  PRODUCT_NEW_LAUNCH = 'product_new_launch',
  
  // 活動事件
  CAMPAIGN_STARTED = 'campaign_started',
  CAMPAIGN_ENDING_SOON = 'campaign_ending_soon',
  CAMPAIGN_ENDED = 'campaign_ended',
  COUPON_ISSUED = 'coupon_issued',
  COUPON_ABOUT_TO_EXPIRE = 'coupon_about_to_expire',
  
  // 系統事件
  SYSTEM_MAINTENANCE = 'system_maintenance',
  PAYMENT_FAILED = 'payment_failed',
  SHIPPING_DELAYED = 'shipping_delayed',
  
  // 定時事件
  SCHEDULED_DAILY = 'scheduled_daily',
  SCHEDULED_WEEKLY = 'scheduled_weekly',
  SCHEDULED_MONTHLY = 'scheduled_monthly'
}

interface TriggerCondition {
  field: string                       // 條件欄位
  operator: ConditionOperator         // 條件運算符
  value: any                          // 條件值
  logicalOperator?: 'AND' | 'OR'      // 邏輯運算符
}

enum ConditionOperator {
  EQUALS = '==',
  NOT_EQUALS = '!=',
  GREATER_THAN = '>',
  GREATER_THAN_EQUAL = '>=',
  LESS_THAN = '<',
  LESS_THAN_EQUAL = '<=',
  CONTAINS = 'contains',
  NOT_CONTAINS = 'not_contains',
  IN = 'in',
  NOT_IN = 'not_in',
  IS_NULL = 'is_null',
  IS_NOT_NULL = 'is_not_null'
}
```

#### 4.2 事件監聽與觸發
```typescript
class NotificationTriggerService {
  // 註冊事件監聽器
  registerEventListeners(): void {
    // 訂單事件監聽
    this.eventBus.on('order.created', async (event) => {
      await this.handleTrigger(TriggerEventType.ORDER_CREATED, event.data)
    })
    
    this.eventBus.on('order.paid', async (event) => {
      await this.handleTrigger(TriggerEventType.ORDER_PAID, event.data)
    })
    
    // 用戶事件監聽
    this.eventBus.on('user.registered', async (event) => {
      await this.handleTrigger(TriggerEventType.USER_REGISTERED, event.data)
    })
    
    this.eventBus.on('user.birthday', async (event) => {
      await this.handleTrigger(TriggerEventType.USER_BIRTHDAY, event.data)
    })
    
    // 商品事件監聽
    this.eventBus.on('product.stock_low', async (event) => {
      await this.handleTrigger(TriggerEventType.PRODUCT_LOW_STOCK, event.data)
    })
    
    // ... 其他事件監聽器
  }

  // 處理觸發器
  async handleTrigger(eventType: TriggerEventType, eventData: any): Promise<void> {
    const templates = await this.templateRepository.findByTriggerEvent(eventType)
    
    for (const template of templates) {
      if (!template.isActive) continue
      
      try {
        // 檢查觸發條件
        const conditionsMet = await this.evaluateConditions(template.trigger.conditions, eventData)
        if (!conditionsMet) continue
        
        // 處理延遲發送
        if (template.trigger.delay) {
          await this.scheduleDelayedNotification(template, eventData)
        } else {
          await this.sendNotification(template, eventData)
        }
        
      } catch (error) {
        await this.logTriggerError(template.id, eventType, error)
      }
    }
  }

  // 評估觸發條件
  async evaluateConditions(conditions: TriggerCondition[], eventData: any): Promise<boolean> {
    if (!conditions || conditions.length === 0) return true
    
    let result = true
    let currentLogicalOperator: 'AND' | 'OR' = 'AND'
    
    for (const condition of conditions) {
      const conditionResult = this.evaluateSingleCondition(condition, eventData)
      
      if (currentLogicalOperator === 'AND') {
        result = result && conditionResult
      } else {
        result = result || conditionResult
      }
      
      if (condition.logicalOperator) {
        currentLogicalOperator = condition.logicalOperator
      }
    }
    
    return result
  }

  // 評估單一條件
  private evaluateSingleCondition(condition: TriggerCondition, eventData: any): boolean {
    const fieldValue = this.getNestedValue(eventData, condition.field)
    
    switch (condition.operator) {
      case ConditionOperator.EQUALS:
        return fieldValue == condition.value
      case ConditionOperator.NOT_EQUALS:
        return fieldValue != condition.value
      case ConditionOperator.GREATER_THAN:
        return Number(fieldValue) > Number(condition.value)
      case ConditionOperator.GREATER_THAN_EQUAL:
        return Number(fieldValue) >= Number(condition.value)
      case ConditionOperator.LESS_THAN:
        return Number(fieldValue) < Number(condition.value)
      case ConditionOperator.LESS_THAN_EQUAL:
        return Number(fieldValue) <= Number(condition.value)
      case ConditionOperator.CONTAINS:
        return String(fieldValue).includes(String(condition.value))
      case ConditionOperator.NOT_CONTAINS:
        return !String(fieldValue).includes(String(condition.value))
      case ConditionOperator.IN:
        return Array.isArray(condition.value) && condition.value.includes(fieldValue)
      case ConditionOperator.NOT_IN:
        return Array.isArray(condition.value) && !condition.value.includes(fieldValue)
      case ConditionOperator.IS_NULL:
        return fieldValue == null || fieldValue == undefined
      case ConditionOperator.IS_NOT_NULL:
        return fieldValue != null && fieldValue != undefined
      default:
        return false
    }
  }
}
```

### 5. 通知歷史管理

#### 5.1 歷史記錄結構
```typescript
interface NotificationHistory {
  id: string
  templateId: string
  templateName: string
  recipientId: string
  recipientType: 'user' | 'admin' | 'system'
  recipientIdentifier: string      // email, phone, userId等
  channel: NotificationChannel
  triggerEvent: TriggerEventType
  eventData: any                   // 觸發事件的資料
  renderedContent: RenderedContent // 實際發送的內容
  status: NotificationStatus
  statusHistory: StatusHistoryEntry[]
  sentAt?: Date
  deliveredAt?: Date
  readAt?: Date
  clickedAt?: Date
  error?: string
  retryCount: number
  metadata: NotificationMetadata
  createdAt: Date
  updatedAt: Date
}

interface RenderedContent {
  subject?: string
  textContent?: string
  htmlContent?: string
  flexContent?: any
  variables: Record<string, any>    // 實際替換的變數值
}

enum NotificationStatus {
  PENDING = 'pending',              // 待發送
  SENDING = 'sending',              // 發送中
  SENT = 'sent',                    // 已發送
  DELIVERED = 'delivered',          // 已送達
  READ = 'read',                    // 已讀取
  CLICKED = 'clicked',              // 已點擊
  FAILED = 'failed',                // 發送失敗
  CANCELLED = 'cancelled'           // 已取消
}

interface StatusHistoryEntry {
  status: NotificationStatus
  timestamp: Date
  details?: string
  metadata?: any
}

interface NotificationMetadata {
  priority: NotificationPriority
  tags: string[]
  campaignId?: string
  batchId?: string
  deviceInfo?: DeviceInfo
  locationInfo?: LocationInfo
  userAgent?: string
}
```

#### 5.2 歷史查詢與分析
```typescript
class NotificationHistoryService {
  // 歷史記錄查詢
  async getNotificationHistory(query: HistoryQuery): Promise<PaginatedResult<NotificationHistory>> {
    const queryBuilder = this.historyRepository.createQueryBuilder()
    
    // 時間範圍篩選
    if (query.startDate) {
      queryBuilder.where('createdAt >= :startDate', { startDate: query.startDate })
    }
    if (query.endDate) {
      queryBuilder.andWhere('createdAt <= :endDate', { endDate: query.endDate })
    }
    
    // 渠道篩選
    if (query.channels?.length) {
      queryBuilder.andWhere('channel IN (:...channels)', { channels: query.channels })
    }
    
    // 狀態篩選
    if (query.statuses?.length) {
      queryBuilder.andWhere('status IN (:...statuses)', { statuses: query.statuses })
    }
    
    // 範本篩選
    if (query.templateIds?.length) {
      queryBuilder.andWhere('templateId IN (:...templateIds)', { templateIds: query.templateIds })
    }
    
    // 接收者篩選
    if (query.recipientType) {
      queryBuilder.andWhere('recipientType = :recipientType', { recipientType: query.recipientType })
    }
    
    if (query.recipientSearch) {
      queryBuilder.andWhere('recipientIdentifier LIKE :recipientSearch', { 
        recipientSearch: `%${query.recipientSearch}%` 
      })
    }
    
    // 內容搜索
    if (query.contentSearch) {
      queryBuilder.andWhere(`(
        JSON_EXTRACT(renderedContent, '$.textContent') LIKE :contentSearch OR
        JSON_EXTRACT(renderedContent, '$.subject') LIKE :contentSearch
      )`, { contentSearch: `%${query.contentSearch}%` })
    }
    
    // 排序
    queryBuilder.orderBy('createdAt', query.sortOrder || 'DESC')
    
    // 分頁
    const total = await queryBuilder.getCount()
    const results = await queryBuilder
      .skip((query.page - 1) * query.limit)
      .take(query.limit)
      .getMany()
    
    return {
      data: results,
      total,
      page: query.page,
      limit: query.limit,
      totalPages: Math.ceil(total / query.limit)
    }
  }

  // 發送統計分析
  async getNotificationStatistics(period: StatisticsPeriod): Promise<NotificationStatistics> {
    const dateRange = this.getDateRange(period)
    
    const stats = await this.historyRepository
      .createQueryBuilder('nh')
      .select([
        'COUNT(*) as totalSent',
        'COUNT(CASE WHEN status = "delivered" THEN 1 END) as delivered',
        'COUNT(CASE WHEN status = "read" THEN 1 END) as opened',
        'COUNT(CASE WHEN status = "clicked" THEN 1 END) as clicked',
        'COUNT(CASE WHEN status = "failed" THEN 1 END) as failed',
        'channel',
        'DATE(createdAt) as date'
      ])
      .where('createdAt BETWEEN :startDate AND :endDate', dateRange)
      .groupBy('channel, DATE(createdAt)')
      .getRawMany()
    
    return this.processStatistics(stats)
  }

  // 效果分析
  async getEngagementAnalytics(templateId?: string): Promise<EngagementAnalytics> {
    let queryBuilder = this.historyRepository
      .createQueryBuilder('nh')
      .select([
        'channel',
        'COUNT(*) as totalSent',
        'COUNT(CASE WHEN status IN ("delivered", "read", "clicked") THEN 1 END) as deliveryRate',
        'COUNT(CASE WHEN status = "read" THEN 1 END) as openRate',
        'COUNT(CASE WHEN status = "clicked" THEN 1 END) as clickRate',
        'AVG(TIMESTAMPDIFF(MINUTE, sentAt, readAt)) as avgOpenTime',
        'AVG(TIMESTAMPDIFF(MINUTE, readAt, clickedAt)) as avgClickTime'
      ])
    
    if (templateId) {
      queryBuilder.where('templateId = :templateId', { templateId })
    }
    
    const results = await queryBuilder
      .groupBy('channel')
      .getRawMany()
    
    return this.calculateEngagementMetrics(results)
  }
}

interface HistoryQuery {
  startDate?: Date
  endDate?: Date
  channels?: NotificationChannel[]
  statuses?: NotificationStatus[]
  templateIds?: string[]
  recipientType?: string
  recipientSearch?: string
  contentSearch?: string
  page: number
  limit: number
  sortOrder?: 'ASC' | 'DESC'
}
```

### 6. 後台管理介面

#### 6.1 通知管理控制台
```typescript
interface NotificationManagementUI {
  // 通知總覽頁面
  notificationOverview: {
    components: [
      'NotificationStatsCards',
      'ChannelPerformanceChart',
      'RecentNotifications',
      'ActiveTemplates',
      'TriggerStatusPanel'
    ]
  }
  
  // 範本管理頁面
  templateManagement: {
    components: [
      'TemplateLibrary',
      'TemplateEditor',
      'VariablePicker',
      'ChannelPreview',
      'TestSender'
    ]
    features: [
      'drag_drop_editor',
      'real_time_preview',
      'variable_autocomplete',
      'template_versioning',
      'a_b_testing'
    ]
  }
  
  // 變數管理頁面
  variableManagement: {
    layout: 'nested_tree',
    components: [
      'VariableCategoryTree',
      'VariableSearch',
      'VariableDetails',
      'UsageAnalytics'
    ]
    features: [
      'category_expansion',
      'search_highlighting',
      'usage_tracking',
      'documentation'
    ]
  }
  
  // 觸發器管理頁面
  triggerManagement: {
    components: [
      'TriggerList',
      'TriggerEditor',
      'ConditionBuilder',
      'EventSimulator',
      'TriggerLogs'
    ]
  }
  
  // 通知歷史頁面
  notificationHistory: {
    components: [
      'HistoryDataTable',
      'AdvancedFilters',
      'StatisticsCharts',
      'BulkActions',
      'ExportTools',
      'DetailModal'
    ]
    features: [
      'real_time_updates',
      'multi_column_sorting',
      'custom_date_ranges',
      'content_preview',
      'retry_mechanism'
    ]
  }
  
  // 渠道設定頁面
  channelConfiguration: {
    components: [
      'ChannelStatusCards',
      'ConfigurationForms',
      'TestingPanels',
      'UsageMetrics',
      'TroubleshootingGuides'
    ]
  }
  
  // 效果分析頁面
  analyticsAndReports: {
    components: [
      'PerformanceMetrics',
      'EngagementCharts',
      'ConversionFunnels',
      'ChannelComparison',
      'TemplatePerformance',
      'CustomReports'
    ]
  }
}
```

#### 6.2 範本編輯器功能
```typescript
class NotificationTemplateEditor {
  // 變數選擇器
  renderVariablePicker(): JSX.Element {
    return (
      <div className="variable-picker">
        <div className="search-box">
          <input 
            type="text" 
            placeholder="搜索變數..."
            onChange={this.handleVariableSearch}
          />
        </div>
        
        <div className="variable-categories">
          {Object.entries(this.getVariableCategories()).map(([key, category]) => (
            <div key={key} className="category-group">
              <div className="category-header" onClick={() => this.toggleCategory(key)}>
                <Icon name={category.icon} />
                <span>{category.name}</span>
                <Icon name={this.state.expandedCategories[key] ? 'chevron-down' : 'chevron-right'} />
              </div>
              
              {this.state.expandedCategories[key] && (
                <div className="subcategories">
                  {Object.entries(category.subcategories).map(([subKey, subcategory]) => (
                    <div key={subKey} className="subcategory">
                      <div className="subcategory-header" onClick={() => this.toggleSubcategory(key, subKey)}>
                        <span>{subcategory.name}</span>
                      </div>
                      
                      {this.state.expandedSubcategories[`${key}.${subKey}`] && (
                        <div className="variables">
                          {subcategory.variables.map(variable => (
                            <div 
                              key={variable.name}
                              className="variable-item"
                              onClick={() => this.insertVariable(variable.name)}
                            >
                              <div className="variable-name">{{{{variable.name}}}}</div>
                              <div className="variable-display">{variable.displayName}</div>
                              <div className="variable-example">範例: {variable.example}</div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          ))}
        </div>
      </div>
    )
  }

  // 即時預覽功能
  renderPreview(template: NotificationTemplate, sampleData: any): JSX.Element {
    const renderedContent = this.renderTemplate(template, sampleData)
    
    return (
      <div className="template-preview">
        <div className="preview-tabs">
          {template.channels.map(channel => (
            <button
              key={channel.channel}
              className={`tab ${this.state.activePreviewTab === channel.channel ? 'active' : ''}`}
              onClick={() => this.setActivePreviewTab(channel.channel)}
            >
              {this.getChannelDisplayName(channel.channel)}
            </button>
          ))}
        </div>
        
        <div className="preview-content">
          {this.renderChannelPreview(this.state.activePreviewTab, renderedContent)}
        </div>
        
        <div className="preview-actions">
          <button onClick={() => this.sendTestNotification()}>
            發送測試
          </button>
          <button onClick={() => this.validateTemplate()}>
            驗證範本
          </button>
        </div>
      </div>
    )
  }
  
  // 範本渲染引擎
  renderTemplate(template: NotificationTemplate, data: any): RenderedContent {
    const variables = this.resolveAllVariables(data)
    
    return template.channels.reduce((acc, channel) => {
      acc[channel.channel] = {
        subject: this.replaceVariables(channel.subject || '', variables),
        content: this.replaceVariables(channel.content, variables),
        htmlContent: channel.htmlContent ? this.replaceVariables(channel.htmlContent, variables) : undefined,
        flexContent: channel.flexContent ? this.replaceVariablesInObject(channel.flexContent, variables) : undefined
      }
      return acc
    }, {} as any)
  }
  
  // 變數替換
  private replaceVariables(content: string, variables: Record<string, any>): string {
    return content.replace(/\{\{([^}]+)\}\}/g, (match, variableName) => {
      const trimmedName = variableName.trim()
      if (variables.hasOwnProperty(trimmedName)) {
        return String(variables[trimmedName])
      }
      return match // 保持原樣如果變數不存在
    })
  }
}
```

### 7. API 介面規格

#### 7.1 後台API
```typescript
// 範本管理
GET /admin/api/notification/templates
POST /admin/api/notification/templates
GET /admin/api/notification/templates/:id
PUT /admin/api/notification/templates/:id
DELETE /admin/api/notification/templates/:id

// 變數管理
GET /admin/api/notification/variables
GET /admin/api/notification/variables/categories
GET /admin/api/notification/variables/search?q={keyword}

// 觸發器管理
GET /admin/api/notification/triggers
POST /admin/api/notification/triggers
PUT /admin/api/notification/triggers/:id
DELETE /admin/api/notification/triggers/:id

// 渠道設定
GET /admin/api/notification/channels
PUT /admin/api/notification/channels/:channel/config
POST /admin/api/notification/channels/:channel/test

// 通知歷史
GET /admin/api/notification/history
GET /admin/api/notification/history/:id
POST /admin/api/notification/history/export
POST /admin/api/notification/history/:id/retry

// 統計分析
GET /admin/api/notification/statistics
GET /admin/api/notification/analytics/engagement
GET /admin/api/notification/analytics/performance
```

### 8. 資料庫設計

#### 8.1 核心資料表
```sql
-- 通知範本表
CREATE TABLE notification_templates (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  category ENUM('order', 'user', 'marketing', 'system', 'product', 'logistics'),
  subcategory VARCHAR(100),
  trigger_event VARCHAR(100) NOT NULL,
  trigger_conditions JSON,
  channels JSON NOT NULL,
  variables JSON,
  priority ENUM('low', 'normal', 'high', 'urgent') DEFAULT 'normal',
  is_active BOOLEAN DEFAULT TRUE,
  version INT DEFAULT 1,
  tags JSON,
  created_by VARCHAR(36),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_templates_category (category),
  INDEX idx_templates_trigger (trigger_event),
  INDEX idx_templates_active (is_active)
);

-- 通知歷史表
CREATE TABLE notification_history (
  id VARCHAR(36) PRIMARY KEY,
  template_id VARCHAR(36),
  template_name VARCHAR(255),
  recipient_id VARCHAR(36),
  recipient_type ENUM('user', 'admin', 'system'),
  recipient_identifier VARCHAR(255),
  channel ENUM('email_text', 'email_html', 'sms', 'line_text', 'line_flex', 'push_app', 'push_web'),
  trigger_event VARCHAR(100),
  event_data JSON,
  rendered_content JSON,
  status ENUM('pending', 'sending', 'sent', 'delivered', 'read', 'clicked', 'failed', 'cancelled'),
  status_history JSON,
  sent_at TIMESTAMP NULL,
  delivered_at TIMESTAMP NULL,
  read_at TIMESTAMP NULL,
  clicked_at TIMESTAMP NULL,
  error TEXT,
  retry_count INT DEFAULT 0,
  metadata JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (template_id) REFERENCES notification_templates(id),
  INDEX idx_history_recipient (recipient_id),
  INDEX idx_history_channel (channel),
  INDEX idx_history_status (status),
  INDEX idx_history_created (created_at),
  INDEX idx_history_template (template_id)
);

-- 渠道配置表
CREATE TABLE notification_channel_configs (
  id VARCHAR(36) PRIMARY KEY,
  channel ENUM('email_text', 'email_html', 'sms', 'line_text', 'line_flex', 'push_app', 'push_web') UNIQUE,
  is_enabled BOOLEAN DEFAULT FALSE,
  config JSON NOT NULL,
  test_recipients JSON,
  last_test_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX idx_channel_configs_enabled (is_enabled)
);

-- 通知變數表（用於記錄變數使用統計）
CREATE TABLE notification_variables (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) UNIQUE NOT NULL,
  display_name VARCHAR(255),
  category VARCHAR(100),
  subcategory VARCHAR(100),
  data_type ENUM('string', 'number', 'date', 'boolean', 'array', 'object'),
  is_required BOOLEAN DEFAULT FALSE,
  default_value TEXT,
  description TEXT,
  example TEXT,
  usage_count INT DEFAULT 0,
  last_used_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_variables_category (category, subcategory),
  INDEX idx_variables_usage (usage_count)
);
```

## 整合規格

### 與訂單管理整合
- 訂單狀態變更自動觸發通知
- 訂單相關變數的即時資料取得
- 付款、出貨、到貨等事件通知

### 與用戶管理整合
- 用戶註冊、生日等事件通知
- 會員等級變更通知
- 個人化通知偏好設定

### 與行銷活動整合
- 活動開始、結束通知
- 個人化優惠推送
- 節慶活動提醒

### 與物流管理整合
- 物流狀態更新通知
- 配送異常提醒
- 取貨提醒通知

### 與會員系統整合
- 點數變動通知
- 等級升級通知
- 專屬活動推送

## 效能考量

### 快取策略
- 範本內容快取 (TTL: 1小時)
- 變數資料快取 (TTL: 30分鐘)
- 渠道配置快取 (TTL: 4小時)

### 效能目標
- 通知發送延遲 < 30秒
- 範本渲染時間 < 100ms
- 歷史查詢響應時間 < 500ms
- 批量通知處理能力 > 10000條/分鐘

### 可靠性設計
- 通知發送重試機制
- 渠道故障自動切換
- 通知佇列持久化
- 系統負載平衡

---

本模組確保通知管理的完整性和可靠性，提供真實可用的變數系統、靈活的觸發機制，以及完整的歷史追蹤功能，支援多渠道通知和巢狀分類變數管理。