# MickeyShop Beauty 後台管理系統架構設計

## 架構概覽

### 部署架構
- **獨立部署模式**：每個客戶都有獨立的 Cloudflare 環境
- **天然租戶隔離**：無需複雜的多租戶系統設計
- **單一品牌管理**：專注於單一電商品牌的後台管理需求

### 技術棧

| 技術領域 | 選用技術 | 版本 | 說明 |
|---------|---------|------|------|
| **前端框架** | React | ^18.0.0 | 與前台保持一致 |
| **構建工具** | Vite | ^5.0.0 | 與前台保持一致 |
| **路由管理** | React Router | ^6.0.0 | SPA 路由管理 |
| **UI組件庫** | Ant Design | ^5.0.0 | 專業的管理界面組件 |
| **狀態管理** | Zustand + React Query | latest | 與前台保持一致 |
| **動畫庫** | GSAP | ^3.0.0 | 提升用戶體驗 |
| **國際化** | react-i18next | ^13.0.0 | 支援多語言 |
| **圖表庫** | Apache ECharts | ^5.0.0 | 數據可視化 |

### Cloudflare 整合

#### Cloudflare Pages (前端部署)
- **構建命令**: `npm run build`
- **輸出目錄**: `dist`
- **環境變量**: 
  - `VITE_API_BASE_URL`: API 服務基礎 URL
  - `VITE_APP_ENV`: 環境標識 (development/staging/production)

#### Cloudflare Workers (API 服務)
- **路由結構**: `/api/*` 路徑處理所有 API 請求
- **認證機制**: JWT + Role-based access control
- **檔案上傳**: Cloudflare R2 儲存

#### Cloudflare D1 (資料庫)
- **主資料庫**: 業務數據儲存
- **備份策略**: 每日自動備份
- **資料遷移**: 版本化 SQL 遷移腳本

#### Cloudflare KV (快取儲存)
- **應用場景**: 
  - API 響應快取
  - 使用者 Session 儲存
  - 系統配置快取
  - 檔案上傳臨時儲存

## 系統架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                    Cloudflare Edge Network                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │  Cloudflare     │    │  Cloudflare     │                │
│  │  Pages          │    │  Workers        │                │
│  │  (Admin UI)     │    │  (API Service)  │                │
│  │                 │    │                 │                │
│  │  React App      │◄───►│  REST API      │                │
│  │  Ant Design     │    │  JWT Auth       │                │
│  │  GSAP           │    │  File Upload    │                │
│  └─────────────────┘    └─────────────────┘                │
│                                   │                         │
│                          ┌────────▼────────┐                │
│                          │  Cloudflare D1  │                │
│                          │  (Database)     │                │
│                          │                 │                │
│                          │  Business Data  │                │
│                          │  User Data      │                │
│                          │  System Config  │                │
│                          └─────────────────┘                │
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │  Cloudflare KV  │    │  Cloudflare R2  │                │
│  │  (Cache)        │    │  (File Storage) │                │
│  │                 │    │                 │                │
│  │  Session Cache  │    │  Product Images │                │
│  │  API Cache      │    │  Brand Assets   │                │
│  │  Config Cache   │    │  Export Files   │                │
│  └─────────────────┘    └─────────────────┘                │
└─────────────────────────────────────────────────────────────┘
```

## 權限系統設計

### 角色定義

| 角色 | 權限範圍 | 說明 |
|-----|---------|------|
| **超級管理員** | 全系統 | 系統設定、用戶管理、所有業務功能 |
| **管理員** | 業務管理 | 商品、訂單、庫存、客戶管理，無系統設定權限 |
| **客服人員** | 客戶服務 | 訂單查詢、客戶管理、退換貨處理 |
| **倉庫人員** | 庫存物流 | 庫存管理、訂單出貨、退換貨處理 |
| **內容編輯** | 內容管理 | 商品內容、品牌資訊、行銷活動管理 |

### 權限控制機制

#### JWT Token 結構
```json
{
  "sub": "user_id",
  "iat": 1609459200,
  "exp": 1609545600,
  "roles": ["admin"],
  "permissions": [
    "product:read",
    "product:write",
    "order:read",
    "order:update",
    "inventory:read",
    "inventory:write"
  ],
  "brand": "mickey-beauty",
  "session": "session_id"
}
```

#### 前端路由守衛
```javascript
// utils/routeGuard.js
export const requirePermissions = (permissions) => {
  return (WrappedComponent) => {
    return (props) => {
      const { user } = useAuth()
      
      const hasPermission = permissions.every(permission => 
        user?.permissions?.includes(permission)
      )
      
      if (!hasPermission) {
        return <Redirect to="/403" />
      }
      
      return <WrappedComponent {...props} />
    }
  }
}

// 使用範例
const ProductManagement = requirePermissions([
  'product:read', 
  'product:write'
])(ProductManagementComponent)
```

#### 後端權限驗證
```javascript
// workers/middleware/auth.js
export const requirePermission = (permission) => {
  return async (request, response, next) => {
    const token = getTokenFromRequest(request)
    const decoded = await verifyJWT(token)
    
    if (!decoded.permissions.includes(permission)) {
      return response.status(403).json({
        error: 'Insufficient permissions'
      })
    }
    
    request.user = decoded
    next()
  }
}
```

## 資料庫設計

### 核心數據表結構

#### 管理員用戶表 (admins)
```sql
CREATE TABLE admins (
  id INTEGER PRIMARY KEY,
  username TEXT UNIQUE NOT NULL,
  email TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  name TEXT NOT NULL,
  avatar TEXT,
  role TEXT NOT NULL DEFAULT 'admin',
  permissions TEXT NOT NULL DEFAULT '[]', -- JSON array
  is_active BOOLEAN DEFAULT TRUE,
  last_login_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 商品管理表 (products)
```sql
CREATE TABLE products (
  id INTEGER PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  brand TEXT NOT NULL,
  category TEXT NOT NULL,
  subcategory TEXT,
  price DECIMAL(10,2) NOT NULL,
  compare_price DECIMAL(10,2),
  cost_price DECIMAL(10,2),
  sku TEXT UNIQUE NOT NULL,
  barcode TEXT,
  images TEXT NOT NULL DEFAULT '[]', -- JSON array
  variants TEXT DEFAULT '[]', -- JSON array
  attributes TEXT DEFAULT '{}', -- JSON object
  seo_title TEXT,
  seo_description TEXT,
  seo_keywords TEXT,
  status TEXT DEFAULT 'draft', -- draft, active, inactive
  featured BOOLEAN DEFAULT FALSE,
  weight DECIMAL(8,2),
  dimensions TEXT, -- JSON object {length, width, height}
  shipping_class TEXT DEFAULT 'standard',
  tags TEXT DEFAULT '[]', -- JSON array
  created_by INTEGER,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (created_by) REFERENCES admins(id)
);
```

#### 庫存管理表 (inventory)
```sql
CREATE TABLE inventory (
  id INTEGER PRIMARY KEY,
  product_id INTEGER NOT NULL,
  variant_id TEXT, -- 變體ID，NULL表示主商品
  sku TEXT NOT NULL,
  quantity INTEGER NOT NULL DEFAULT 0,
  reserved_quantity INTEGER NOT NULL DEFAULT 0, -- 購物車預留數量
  available_quantity INTEGER GENERATED ALWAYS AS (quantity - reserved_quantity) STORED,
  low_stock_threshold INTEGER DEFAULT 10,
  reorder_point INTEGER DEFAULT 5,
  reorder_quantity INTEGER DEFAULT 20,
  location TEXT, -- 儲位
  cost DECIMAL(10,2),
  last_received_at DATETIME,
  last_sold_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
  UNIQUE(product_id, variant_id)
);
```

#### 訂單管理表 (orders)
```sql
CREATE TABLE orders (
  id INTEGER PRIMARY KEY,
  order_number TEXT UNIQUE NOT NULL,
  customer_id INTEGER,
  customer_email TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'created', -- created, paid, preparing, shipped, delivered, completed, cancelled
  payment_status TEXT DEFAULT 'pending', -- pending, paid, failed, refunded
  payment_method TEXT,
  payment_reference TEXT,
  subtotal DECIMAL(10,2) NOT NULL,
  shipping_cost DECIMAL(10,2) DEFAULT 0,
  tax_amount DECIMAL(10,2) DEFAULT 0,
  discount_amount DECIMAL(10,2) DEFAULT 0,
  total DECIMAL(10,2) NOT NULL,
  currency TEXT DEFAULT 'TWD',
  
  -- 收件資訊
  shipping_name TEXT NOT NULL,
  shipping_phone TEXT NOT NULL,
  shipping_address TEXT NOT NULL, -- JSON object
  
  -- 訂單時間戳
  paid_at DATETIME,
  preparing_at DATETIME,
  shipped_at DATETIME,
  delivered_at DATETIME,
  completed_at DATETIME,
  cancelled_at DATETIME,
  
  -- 物流資訊
  tracking_number TEXT,
  shipping_carrier TEXT,
  
  -- 備註
  customer_notes TEXT,
  admin_notes TEXT,
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (customer_id) REFERENCES customers(id)
);
```

#### 訂單商品明細表 (order_items)
```sql
CREATE TABLE order_items (
  id INTEGER PRIMARY KEY,
  order_id INTEGER NOT NULL,
  product_id INTEGER NOT NULL,
  variant_id TEXT,
  product_name TEXT NOT NULL,
  product_sku TEXT NOT NULL,
  variant_name TEXT,
  quantity INTEGER NOT NULL,
  unit_price DECIMAL(10,2) NOT NULL,
  total_price DECIMAL(10,2) NOT NULL,
  product_data TEXT, -- JSON snapshot of product at order time
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
  FOREIGN KEY (product_id) REFERENCES products(id)
);
```

#### 客戶管理表 (customers)
```sql
CREATE TABLE customers (
  id INTEGER PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  phone TEXT,
  name TEXT,
  birthday DATE,
  gender TEXT,
  registration_source TEXT, -- web, mobile, social
  status TEXT DEFAULT 'active', -- active, inactive, blocked
  email_verified BOOLEAN DEFAULT FALSE,
  phone_verified BOOLEAN DEFAULT FALSE,
  marketing_consent BOOLEAN DEFAULT FALSE,
  
  -- 統計數據
  total_orders INTEGER DEFAULT 0,
  total_spent DECIMAL(10,2) DEFAULT 0,
  average_order_value DECIMAL(10,2) DEFAULT 0,
  last_order_at DATETIME,
  
  -- 地址資訊
  default_address_id INTEGER,
  
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 客戶地址表 (customer_addresses)
```sql
CREATE TABLE customer_addresses (
  id INTEGER PRIMARY KEY,
  customer_id INTEGER NOT NULL,
  name TEXT NOT NULL,
  phone TEXT NOT NULL,
  city TEXT NOT NULL,
  district TEXT NOT NULL,
  zip_code TEXT NOT NULL,
  street_address TEXT NOT NULL,
  address_type TEXT DEFAULT 'shipping', -- shipping, billing
  is_default BOOLEAN DEFAULT FALSE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE
);
```

#### 系統配置表 (system_config)
```sql
CREATE TABLE system_config (
  id INTEGER PRIMARY KEY,
  config_key TEXT UNIQUE NOT NULL,
  config_value TEXT NOT NULL,
  config_type TEXT DEFAULT 'string', -- string, number, boolean, json
  description TEXT,
  is_public BOOLEAN DEFAULT FALSE, -- 是否可在前台訪問
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 資料庫索引策略

```sql
-- 效能優化索引
CREATE INDEX idx_products_status ON products(status);
CREATE INDEX idx_products_category ON products(category);
CREATE INDEX idx_products_brand ON products(brand);
CREATE INDEX idx_products_featured ON products(featured);
CREATE INDEX idx_products_created_at ON products(created_at);

CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_customer_id ON orders(customer_id);
CREATE INDEX idx_orders_order_number ON orders(order_number);
CREATE INDEX idx_orders_created_at ON orders(created_at);

CREATE INDEX idx_inventory_product_id ON inventory(product_id);
CREATE INDEX idx_inventory_low_stock ON inventory(available_quantity) 
  WHERE available_quantity <= low_stock_threshold;

CREATE INDEX idx_customers_email ON customers(email);
CREATE INDEX idx_customers_phone ON customers(phone);
CREATE INDEX idx_customers_status ON customers(status);
```

## API 架構設計

### RESTful API 設計原則

#### 統一響應格式
```javascript
// 成功響應
{
  "success": true,
  "data": {...},
  "message": "操作成功",
  "pagination": { // 列表接口才有
    "page": 1,
    "limit": 20,
    "total": 100,
    "pages": 5
  }
}

// 錯誤響應
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "請求參數錯誤",
    "details": {
      "field": "email",
      "message": "郵箱格式不正確"
    }
  }
}
```

#### API 端點設計

**認證相關**
- `POST /api/auth/login` - 管理員登入
- `POST /api/auth/logout` - 登出
- `GET /api/auth/me` - 獲取當前用戶資訊
- `POST /api/auth/refresh` - 刷新 Token

**商品管理**
- `GET /api/products` - 商品列表（支援篩選、搜尋、分頁）
- `POST /api/products` - 新增商品
- `GET /api/products/:id` - 商品詳情
- `PUT /api/products/:id` - 更新商品
- `DELETE /api/products/:id` - 刪除商品
- `POST /api/products/:id/images` - 上傳商品圖片
- `DELETE /api/products/:id/images/:imageId` - 刪除商品圖片

**訂單管理**
- `GET /api/orders` - 訂單列表
- `GET /api/orders/:id` - 訂單詳情
- `PUT /api/orders/:id/status` - 更新訂單狀態
- `POST /api/orders/:id/tracking` - 更新物流資訊
- `GET /api/orders/stats` - 訂單統計數據

**庫存管理**
- `GET /api/inventory` - 庫存列表
- `PUT /api/inventory/:id` - 更新庫存數量
- `POST /api/inventory/adjust` - 庫存調整
- `GET /api/inventory/low-stock` - 低庫存商品
- `GET /api/inventory/reports` - 庫存報表

**客戶管理**
- `GET /api/customers` - 客戶列表
- `GET /api/customers/:id` - 客戶詳情
- `PUT /api/customers/:id` - 更新客戶資訊
- `GET /api/customers/:id/orders` - 客戶訂單歷史

**系統設定**
- `GET /api/config` - 獲取系統配置
- `PUT /api/config` - 更新系統配置
- `POST /api/config/backup` - 建立備份
- `GET /api/config/backup` - 備份列表

## 前端架構設計

### 目錄結構
```
admin/
├── src/
│   ├── components/          # 通用組件
│   │   ├── Layout/         # 佈局組件
│   │   ├── Charts/         # 圖表組件
│   │   ├── Upload/         # 檔案上傳組件
│   │   └── Form/           # 表單組件
│   ├── pages/              # 頁面組件
│   │   ├── Dashboard/      # 儀表板
│   │   ├── Products/       # 商品管理
│   │   ├── Orders/         # 訂單管理
│   │   ├── Inventory/      # 庫存管理
│   │   ├── Customers/      # 客戶管理
│   │   ├── Content/        # 內容管理
│   │   ├── Settings/       # 系統設定
│   │   └── Reports/        # 數據報表
│   ├── hooks/              # 自定義 Hooks
│   ├── stores/             # 狀態管理
│   ├── services/           # API 服務
│   ├── utils/              # 工具函數
│   ├── styles/             # 樣式文件
│   └── assets/             # 靜態資源
├── public/
├── vite.config.js
└── package.json
```

### 佈局系統
- **側邊欄導航**：支援多級選單、權限控制
- **頂部導航**：用戶資訊、通知中心、系統設定
- **內容區域**：響應式設計、支援全屏模式
- **底部資訊**：版權資訊、系統版本

### 主題系統
- **多主題支援**：支援亮色/暗色主題切換
- **品牌定制**：支援品牌色彩定制
- **響應式設計**：完整的行動裝置支援

## 安全性設計

### 認證安全
- **JWT Token 管理**：短期 Access Token + 長期 Refresh Token
- **Session 控制**：支援單一登入限制
- **密碼安全**：BCrypt 加密、密碼強度檢查

### 資料安全
- **輸入驗證**：前後端雙重驗證
- **SQL 注入防護**：參數化查詢
- **XSS 防護**：內容安全政策 (CSP)
- **CSRF 防護**：Token 驗證

### API 安全
- **速率限制**：防止 API 濫用
- **IP 白名單**：限制管理後台訪問 IP
- **HTTPS 強制**：所有通信加密
- **資料脫敏**：敏感資訊遮罩顯示

## 效能優化

### 前端優化
- **程式碼分割**：路由級別的懒加載
- **資源壓縮**：Gzip 壓縮、圖片優化
- **快取策略**：瀏覽器快取、Service Worker
- **虛擬滾動**：大列表效能優化

### 後端優化
- **資料庫索引**：查詢效能優化
- **API 快取**：Cloudflare KV 快取
- **批次操作**：減少資料庫查詢次數
- **背景任務**：非同步處理耗時操作

### Cloudflare 優化
- **Edge Computing**：就近處理請求
- **圖片優化**：自動格式轉換、大小優化
- **靜態資源 CDN**：全球加速

## 監控與維護

### 日誌系統
- **操作日誌**：管理員操作記錄
- **系統日誌**：系統錯誤、效能監控
- **安全日誌**：登入失敗、異常操作

### 備份策略
- **資料庫備份**：每日自動備份
- **檔案備份**：定期備份上傳檔案
- **配置備份**：系統配置版本控制

### 更新維護
- **版本控制**：Git 版本管理
- **部署流程**：自動化部署管道
- **回滾機制**：快速版本回滾

這個架構設計確保了 MickeyShop Beauty 後台管理系統的可擴展性、安全性和維護性，同時充分利用了 Cloudflare 生態系統的優勢。